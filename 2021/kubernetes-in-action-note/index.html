<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bqyang.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="关于 kubernetes in action 的读书笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes in action 读书笔记">
<meta property="og:url" content="https://bqyang.top/2021/kubernetes-in-action-note/index.html">
<meta property="og:site_name" content="杨宝强的技术笔记">
<meta property="og:description" content="关于 kubernetes in action 的读书笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/k8s-overview.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211216230209359.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/docker-overview.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211217140936336.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211217141152654.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211217151611381.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/1639725901(1).jpg">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211220152602878.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211220210440669.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211221143951994.png">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211221151336748.png">
<meta property="article:published_time" content="2021-12-16T12:14:24.744Z">
<meta property="article:modified_time" content="2021-12-21T08:50:51.884Z">
<meta property="article:author" content="杨宝强">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/k8s-overview.png">

<link rel="canonical" href="https://bqyang.top/2021/kubernetes-in-action-note/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>kubernetes in action 读书笔记 | 杨宝强的技术笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="杨宝强的技术笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <h1 class="site-title" style="font-size:27px">杨宝强的技术笔记</h1>
      <span class="logo-line-before"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">欢迎~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://bqyang.top/2021/kubernetes-in-action-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="杨宝强">
      <meta itemprop="description" content="记录技术精进之路，记录生活的打情骂俏">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨宝强的技术笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kubernetes in action 读书笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-16 20:14:24" itemprop="dateCreated datePublished" datetime="2021-12-16T20:14:24+08:00">2021-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-21 16:50:51" itemprop="dateModified" datetime="2021-12-21T16:50:51+08:00">2021-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>关于 kubernetes in action 的读书笔记</p>
<span id="more"></span>

<p>我读的这个是第一版，发现有很多东西都已经过时了，该书的原作者正在编辑第二版，manning 上可以看到第二版的相关内容，正处在 MEAP 阶段。我一开始能够免费阅读已开放的章节，今天到了公司突然不行了.. 需要花钱购买 MEAP 版本..</p>
<h2 id="1-Introducing-Kubernetes"><a href="#1-Introducing-Kubernetes" class="headerlink" title="1-Introducing Kubernetes"></a>1-Introducing Kubernetes</h2><p>首先介绍了传统 VM 和 Container 的区别，以及各自的优缺点，还针对 microservice 进行了系统的概述，怎么一步步从 Big  Monolithic 架构演进到 microservice，以及垂直扩展、水平扩展。</p>
<p>如何 Big Monolithic 架构拆分出来的 service 进行管理？</p>
<p>结尾描述了 k8s 集群的 architectue：</p>
<p>从硬件角度区分，可以分为 master node 和 worker node</p>
<ul>
<li>master  node 运行 K8s Control Plane 用来控制和管理 k8s 系统</li>
<li>worker nodes 是实际运行我们 app 的节点</li>
</ul>
<p>master node 又是由以下几个组件组成：</p>
<ul>
<li>Kubernetes API Server 用来和其他的 K8s Control Plane 组件进行通信</li>
<li>Scheduler 调度我们的部署的</li>
<li>Controller Manager 执行集群级别的函数，比如跟踪 work node，replicating components，处理失败的节点等</li>
<li>etcd 一个可靠的分布式数据存储，用来持久化存储集群配置</li>
</ul>
<p>worker nodes 有如下的组件：</p>
<ul>
<li><p>Kubernetes Service Proxy 可以在我们的应用组件件提供 LB 功能</p>
</li>
<li><p>Docker, rkt (rock-it) 用来执行我们的容器化的app</p>
</li>
<li><p>Kubelet 管理当前 node 上的容器和 API server 通信</p>
</li>
</ul>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/k8s-overview.png" alt="k8s-overview"></p>
<p>看到这句话，感觉真的是爆笑… 太逗了哈哈</p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211216230209359.png" alt="image-20211216230209359"></p>
<h2 id="2-First-steps-with-Docker-and-Kubernetes"><a href="#2-First-steps-with-Docker-and-Kubernetes" class="headerlink" title="2-First steps with Docker and Kubernetes"></a>2-First steps with Docker and Kubernetes</h2><p>第二章，主要涉及到一些动手实践的东西，Docker 中启动一个容器，K8s 中运行一个容器，学习使用 kubectl。</p>
<p>首先介绍了 docker 的简单使用，如下这个简版的 docker 运行 container 的过程</p>
<img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/docker-overview.png" alt="docker-overview" style="zoom:150%;" />

<p>书中讲了一些关于 docker 的基本使用，Dockerfile 的构建，启动、运行、停止、查看 container，怎么把image推送到 registry。</p>
<p>接下来的内容就是，配置 k8s，让我们的 container 跑在 k8s 中，而不是直接通过 docker 来运行。</p>
<p>需要注意的是，使用 Dockerfile 构建镜像的过程，会把需要的文件上传到 docker daemon，所以<strong>在构建目录下去除没必要的文件</strong>，否则会降低 build 的速度，尤其当 docker daemon 在远程的时候。</p>
<h3 id="配置-K8s-Cluster"><a href="#配置-K8s-Cluster" class="headerlink" title="配置 K8s Cluster"></a>配置 K8s Cluster</h3><p>上来就是当头一棒，告诉我们配置一个多个节点的 k8s 集群很难，要对 linux 和 网络非常熟悉，因为需要使多个物理机、虚拟机设置在一个适当的网络环境中，让他们彼此通信。</p>
<h4 id="minikube-安装-kubernetes"><a href="#minikube-安装-kubernetes" class="headerlink" title="minikube 安装 kubernetes"></a><code>minikube</code> 安装 kubernetes</h4><p>先到 <a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/start/">minikube</a> 官网下载一个安装包，然后直接执行 <code>minikube start</code> 命令，会拉取一些镜像。在拉取镜像的过程安装 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/tools/">kubectl</a> 用来和  K8s 进行交互，直接下载对应的可执行文件即可，然后添加到我们的环境变量中。</p>
<p>（貌似在执行完 minikube start 之后就已经自动安装了 kubectl，删除垃圾容器的时候还误删了自己的一个的 practise container .. 幸亏以前打了镜像，能恢复过来不然又要从头开始..）</p>
<p> 以上步骤都执行完成后，使用 <code>kubectl cluster-info</code> 查看一下 cluster 的信息。</p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211217140936336.png" alt="image-20211217140936336"></p>
<p><code>minikube ssh</code> 登录到刚刚部署的 master node</p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211217141152654.png" alt="image-20211217141152654"></p>
<p>可以看到，在这个 master node 上正在运行的线程，有第一章提到的，etcd/ apiserver/ schedule 等。</p>
<p><code>kubectl get nodes</code> 可以查看节点信息，比如有多少个 control plane(master)、多少个 worker。</p>
<p><code>kubectl describe node node_name</code> 可用来查看一个 node 详细信息，带 name 显示特定的 node 信息，不带 name 显示所有。</p>
<p>下面作业又教我们设置快捷键。。确实是，每次想看看看服务的日志信息，都需要输入完整的命令实在是太痛苦了，这部分章节再次就不再赘述。</p>
<h3 id="部署-Node-js-app"><a href="#部署-Node-js-app" class="headerlink" title="部署 Node.js app"></a>部署 Node.js app</h3><p>因为还没学习 yaml 文件的方式进行部署，所以只使用 run 命令进行部署 <code>kubectl run --image=yangbaoqiang2019/kubia --port=8080 </code> </p>
<p>这里跟书中内容有点出入，可能是因为书中内容的版本比较老，通过 <code>kubectl version</code> 查看一下当前 k8s 的版本信息，如果大于 1.18 版本在部署的时候就不需要添加 <code>--generator=run/v1</code> 命令</p>
<h4 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h4><p>K8s 并不直接对单独的 container 进行处理，取而代之的是，Pod。Pod 是一个或多个紧密关联的容器组合，这些容器会在同一个 worker node 或 Linux namespace 运行。</p>
<p><strong>Pod-node-container 之间的关系</strong></p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211217151611381.png" alt="image-20211217151611381"></p>
<p><code>kubectl get pods</code> 查看 pods，k8s 中没办法直接查看容器，因为容器在k8s中并不是一个独立的对象。</p>
<p><code>kubectl describe pod pod_name</code> 用来查看pod的详细信息。</p>
<p>看一下执行 kubectl run 命令后发生了什么</p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/1639725901(1).jpg" alt="1639725901(1)"></p>
<p>感觉大体上跟 docker 的执行过程相似。</p>
<p><strong>如何访问我们部署的pod</strong></p>
<p>如上边的图 2.5 每一个pod都有自己的 IP 地址，但是这个IP是集群内部的IP, 并不能从外部进行访问</p>
<p>要是想把内部的pod暴露出去，需要通过 service 来实现，创建一个 LB 的 service，创建一个常规的 service 还不行，也只能从内部进行访问。</p>
<ul>
<li>创建 service object<ul>
<li><code>kubectl expose rc kubia --type=LoadBalancer --name kubia-http</code></li>
</ul>
</li>
</ul>
<p>​              这里又搞了点小插曲.. 1.21 版本的 k8s 不支持 rc 这个对象了.. 通过上述命令创建不出来 LB，并且 minikube 是不支持 LB 的，externalID 一直都是空。。</p>
<p><strong>为什么我们要搞一个 service</strong></p>
<p>无论你后边的 pod 怎么变我暴露给你的外部externaIP 都是不变的。</p>
<p><strong>查看我们app跑在哪个node上</strong></p>
<p>在 k8s 中，app 被调度到哪个 node 上其实不重要，只要能给  app 提供运行所需要的环境就行。</p>
<p><code>kubectl get pods -o wide</code></p>
<p>第二章末尾还讲了一个 k8s dashborad 主要是一些可视化操作，不过要想逼格高，我觉得还是命令更能装逼哈哈</p>
<h2 id="3-Pods：-running-containers-in-Kubernetes"><a href="#3-Pods：-running-containers-in-Kubernetes" class="headerlink" title="3-Pods： running containers in Kubernetes"></a>3-Pods： running containers in Kubernetes</h2><p>第三章就开始深入的对 k8s 的各个组件进行讲解，首先从 pods 开始入手，因为 pods 是 k8s 中最重要，最核心的概念。</p>
<p>通常，一个 pod 只包含一个 container</p>
<p>问题：多个进程跑在一个容器中的问题。</p>
<p>日志管理、崩溃重启等。</p>
<p>Pod 是一个逻辑上的主机，他的表现像是一个 VM 或者物理机。我理解为，就像 Container 运行在 Host 上一样，现在是 container 运行在 pod 上。</p>
<p><strong>通过 pod 管理容器</strong></p>
<p>这里，书中举例，两个不相干的服务放在同一个 pod 中是否正确？</p>
<p>答案是，不正确的！作者从资源利用上进行分析，然后又从水平扩展进行了分析，因为在 k8s 中的水平扩展是以 pod 为单位的，每一次水平扩展都会将整个pod复制一份。</p>
<p>既然总说最好要在一个pod中运行一个container，那么什么时候应该在 pod 中运行多个 container 呢？</p>
<p>当 main container 不能独自完成某项任务，需要额外的 container 来辅助执行时。这种情况下就需要将多个 container 运行在同一个 pod 中。比如，在这个 pod 中，有一个container是用来提供目录下的文件服务，另一个 container 往目录中的文件写东西。</p>
<p>作者还给我们提供了几个标准用来判断是否要在同一个pod中运行多个 container</p>
<ul>
<li>他们是否需要在一起运行或他们可以在不同的 host 上运行？</li>
<li>他们是否是一个独立服务或一个独立的组件？</li>
<li>他们一定要一起扩展或单独的扩展？</li>
</ul>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211220152602878.png" alt="image-20211220152602878"></p>
<p><strong>通过 YAML 或 JSON 创建 pods</strong></p>
<p>这个地方和 Dockerfile 上传到 docker daemon 类似。</p>
<p><strong>学习下 YAML 各个字段的含义</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># kubernetes API 版本</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token comment"># k8s obj/res 类型</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token comment"># pod 信息</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2021-12-17T06:42:21Z"</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> kubia
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubia
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"17898"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> c048e5b1<span class="token punctuation">-</span>5aa6<span class="token punctuation">-</span>4ea7<span class="token punctuation">-</span>887a<span class="token punctuation">-</span>4601c2f3feff
<span class="token comment"># pod 详细信息</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> yangbaoqiang2019/kubia
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kubia
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
    <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount
      <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>api<span class="token punctuation">-</span>access<span class="token punctuation">-</span>9hqxs
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">enableServiceLinks</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> minikube
  <span class="token key atrule">preemptionPolicy</span><span class="token punctuation">:</span> PreemptLowerPriority
  <span class="token key atrule">priority</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
  <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> default
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> default
  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
    <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
    <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>api<span class="token punctuation">-</span>access<span class="token punctuation">-</span>9hqxs
    <span class="token key atrule">projected</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>
      <span class="token key atrule">sources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">serviceAccountToken</span><span class="token punctuation">:</span>
          <span class="token key atrule">expirationSeconds</span><span class="token punctuation">:</span> <span class="token number">3607</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> token
      <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
          <span class="token key atrule">items</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> ca.crt
            <span class="token key atrule">path</span><span class="token punctuation">:</span> ca.crt
          <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>root<span class="token punctuation">-</span>ca.crt
      <span class="token punctuation">-</span> <span class="token key atrule">downwardAPI</span><span class="token punctuation">:</span>
          <span class="token key atrule">items</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
            <span class="token key atrule">path</span><span class="token punctuation">:</span> namespace
<span class="token comment"># pod 和 container 的详细状态            </span>
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">conditions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2021-12-17T06:42:21Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Initialized
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2021-12-20T08:03:03Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Ready
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2021-12-20T08:03:03Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> ContainersReady
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2021-12-17T06:42:21Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> PodScheduled
  <span class="token key atrule">containerStatuses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">containerID</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>//e010602aa40ef907b61891d7ea5ae2adc5c5837eb1be09b59fed499a1a49cf2d
    <span class="token key atrule">image</span><span class="token punctuation">:</span> yangbaoqiang2019/kubia<span class="token punctuation">:</span>latest
    <span class="token key atrule">imageID</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>pullable<span class="token punctuation">:</span>//yangbaoqiang2019/kubia@sha256<span class="token punctuation">:</span>90a1f114d736dabfed10348ae0c67206e68f1c736f2b3382c91adc473f4dad73
    <span class="token key atrule">lastState</span><span class="token punctuation">:</span>
      <span class="token key atrule">terminated</span><span class="token punctuation">:</span>
        <span class="token key atrule">containerID</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>//59168997abb548e83da52623973820e56e43e7bbaee4490f1065b7eb5d0d0a83
        <span class="token key atrule">exitCode</span><span class="token punctuation">:</span> <span class="token number">255</span>
        <span class="token key atrule">finishedAt</span><span class="token punctuation">:</span> <span class="token string">"2021-12-20T05:43:35Z"</span>
        <span class="token key atrule">reason</span><span class="token punctuation">:</span> Error
        <span class="token key atrule">startedAt</span><span class="token punctuation">:</span> <span class="token string">"2021-12-20T02:43:44Z"</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kubia
    <span class="token key atrule">ready</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">restartCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token key atrule">started</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span>
      <span class="token key atrule">running</span><span class="token punctuation">:</span>
        <span class="token key atrule">startedAt</span><span class="token punctuation">:</span> <span class="token string">"2021-12-20T08:03:03Z"</span>
  <span class="token key atrule">hostIP</span><span class="token punctuation">:</span> 192.168.49.2
  <span class="token key atrule">phase</span><span class="token punctuation">:</span> Running
  <span class="token key atrule">podIP</span><span class="token punctuation">:</span> 172.17.0.2
  <span class="token key atrule">podIPs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 172.17.0.2
  <span class="token key atrule">qosClass</span><span class="token punctuation">:</span> BestEffort
  <span class="token key atrule">startTime</span><span class="token punctuation">:</span> <span class="token string">"2021-12-17T06:42:21Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>别看这里列出来的比较多，但是实际上重要的部分并不多。其中 <code>Metadata</code> <code>Spec</code> <code>Status</code> 是一些关键的部分。</p>
<ul>
<li>Metadata includes the name, namespace, labels, and other information about the pod.</li>
<li>Spec  contains the actual description of the pod’s contents, such as the pod’s containers, volumes, and other data.</li>
<li><em>Status</em> contains the current information about the running pod, such as what condition the pod is in, the description and status of each container, and the pod’s internal IP and other basic info.</li>
</ul>
<p>status 展示的是一个运行中的 pod 信息，在我们创建 pod 的时候并不需要关心 status 的内容。</p>
<p>注：可以使用 <code>kubectl explain pod</code> 来查看关于 pod 的一些字段</p>
<p><strong>kubectl create</strong> 创建 pod</p>
<p>通过 kubectl create -f filename 命令，创建一个 pod，create 能够创建的不止 pod </p>
<ul>
<li>-f –&gt; filename</li>
</ul>
<p><strong>查看 app log</strong></p>
<p>注：作者提到容器化的应用，通常将日志和错误以流式的方式输出到控制台，而不是将他们写入到文件中。主要是给用户提供了一个标准、简单的方式。</p>
<p>关于日志大小，容器日志采用的是循环写入的方式。</p>
<p><strong>port-forward</strong></p>
<p>通过这种方式，方便测试单个 pod，并不需要创建一个 service，指定一个本地端口和 pod 进行关联即可。</p>
<p><code>kubectl port-forward kubia-manual 8888:8080</code></p>
<p><strong>使用 labels 组织 pod</strong></p>
<p>方便 pod 的管理.. 可以在 YAML 中添加 labels 来指定该 pod 的 label，只要不重复可以随便添加。</p>
<ul>
<li>列出所有的 label<ul>
<li><code>kubectl get pods --show-labels</code></li>
</ul>
</li>
<li>只查看特定的 label<ul>
<li><code>kubectl get pods -L env</code></li>
</ul>
</li>
<li>修改已存在的 label<ul>
<li><code>kubectl label pod pod_name labelKey=labelValue</code></li>
</ul>
</li>
<li>label selector 支持多条件查询<ul>
<li><code>kubectl get pods -l app=as,rel=stable</code></li>
</ul>
</li>
</ul>
<p><strong>使用 label 控制调度</strong></p>
<p>为什么需要将pod调度到特定的 host 呢？本来 k8s 已经给我们把底层抽象出来了，无差别统一，给我们封装成了一个对象。</p>
<p>这个调度呢，还是给我们保留了一定的余地，比如我们有个 GPU 类型的主机，那这时候就需要将 Pod 调度到 GPU 类型的 Host 上。</p>
<p>正是使用了 label 来实现上述的调度。既然想将 pod 根据 label 调度到特定的 worker node， 那么 worker node 也是需要打上 label 的，不然怎么进行一一对应。</p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211220210440669.png" alt="image-20211220210440669"></p>
<p><strong>namespace 对资源分组</strong></p>
<p>了解为什么需要 namespace ？因为 namespace 可以将庞大的组件划分为更小且更容易区分的组。也可以用来根据不同的租户分离资源，也可以将资源划分为生产、开发、QA..</p>
<p>注：namespace 还可以提供权限控制甚至限制计算资源（配额）；有些 k8s 中的资源是没有 namespace 的，比如 node。</p>
<p><strong>创建 namespace</strong></p>
<ul>
<li>可以通过 YAML 创建</li>
<li>可以通过 command line 创建 <code>kubectl create ns ns_name</code></li>
</ul>
<p>第三章结尾又讲了一些删除 pod 的相关操作.. </p>
<h2 id="4-Replication-and-other-controllers-deploying-managed-pods"><a href="#4-Replication-and-other-controllers-deploying-managed-pods" class="headerlink" title="4-Replication and other controllers: deploying managed pods"></a>4-Replication and other controllers: deploying managed pods</h2><p>Pod 虽然是最基本的调度单位，但实际上我们并不直接对 Pod 进行操作，而是对 Pod 又做了一层封装，ReplicationContronller 或 Deployment。</p>
<p>这里有个问题就是，我们之前学习到的是直接对 Pod 进行操作，尽管 Pod 故障了，仍然可以在当前 node 上进行重启，但是 node 要是故障了，就会导致当前这个 pod 丢失，无法被恢复。</p>
<p>container 中进程崩溃了 k8s 可以帮助我们进行恢复，如果进程没崩溃只是一种假死状态（执行死循环）应该怎么办？这时候容器中的服务不能正常提供服务了。</p>
<p><strong>liveness probes</strong></p>
<p>k8s 有三种机制检测容器是否存活。</p>
<ul>
<li>HTTP GET，检测HTTP返回的状态码</li>
<li>TCP Socket，尝试和 container 建立链接（三次握手过程）</li>
<li>exec 命令，检查退出码</li>
</ul>
<p><strong>基于 HTTP</strong></p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211221143951994.png" alt="image-20211221143951994"></p>
<p>获取崩溃容器的日志 <code>kubectl logs mypod --previous</code> ，通过这种方式可以上去看看日志为什么容器崩溃了。</p>
<p><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/image-20211221151336748.png" alt="image-20211221151336748"></p>
<p>可以看到，图片中显示我们的 container 已经重启了 9 次。</p>
<p>delay 表明这个探活的请求是从容器启动后多久开始发起的，0s 显示，容器一运行这个请求发出去了。delay 的时间是可以调整的 <code>initialDelaySeconds</code> <strong>一定要设置该参数，在 delay = 0s 的情况下，容器有可能未准备好接收请求，还在初始化的过程中，这样就会导致 probe 失败重启该容器，陷入死循环</strong></p>
<p>period 表明发送请求的周期。</p>
<p>success 表明成功的次数。</p>
<p>failure 表明失败的次数。</p>
<p>timeout 表明请求的超时时间，如果超过 1s 就表明探活失败，要重启 container 了。</p>
<p>Exit Code： 退出的状态码，137 表明 exit code is 128 + 9 (SIGKILL); 143 表明 128 +</p>
<p>15 (SIGTERM)</p>
<p>使用这两种信号，是因为一个为了优雅的关停，如果说超过某个阈值container仍然没有停下来，就发送 kill 信号，强制关闭。</p>
<p>注意：这个过程是不需要 master 来参与的，只需要 pod 所在的 node 的 kubelet 即可完成对 pod 的恢复。**但是，如果 node 崩溃了 master control plane 就需要参与进来了，这时候就需要下面章节的知识点 **</p>
<p><strong>ReplicationControllers</strong></p>
<p>RC 就是一种 k8s 资源用来确保 pod 总是运行的。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="杨宝强 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="杨宝强 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>杨宝强
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://bqyang.top/2021/kubernetes-in-action-note/" title="kubernetes in action 读书笔记">https://bqyang.top/2021/kubernetes-in-action-note/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/git-rebase/" rel="prev" title="git rebase">
      <i class="fa fa-chevron-left"></i> git rebase
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/new-words/" rel="next" title="new words for me">
      new words for me <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Introducing-Kubernetes"><span class="nav-number">1.</span> <span class="nav-text">1-Introducing Kubernetes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-First-steps-with-Docker-and-Kubernetes"><span class="nav-number">2.</span> <span class="nav-text">2-First steps with Docker and Kubernetes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-K8s-Cluster"><span class="nav-number">2.1.</span> <span class="nav-text">配置 K8s Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#minikube-%E5%AE%89%E8%A3%85-kubernetes"><span class="nav-number">2.1.1.</span> <span class="nav-text">minikube 安装 kubernetes</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-Node-js-app"><span class="nav-number">2.2.</span> <span class="nav-text">部署 Node.js app</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pods"><span class="nav-number">2.2.1.</span> <span class="nav-text">Pods</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Pods%EF%BC%9A-running-containers-in-Kubernetes"><span class="nav-number">3.</span> <span class="nav-text">3-Pods： running containers in Kubernetes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Replication-and-other-controllers-deploying-managed-pods"><span class="nav-number">4.</span> <span class="nav-text">4-Replication and other controllers: deploying managed pods</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">杨宝强</p>
  <div class="site-description" itemprop="description">记录技术精进之路，记录生活的打情骂俏</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/clamyang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;clamyang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://xargin.com/" title="https:&#x2F;&#x2F;xargin.com" rel="noopener" target="_blank">Xargin</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://mytechshares.com/" title="https:&#x2F;&#x2F;mytechshares.com&#x2F;" rel="noopener" target="_blank">董泽润</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-car"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨宝强</span>
</div>
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2021035561号-1 </a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '4bcae079402e9cc4ce7b',
      clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
      repo        : 'blog_comments',
      owner       : 'clamyang',
      admin       : ['clamyang'],
      id          : '390d2e7906ce59bcde06dc3deb92c396',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
