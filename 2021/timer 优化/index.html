<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€ç‰©ä¸çŸ¥æ·±ä»¥ä¸ºè€»"><title>timer ä¼˜åŒ– | æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">timer ä¼˜åŒ–</h1><a id="logo" href="/.">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">timer ä¼˜åŒ–</h1><div class="post-meta">2021-11-14</div><div class="post-content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œè€ç‰ˆæœ¬ timer çš„æ€§èƒ½ç“¶é¢ˆä¸»è¦æ˜¯åœ¨é‚£æŠŠå…¨å±€é”ä»¥åŠé¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸Šï¼Œä»Šå¤©æˆ‘ä»¬çœ‹çœ‹ go å¤§ä½¬ä»¬é€šè¿‡å“ªç§æ–¹å¼è¿›è¡Œä¼˜åŒ–çš„ã€‚<br>â€‹</p>
<p>åœ¨è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆé€‰æ‹©è¿™å‡ ä¸ªç‰ˆæœ¬ï¼Œæ®æˆ‘æ‰€çŸ¥å•Šï¼Œä» 1.10 ç‰ˆæœ¬ä»¥å‰éƒ½æ˜¯åƒä¸Šä¸€ç¯‡æ–‡ä¸­æ‰€æè¿°çš„é‚£æ ·ï¼Œåœ¨ 1.10 ç‰ˆæœ¬å¼€å§‹å°±åšäº†è¿™ä¸ªä¼˜åŒ–ï¼Œä½†ä» 1.14 å¼€å§‹åˆå¯¹ timer è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº† 1.8ï¼Œ 1.13ï¼Œ 1.14 è¿™å‡ ä¸ªé‚»è¿‘çš„ä½œä¸ºå‚è€ƒã€‚</p>
<span id="more"></span>

<h2 id="go-1-13-ä¸­çš„ä¼˜åŒ–"><a href="#go-1-13-ä¸­çš„ä¼˜åŒ–" class="headerlink" title="go 1.13 ä¸­çš„ä¼˜åŒ–"></a>go 1.13 ä¸­çš„ä¼˜åŒ–</h2><h3 id="ç¯å¢ƒä¿¡æ¯"><a href="#ç¯å¢ƒä¿¡æ¯" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h3><ul>
<li>go version: go1.13</li>
<li>compute: linux, centos7</li>
</ul>
<h3 id="timer-ç»“æ„çš„å˜åŒ–"><a href="#timer-ç»“æ„çš„å˜åŒ–" class="headerlink" title="timer ç»“æ„çš„å˜åŒ–"></a>timer ç»“æ„çš„å˜åŒ–</h3><h5 id="go1-8"><a href="#go1-8" class="headerlink" title="go1.8"></a>go1.8</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> timer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	i <span class="token builtin">int</span> <span class="token comment">// heap index</span>
	when   <span class="token builtin">int64</span>
	period <span class="token builtin">int64</span>
	f      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
	arg    <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	seq    <span class="token builtin">uintptr</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="go1-13"><a href="#go1-13" class="headerlink" title="go1.13"></a>go1.13</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> timer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	tb <span class="token operator">*</span>timersBucket <span class="token comment">// the bucket the timer lives in</span>
	i  <span class="token builtin">int</span>           <span class="token comment">// heap index</span>
	when   <span class="token builtin">int64</span>
	period <span class="token builtin">int64</span>
	f      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
	arg    <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	seq    <span class="token builtin">uintptr</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨go1.13ç‰ˆæœ¬ä¸­æ·»åŠ äº†ä¸€ä¸ª tb å­—æ®µï¼Œè¡¨ç¤ºå½“å‰è¿™ä¸ª timer æ˜¯åœ¨å“ªä¸ª bucket ä¸­çš„ï¼Œå…¶ä½™å­—æ®µå«ä¹‰è¿˜æ˜¯å’Œè€ç‰ˆæœ¬ä¸­çš„ä¸€è‡´ã€‚<br>â€‹</p>
<p>è¿˜è®°å¾—è€ç‰ˆæœ¬æŠŠæ–°å»ºçš„ <code>timer</code> å¯¹è±¡éƒ½æ”¾åœ¨å“ªé‡Œäº†å—ï¼Ÿ<code>ä¸€ä¸ªå…¨å±€çš„ timers ä¸­</code> go1.13ç‰ˆæœ¬ä¸­å°†çš„ timers æ‹†åˆ†æˆäº† 64 ä¸ªå¤§å°çš„ timers æ•°ç»„ï¼Œæ¯ä¸€ä¸ªé‡Œè¾¹åŒ…å«äº†ä¸€ä¸ª bucket ï¼Œbucket ä¸­å†å­˜æ”¾ timer å¯¹è±¡ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯ 64 å®˜æ–¹çš„è§£é‡Šå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// timersLen is the length of timers array.</span>
<span class="token comment">//</span>
<span class="token comment">// Ideally, this would be set to GOMAXPROCS, but that would require</span>
<span class="token comment">// dynamic reallocation</span>
<span class="token comment">//</span>
<span class="token comment">// The current value is a compromise between memory usage and performance</span>
<span class="token comment">// that should cover the majority of GOMAXPROCS values used in the wild.</span>
<span class="token keyword">const</span> timersLen <span class="token operator">=</span> <span class="token number">64</span>

<span class="token comment">// timersLen is the length of timers array.</span>
<span class="token comment">//</span>
<span class="token comment">// Ideally, this would be set to GOMAXPROCS, but that would require</span>
<span class="token comment">// dynamic reallocation</span>
<span class="token comment">//</span>
<span class="token comment">// The current value is a compromise between memory usage and performance</span>
<span class="token comment">// that should cover the majority of GOMAXPROCS values used in the wild.</span>
<span class="token keyword">var</span> timers <span class="token punctuation">[</span>timersLen<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	timersBucket

	<span class="token comment">// The padding should eliminate false sharing</span>
	<span class="token comment">// between timersBucket values.</span>
	pad <span class="token punctuation">[</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>timersBucket<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//go:notinheap</span>
<span class="token keyword">type</span> timersBucket <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	lock         mutex
	gp           <span class="token operator">*</span>g
	created      <span class="token builtin">bool</span>
	sleeping     <span class="token builtin">bool</span>
	rescheduling <span class="token builtin">bool</span>
	sleepUntil   <span class="token builtin">int64</span>
	waitnote     note
	t            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨æ·»åŠ  timer å¯¹è±¡æ—¶é€»è¾‘å˜æˆäº†ï¼Œæ ¹æ®å½“å‰ p çš„ id å¯¹ timersLen å–æ¨¡ï¼Œå¾—åˆ°äº† p å¯¹åº”çš„ timersBucket <code>id := uint8(getg().m.p.ptr().id) % _timersLen_</code><br>ä»è¿™ä¸ªä¼˜åŒ–çš„æ–¹æ³•æ¥çœ‹ï¼Œä»¥å‰æ˜¯æ¯ä¸ªpå»æŠ¢åŒä¸€æŠŠé”ï¼Œç°åœ¨å˜æˆï¼Œæ¯ä¸ªpåªä¼šæ“ä½œå¯¹åº”çš„ timersBucketï¼ˆå¤§å¤šæ•°æƒ…å†µä¸‹ï¼‰ã€‚</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>åœ¨è¶…è¿‡ 64 ä¸ª p çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°å–æ¨¡åˆ°åŒä¸€ä¸ª bucket ä¸­ï¼Œè¿™ç§æƒ…å†µåœ¨å¤šæ ¸ cpu &gt; 64 ä¸Šæ˜¯æ²¡åŠæ³•é¿å…çš„</strong></li>
<li><input disabled="" type="checkbox"> <strong>å¯èƒ½è¿˜æœ‰ p ä»åˆ«çš„ p ä¸Šå· timer çš„æƒ…å†µ</strong></li>
</ul>
<p>æ¥ä¸‹é‡Œæˆ‘ä»¬çœ‹ä¸‹æ‰§è¡Œ timer çš„ <code>timerproc</code><br>1.8 ç‰ˆæœ¬ä¸­ï¼Œå…¨å±€åªæœ‰ä¸€ä¸ªæ‰§è¡Œ timer çš„ timerprocï¼Œå¯ä»¥ç†è§£ä¸ºåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚1.13 ä¸­ä¿®æ”¹ä¸ºæ¯ä¸ªä¸åŒçš„ bucket éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ bucketã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ 4 ä¸ª Pï¼Œå°±è¯´æ˜æˆ‘ä»¬ä¼šæœ‰ 4 ä¸ª bucket å’Œ 4 ä¸ª timerprocï¼Œæ¯å½“é€šè¿‡ addtimer æ·»åŠ æ—¶ï¼Œéƒ½ä¼šå¾€ p å¯¹åº”çš„ bucket ä¸­æ·»åŠ ä»»åŠ¡ï¼Œtimerproc ä½œä¸ºæ¶ˆè´¹è€…ä»ä¸­æ‰¾å¯æ‰§è¡Œçš„timerï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/1636033788855-ece14ebf-e72d-4851-9a75-de7cd60d59ba.png" alt="image.png"></p>
<h3 id="timer-çš„â€œç”Ÿäº§è€…â€"><a href="#timer-çš„â€œç”Ÿäº§è€…â€" class="headerlink" title="timer çš„â€œç”Ÿäº§è€…â€"></a>timer çš„â€œç”Ÿäº§è€…â€</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// å¦‚å‰æ‰€è¿°ï¼Œæ¯ä¸ªpå¯¹åº”ä¸åŒçš„ timersBucketï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºä¹‹å‰æˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥å…ˆæ‰¾åˆ°åœ¨å“ªä¸ª p ä¸Šæ‰§è¡Œ</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token function">assignBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>timersBucket <span class="token punctuation">&#123;</span>
	id <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">%</span> timersLen
	t<span class="token punctuation">.</span>tb <span class="token operator">=</span> <span class="token operator">&amp;</span>timers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>timersBucket
	<span class="token keyword">return</span> t<span class="token punctuation">.</span>tb
<span class="token punctuation">&#125;</span>

<span class="token comment">// å°† timer æ·»åŠ åˆ°å¯¹åº”çš„ timersBucket ä¸­</span>
<span class="token keyword">func</span> <span class="token function">addtimer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tb <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">assignBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	ok <span class="token operator">:=</span> tb<span class="token punctuation">.</span><span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// å’±ä»¬åªæŠŠé‡ç‚¹æ”¾åœ¨ä¸ä»¥å‰ä¸åŒçš„åœ°æ–¹ä¸Š</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>tb <span class="token operator">*</span>timersBucket<span class="token punctuation">)</span> <span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>when <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span>when <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">63</span> <span class="token operator">-</span> <span class="token number">1</span>
	<span class="token punctuation">&#125;</span>
	t<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">)</span>
	tb<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> t<span class="token punctuation">)</span> 		<span class="token comment">// æ·»åŠ åˆ°på¯¹åº”çš„timersBucketä¸­ï¼Œè€Œä¸æ˜¯å…¨å±€çš„ timers ä¸­äº†</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">siftupTimer</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> t<span class="token punctuation">.</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// siftup moved to top: new earliest deadline.</span>
		<span class="token keyword">if</span> tb<span class="token punctuation">.</span>sleeping <span class="token operator">&amp;&amp;</span> tb<span class="token punctuation">.</span>sleepUntil <span class="token operator">></span> t<span class="token punctuation">.</span>when <span class="token punctuation">&#123;</span>
			tb<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token function">notewakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>waitnote<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> tb<span class="token punctuation">.</span>rescheduling <span class="token punctuation">&#123;</span>
			tb<span class="token punctuation">.</span>rescheduling <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token function">goready</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>tb<span class="token punctuation">.</span>created <span class="token punctuation">&#123;</span>
			<span class="token comment">// åˆ¤æ–­å±äºè¿™ä¸ª tb çš„ timerproc æ˜¯å¦å¯åŠ¨äº†ï¼Œ</span>
			<span class="token comment">// åŒºåˆ«äº1.8ç‰ˆæœ¬æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡æ§åˆ¶çš„ï¼Œåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œè¿™é‡Œæ˜¯æ¯ä¸€ä¸ª tb éƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…</span>
			tb<span class="token punctuation">.</span>created <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">go</span> <span class="token function">timerproc</span><span class="token punctuation">(</span>tb<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="timer-çš„â€œæ¶ˆè´¹è€…â€"><a href="#timer-çš„â€œæ¶ˆè´¹è€…â€" class="headerlink" title="timer çš„â€œæ¶ˆè´¹è€…â€"></a>timer çš„â€œæ¶ˆè´¹è€…â€</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ä¸»è¦çš„é€»è¾‘è¿˜æ˜¯åŒ 1.8 ç‰ˆæœ¬ä¸­ä¸€è‡´çš„ï¼Œä¸åŒçš„åœ°æ–¹å°±æ˜¯é’ˆå¯¹æ¯ä¸ªtbè¿›è¡Œçš„æ“ä½œï¼Œä¸æ˜¯å…¨å±€çš„ timers</span>
<span class="token keyword">func</span> <span class="token function">timerproc</span><span class="token punctuation">(</span>tb <span class="token operator">*</span>timersBucket<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tb<span class="token punctuation">.</span>gp <span class="token operator">=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		tb<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span>
		now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		delta <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				delta <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			t <span class="token operator">:=</span> tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			delta <span class="token operator">=</span> t<span class="token punctuation">.</span>when <span class="token operator">-</span> now
			<span class="token keyword">if</span> delta <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			ok <span class="token operator">:=</span> <span class="token boolean">true</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span>period <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// leave in heap but adjust next time to fire</span>
				t<span class="token punctuation">.</span>when <span class="token operator">+=</span> t<span class="token punctuation">.</span>period <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token operator">-</span>delta<span class="token operator">/</span>t<span class="token punctuation">.</span>period<span class="token punctuation">)</span>
				<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">siftdownTimer</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					ok <span class="token operator">=</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// remove from heap</span>
				last <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
				<span class="token keyword">if</span> last <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span>last<span class="token punctuation">]</span>
					tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">0</span>
				<span class="token punctuation">&#125;</span>
				tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span>last<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
				tb<span class="token punctuation">.</span>t <span class="token operator">=</span> tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token punctuation">:</span>last<span class="token punctuation">]</span>
				<span class="token keyword">if</span> last <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">siftdownTimer</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						ok <span class="token operator">=</span> <span class="token boolean">false</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				t<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// mark as removed</span>
			<span class="token punctuation">&#125;</span>
			f <span class="token operator">:=</span> t<span class="token punctuation">.</span>f
			arg <span class="token operator">:=</span> t<span class="token punctuation">.</span>arg
			seq <span class="token operator">:=</span> t<span class="token punctuation">.</span>seq
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
				<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> raceenabled <span class="token punctuation">&#123;</span>
				<span class="token function">raceacquire</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token function">f</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> seq<span class="token punctuation">)</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> faketime <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// No timers left - put goroutine to sleep.</span>
			tb<span class="token punctuation">.</span>rescheduling <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token function">goparkunlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> waitReasonTimerGoroutineIdle<span class="token punctuation">,</span> traceEvGoBlock<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// At least one timer pending. Sleep until then.</span>
		tb<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">true</span>
		tb<span class="token punctuation">.</span>sleepUntil <span class="token operator">=</span> now <span class="token operator">+</span> delta
		<span class="token function">noteclear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>waitnote<span class="token punctuation">)</span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token function">notetsleepg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>waitnote<span class="token punctuation">,</span> delta<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç›¸æ¯”äº 1.8ï¼Œ1.13ç‰ˆæœ¬ä¸­è¿˜æ·»åŠ äº†ä¸€ä¸ª <code>modtimer(t *timer, when, period int64, f func(interface&#123;&#125;, uintptr), arg interface&#123;&#125;, seq uintptr)</code><br>modtimer å‡½æ•°ä¸»è¦åšäº†ï¼Œå°† t ä» tb ä¸­åˆ é™¤ï¼Œç„¶åæœ‰ é‡æ–°ç»™å®ƒ åŠ å…¥è¿›å»</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">modtimer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">,</span> when<span class="token punctuation">,</span> period <span class="token builtin">int64</span><span class="token punctuation">,</span> f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> seq <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tb <span class="token operator">:=</span> t<span class="token punctuation">.</span>tb

	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> tb<span class="token punctuation">.</span><span class="token function">deltimerLocked</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span>when <span class="token operator">=</span> when
		t<span class="token punctuation">.</span>period <span class="token operator">=</span> period
		t<span class="token punctuation">.</span>f <span class="token operator">=</span> f
		t<span class="token punctuation">.</span>arg <span class="token operator">=</span> arg
		t<span class="token punctuation">.</span>seq <span class="token operator">=</span> seq
		ok <span class="token operator">=</span> tb<span class="token punctuation">.</span><span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨ netpoll ä¸­ï¼Œæœ‰ä¸¤å¤„åœ°æ–¹è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œä¸»è¦å°±æ˜¯ç»™ fd è°ƒæ•´è¶…æ—¶å¤„ç†ä½¿ç”¨çš„ã€‚</p>
<p>æ€»çš„æ¥è¯´è¿™ä¸ªç‰ˆæœ¬ä¸­çš„ä¼˜åŒ–åªæ˜¯åšäº†å…¨å±€é”ç²’åº¦çš„æ‹†åˆ†ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ä»ç„¶æ²¡æœ‰å¾—åˆ°ä¼˜åŒ–ï¼Œä¸è¿‡ä¸è¦ç€æ€¥ï¼Œ1.14 ç‰ˆæœ¬ä¸­é’ˆå¯¹è¿™ä¸ªé—®é¢˜å·²ç»åšäº†å¦¥å–„çš„å¤„ç†ï¼Œæˆ‘ä»¬é©¬ä¸Šå°±æ¥çœ‹ä¸€ä¸‹ã€‚<br>â€‹</p>
<h2 id="go-1-14-ä¸­çš„ä¼˜åŒ–"><a href="#go-1-14-ä¸­çš„ä¼˜åŒ–" class="headerlink" title="go 1.14 ä¸­çš„ä¼˜åŒ–"></a>go 1.14 ä¸­çš„ä¼˜åŒ–</h2><h3 id="ç¯å¢ƒä¿¡æ¯-1"><a href="#ç¯å¢ƒä¿¡æ¯-1" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h3><p>go version: go1.14.1<br>compute: linux, centos7</p>
<h3 id="timer-ç»“æ„çš„å˜åŒ–-1"><a href="#timer-ç»“æ„çš„å˜åŒ–-1" class="headerlink" title="timer ç»“æ„çš„å˜åŒ–"></a>timer ç»“æ„çš„å˜åŒ–</h3><p>ä»¥å‰çš„ç»“æ„ä½“éƒ½æ˜¯å…¨å±€å˜é‡ï¼Œåœ¨ 1.14 ç‰ˆæœ¬å¼€å§‹ï¼Œtimer ç»“æ„ä½“å°±å†…åµŒåˆ°äº† P ä¸­ã€‚</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Package time knows the layout of this structure.</span>
<span class="token comment">// If this struct changes, adjust ../time/sleep.go:/runtimeTimer.</span>
<span class="token keyword">type</span> timer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// If this timer is on a heap, which P's heap it is on.</span>
	<span class="token comment">// puintptr rather than *p to match uintptr in the versions</span>
	<span class="token comment">// of this struct defined in other packages.</span>
	pp puintptr

	<span class="token comment">// Timer wakes up at when, and then at when+period, ... (period > 0 only)</span>
	<span class="token comment">// each time calling f(arg, now) in the timer goroutine, so f must be</span>
	<span class="token comment">// a well-behaved function and not block.</span>
	when   <span class="token builtin">int64</span>
	period <span class="token builtin">int64</span>
	f      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
	arg    <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	seq    <span class="token builtin">uintptr</span>

	<span class="token comment">// What to set the when field to in timerModifiedXX status.</span>
	nextwhen <span class="token builtin">int64</span>

	<span class="token comment">// The status field holds one of the values below.</span>
	status <span class="token builtin">uint32</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	id          <span class="token builtin">int32</span>
    
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    
	<span class="token comment">// Lock for timers. We normally access the timers while running</span>
	<span class="token comment">// on this P, but the scheduler can also do it from a different P.</span>
	<span class="token comment">// è®²é“ç†ï¼Œä½ på¤„ç†æœ¬åœ°çš„ timer ç”¨é”å¹²ä»€ä¹ˆï¼Ÿ</span>
	<span class="token comment">// 1.14 æ˜¯å¯ä»¥å· timer çš„ï¼Œè¿™æ—¶å€™å°±å˜æˆäº†å…±äº«èµ„æºï¼Œè®¿é—®çš„æ—¶å€™æ˜¯ä¸€å®šè¦åŠ é”çš„ã€‚</span>
	<span class="token comment">// ä¸Šè¾¹æ³¨é‡Šï¼ˆè‹±æ–‡ï¼‰è¯´çš„ä¹Ÿå¾ˆæ¸…æ¥šï¼Œè¿™ä¸ªæ˜¯å®˜æ–¹çš„è§£é‡Š</span>
	timersLock mutex

	<span class="token comment">// Actions to take at some time. This is used to implement the</span>
	<span class="token comment">// standard library's time package.</span>
	<span class="token comment">// Must hold timersLock to access.</span>
	timers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer

	<span class="token comment">// Number of timers in P's heap.</span>
	<span class="token comment">// Modified using atomic instructions.</span>
	<span class="token comment">// è®°å½•å½“å‰ p ä¸­ timerçš„æ€»æ•°é‡</span>
	numTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Number of timerModifiedEarlier timers on P's heap.</span>
	<span class="token comment">// This should only be modified while holding timersLock,</span>
	<span class="token comment">// or while the timer status is in a transient state</span>
	<span class="token comment">// such as timerModifying.</span>
	<span class="token comment">// P ä¸­ è°ƒæ•´ when çš„æ—¶é—´æå‰äº†çš„ timer æ•°é‡</span>
	adjustTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Number of timerDeleted timers in P's heap.</span>
	<span class="token comment">// Modified using atomic instructions.</span>
	<span class="token comment">// è®°å½• p ä¸­è¢«åˆ é™¤çš„ timer æ•°é‡</span>
	deletedTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Race context used while executing timer functions.</span>
	timerRaceCtx <span class="token builtin">uintptr</span>
    
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="timer-çš„â€œç”Ÿäº§è€…â€-1"><a href="#timer-çš„â€œç”Ÿäº§è€…â€-1" class="headerlink" title="timer çš„â€œç”Ÿäº§è€…â€"></a>timer çš„â€œç”Ÿäº§è€…â€</h3><p><code>... åŸºæœ¬ä¸Šå¤§åŒå°å¼‚ï¼Œåªä¸è¿‡æ˜¯åŠ äº†ä¸€äº›çŠ¶æ€</code><br>ä¸è¿‡éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ1.14 ä¸­æœ‰äº† timer å’Œ netpoll çš„ç»“åˆã€‚æˆ‘çš„ç†è§£æ˜¯ï¼š<br>findrunnable æœ€åæ²¡æœ‰æ‰¾åˆ°å¯æ‰§è¡Œçš„ g çš„æ—¶å€™ä¼šå†æ£€æŸ¥ netpollã€‚è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œé˜»å¡ delta è¿™æ®µæ—¶é—´ï¼Œç„¶åè¿™æ—¶å€™æ¯”å¦‚è¯´æˆ‘é€šè¿‡ addtimer åŠ å…¥æ–°timerï¼Œå°±æ˜¯å‡è®¾å“ˆï¼Œ1s åè¦æ‰§è¡Œï¼Œç„¶åä½ é‚£ä¸ªé˜»å¡è¿‡ç¨‹è¦é˜»å¡ 3sï¼Œä½†è¿™æ˜¯åœ¨é˜»å¡æ²¡æœ‰åŠæ³•æ‰§è¡Œæˆ‘ä»¬çš„ timerï¼Œç„¶åè¿™æ—¶å€™ addtimer ä¸­çš„ wakenetpoller å°±æ´¾ä¸Šç”¨åœºï¼Œé€šè¿‡ <code>netpollbreak</code> ä¸­æ–­é‚£ä¸ªé˜»å¡è°ƒç”¨ï¼Œç„¶åå°±å›åˆ° <code>findrunnable</code> ç»§ç»­æ‰§è¡Œï¼ŒåŠæ—¶å“åº”é‚£ä¸ªè¿‘æœŸçš„ timer å¯¹è±¡ã€‚</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// addtimer:</span>
<span class="token comment">//   timerNoStatus   -> timerWaiting</span>
<span class="token comment">//   anything else   -> panic: invalid value</span>
<span class="token comment">// deltimer:</span>
<span class="token comment">//   timerWaiting         -> timerModifying -> timerDeleted</span>
<span class="token comment">//   timerModifiedEarlier -> timerModifying -> timerDeleted</span>
<span class="token comment">//   timerModifiedLater   -> timerModifying -> timerDeleted</span>
<span class="token comment">//   timerNoStatus        -> do nothing</span>
<span class="token comment">//   timerDeleted         -> do nothing</span>
<span class="token comment">//   timerRemoving        -> do nothing</span>
<span class="token comment">//   timerRemoved         -> do nothing</span>
<span class="token comment">//   timerRunning         -> wait until status changes</span>
<span class="token comment">//   timerMoving          -> wait until status changes</span>
<span class="token comment">//   timerModifying       -> wait until status changes</span>
<span class="token comment">// modtimer:</span>
<span class="token comment">//   timerWaiting    -> timerModifying -> timerModifiedXX</span>
<span class="token comment">//   timerModifiedXX -> timerModifying -> timerModifiedYY</span>
<span class="token comment">//   timerNoStatus   -> timerModifying -> timerWaiting</span>
<span class="token comment">//   timerRemoved    -> timerModifying -> timerWaiting</span>
<span class="token comment">//   timerDeleted    -> timerModifying -> timerModifiedXX</span>
<span class="token comment">//   timerRunning    -> wait until status changes</span>
<span class="token comment">//   timerMoving     -> wait until status changes</span>
<span class="token comment">//   timerRemoving   -> wait until status changes</span>
<span class="token comment">//   timerModifying  -> wait until status changes</span>
<span class="token comment">// cleantimers (looks in P's timer heap):</span>
<span class="token comment">//   timerDeleted    -> timerRemoving -> timerRemoved</span>
<span class="token comment">//   timerModifiedXX -> timerMoving -> timerWaiting</span>
<span class="token comment">// adjusttimers (looks in P's timer heap):</span>
<span class="token comment">//   timerDeleted    -> timerRemoving -> timerRemoved</span>
<span class="token comment">//   timerModifiedXX -> timerMoving -> timerWaiting</span>
<span class="token comment">// runtimer (looks in P's timer heap):</span>
<span class="token comment">//   timerNoStatus   -> panic: uninitialized timer</span>
<span class="token comment">//   timerWaiting    -> timerWaiting or</span>
<span class="token comment">//   timerWaiting    -> timerRunning -> timerNoStatus or</span>
<span class="token comment">//   timerWaiting    -> timerRunning -> timerWaiting</span>
<span class="token comment">//   timerModifying  -> wait until status changes</span>
<span class="token comment">//   timerModifiedXX -> timerMoving -> timerWaiting</span>
<span class="token comment">//   timerDeleted    -> timerRemoving -> timerRemoved</span>
<span class="token comment">//   timerRunning    -> panic: concurrent runtimer calls</span>
<span class="token comment">//   timerRemoved    -> panic: inconsistent timer heap</span>
<span class="token comment">//   timerRemoving   -> panic: inconsistent timer heap</span>
<span class="token comment">//   timerMoving     -> panic: inconsistent timer heap</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="timer-çš„â€œæ¶ˆè´¹è€…â€-1"><a href="#timer-çš„â€œæ¶ˆè´¹è€…â€-1" class="headerlink" title="timer çš„â€œæ¶ˆè´¹è€…â€"></a>timer çš„â€œæ¶ˆè´¹è€…â€</h3><p>æ–°ç‰ˆæœ¬ä¸­çš„â€œæ¶ˆè´¹è€…â€æœ‰ç€éå¸¸é‡è¦çš„æ”¹å˜ï¼Œ<code>timerproc</code> æ²¡äº†ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ï¼š<br>timerproc ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ˜¯ runtime åˆ›å»ºçš„ä¸€ä¸ª goroutineï¼Œå› æ­¤å¯çŸ¥ï¼Œä»¥å‰çš„â€œæ¶ˆè´¹è€…â€å°±æ˜¯ä¸€ä¸ª goroutineï¼Œ å®ƒå¹¶æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼ŒåŒæ ·è¢« <code>scheduler</code>è°ƒåº¦ã€‚</p>
<p>1.14 ä¸­ï¼Œç›´æ¥ç»™â€œæ¶ˆè´¹è€…â€å‡åˆ°â€œå¤´ç­‰èˆ±â€ï¼Œçœ‹ä½ å°å­å¹²æ´»å‹¤å‹¤æ³æ³ï¼Œschedulerè¯´ï¼Œä½ æ¥æˆ‘è¿™ä¸Šç­å§ï¼Œç»“æœäººå®¶å°±å»äº†ã€‚</p>
<p>1.14 ä¸­ï¼Œtimer çš„æ¶ˆè´¹è€…å°±æ˜¯åœ¨è°ƒåº¦å¾ªç¯çš„ <code>schedule</code> ä¸­ï¼Œå…¶æ¬¡å°±æ˜¯ <code>sysmon</code> ï¼ˆsysmonä½œä¸ºå…œåº•ï¼‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹æºç ï¼Œçœ‹çœ‹æ–°ç‰ˆæœ¬çš„æ¶ˆè´¹è€…æ˜¯æ€ä¹ˆâ€œæ™‹å‡â€çš„ã€‚</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// çœç•¥å®‰å…¨æ£€æŸ¥</span>
    
	<span class="token comment">// çœ‹çœ‹äººå®¶ timer ç›´æ¥è¢«å®‰æ’åˆ°é¡¶çº§ä½ç½®</span>
	<span class="token comment">// è°ƒåº¦å¾ªç¯ä¸Šæ¥å°±æ˜¯å…ˆæ£€æŸ¥ timer</span>
	<span class="token function">checkTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>
	<span class="token punctuation">&#125;</span>

    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæ–°ç‰ˆæœ¬çš„â€œæ¶ˆè´¹è€…â€ ä» goroutine çº§åˆ« è½¬å˜åˆ° å‡½æ•°çº§åˆ«ã€‚</p>
<h4 id="checkTimers"><a href="#checkTimers" class="headerlink" title="checkTimers()"></a>checkTimers()</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// checkTimers runs any timers for the P that are ready.</span>
<span class="token comment">// If now is not 0 it is the current time.</span>
<span class="token comment">// It returns the current time or 0 if it is not known,</span>
<span class="token comment">// and the time when the next timer should run or 0 if there is no next timer,</span>
<span class="token comment">// and reports whether it ran any timers.</span>
<span class="token comment">// If the time when the next timer should run is not 0,</span>
<span class="token comment">// it is always larger than the returned time.</span>
<span class="token comment">// We pass now in and out to avoid extra calls of nanotime.</span>
<span class="token comment">//go:yeswritebarrierrec</span>
<span class="token comment">// rnow			</span>
<span class="token comment">// pollUntil	0 è¡¨ç¤ºæ²¡æœ‰ä¸‹ä¸€ä¸ª timerï¼Œé 0 è¡¨ç¤ºä¸‹ä¸€ä¸ªtimerçš„ç­‰å¾…æ—¶é—´</span>
<span class="token comment">// ran			è¡¨ç¤ºæ˜¯å¦æ‰§è¡Œäº† timer</span>
<span class="token keyword">func</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">,</span> now <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>rnow<span class="token punctuation">,</span> pollUntil <span class="token builtin">int64</span><span class="token punctuation">,</span> ran <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// If there are no timers to adjust, and the first timer on</span>
	<span class="token comment">// the heap is not yet ready to run, then there is nothing to do.</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		next <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>timer0When<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> next <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> now<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> now <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			now <span class="token operator">=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> now <span class="token operator">&lt;</span> next <span class="token punctuation">&#123;</span>
			<span class="token comment">// Next timer is not ready to run.</span>
			<span class="token comment">// But keep going if we would clear deleted timers.</span>
			<span class="token comment">// This corresponds to the condition below where</span>
			<span class="token comment">// we decide whether to call clearDeletedTimers.</span>
			<span class="token comment">// å°½å¯èƒ½æ‰¾æœºä¼šæ¸…ç† timer</span>
			<span class="token keyword">if</span> pp <span class="token operator">!=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">int</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">int</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>numTimers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> now<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>timersLock<span class="token punctuation">)</span>

	<span class="token function">adjusttimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>

	rnow <span class="token operator">=</span> now
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> rnow <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			rnow <span class="token operator">=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Note that runtimer may temporarily unlock</span>
			<span class="token comment">// pp.timersLock.</span>
			<span class="token keyword">if</span> tw <span class="token operator">:=</span> <span class="token function">runtimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> rnow<span class="token punctuation">)</span><span class="token punctuation">;</span> tw <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> tw <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					pollUntil <span class="token operator">=</span> tw
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			ran <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// If this is the local P, and there are a lot of deleted timers,</span>
	<span class="token comment">// clear them out. We only do this for the local P to reduce</span>
	<span class="token comment">// lock contention on timersLock.</span>
	<span class="token keyword">if</span> pp <span class="token operator">==</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">int</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span> <span class="token punctuation">&#123;</span>
		<span class="token function">clearDeletedTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>timersLock<span class="token punctuation">)</span>

	<span class="token keyword">return</span> rnow<span class="token punctuation">,</span> pollUntil<span class="token punctuation">,</span> ran
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨ä¸Šè¿° <code>checkTimers</code> ä¸­ï¼Œé€šè¿‡ <code>adjusttimers</code> è°ƒæ•´å½“å‰ p çš„ timers æ•°ç»„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å®ç°</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// adjusttimers looks through the timers in the current P's heap for</span>
<span class="token comment">// any timers that have been modified to run earlier, and puts them in</span>
<span class="token comment">// the correct place in the heap. While looking for those timers,</span>
<span class="token comment">// it also moves timers that have been modified to run later,</span>
<span class="token comment">// and removes deleted timers. The caller must have locked the timers for pp.</span>
<span class="token keyword">func</span> <span class="token function">adjusttimers</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// åˆ¤æ–­å½“å‰ p æ˜¯å¦æœ‰ timer</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> verifyTimers <span class="token punctuation">&#123;</span>
			<span class="token function">verifyTimerHeap</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// å­˜æ”¾éœ€è¦ç§»åŠ¨çš„ timer</span>
	<span class="token keyword">var</span> moved <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer
loop<span class="token punctuation">:</span>
	<span class="token comment">// éå†å½“å‰ p çš„ timers</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		t <span class="token operator">:=</span> pp<span class="token punctuation">.</span>timers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span>pp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> pp <span class="token punctuation">&#123;</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"adjusttimers: bad p"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// åˆ¤æ–­å½“å‰ timer çš„çŠ¶æ€</span>
		<span class="token keyword">switch</span> s <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token punctuation">&#123;</span>
		<span class="token comment">// è¡¨ç¤º timer éœ€è¦åˆ é™¤ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰åˆ é™¤å‘¢</span>
		<span class="token keyword">case</span> timerDeleted<span class="token punctuation">:</span>
			<span class="token comment">// ä¿®æ”¹ timer çš„çŠ¶æ€ä¸ºï¼Œæ­£åœ¨åˆ é™¤ä¸­ timerRemoving</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// æ‰§è¡Œåˆ é™¤æ“ä½œ</span>
				<span class="token function">dodeltimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
				<span class="token comment">// ä¿®æ”¹ timer çš„çŠ¶æ€ä¸ºï¼Œå·²åˆ é™¤ timerRemoved</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token comment">// ä¿®æ”¹å¾…åˆ é™¤ timer çš„æ•°é‡ pp.deletedTimers - 1</span>
				atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token comment">// Look at this heap position again.</span>
				<span class="token comment">// æ€è€ƒä¸€ä¸‹å°±å¯ä»¥çŸ¥é“ï¼Œä¸ºä»€ä¹ˆéœ€è¦å†æ¬¡æ£€æŸ¥å½“å‰è¿™ä¸ªä½ç½®çš„ timer</span>
				<span class="token comment">// é€šè¿‡ dodeltimer å°†ç´¢å¼•ä¸º i çš„ timer åˆ é™¤åï¼Œæˆ‘ä»¬çŸ¥é“çš„æ˜¯</span>
				<span class="token comment">// å‡è®¾æ€»æ•°é‡ä¸º n, [0, i) ä¹‹å‰çš„å…ƒç´ ä¸éœ€è¦æ”¹å˜ï¼Œåˆ æ‰ç¬¬ I ä¸ªå</span>
				<span class="token comment">// éœ€è¦åœ¨ [i,n-1) é‡Œè¾¹ä¸­é€‰ä¸€ä¸ªå¡«è¡¥ i çš„ä½ç½®ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æ£€æŸ¥ä¸€æ¬¡</span>
				i<span class="token operator">--</span>
			<span class="token punctuation">&#125;</span>
		<span class="token comment">// è¡¨ç¤º timer çš„ç­‰å¾…æ—¶é—´è¢«è°ƒæ•´äº†</span>
		<span class="token comment">// timerModifiedEarlier å‘å‰è°ƒæ•´</span>
		<span class="token comment">// timerModifiedLater å‘åè°ƒæ•´</span>
		<span class="token keyword">case</span> timerModifiedEarlier<span class="token punctuation">,</span> timerModifiedLater<span class="token punctuation">:</span>
			<span class="token comment">// å› ä¸ºè°ƒæ•´äº† timer çš„æ—¶é—´ç‚¹ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è°ƒæ•´è¯¥ timer åœ¨å †ä¸­çš„ä½ç½®</span>
			<span class="token comment">// ä¿®æ”¹ timer çŠ¶æ€ä¸ºï¼Œç§»åŠ¨ä¸­ timerMoving</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerMoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// Now we can change the when field.</span>
				t<span class="token punctuation">.</span>when <span class="token operator">=</span> t<span class="token punctuation">.</span>nextwhen
				<span class="token comment">// Take t off the heap, and hold onto it.</span>
				<span class="token comment">// We don't add it back yet because the</span>
				<span class="token comment">// heap manipulation could cause our</span>
				<span class="token comment">// loop to skip some other timer.</span>
				<span class="token function">dodeltimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
				<span class="token comment">// å°†è¿™ä¸ª timer åŠ å…¥åˆ°éœ€è¦ç§»åŠ¨çš„ timer å½“ä¸­</span>
				moved <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>moved<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
				<span class="token keyword">if</span> s <span class="token operator">==</span> timerModifiedEarlier <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> n <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">int32</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">break</span> loop
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token comment">// Look at this heap position again.</span>
				i<span class="token operator">--</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> timerNoStatus<span class="token punctuation">,</span> timerRunning<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">,</span> timerMoving<span class="token punctuation">:</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> timerWaiting<span class="token punctuation">:</span>
			<span class="token comment">// OK, nothing to do.</span>
		<span class="token keyword">case</span> timerModifying<span class="token punctuation">:</span>
			<span class="token comment">// Check again after modification is complete.</span>
			<span class="token function">osyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			i<span class="token operator">--</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>moved<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// å°† timer é‡æ–°åŠ å…¥åˆ°å½“å‰ p çš„ timers ä¸­</span>
		<span class="token comment">// å¹¶ä¸”æŒ‰ç…§å°é¡¶å †è¿›è¡Œæ’åº</span>
		<span class="token function">addAdjustedTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> moved<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> verifyTimers <span class="token punctuation">&#123;</span>
		<span class="token function">verifyTimerHeap</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ <code>checkTimers</code> å‡½æ•°æœ«å°¾çš„ä½ç½®ï¼Œå°±æ˜¯è¦çœŸæ­£æ‰§è¡Œ timer çš„æ—¶å€™äº†ï¼Œé€šè¿‡ <code>runtimer</code> æ¥æ‰§è¡Œ p ä¸­çš„ timer</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// runtimer examines the first timer in timers. If it is ready based on now,</span>
<span class="token comment">// it runs the timer and removes or updates it.</span>
<span class="token comment">// Returns 0 if it ran a timer, -1 if there are no more timers, or the time</span>
<span class="token comment">// when the first timer should run.</span>
<span class="token comment">// The caller must have locked the timers for pp.</span>
<span class="token comment">// If a timer is run, this will temporarily unlock the timers.</span>

<span class="token comment">/*
	æ ¹æ®ä¸Šè¿°æ³¨é‡Šå¯ä»¥äº†è§£åˆ°:
	è¿”å›å€¼ = 0;  è¡¨ç¤ºæ‰§è¡Œäº†ä¸€ä¸ª timer
	è¿”å›å€¼ = -1; è¡¨ç¤º p ä¸­æ²¡æœ‰ timer äº†
	è¿”å›å€¼ > 0;  è¡¨ç¤ºç¬¬ä¸€ä¸ª timer è¦æ‰§è¡Œçš„æ—¶é—´ç‚¹
	
	ï¼ˆè¿™é‡Œçš„æºç å°±ä¸åšè¿‡å¤šåˆ†æäº†ï¼Œæ²¡æœ‰ä»€ä¹ˆå¯è¯´çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½è¦†ç›–åˆ°äº†ï¼‰
*/</span>

<span class="token comment">//go:systemstack</span>
<span class="token keyword">func</span> <span class="token function">runtimer</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">,</span> now <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		t <span class="token operator">:=</span> pp<span class="token punctuation">.</span>timers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span>pp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> pp <span class="token punctuation">&#123;</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"runtimer: bad p"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">switch</span> s <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> timerWaiting<span class="token punctuation">:</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span>when <span class="token operator">></span> now <span class="token punctuation">&#123;</span>
				<span class="token comment">// Not ready to run.</span>
				<span class="token keyword">return</span> t<span class="token punctuation">.</span>when
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerRunning<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			<span class="token comment">// Note that runOneTimer may temporarily unlock</span>
			<span class="token comment">// pp.timersLock.</span>
			<span class="token function">runOneTimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> t<span class="token punctuation">,</span> now<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span>

		<span class="token keyword">case</span> timerDeleted<span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			<span class="token function">dodeltimer0</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> timerModifiedEarlier<span class="token punctuation">,</span> timerModifiedLater<span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerMoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			t<span class="token punctuation">.</span>when <span class="token operator">=</span> t<span class="token punctuation">.</span>nextwhen
			<span class="token function">dodeltimer0</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
			<span class="token function">doaddtimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
			<span class="token keyword">if</span> s <span class="token operator">==</span> timerModifiedEarlier <span class="token punctuation">&#123;</span>
				atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> timerMoving<span class="token punctuation">,</span> timerWaiting<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> timerModifying<span class="token punctuation">:</span>
			<span class="token comment">// Wait for modification to complete.</span>
			<span class="token function">osyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> timerNoStatus<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">:</span>
			<span class="token comment">// Should not see a new or inactive timer on the heap.</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> timerRunning<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerMoving<span class="token punctuation">:</span>
			<span class="token comment">// These should only be set when timers are locked,</span>
			<span class="token comment">// and we didn't do it.</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆªæ­¢åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æŠŠ <code>checkTimers</code> ç»™åˆ†æå®Œäº†ã€‚</p>
<h3 id="å·-timer"><a href="#å·-timer" class="headerlink" title="å· timer"></a>å· timer</h3><p>è¿™é‡Œçš„å· timer ä¸æ˜¯è¯´æŠŠ å¦ä¸€ä¸ª p çš„ timer å·åˆ°æˆ‘æœ¬åœ°åå†æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨å½“å‰è¿™ä¸ª p ï¼Œæ‰§è¡Œå…¶ä»– p timerã€‚</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// æˆªå–éƒ¨åˆ† findrunnable ä»£ç </span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> enum <span class="token operator">:=</span> stealOrder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>enum<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> enum<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token function">shouldStealTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				tnow<span class="token punctuation">,</span> w<span class="token punctuation">,</span> ran <span class="token operator">:=</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> now<span class="token punctuation">)</span>
                <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="åè¯­"><a href="#åè¯­" class="headerlink" title="åè¯­"></a>åè¯­</h2><p>ç»™å¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘åœ¨æ•´ç†è¿‡ç¨‹ä¸­çš„å‚è€ƒèµ„æ–™å§ï¼š<br><em>1.luozhiyun Goä¸­å®šæ—¶å™¨å®ç°åŸç†åŠæºç è§£æ</em><br>   <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/14494540.html"><em>https://www.cnblogs.com/luozhiyun/p/14494540.html</em></a><br><em>2.çŒªåƒé±¼ Netpoll è§£æ</em><br>   <a target="_blank" rel="noopener" href="https://www.pefish.club/2020/05/04/Golang/1011Netpoll%E8%A7%A3%E6%9E%90/"><em>https://www.pefish.club/2020/05/04/Golang/1011Netpoll%E8%A7%A3%E6%9E%90/</em></a><br><em>3.issues<br>   <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/6239"><em>https://github.com/golang/go/issues/6239</em></a><br>4.å³°äº‘å°±å¥¹äº†  go1.14åŸºäºnetpollå®šæ—¶å™¨å®ç°åŸç†</em><br>   <a target="_blank" rel="noopener" href="http://xiaorui.cc/archives/6483"><em>http://xiaorui.cc/archives/6483</em></a></p>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=1.0.0"><script type="text/javascript" src="/js/donate.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><a class="pos-f tr3" id="github" href="https://github.com/Kaiyuan/donate-page" target="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="ps">æ²¡æœ‰å¼€å¯ä»»ä½•Donateé€‰é¡¹!</li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>timer ä¼˜åŒ–</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>bqyang</p><p><span>å‘å¸ƒæ—¶é—´ï¼š</span>2021-11-14</p><p><span>æœ€åæ›´æ–°ï¼š</span>2021-12-06</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2021/timer ä¼˜åŒ–/">https://bqyang.top/2021/timer%20%E4%BC%98%E5%8C%96/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://bqyang.top/2021/timer%20%E4%BC%98%E5%8C%96/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2021/%E8%81%8A%E8%81%8A%E5%B7%A5%E4%BD%9C%E4%B8%8A%E7%9A%84%E5%B0%8F%E4%BA%8B/">å·¥ä½œç°çŠ¶</a><a class="next" href="/2021/timer%20%E6%B5%85%E6%9E%90/">timer æºç åˆ†æ</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '4bcae079402e9cc4ce7b',
  clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
  repo: 'blog_comments',
  owner: 'clamyang',
  admin: ['clamyang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://bqyang.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/leetcode/array/easy/">æ•°ç»„-ç®€å•é¢˜</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/recur/">å†å­¦é€’å½’ï¼ˆå‡ ä¸ªæœ‰æ„æ€çš„é€’å½’ç»ƒä¹ ï¼‰</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/print/">æ‰“å°å­—ç¬¦</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/string/">C-String</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/enum/">Rust-Enums</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/structs/">Rust-Structs</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/ownership/">Rust-Ownership</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/deployment/">Deployment æ›´æ–°ç­–ç•¥</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/os-start/">æ“ä½œç³»ç»Ÿå¯åŠ¨</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/concurrency-sema/">åŒæ­¥åŸè¯­-semaphore</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.xargin.com/" title="Xargin" target="_blank">Xargin</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2022 <a href="/." rel="nofollow">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>