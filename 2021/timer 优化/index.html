<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bqyang.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="前言我们已经知道了，老版本 timer 的性能瓶颈主要是在那把全局锁以及频繁的上下文切换上，今天我们看看 go 大佬们通过哪种方式进行优化的。​ 在这里解释一下为什么选择这几个版本，据我所知啊，从 1.10 版本以前都是像上一篇文中所描述的那样，在 1.10 版本开始就做了这个优化，但从 1.14 开始又对 timer 进行了优化，所以我选择了 1.8， 1.13， 1.14 这几个邻近的作为参考">
<meta property="og:type" content="article">
<meta property="og:title" content="timer 优化">
<meta property="og:url" content="https://bqyang.top/2021/timer%20%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="杨宝强的技术笔记">
<meta property="og:description" content="前言我们已经知道了，老版本 timer 的性能瓶颈主要是在那把全局锁以及频繁的上下文切换上，今天我们看看 go 大佬们通过哪种方式进行优化的。​ 在这里解释一下为什么选择这几个版本，据我所知啊，从 1.10 版本以前都是像上一篇文中所描述的那样，在 1.10 版本开始就做了这个优化，但从 1.14 开始又对 timer 进行了优化，所以我选择了 1.8， 1.13， 1.14 这几个邻近的作为参考">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/1636033788855-ece14ebf-e72d-4851-9a75-de7cd60d59ba.png">
<meta property="article:published_time" content="2021-11-14T14:47:26.661Z">
<meta property="article:modified_time" content="2021-11-18T03:32:25.753Z">
<meta property="article:author" content="杨宝强">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/1636033788855-ece14ebf-e72d-4851-9a75-de7cd60d59ba.png">

<link rel="canonical" href="https://bqyang.top/2021/timer%20%E4%BC%98%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>timer 优化 | 杨宝强的技术笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="杨宝强的技术笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <h1 class="site-title" style="font-size:35px">杨宝强的技术笔记</h1>
      <span class="logo-line-before"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">欢迎~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://bqyang.top/2021/timer%20%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="杨宝强">
      <meta itemprop="description" content="记录技术精进之路，记录生活的打情骂俏">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨宝强的技术笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          timer 优化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-14 22:47:26" itemprop="dateCreated datePublished" datetime="2021-11-14T22:47:26+08:00">2021-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-18 11:32:25" itemprop="dateModified" datetime="2021-11-18T11:32:25+08:00">2021-11-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们已经知道了，老版本 timer 的性能瓶颈主要是在那把全局锁以及频繁的上下文切换上，今天我们看看 go 大佬们通过哪种方式进行优化的。<br>​</p>
<p>在这里解释一下为什么选择这几个版本，据我所知啊，从 1.10 版本以前都是像上一篇文中所描述的那样，在 1.10 版本开始就做了这个优化，但从 1.14 开始又对 timer 进行了优化，所以我选择了 1.8， 1.13， 1.14 这几个邻近的作为参考。</p>
<span id="more"></span>

<h2 id="go-1-13-中的优化"><a href="#go-1-13-中的优化" class="headerlink" title="go 1.13 中的优化"></a>go 1.13 中的优化</h2><h3 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h3><ul>
<li>go version: go1.13</li>
<li>compute: linux, centos7</li>
</ul>
<h3 id="timer-结构的变化"><a href="#timer-结构的变化" class="headerlink" title="timer 结构的变化"></a>timer 结构的变化</h3><h5 id="go1-8"><a href="#go1-8" class="headerlink" title="go1.8"></a>go1.8</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> timer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	i <span class="token builtin">int</span> <span class="token comment">// heap index</span>
	when   <span class="token builtin">int64</span>
	period <span class="token builtin">int64</span>
	f      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
	arg    <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	seq    <span class="token builtin">uintptr</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="go1-13"><a href="#go1-13" class="headerlink" title="go1.13"></a>go1.13</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> timer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	tb <span class="token operator">*</span>timersBucket <span class="token comment">// the bucket the timer lives in</span>
	i  <span class="token builtin">int</span>           <span class="token comment">// heap index</span>
	when   <span class="token builtin">int64</span>
	period <span class="token builtin">int64</span>
	f      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
	arg    <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	seq    <span class="token builtin">uintptr</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在go1.13版本中添加了一个 tb 字段，表示当前这个 timer 是在哪个 bucket 中的，其余字段含义还是和老版本中的一致。<br>​</p>
<p>还记得老版本把新建的 <code>timer</code> 对象都放在哪里了吗？<code>一个全局的 timers 中</code> go1.13版本中将的 timers 拆分成了 64 个大小的 timers 数组，每一个里边包含了一个 bucket ，bucket 中再存放 timer 对象，至于为什么是 64 官方的解释如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// timersLen is the length of timers array.</span>
<span class="token comment">//</span>
<span class="token comment">// Ideally, this would be set to GOMAXPROCS, but that would require</span>
<span class="token comment">// dynamic reallocation</span>
<span class="token comment">//</span>
<span class="token comment">// The current value is a compromise between memory usage and performance</span>
<span class="token comment">// that should cover the majority of GOMAXPROCS values used in the wild.</span>
<span class="token keyword">const</span> timersLen <span class="token operator">=</span> <span class="token number">64</span>

<span class="token comment">// timersLen is the length of timers array.</span>
<span class="token comment">//</span>
<span class="token comment">// Ideally, this would be set to GOMAXPROCS, but that would require</span>
<span class="token comment">// dynamic reallocation</span>
<span class="token comment">//</span>
<span class="token comment">// The current value is a compromise between memory usage and performance</span>
<span class="token comment">// that should cover the majority of GOMAXPROCS values used in the wild.</span>
<span class="token keyword">var</span> timers <span class="token punctuation">[</span>timersLen<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	timersBucket

	<span class="token comment">// The padding should eliminate false sharing</span>
	<span class="token comment">// between timersBucket values.</span>
	pad <span class="token punctuation">[</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>timersBucket<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//go:notinheap</span>
<span class="token keyword">type</span> timersBucket <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	lock         mutex
	gp           <span class="token operator">*</span>g
	created      <span class="token builtin">bool</span>
	sleeping     <span class="token builtin">bool</span>
	rescheduling <span class="token builtin">bool</span>
	sleepUntil   <span class="token builtin">int64</span>
	waitnote     note
	t            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在添加 timer 对象时逻辑变成了，根据当前 p 的 id 对 timersLen 取模，得到了 p 对应的 timersBucket <code>id := uint8(getg().m.p.ptr().id) % _timersLen_</code><br>从这个优化的方法来看，以前是每个p去抢同一把锁，现在变成，每个p只会操作对应的 timersBucket（大多数情况下）。</p>
<ul>
<li><input disabled="" type="checkbox"> <strong>在超过 64 个 p 的时候，就会出现取模到同一个 bucket 中，这种情况在多核 cpu &gt; 64 上是没办法避免的</strong></li>
<li><input disabled="" type="checkbox"> <strong>可能还有p从别的p上偷timer的情况</strong></li>
</ul>
<p>接下里我们看下执行 timer 的 <code>timerproc</code><br>1.8 版本中，全局只有一个执行 timer 的 timerproc，可以理解为只有一个消费者。1.13 中修改为每个不同的 bucket 都会有一个对应的 bucket。举个例子，比如我们有 4 个 P，就说明我们会有 4 个 bucket 和 4 个 timerproc，每当通过 addtimer 添加时，都会往 p 对应的 bucket 中添加任务，timerproc 作为消费者从中找可执行的timer，如下图：<br><img src="https://gitee.com/yangbaoqiang/images/raw/master/blogpics/1636033788855-ece14ebf-e72d-4851-9a75-de7cd60d59ba.png" alt="image.png"></p>
<h3 id="timer-的“生产者”"><a href="#timer-的“生产者”" class="headerlink" title="timer 的“生产者”"></a>timer 的“生产者”</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 如前所述，每个p对应不同的 timersBucket，那么在创建之前我们是不是应该先找到在哪个 p 上执行</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token function">assignBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>timersBucket <span class="token punctuation">&#123;</span>
	id <span class="token operator">:=</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">%</span> timersLen
	t<span class="token punctuation">.</span>tb <span class="token operator">=</span> <span class="token operator">&amp;</span>timers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>timersBucket
	<span class="token keyword">return</span> t<span class="token punctuation">.</span>tb
<span class="token punctuation">&#125;</span>

<span class="token comment">// 将 timer 添加到对应的 timersBucket 中</span>
<span class="token keyword">func</span> <span class="token function">addtimer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tb <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">assignBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	ok <span class="token operator">:=</span> tb<span class="token punctuation">.</span><span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 咱们只把重点放在与以前不同的地方上</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>tb <span class="token operator">*</span>timersBucket<span class="token punctuation">)</span> <span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>when <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span>when <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">63</span> <span class="token operator">-</span> <span class="token number">1</span>
	<span class="token punctuation">&#125;</span>
	t<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">)</span>
	tb<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> t<span class="token punctuation">)</span> 		<span class="token comment">// 添加到p对应的timersBucket中，而不是全局的 timers 中了</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">siftupTimer</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> t<span class="token punctuation">.</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// siftup moved to top: new earliest deadline.</span>
		<span class="token keyword">if</span> tb<span class="token punctuation">.</span>sleeping <span class="token operator">&amp;&amp;</span> tb<span class="token punctuation">.</span>sleepUntil <span class="token operator">></span> t<span class="token punctuation">.</span>when <span class="token punctuation">&#123;</span>
			tb<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token function">notewakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>waitnote<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> tb<span class="token punctuation">.</span>rescheduling <span class="token punctuation">&#123;</span>
			tb<span class="token punctuation">.</span>rescheduling <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token function">goready</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>tb<span class="token punctuation">.</span>created <span class="token punctuation">&#123;</span>
			<span class="token comment">// 判断属于这个 tb 的 timerproc 是否启动了，</span>
			<span class="token comment">// 区别于1.8版本是一个全局变量控制的，只有一个消费者，这里是每一个 tb 都有一个消费者</span>
			tb<span class="token punctuation">.</span>created <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">go</span> <span class="token function">timerproc</span><span class="token punctuation">(</span>tb<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="timer-的“消费者”"><a href="#timer-的“消费者”" class="headerlink" title="timer 的“消费者”"></a>timer 的“消费者”</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 主要的逻辑还是同 1.8 版本中一致的，不同的地方就是针对每个tb进行的操作，不是全局的 timers</span>
<span class="token keyword">func</span> <span class="token function">timerproc</span><span class="token punctuation">(</span>tb <span class="token operator">*</span>timersBucket<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tb<span class="token punctuation">.</span>gp <span class="token operator">=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		tb<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">false</span>
		now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		delta <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				delta <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			t <span class="token operator">:=</span> tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			delta <span class="token operator">=</span> t<span class="token punctuation">.</span>when <span class="token operator">-</span> now
			<span class="token keyword">if</span> delta <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			ok <span class="token operator">:=</span> <span class="token boolean">true</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span>period <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// leave in heap but adjust next time to fire</span>
				t<span class="token punctuation">.</span>when <span class="token operator">+=</span> t<span class="token punctuation">.</span>period <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token operator">-</span>delta<span class="token operator">/</span>t<span class="token punctuation">.</span>period<span class="token punctuation">)</span>
				<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">siftdownTimer</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					ok <span class="token operator">=</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// remove from heap</span>
				last <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
				<span class="token keyword">if</span> last <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span>last<span class="token punctuation">]</span>
					tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">0</span>
				<span class="token punctuation">&#125;</span>
				tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span>last<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
				tb<span class="token punctuation">.</span>t <span class="token operator">=</span> tb<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token punctuation">:</span>last<span class="token punctuation">]</span>
				<span class="token keyword">if</span> last <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">siftdownTimer</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						ok <span class="token operator">=</span> <span class="token boolean">false</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				t<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// mark as removed</span>
			<span class="token punctuation">&#125;</span>
			f <span class="token operator">:=</span> t<span class="token punctuation">.</span>f
			arg <span class="token operator">:=</span> t<span class="token punctuation">.</span>arg
			seq <span class="token operator">:=</span> t<span class="token punctuation">.</span>seq
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
				<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> raceenabled <span class="token punctuation">&#123;</span>
				<span class="token function">raceacquire</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token function">f</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> seq<span class="token punctuation">)</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> faketime <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// No timers left - put goroutine to sleep.</span>
			tb<span class="token punctuation">.</span>rescheduling <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token function">goparkunlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> waitReasonTimerGoroutineIdle<span class="token punctuation">,</span> traceEvGoBlock<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// At least one timer pending. Sleep until then.</span>
		tb<span class="token punctuation">.</span>sleeping <span class="token operator">=</span> <span class="token boolean">true</span>
		tb<span class="token punctuation">.</span>sleepUntil <span class="token operator">=</span> now <span class="token operator">+</span> delta
		<span class="token function">noteclear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>waitnote<span class="token punctuation">)</span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token function">notetsleepg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>waitnote<span class="token punctuation">,</span> delta<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>相比于 1.8，1.13版本中还添加了一个 <code>modtimer(t *timer, when, period int64, f func(interface&#123;&#125;, uintptr), arg interface&#123;&#125;, seq uintptr)</code><br>modtimer 函数主要做了，将 t 从 tb 中删除，然后有 重新给它 加入进去</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">modtimer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">,</span> when<span class="token punctuation">,</span> period <span class="token builtin">int64</span><span class="token punctuation">,</span> f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> seq <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tb <span class="token operator">:=</span> t<span class="token punctuation">.</span>tb

	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> tb<span class="token punctuation">.</span><span class="token function">deltimerLocked</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span>when <span class="token operator">=</span> when
		t<span class="token punctuation">.</span>period <span class="token operator">=</span> period
		t<span class="token punctuation">.</span>f <span class="token operator">=</span> f
		t<span class="token punctuation">.</span>arg <span class="token operator">=</span> arg
		t<span class="token punctuation">.</span>seq <span class="token operator">=</span> seq
		ok <span class="token operator">=</span> tb<span class="token punctuation">.</span><span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 netpoll 中，有两处地方调用了这个函数，主要就是给 fd 调整超时处理使用的。</p>
<p>总的来说这个版本中的优化只是做了全局锁粒度的拆分，上下文切换带来额外的性能开销仍然没有得到优化，不过不要着急，1.14 版本中针对这个问题已经做了妥善的处理，我们马上就来看一下。<br>​</p>
<h2 id="go-1-14-中的优化"><a href="#go-1-14-中的优化" class="headerlink" title="go 1.14 中的优化"></a>go 1.14 中的优化</h2><h3 id="环境信息-1"><a href="#环境信息-1" class="headerlink" title="环境信息"></a>环境信息</h3><p>go version: go1.14.1<br>compute: linux, centos7</p>
<h3 id="timer-结构的变化-1"><a href="#timer-结构的变化-1" class="headerlink" title="timer 结构的变化"></a>timer 结构的变化</h3><p>以前的结构体都是全局变量，在 1.14 版本开始，timer 结构体就内嵌到了 P 中。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Package time knows the layout of this structure.</span>
<span class="token comment">// If this struct changes, adjust ../time/sleep.go:/runtimeTimer.</span>
<span class="token keyword">type</span> timer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// If this timer is on a heap, which P's heap it is on.</span>
	<span class="token comment">// puintptr rather than *p to match uintptr in the versions</span>
	<span class="token comment">// of this struct defined in other packages.</span>
	pp puintptr

	<span class="token comment">// Timer wakes up at when, and then at when+period, ... (period > 0 only)</span>
	<span class="token comment">// each time calling f(arg, now) in the timer goroutine, so f must be</span>
	<span class="token comment">// a well-behaved function and not block.</span>
	when   <span class="token builtin">int64</span>
	period <span class="token builtin">int64</span>
	f      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token builtin">uintptr</span><span class="token punctuation">)</span>
	arg    <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	seq    <span class="token builtin">uintptr</span>

	<span class="token comment">// What to set the when field to in timerModifiedXX status.</span>
	nextwhen <span class="token builtin">int64</span>

	<span class="token comment">// The status field holds one of the values below.</span>
	status <span class="token builtin">uint32</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	id          <span class="token builtin">int32</span>
    
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    
	<span class="token comment">// Lock for timers. We normally access the timers while running</span>
	<span class="token comment">// on this P, but the scheduler can also do it from a different P.</span>
	<span class="token comment">// 讲道理，你p处理本地的 timer 用锁干什么？</span>
	<span class="token comment">// 1.14 是可以偷 timer 的，这时候就变成了共享资源，访问的时候是一定要加锁的。</span>
	<span class="token comment">// 上边注释（英文）说的也很清楚，这个是官方的解释</span>
	timersLock mutex

	<span class="token comment">// Actions to take at some time. This is used to implement the</span>
	<span class="token comment">// standard library's time package.</span>
	<span class="token comment">// Must hold timersLock to access.</span>
	timers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer

	<span class="token comment">// Number of timers in P's heap.</span>
	<span class="token comment">// Modified using atomic instructions.</span>
	<span class="token comment">// 记录当前 p 中 timer的总数量</span>
	numTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Number of timerModifiedEarlier timers on P's heap.</span>
	<span class="token comment">// This should only be modified while holding timersLock,</span>
	<span class="token comment">// or while the timer status is in a transient state</span>
	<span class="token comment">// such as timerModifying.</span>
	<span class="token comment">// P 中 调整 when 的时间提前了的 timer 数量</span>
	adjustTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Number of timerDeleted timers in P's heap.</span>
	<span class="token comment">// Modified using atomic instructions.</span>
	<span class="token comment">// 记录 p 中被删除的 timer 数量</span>
	deletedTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Race context used while executing timer functions.</span>
	timerRaceCtx <span class="token builtin">uintptr</span>
    
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="timer-的“生产者”-1"><a href="#timer-的“生产者”-1" class="headerlink" title="timer 的“生产者”"></a>timer 的“生产者”</h3><p><code>... 基本上大同小异，只不过是加了一些状态</code><br>不过需要注意的一点是，1.14 中有了 timer 和 netpoll 的结合。我的理解是：<br>findrunnable 最后没有找到可执行的 g 的时候会再检查 netpoll。这个调用过程是阻塞的，阻塞 delta 这段时间，然后这时候比如说我通过 addtimer 加入新timer，就是假设哈，1s 后要执行，然后你那个阻塞过程要阻塞 3s，但这是在阻塞没有办法执行我们的 timer，然后这时候 addtimer 中的 wakenetpoller 就派上用场，通过 <code>netpollbreak</code> 中断那个阻塞调用，然后就回到 <code>findrunnable</code> 继续执行，及时响应那个近期的 timer 对象。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// addtimer:</span>
<span class="token comment">//   timerNoStatus   -> timerWaiting</span>
<span class="token comment">//   anything else   -> panic: invalid value</span>
<span class="token comment">// deltimer:</span>
<span class="token comment">//   timerWaiting         -> timerModifying -> timerDeleted</span>
<span class="token comment">//   timerModifiedEarlier -> timerModifying -> timerDeleted</span>
<span class="token comment">//   timerModifiedLater   -> timerModifying -> timerDeleted</span>
<span class="token comment">//   timerNoStatus        -> do nothing</span>
<span class="token comment">//   timerDeleted         -> do nothing</span>
<span class="token comment">//   timerRemoving        -> do nothing</span>
<span class="token comment">//   timerRemoved         -> do nothing</span>
<span class="token comment">//   timerRunning         -> wait until status changes</span>
<span class="token comment">//   timerMoving          -> wait until status changes</span>
<span class="token comment">//   timerModifying       -> wait until status changes</span>
<span class="token comment">// modtimer:</span>
<span class="token comment">//   timerWaiting    -> timerModifying -> timerModifiedXX</span>
<span class="token comment">//   timerModifiedXX -> timerModifying -> timerModifiedYY</span>
<span class="token comment">//   timerNoStatus   -> timerModifying -> timerWaiting</span>
<span class="token comment">//   timerRemoved    -> timerModifying -> timerWaiting</span>
<span class="token comment">//   timerDeleted    -> timerModifying -> timerModifiedXX</span>
<span class="token comment">//   timerRunning    -> wait until status changes</span>
<span class="token comment">//   timerMoving     -> wait until status changes</span>
<span class="token comment">//   timerRemoving   -> wait until status changes</span>
<span class="token comment">//   timerModifying  -> wait until status changes</span>
<span class="token comment">// cleantimers (looks in P's timer heap):</span>
<span class="token comment">//   timerDeleted    -> timerRemoving -> timerRemoved</span>
<span class="token comment">//   timerModifiedXX -> timerMoving -> timerWaiting</span>
<span class="token comment">// adjusttimers (looks in P's timer heap):</span>
<span class="token comment">//   timerDeleted    -> timerRemoving -> timerRemoved</span>
<span class="token comment">//   timerModifiedXX -> timerMoving -> timerWaiting</span>
<span class="token comment">// runtimer (looks in P's timer heap):</span>
<span class="token comment">//   timerNoStatus   -> panic: uninitialized timer</span>
<span class="token comment">//   timerWaiting    -> timerWaiting or</span>
<span class="token comment">//   timerWaiting    -> timerRunning -> timerNoStatus or</span>
<span class="token comment">//   timerWaiting    -> timerRunning -> timerWaiting</span>
<span class="token comment">//   timerModifying  -> wait until status changes</span>
<span class="token comment">//   timerModifiedXX -> timerMoving -> timerWaiting</span>
<span class="token comment">//   timerDeleted    -> timerRemoving -> timerRemoved</span>
<span class="token comment">//   timerRunning    -> panic: concurrent runtimer calls</span>
<span class="token comment">//   timerRemoved    -> panic: inconsistent timer heap</span>
<span class="token comment">//   timerRemoving   -> panic: inconsistent timer heap</span>
<span class="token comment">//   timerMoving     -> panic: inconsistent timer heap</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="timer-的“消费者”-1"><a href="#timer-的“消费者”-1" class="headerlink" title="timer 的“消费者”"></a>timer 的“消费者”</h3><p>新版本中的“消费者”有着非常重要的改变，<code>timerproc</code> 没了，首先我们要明确：<br>timerproc 不仅仅是一个函数，它是 runtime 创建的一个 goroutine，因此可知，以前的“消费者”就是一个 goroutine， 它并没有什么不同，同样被 <code>scheduler</code>调度。</p>
<p>1.14 中，直接给“消费者”升到“头等舱”，看你小子干活勤勤恳恳，scheduler说，你来我这上班吧，结果人家就去了。</p>
<p>1.14 中，timer 的消费者就是在调度循环的 <code>schedule</code> 中，其次就是 <code>sysmon</code> （sysmon作为兜底），我们看下源码，看看新版本的消费者是怎么“晋升”的。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// 省略安全检查</span>
    
	<span class="token comment">// 看看人家 timer 直接被安排到顶级位置</span>
	<span class="token comment">// 调度循环上来就是先检查 timer</span>
	<span class="token function">checkTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>
	<span class="token punctuation">&#125;</span>

    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以得出结论，新版本的“消费者” 从 goroutine 级别 转变到 函数级别。</p>
<h4 id="checkTimers"><a href="#checkTimers" class="headerlink" title="checkTimers()"></a>checkTimers()</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// checkTimers runs any timers for the P that are ready.</span>
<span class="token comment">// If now is not 0 it is the current time.</span>
<span class="token comment">// It returns the current time or 0 if it is not known,</span>
<span class="token comment">// and the time when the next timer should run or 0 if there is no next timer,</span>
<span class="token comment">// and reports whether it ran any timers.</span>
<span class="token comment">// If the time when the next timer should run is not 0,</span>
<span class="token comment">// it is always larger than the returned time.</span>
<span class="token comment">// We pass now in and out to avoid extra calls of nanotime.</span>
<span class="token comment">//go:yeswritebarrierrec</span>
<span class="token comment">// rnow			</span>
<span class="token comment">// pollUntil	0 表示没有下一个 timer，非 0 表示下一个timer的等待时间</span>
<span class="token comment">// ran			表示是否执行了 timer</span>
<span class="token keyword">func</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">,</span> now <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>rnow<span class="token punctuation">,</span> pollUntil <span class="token builtin">int64</span><span class="token punctuation">,</span> ran <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// If there are no timers to adjust, and the first timer on</span>
	<span class="token comment">// the heap is not yet ready to run, then there is nothing to do.</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		next <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>timer0When<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> next <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> now<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> now <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			now <span class="token operator">=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> now <span class="token operator">&lt;</span> next <span class="token punctuation">&#123;</span>
			<span class="token comment">// Next timer is not ready to run.</span>
			<span class="token comment">// But keep going if we would clear deleted timers.</span>
			<span class="token comment">// This corresponds to the condition below where</span>
			<span class="token comment">// we decide whether to call clearDeletedTimers.</span>
			<span class="token comment">// 尽可能找机会清理 timer</span>
			<span class="token keyword">if</span> pp <span class="token operator">!=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">int</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">int</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>numTimers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> now<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>timersLock<span class="token punctuation">)</span>

	<span class="token function">adjusttimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>

	rnow <span class="token operator">=</span> now
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> rnow <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			rnow <span class="token operator">=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Note that runtimer may temporarily unlock</span>
			<span class="token comment">// pp.timersLock.</span>
			<span class="token keyword">if</span> tw <span class="token operator">:=</span> <span class="token function">runtimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> rnow<span class="token punctuation">)</span><span class="token punctuation">;</span> tw <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> tw <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					pollUntil <span class="token operator">=</span> tw
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			ran <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// If this is the local P, and there are a lot of deleted timers,</span>
	<span class="token comment">// clear them out. We only do this for the local P to reduce</span>
	<span class="token comment">// lock contention on timersLock.</span>
	<span class="token keyword">if</span> pp <span class="token operator">==</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">int</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span> <span class="token punctuation">&#123;</span>
		<span class="token function">clearDeletedTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>timersLock<span class="token punctuation">)</span>

	<span class="token keyword">return</span> rnow<span class="token punctuation">,</span> pollUntil<span class="token punctuation">,</span> ran
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上述 <code>checkTimers</code> 中，通过 <code>adjusttimers</code> 调整当前 p 的 timers 数组，我们看一下它的实现</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// adjusttimers looks through the timers in the current P's heap for</span>
<span class="token comment">// any timers that have been modified to run earlier, and puts them in</span>
<span class="token comment">// the correct place in the heap. While looking for those timers,</span>
<span class="token comment">// it also moves timers that have been modified to run later,</span>
<span class="token comment">// and removes deleted timers. The caller must have locked the timers for pp.</span>
<span class="token keyword">func</span> <span class="token function">adjusttimers</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 判断当前 p 是否有 timer</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> verifyTimers <span class="token punctuation">&#123;</span>
			<span class="token function">verifyTimerHeap</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 存放需要移动的 timer</span>
	<span class="token keyword">var</span> moved <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer
loop<span class="token punctuation">:</span>
	<span class="token comment">// 遍历当前 p 的 timers</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		t <span class="token operator">:=</span> pp<span class="token punctuation">.</span>timers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span>pp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> pp <span class="token punctuation">&#123;</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"adjusttimers: bad p"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// 判断当前 timer 的状态</span>
		<span class="token keyword">switch</span> s <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token punctuation">&#123;</span>
		<span class="token comment">// 表示 timer 需要删除，但是还没有删除呢</span>
		<span class="token keyword">case</span> timerDeleted<span class="token punctuation">:</span>
			<span class="token comment">// 修改 timer 的状态为，正在删除中 timerRemoving</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// 执行删除操作</span>
				<span class="token function">dodeltimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
				<span class="token comment">// 修改 timer 的状态为，已删除 timerRemoved</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token comment">// 修改待删除 timer 的数量 pp.deletedTimers - 1</span>
				atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token comment">// Look at this heap position again.</span>
				<span class="token comment">// 思考一下就可以知道，为什么需要再次检查当前这个位置的 timer</span>
				<span class="token comment">// 通过 dodeltimer 将索引为 i 的 timer 删除后，我们知道的是</span>
				<span class="token comment">// 假设总数量为 n, [0, i) 之前的元素不需要改变，删掉第 I 个后</span>
				<span class="token comment">// 需要在 [i,n-1) 里边中选一个填补 i 的位置，所以需要重新检查一次</span>
				i<span class="token operator">--</span>
			<span class="token punctuation">&#125;</span>
		<span class="token comment">// 表示 timer 的等待时间被调整了</span>
		<span class="token comment">// timerModifiedEarlier 向前调整</span>
		<span class="token comment">// timerModifiedLater 向后调整</span>
		<span class="token keyword">case</span> timerModifiedEarlier<span class="token punctuation">,</span> timerModifiedLater<span class="token punctuation">:</span>
			<span class="token comment">// 因为调整了 timer 的时间点，所以需要重新调整该 timer 在堆中的位置</span>
			<span class="token comment">// 修改 timer 状态为，移动中 timerMoving</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerMoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// Now we can change the when field.</span>
				t<span class="token punctuation">.</span>when <span class="token operator">=</span> t<span class="token punctuation">.</span>nextwhen
				<span class="token comment">// Take t off the heap, and hold onto it.</span>
				<span class="token comment">// We don't add it back yet because the</span>
				<span class="token comment">// heap manipulation could cause our</span>
				<span class="token comment">// loop to skip some other timer.</span>
				<span class="token function">dodeltimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
				<span class="token comment">// 将这个 timer 加入到需要移动的 timer 当中</span>
				moved <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>moved<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
				<span class="token keyword">if</span> s <span class="token operator">==</span> timerModifiedEarlier <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> n <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">int32</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">break</span> loop
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token comment">// Look at this heap position again.</span>
				i<span class="token operator">--</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> timerNoStatus<span class="token punctuation">,</span> timerRunning<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">,</span> timerMoving<span class="token punctuation">:</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> timerWaiting<span class="token punctuation">:</span>
			<span class="token comment">// OK, nothing to do.</span>
		<span class="token keyword">case</span> timerModifying<span class="token punctuation">:</span>
			<span class="token comment">// Check again after modification is complete.</span>
			<span class="token function">osyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			i<span class="token operator">--</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>moved<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 将 timer 重新加入到当前 p 的 timers 中</span>
		<span class="token comment">// 并且按照小顶堆进行排序</span>
		<span class="token function">addAdjustedTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> moved<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> verifyTimers <span class="token punctuation">&#123;</span>
		<span class="token function">verifyTimerHeap</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后我们再看一下 <code>checkTimers</code> 函数末尾的位置，就是要真正执行 timer 的时候了，通过 <code>runtimer</code> 来执行 p 中的 timer</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// runtimer examines the first timer in timers. If it is ready based on now,</span>
<span class="token comment">// it runs the timer and removes or updates it.</span>
<span class="token comment">// Returns 0 if it ran a timer, -1 if there are no more timers, or the time</span>
<span class="token comment">// when the first timer should run.</span>
<span class="token comment">// The caller must have locked the timers for pp.</span>
<span class="token comment">// If a timer is run, this will temporarily unlock the timers.</span>

<span class="token comment">/*
	根据上述注释可以了解到:
	返回值 = 0;  表示执行了一个 timer
	返回值 = -1; 表示 p 中没有 timer 了
	返回值 > 0;  表示第一个 timer 要执行的时间点
	
	（这里的源码就不做过多分析了，没有什么可说的，基本上都覆盖到了）
*/</span>

<span class="token comment">//go:systemstack</span>
<span class="token keyword">func</span> <span class="token function">runtimer</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">,</span> now <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		t <span class="token operator">:=</span> pp<span class="token punctuation">.</span>timers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span>pp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> pp <span class="token punctuation">&#123;</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"runtimer: bad p"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">switch</span> s <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> timerWaiting<span class="token punctuation">:</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span>when <span class="token operator">></span> now <span class="token punctuation">&#123;</span>
				<span class="token comment">// Not ready to run.</span>
				<span class="token keyword">return</span> t<span class="token punctuation">.</span>when
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerRunning<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			<span class="token comment">// Note that runOneTimer may temporarily unlock</span>
			<span class="token comment">// pp.timersLock.</span>
			<span class="token function">runOneTimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> t<span class="token punctuation">,</span> now<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span>

		<span class="token keyword">case</span> timerDeleted<span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			<span class="token function">dodeltimer0</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>deletedTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>timers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> timerModifiedEarlier<span class="token punctuation">,</span> timerModifiedLater<span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> s<span class="token punctuation">,</span> timerMoving<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			t<span class="token punctuation">.</span>when <span class="token operator">=</span> t<span class="token punctuation">.</span>nextwhen
			<span class="token function">dodeltimer0</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
			<span class="token function">doaddtimer</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
			<span class="token keyword">if</span> s <span class="token operator">==</span> timerModifiedEarlier <span class="token punctuation">&#123;</span>
				atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>adjustTimers<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>status<span class="token punctuation">,</span> timerMoving<span class="token punctuation">,</span> timerWaiting<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> timerModifying<span class="token punctuation">:</span>
			<span class="token comment">// Wait for modification to complete.</span>
			<span class="token function">osyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> timerNoStatus<span class="token punctuation">,</span> timerRemoved<span class="token punctuation">:</span>
			<span class="token comment">// Should not see a new or inactive timer on the heap.</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> timerRunning<span class="token punctuation">,</span> timerRemoving<span class="token punctuation">,</span> timerMoving<span class="token punctuation">:</span>
			<span class="token comment">// These should only be set when timers are locked,</span>
			<span class="token comment">// and we didn't do it.</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token function">badTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>截止到目前为止，我们已经把 <code>checkTimers</code> 给分析完了。</p>
<h3 id="偷-timer"><a href="#偷-timer" class="headerlink" title="偷 timer"></a>偷 timer</h3><p>这里的偷 timer 不是说把 另一个 p 的 timer 偷到我本地后再执行，而是在当前这个 p ，执行其他 p timer。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 截取部分 findrunnable 代码</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> enum <span class="token operator">:=</span> stealOrder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>enum<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> enum<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token function">shouldStealTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				tnow<span class="token punctuation">,</span> w<span class="token punctuation">,</span> ran <span class="token operator">:=</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> now<span class="token punctuation">)</span>
                <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="后语"><a href="#后语" class="headerlink" title="后语"></a>后语</h2><p>给大家分享一下我在整理过程中的参考资料吧：<br><em>1.luozhiyun Go中定时器实现原理及源码解析</em><br>   <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/14494540.html"><em>https://www.cnblogs.com/luozhiyun/p/14494540.html</em></a><br><em>2.猪吃鱼 Netpoll 解析</em><br>   <a target="_blank" rel="noopener" href="https://www.pefish.club/2020/05/04/Golang/1011Netpoll%E8%A7%A3%E6%9E%90/"><em>https://www.pefish.club/2020/05/04/Golang/1011Netpoll%E8%A7%A3%E6%9E%90/</em></a><br><em>3.issues<br>   <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/6239"><em>https://github.com/golang/go/issues/6239</em></a><br>4.峰云就她了  go1.14基于netpoll定时器实现原理</em><br>   <a target="_blank" rel="noopener" href="http://xiaorui.cc/archives/6483"><em>http://xiaorui.cc/archives/6483</em></a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="杨宝强 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="杨宝强 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>杨宝强
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://bqyang.top/2021/timer%20%E4%BC%98%E5%8C%96/" title="timer 优化">https://bqyang.top/2021/timer 优化/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/timer%20%E6%B5%85%E6%9E%90/" rel="prev" title="timer 源码分析">
      <i class="fa fa-chevron-left"></i> timer 源码分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/%E8%81%8A%E8%81%8A%E5%B7%A5%E4%BD%9C%E4%B8%8A%E7%9A%84%E5%B0%8F%E4%BA%8B/" rel="next" title="工作现状">
      工作现状 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-1-13-%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">go 1.13 中的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-number">2.1.</span> <span class="nav-text">环境信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timer-%E7%BB%93%E6%9E%84%E7%9A%84%E5%8F%98%E5%8C%96"><span class="nav-number">2.2.</span> <span class="nav-text">timer 结构的变化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#go1-8"><span class="nav-number">2.2.0.1.</span> <span class="nav-text">go1.8</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#go1-13"><span class="nav-number">2.2.0.2.</span> <span class="nav-text">go1.13</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timer-%E7%9A%84%E2%80%9C%E7%94%9F%E4%BA%A7%E8%80%85%E2%80%9D"><span class="nav-number">2.3.</span> <span class="nav-text">timer 的“生产者”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timer-%E7%9A%84%E2%80%9C%E6%B6%88%E8%B4%B9%E8%80%85%E2%80%9D"><span class="nav-number">2.4.</span> <span class="nav-text">timer 的“消费者”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-1-14-%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">go 1.14 中的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF-1"><span class="nav-number">3.1.</span> <span class="nav-text">环境信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timer-%E7%BB%93%E6%9E%84%E7%9A%84%E5%8F%98%E5%8C%96-1"><span class="nav-number">3.2.</span> <span class="nav-text">timer 结构的变化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timer-%E7%9A%84%E2%80%9C%E7%94%9F%E4%BA%A7%E8%80%85%E2%80%9D-1"><span class="nav-number">3.3.</span> <span class="nav-text">timer 的“生产者”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timer-%E7%9A%84%E2%80%9C%E6%B6%88%E8%B4%B9%E8%80%85%E2%80%9D-1"><span class="nav-number">3.4.</span> <span class="nav-text">timer 的“消费者”</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#checkTimers"><span class="nav-number">3.4.1.</span> <span class="nav-text">checkTimers()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%B7-timer"><span class="nav-number">3.5.</span> <span class="nav-text">偷 timer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E8%AF%AD"><span class="nav-number">4.</span> <span class="nav-text">后语</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">杨宝强</p>
  <div class="site-description" itemprop="description">记录技术精进之路，记录生活的打情骂俏</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/clamyang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;clamyang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://xargin.com/" title="https:&#x2F;&#x2F;xargin.com" rel="noopener" target="_blank">Xargin</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://mytechshares.com/" title="https:&#x2F;&#x2F;mytechshares.com&#x2F;" rel="noopener" target="_blank">董泽润</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-car"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨宝强</span>
</div>
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2021035561号-1 </a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '4bcae079402e9cc4ce7b',
      clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
      repo        : 'blog_comments',
      owner       : 'clamyang',
      admin       : ['clamyang'],
      id          : '82d15d6c92fc1bd6a6c863e3934ecb06',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
