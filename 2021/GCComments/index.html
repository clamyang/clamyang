<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bqyang.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="来自 Go 官方对 GC 的解释。">
<meta property="og:type" content="article">
<meta property="og:title" content="GC from go comments">
<meta property="og:url" content="https://bqyang.top/2021/GCComments/index.html">
<meta property="og:site_name" content="杨宝强的技术笔记">
<meta property="og:description" content="来自 Go 官方对 GC 的解释。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-11-25T11:02:41.887Z">
<meta property="article:modified_time" content="2021-11-25T11:08:45.547Z">
<meta property="article:author" content="杨宝强">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bqyang.top/2021/GCComments/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>GC from go comments | 杨宝强的技术笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="杨宝强的技术笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <h1 class="site-title" style="font-size:27px">杨宝强的技术笔记</h1>
      <span class="logo-line-before"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">欢迎~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://bqyang.top/2021/GCComments/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="杨宝强">
      <meta itemprop="description" content="记录技术精进之路，记录生活的打情骂俏">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨宝强的技术笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GC from go comments
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-11-25 19:02:41 / 修改时间：19:08:45" itemprop="dateCreated datePublished" datetime="2021-11-25T19:02:41+08:00">2021-11-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>来自 Go 官方对 GC 的解释。</p>
<span id="more"></span>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">Garbage collector <span class="token punctuation">(</span>GC<span class="token punctuation">)</span><span class="token punctuation">.</span>

The GC runs concurrently with mutator threads<span class="token punctuation">,</span> is <span class="token keyword">type</span> accurate <span class="token punctuation">(</span>aka precise<span class="token punctuation">)</span><span class="token punctuation">,</span> allows multiple
GC thread to run in parallel<span class="token punctuation">.</span> It is a concurrent mark and sweep that uses a write barrier<span class="token punctuation">.</span> It is
non<span class="token operator">-</span>generational and non<span class="token operator">-</span>compacting<span class="token punctuation">.</span> Allocation is done using size segregated per P allocation
areas to minimize fragmentation while eliminating locks in the common <span class="token keyword">case</span><span class="token punctuation">.</span>

The algorithm decomposes into several steps<span class="token punctuation">.</span>
This is a high level description of the algorithm being used<span class="token punctuation">.</span> For an overview of GC a good
place to start is Richard Jones<span class="token string">' gchandbook.org.

The algorithm'</span>s intellectual heritage includes Dijkstra<span class="token string">'s on-the-fly algorithm, see
Edsger W. Dijkstra, Leslie Lamport, A. J. Martin, C. S. Scholten, and E. F. M. Steffens. 1978.
On-the-fly garbage collection: an exercise in cooperation. Commun. ACM 21, 11 (November 1978),
966-975.
For journal quality proofs that these steps are complete, correct, and terminate see
Hudson, R., and Moss, J.E.B. Copying Garbage Collection without stopping the world.
Concurrency and Computation: Practice and Experience 15(3-5), 2003.

1. GC performs sweep termination.

   a. Stop the world. This causes all Ps to reach a GC safe-point.

   b. Sweep any unswept spans. There will only be unswept spans if
   this GC cycle was forced before the expected time.

2. GC performs the mark phase.

   a. Prepare for the mark phase by setting gcphase to _GCmark
   (from _GCoff), enabling the write barrier, enabling mutator
   assists, and enqueueing root mark jobs. No objects may be
   scanned until all Ps have enabled the write barrier, which is
   accomplished using STW.

   b. Start the world. From this point, GC work is done by mark
   workers started by the scheduler and by assists performed as
   part of allocation. The write barrier shades both the
   overwritten pointer and the new pointer value for any pointer
   writes (see mbarrier.go for details). Newly allocated objects
   are immediately marked black.

   c. GC performs root marking jobs. This includes scanning all
   stacks, shading all globals, and shading any heap pointers in
   off-heap runtime data structures. Scanning a stack stops a
   goroutine, shades any pointers found on its stack, and then
   resumes the goroutine.

   d. GC drains the work queue of grey objects, scanning each grey
   object to black and shading all pointers found in the object
   (which in turn may add those pointers to the work queue).

   e. Because GC work is spread across local caches, GC uses a
   distributed termination algorithm to detect when there are no
   more root marking jobs or grey objects (see gcMarkDone). At this
   point, GC transitions to mark termination.

3. GC performs mark termination.

   a. Stop the world.

   b. Set gcphase to _GCmarktermination, and disable workers and
   assists.

   c. Perform housekeeping like flushing mcaches.

4. GC performs the sweep phase.

   a. Prepare for the sweep phase by setting gcphase to _GCoff,
   setting up sweep state and disabling the write barrier.

   b. Start the world. From this point on, newly allocated objects
   are white, and allocating sweeps spans before use if necessary.

   c. GC does concurrent sweeping in the background and in response
   to allocation. See description below.

5. When sufficient allocation has taken place, replay the sequence
starting with 1 above. See discussion of GC rate below.
Concurrent sweep.

The sweep phase proceeds concurrently with normal program execution.
The heap is swept span-by-span both lazily (when a goroutine needs another span)
and concurrently in a background goroutine (this helps programs that are not CPU bound).
At the end of STW mark termination all spans are marked as "needs sweeping".

The background sweeper goroutine simply sweeps spans one-by-one.

To avoid requesting more OS memory while there are unswept spans, when a
goroutine needs another span, it first attempts to reclaim that much memory
by sweeping. When a goroutine needs to allocate a new small-object span, it
sweeps small-object spans for the same object size until it frees at least
one object. When a goroutine needs to allocate large-object span from heap,
it sweeps spans until it frees at least that many pages into heap. There is
one case where this may not suffice: if a goroutine sweeps and frees two
nonadjacent one-page spans to the heap, it will allocate a new two-page
span, but there can still be other one-page unswept spans which could be
combined into a two-page span.

It'</span>s critical to ensure that no operations proceed on unswept spans <span class="token punctuation">(</span>that would corrupt
mark bits in GC bitmap<span class="token punctuation">)</span><span class="token punctuation">.</span> During GC all mcaches are flushed into the central cache<span class="token punctuation">,</span>
so they are empty<span class="token punctuation">.</span> When a goroutine grabs a <span class="token builtin">new</span> span into mcache<span class="token punctuation">,</span> it sweeps it<span class="token punctuation">.</span>
When a goroutine explicitly frees an object or sets a finalizer<span class="token punctuation">,</span> it ensures that
the span is swept <span class="token punctuation">(</span>either by sweeping it<span class="token punctuation">,</span> or by waiting <span class="token keyword">for</span> the concurrent sweep to finish<span class="token punctuation">)</span><span class="token punctuation">.</span>
The finalizer goroutine is kicked off only when all spans are swept<span class="token punctuation">.</span>
When the next GC starts<span class="token punctuation">,</span> it sweeps all not<span class="token operator">-</span>yet<span class="token operator">-</span>swept spans <span class="token punctuation">(</span><span class="token keyword">if</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>
GC rate<span class="token punctuation">.</span>
Next GC is after we<span class="token string">'ve allocated an extra amount of memory proportional to
the amount already in use. The proportion is controlled by GOGC environment variable
(100 by default). If GOGC=100 and we'</span>re using <span class="token number">4</span>M<span class="token punctuation">,</span> we'll GC again when we get to <span class="token number">8</span>M
<span class="token punctuation">(</span>this mark is tracked in next_gc variable<span class="token punctuation">)</span><span class="token punctuation">.</span> This keeps the GC cost in linear
proportion to the allocation cost<span class="token punctuation">.</span> Adjusting GOGC just changes the linear constant
<span class="token punctuation">(</span>and also the amount of extra memory used<span class="token punctuation">)</span><span class="token punctuation">.</span>
Oblets

In order to prevent long pauses while scanning large objects and to
improve parallelism<span class="token punctuation">,</span> the garbage collector breaks up scan jobs <span class="token keyword">for</span>
objects larger than maxObletBytes into <span class="token string">"oblets"</span> of at most
maxObletBytes<span class="token punctuation">.</span> When scanning encounters the beginning of a large
object<span class="token punctuation">,</span> it scans only the first oblet and enqueues the remaining
oblets as <span class="token builtin">new</span> scan jobs<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="杨宝强 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="杨宝强 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>杨宝强
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://bqyang.top/2021/GCComments/" title="GC from go comments">https://bqyang.top/2021/GCComments/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/contributeToYunion/" rel="prev" title="第一次 pr">
      <i class="fa fa-chevron-left"></i> 第一次 pr
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">杨宝强</p>
  <div class="site-description" itemprop="description">记录技术精进之路，记录生活的打情骂俏</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/clamyang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;clamyang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://xargin.com/" title="https:&#x2F;&#x2F;xargin.com" rel="noopener" target="_blank">Xargin</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://mytechshares.com/" title="https:&#x2F;&#x2F;mytechshares.com&#x2F;" rel="noopener" target="_blank">董泽润</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-car"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨宝强</span>
</div>
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2021035561号-1 </a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '4bcae079402e9cc4ce7b',
      clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
      repo        : 'blog_comments',
      owner       : 'clamyang',
      admin       : ['clamyang'],
      id          : '402e14b29f4d8ff7bdf22b7a4b4e12ea',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
