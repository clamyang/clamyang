<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€ç‰©ä¸çŸ¥æ·±ä»¥ä¸ºè€»"><title>GC æºç æ¢³ç† | æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">GC æºç æ¢³ç†</h1><a id="logo" href="/.">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">GC æºç æ¢³ç†</h1><div class="post-meta">2021-12-02</div><div class="post-content"><p>Golang GC åƒåœ¾å›æ”¶çŸ¥è¯†ç‚¹æ€»ç»“ï¼Œæœ‰äº›å†…å®¹è¿˜æ²¡æœ‰å®Œæˆï¼Œåªæ˜¯æš‚æ—¶å†™ä¸Šäº†é—®é¢˜ï¼Œè¿˜æ²¡æ¥å¾—åŠæ¢³ç†ç›¸åº”çš„å†…å®¹ã€‚</p>
<span id="more"></span>

<h2 id="GC-è¿è¿é—®"><a href="#GC-è¿è¿é—®" class="headerlink" title="GC è¿è¿é—®"></a>GC è¿è¿é—®</h2><h3 id="GC-çš„æµç¨‹é˜¶æ®µ"><a href="#GC-çš„æµç¨‹é˜¶æ®µ" class="headerlink" title="GC çš„æµç¨‹é˜¶æ®µ"></a>GC çš„æµç¨‹é˜¶æ®µ</h3><ul>
<li>sweep termination</li>
<li>mark</li>
<li>mark termination</li>
<li>sweep</li>
</ul>
<p>æ³¨ï¼šåœ¨ä¸‹ä¸€æ¬¡ GC mark é˜¶æ®µå¼€å§‹ä¹‹å‰ï¼Œä¸€å®šè¦å®Œæˆä¸Šä¸€æ¬¡çš„æ¸…æ‰«å·¥ä½œã€‚æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ª sweep termination  é˜¶æ®µã€‚æ ¹æœ¬åŸå› æ˜¯ Golang ä¸­é‡‡ç”¨çš„æ˜¯æƒ°æ€§æ¸…æ‰«çš„ã€‚</p>
<h3 id="GC-çš„è§¦å‘æ—¶æœº"><a href="#GC-çš„è§¦å‘æ—¶æœº" class="headerlink" title="GC çš„è§¦å‘æ—¶æœº"></a>GC çš„è§¦å‘æ—¶æœº</h3><p>1.runtime.GC æ‰‹åŠ¨è§¦å‘</p>
<p>2.mallocgc æ ¹æ®å†…å­˜åˆ†é…å¤§å°ï¼Œæ¯”å¦‚å½“å‰ä½¿ç”¨ 4Mï¼Œå½“å†…å­˜åˆ†é…åˆ°è¾¾ 8M æ—¶ï¼Œä¼šè§¦å‘ GCï¼Œè¿™ä¸ªç™¾åˆ†æ¯”æ˜¯å¯ä»¥è°ƒæ•´çš„ï¼Œé€šè¿‡ è®¾ç½® triggerRatio æŒ‡å®šè§¦å‘ GC çš„é˜ˆå€¼ go1.16.5 ä¸­ï¼Œæ˜¯ 7/8.0 = 87.5% </p>
<p>3.forcegchelper å®šæ—¶è§¦å‘ GC</p>
<p>mallocgc æ˜¯ä¸»è¦çš„è§¦å‘å‡½æ•°ã€‚</p>
<h3 id="GC-çš„èµ·ç‚¹"><a href="#GC-çš„èµ·ç‚¹" class="headerlink" title="GC çš„èµ·ç‚¹"></a>GC çš„èµ·ç‚¹</h3><p>gcStartï¼Œæ§åˆ¶ worker çš„æ•°é‡ï¼Œå  CPU çš„ 1/4ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆè€ç‰ˆæœ¬éœ€è¦é‡æ–°æ‰«ææ ˆï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè€ç‰ˆæœ¬éœ€è¦é‡æ–°æ‰«ææ ˆï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè€ç‰ˆæœ¬éœ€è¦é‡æ–°æ‰«ææ ˆï¼Ÿ"></a>ä¸ºä»€ä¹ˆè€ç‰ˆæœ¬éœ€è¦é‡æ–°æ‰«ææ ˆï¼Ÿ</h3><h3 id="GC-æ ‡è®°çš„æ ¹éƒ½æœ‰ä»€ä¹ˆï¼Ÿ"><a href="#GC-æ ‡è®°çš„æ ¹éƒ½æœ‰ä»€ä¹ˆï¼Ÿ" class="headerlink" title="GC æ ‡è®°çš„æ ¹éƒ½æœ‰ä»€ä¹ˆï¼Ÿ"></a>GC æ ‡è®°çš„æ ¹éƒ½æœ‰ä»€ä¹ˆï¼Ÿ</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// gcMarkRootPrepare queues root scanning jobs (stacks, globals, and</span>
<span class="token comment">// some miscellany) and initializes scanning-related state.</span>
<span class="token comment">//</span>
<span class="token comment">// The world must be stopped.</span>
<span class="token comment">/*
	å†™åœ¨æœ€å‰è¾¹ï¼Œæˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹åªæ˜¯ GCï¼Œ
	ä¸è¦è¿‡å¤šçš„è¢«å…¶ä»–çŸ¥è¯†ç‚¹æ‰€è’™è”½ï¼Œ
	æ¯”å¦‚è¿™é‡Œï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œæ ¹ä»å“ªé‡Œæ¥ï¼Œæ ¹éƒ½åŒ…å«ä»€ä¹ˆ
	å…¶å®ƒçš„éƒ½å¯ä»¥å¿½ç•¥ï¼ï¼
*/</span>
<span class="token keyword">func</span> <span class="token function">gcMarkRootPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assertWorldStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Compute how many data and BSS root blocks there are.</span>
    nBlocks <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>bytes <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token function">divRoundUp</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> rootBlockBytes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// åˆå§‹åŒ–éœ€è¦è¢«æ‰«æçš„ dataã€bss æ®µä¸ªæ•°</span>
    work<span class="token punctuation">.</span>nDataRoots <span class="token operator">=</span> <span class="token number">0</span>
    work<span class="token punctuation">.</span>nBSSRoots <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token comment">/*
    	æš‚æ—¶è®°å½•ä¸‹ç›®å‰çš„ç†è§£ï¼š
    	è¿™é‡Œçš„ bss data æ®µï¼Œæœ‰å¯èƒ½ä¼šå˜å¾—ï¼Œæ¯”å¦‚è¯´è¿›è¡ŒåŠ¨æ€é“¾æ¥çš„æ—¶å€™ï¼Œ
    	å°±ä¼šæŠŠé‚£ä¸ªè¢«é“¾æ¥çš„æ–‡ä»¶åŠ å…¥åˆ° activeModules ä¸­ï¼Œæ‰€ä»¥éƒ½æ˜¯é€šè¿‡
    	å‡½æ•°è°ƒç”¨çš„æ–¹å¼æ¥è·å–å¯¹åº”çš„æ•°æ®
    	æ³¨ï¼šä»–è¿™ä¸ªå¯¹æ€»æ•°çš„èµ‹å€¼æ“ä½œæœ‰ç‚¹è¿·æƒ‘ï¼Œä¸çŸ¥é“ä¸ºå•¥è¦è¿™æ ·å†™..
    */</span>

    <span class="token comment">// Scan globals.</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> datap <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">activeModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        nDataRoots <span class="token operator">:=</span> <span class="token function">nBlocks</span><span class="token punctuation">(</span>datap<span class="token punctuation">.</span>edata <span class="token operator">-</span> datap<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> nDataRoots <span class="token operator">></span> work<span class="token punctuation">.</span>nDataRoots <span class="token punctuation">&#123;</span>
            work<span class="token punctuation">.</span>nDataRoots <span class="token operator">=</span> nDataRoots
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> datap <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">activeModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        nBSSRoots <span class="token operator">:=</span> <span class="token function">nBlocks</span><span class="token punctuation">(</span>datap<span class="token punctuation">.</span>ebss <span class="token operator">-</span> datap<span class="token punctuation">.</span>bss<span class="token punctuation">)</span>
        <span class="token keyword">if</span> nBSSRoots <span class="token operator">></span> work<span class="token punctuation">.</span>nBSSRoots <span class="token punctuation">&#123;</span>
            work<span class="token punctuation">.</span>nBSSRoots <span class="token operator">=</span> nBSSRoots
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Scan span roots for finalizer specials.</span>
    <span class="token comment">//</span>
    <span class="token comment">// We depend on addfinalizer to mark objects that get</span>
    <span class="token comment">// finalizers after root marking.</span>
    <span class="token comment">//</span>
    <span class="token comment">// We're going to scan the whole heap (that was available at the time the</span>
    <span class="token comment">// mark phase started, i.e. markArenas) for in-use spans which have specials.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Break up the work into arenas, and further into chunks.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Snapshot allArenas as markArenas. This snapshot is safe because allArenas</span>
    <span class="token comment">// is append-only.</span>
    <span class="token comment">// æ‰«ææ•´ä¸ª heapï¼Œå¯¹ allArenas åšå¿«ç…§</span>
    mheap_<span class="token punctuation">.</span>markArenas <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>allArenas<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>mheap_<span class="token punctuation">.</span>allArenas<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>mheap_<span class="token punctuation">.</span>allArenas<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment">// è®¡ç®—éœ€è¦æ‰«æçš„ span æ•°é‡ï¼Œarena * ï¼ˆå•ä¸ª arena ä¸­ span çš„æ•°é‡ï¼‰</span>
    work<span class="token punctuation">.</span>nSpanRoots <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>mheap_<span class="token punctuation">.</span>markArenas<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>pagesPerArena <span class="token operator">/</span> pagesPerSpanRoot<span class="token punctuation">)</span>

    <span class="token comment">// Scan stacks.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Gs may be created after this point, but it's okay that we</span>
    <span class="token comment">// ignore them because they begin life without any roots, so</span>
    <span class="token comment">// there's nothing to scan, and any roots they create during</span>
    <span class="token comment">// the concurrent phase will be caught by the write barrier.</span>
    <span class="token comment">// å¦‚æ³¨é‡Šæ‰€è¯´ï¼Œå°½ç®¡è¿™æ—¶å€™æœ‰ goroutine è¢«åˆ›å»ºï¼Œä¹Ÿä¸éœ€è¦æ‹…å¿ƒ</span>
    <span class="token comment">// å› ä¸ºä»–ä»¬æ²¡æœ‰ rootï¼Œå³ä¸éœ€è¦æ‰«æã€‚å¦‚æœåœ¨å¹¶å‘é˜¶æ®µåˆ›å»ºå‡ºæ¥çš„ goroutineï¼Œ</span>
    <span class="token comment">// è¿™ä¸ª G ä½¿ç”¨çš„ root ä¼šè¢« write barrier æ•è·åˆ°ã€‚</span>
    work<span class="token punctuation">.</span>nStackRoots <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allglen<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// åˆå§‹åŒ–æ ‡è®°çš„å¼€å§‹ä½ç½®</span>
    work<span class="token punctuation">.</span>markrootNext <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">//ã€€è®¡ç®—æ‰€æœ‰æ ¹çš„æ•°é‡</span>
    <span class="token comment">//ã€€åŒ…æ‹¬äº†ï¼šDataã€€æ®µï¼ŒBSSã€€æ®µ,span,ä»¥åŠ goroutine æ ˆ</span>
    work<span class="token punctuation">.</span>markrootJobs <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>fixedRootCount <span class="token operator">+</span> work<span class="token punctuation">.</span>nDataRoots <span class="token operator">+</span> work<span class="token punctuation">.</span>nBSSRoots <span class="token operator">+</span> work<span class="token punctuation">.</span>nSpanRoots <span class="token operator">+</span> work<span class="token punctuation">.</span>nStackRoots<span class="token punctuation">)</span>

    <span class="token comment">// Calculate base indexes of each root type</span>
    <span class="token comment">// markroot æ ‡è®°çš„æ—¶å€™ä¼šæ ¹æ®ä¸åŒçš„ i æ‰¾åˆ°ä¸åŒçš„æ ¹</span>
    work<span class="token punctuation">.</span>baseData <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>fixedRootCount<span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>baseBSS <span class="token operator">=</span> work<span class="token punctuation">.</span>baseData <span class="token operator">+</span> <span class="token function">uint32</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span>nDataRoots<span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>baseSpans <span class="token operator">=</span> work<span class="token punctuation">.</span>baseBSS <span class="token operator">+</span> <span class="token function">uint32</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span>nBSSRoots<span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>baseStacks <span class="token operator">=</span> work<span class="token punctuation">.</span>baseSpans <span class="token operator">+</span> <span class="token function">uint32</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span>nSpanRoots<span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>baseEnd <span class="token operator">=</span> work<span class="token punctuation">.</span>baseStacks <span class="token operator">+</span> <span class="token function">uint32</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span>nStackRoots<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ç»“åˆä¸Šè¾¹ä»£ç æ¥çœ‹ï¼ŒGC æ ‡è®°è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ ¹æœ‰ï¼šå…¨å±€å˜é‡ï¼Œstackï¼Œheapï¼ˆspanï¼‰</li>
</ul>
<h3 id="å•ç‹¬ä½¿ç”¨-D-å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ"><a href="#å•ç‹¬ä½¿ç”¨-D-å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ" class="headerlink" title="å•ç‹¬ä½¿ç”¨ D å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ"></a>å•ç‹¬ä½¿ç”¨ D å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ</h3><h3 id="å•ç‹¬ä½¿ç”¨-Y-å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ"><a href="#å•ç‹¬ä½¿ç”¨-Y-å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ" class="headerlink" title="å•ç‹¬ä½¿ç”¨ Y å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ"></a>å•ç‹¬ä½¿ç”¨ Y å±éšœæœ‰ä½•é—®é¢˜ï¼Ÿ</h3><h3 id="æ··åˆå†™å±éšœæ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ"><a href="#æ··åˆå†™å±éšœæ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ" class="headerlink" title="æ··åˆå†™å±éšœæ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ"></a>æ··åˆå†™å±éšœæ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ</h3><h3 id="ååŠ©æ ‡è®°æµç¨‹"><a href="#ååŠ©æ ‡è®°æµç¨‹" class="headerlink" title="ååŠ©æ ‡è®°æµç¨‹"></a>ååŠ©æ ‡è®°æµç¨‹</h3><p>è¿™ä¸ªæ¶‰åŠåˆ° credit çš„æœºåˆ¶ï¼Œä¸€èˆ¬éƒ½æ˜¯ malloc ä¸­ credit ä¸å¤Ÿäº†ï¼Œæ‰è¿›è¡Œçš„ã€‚</p>
<h3 id="å¯¹è±¡çš„äº¤å‰å¼•ç”¨æ˜¯å¦‚ä½•å‰ªæçš„ï¼Ÿ"><a href="#å¯¹è±¡çš„äº¤å‰å¼•ç”¨æ˜¯å¦‚ä½•å‰ªæçš„ï¼Ÿ" class="headerlink" title="å¯¹è±¡çš„äº¤å‰å¼•ç”¨æ˜¯å¦‚ä½•å‰ªæçš„ï¼Ÿ"></a>å¯¹è±¡çš„äº¤å‰å¼•ç”¨æ˜¯å¦‚ä½•å‰ªæçš„ï¼Ÿ</h3><p>é€šè¿‡åŸå­æ“ä½œ <code>atomic.Or8</code> é¿å…äº†é‡å¤æ ‡è®°</p>
<h4 id="ä¸è¿ç®—"><a href="#ä¸è¿ç®—" class="headerlink" title="ä¸è¿ç®—"></a>ä¸è¿ç®—</h4><p>ä¸¤ä¸ªéƒ½æ˜¯ä¸€æ‰æ˜¯ä¸€</p>
<h4 id="æˆ–è¿ç®—"><a href="#æˆ–è¿ç®—" class="headerlink" title="æˆ–è¿ç®—"></a>æˆ–è¿ç®—</h4><p>æœ‰ä¸€ä¸ªæ˜¯ä¸€å°±æ˜¯ä¸€</p>
<h4 id="å¼‚æˆ–è¿ç®—"><a href="#å¼‚æˆ–è¿ç®—" class="headerlink" title="å¼‚æˆ–è¿ç®—"></a>å¼‚æˆ–è¿ç®—</h4><p>åŒé›¶å¼‚ä¸€</p>
<h3 id="GC-çš„-CPU-ä½¿ç”¨ç‡"><a href="#GC-çš„-CPU-ä½¿ç”¨ç‡" class="headerlink" title="GC çš„ CPU ä½¿ç”¨ç‡"></a>GC çš„ CPU ä½¿ç”¨ç‡</h3><ul>
<li>GC cpu ä½¿ç”¨ç‡ä¸»è¦ç”¨æ¥æ§åˆ¶ï¼Œå¯åŠ¨ mark worker çš„æ•°é‡</li>
</ul>
<p>mark worker count = gomaxprocs * 25%</p>
<p>å¦‚æœ gomaxprocs = 4ï¼Œé‚£ä¹ˆåªéœ€è¦å¯åŠ¨ä¸€ä¸ª markworker</p>
<p>å¯¹äºè®¡ç®—ç»“æœä¸ä¸ºæ•´æ•°çš„æƒ…å†µï¼Œæ¯”å¦‚ gomaxprocs = 6ï¼Œé‚£ä¹ˆ work count  = 1.5ï¼Œä¼šå¯¹ç»“æœ + 0.5 è¿›è¡Œ roundingï¼Œ ç„¶åé€šè¿‡è®¡ç®—è¯¯å·®æ˜¯å¦ &gt; 0.3 åˆ¤æ–­å¼€å‡ ä¸ªå…¨èŒ worker</p>
<p>2/1.5 -1 = 1/3 &gt; 0.3</p>
<h3 id="gcTriggerKind"><a href="#gcTriggerKind" class="headerlink" title="gcTriggerKind"></a>gcTriggerKind</h3><p>gc è§¦å‘ç±»å‹ï¼š</p>
<ul>
<li>gcTriggerHeap å†…å­˜åˆ°è¾¾é˜ˆå€¼</li>
<li>gcTriggerTime åˆ°è¾¾è§¦å‘æ—¶é—´</li>
<li>gcTriggerCycle å¯ä»¥ç†è§£ä¸ºç”¨æˆ·æ‰‹åŠ¨è§¦å‘ç±»å‹</li>
</ul>
<h3 id="STW-æ—¶é—´æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ"><a href="#STW-æ—¶é—´æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ" class="headerlink" title="STW æ—¶é—´æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ"></a>STW æ—¶é—´æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ</h3><h3 id="GC-è¿‡ç¨‹ä¸­æ˜¯ä»€ä¹ˆæ—¶å€™å°†å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²çš„"><a href="#GC-è¿‡ç¨‹ä¸­æ˜¯ä»€ä¹ˆæ—¶å€™å°†å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²çš„" class="headerlink" title="GC è¿‡ç¨‹ä¸­æ˜¯ä»€ä¹ˆæ—¶å€™å°†å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²çš„"></a>GC è¿‡ç¨‹ä¸­æ˜¯ä»€ä¹ˆæ—¶å€™å°†å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²çš„</h3><p>æ¢å¥è¯è¯´ï¼Œæ˜¯é€šè¿‡ä¿®æ”¹äº†ä»€ä¹ˆå˜é‡ï¼Œå°±ä»£è¡¨è¿™ä¸ªæŒ‡é’ˆè¢«æ ‡è®°ä¸ºé»‘è‰²ã€‚</p>
<p>è§£é‡Šå¦‚ä¸‹ï¼š</p>
<p>â€‹    é€šè¿‡æºç åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä»ç™½è‰²å¯¹è±¡åˆ°ç°è‰²å¯¹è±¡æ˜¯é€šè¿‡ greyobject æ¥å®ç°çš„ï¼ŒåŒäº‹ä¹Ÿèƒ½å¤ŸçŸ¥é“åœ¨ gcw é˜Ÿåˆ—ä¸­çš„å¯¹è±¡éƒ½æ˜¯ç°è‰²çš„ã€‚</p>
<p>â€‹    æ ‡è®°ä¸ºé»‘è‰²çš„è¿‡ç¨‹æ˜¯ä» gcw é˜Ÿåˆ—ä¸­å–å‡ºç°è‰²å¯¹è±¡ï¼Œå†éå†å…¶å­å¯¹è±¡å¹¶å°†å…¶æ ‡ç°ï¼Œä¹Ÿå³æ˜¯è¯´å½“ç°è‰²å¯¹è±¡å‡ºé˜Ÿçš„æ—¶å€™å°±è‡ªåŠ¨å˜æˆé»‘è‰²äº†ï¼Œå°±å®Œæˆäº†å°†ä¸€ä¸ªç°è‰²å¯¹è±¡æ ‡è®°ä½é»‘è‰²çš„è¿‡ç¨‹ï¼Œåœ¨ Go çš„æºç ä¸­ï¼Œå…¶å®å¹¶ä¸å­˜åœ¨çš„æŸä¸ªæ–¹æ³•æˆ–è€…æŸä¸ªæ ‡å¿—ä½ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡æ˜¯é»‘è‰²çš„ã€‚</p>
<h2 id="gcStart-æºç å‰–æ"><a href="#gcStart-æºç å‰–æ" class="headerlink" title="gcStart æºç å‰–æ"></a>gcStart æºç å‰–æ</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// gcStart starts the GC. It transitions from _GCoff to _GCmark (if</span>
<span class="token comment">// debug.gcstoptheworld == 0) or performs all of GC (if</span>
<span class="token comment">// debug.gcstoptheworld != 0).</span>
<span class="token comment">//</span>
<span class="token comment">// This may return without performing this transition in some cases,</span>
<span class="token comment">// such as when called on a system stack or with locks held.</span>

<span class="token comment">// gcStart æ˜¯ GC çš„èµ·ç‚¹ï¼Œå¹¶å°† GC çš„çŠ¶æ€ç”± _GCoff åˆ‡æ¢åˆ° _GCmarkï¼Œ</span>
<span class="token comment">// å¦‚æœ gcStart åœ¨ç³»ç»Ÿæ ˆä¸Šè¢«è°ƒç”¨æˆ–è€…æŒæœ‰é”çš„æ—¶å€™ï¼Œå°±ä¸ä¼šæ‰§è¡ŒçŠ¶æ€çš„æ”¹å˜ç›´æ¥è¿”å›äº†ã€‚</span>
<span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>trigger gcTrigger<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Since this is called from malloc and malloc is called in</span>
    <span class="token comment">// the guts of a number of libraries that might be holding</span>
    <span class="token comment">// locks, don't attempt to start GC in non-preemptible or</span>
    <span class="token comment">// potentially unstable situations.</span>

    <span class="token comment">// å¦‚æœ gcStart æ˜¯ä» malloc è°ƒç”¨çš„ï¼Œå¹¶ä¸” malloc åˆæ˜¯è¢«å…¶ä»–çš„åº“è°ƒç”¨çš„ï¼Œ</span>
    <span class="token comment">// è¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šæŒæœ‰é”ï¼ˆmp.locks > 1ï¼‰</span>
    <span class="token comment">// ä¸è¦å†éæŠ¢å æˆ–è€…ä¸ç¨³å®šçš„æƒ…å†µä¸‹è°ƒç”¨ gcStart</span>
    <span class="token comment">/*
       æˆ‘çš„ç†è§£ï¼šå¦‚æœä¸æ˜¯éæŠ¢å æ¨¡å¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´åé¢ stw æ—¶ï¼Œä¸€äº› g æ²¡æœ‰åŠæ³•åœæ­¢
       ä¼šå½±å“ GC çš„ç»“æœã€‚
    */</span>
    mp <span class="token operator">:=</span> <span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// mp.locks > 1 è¯´æ˜åœ¨ gcStart ä¹‹å‰å°±æŒæœ‰é”</span>
    <span class="token comment">// mp.preemptoff != "" è¯´æ˜åœ¨ non-preempt æ¨¡å¼ä¸‹</span>
    <span class="token keyword">if</span> gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">==</span> mp<span class="token punctuation">.</span>g0 <span class="token operator">||</span> mp<span class="token punctuation">.</span>locks <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> mp<span class="token punctuation">.</span>preemptoff <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
        <span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
    mp <span class="token operator">=</span> <span class="token boolean">nil</span>	

    <span class="token comment">// Pick up the remaining unswept/not being swept spans concurrently</span>
    <span class="token comment">//</span>
    <span class="token comment">// This shouldn't happen if we're being invoked in background</span>
    <span class="token comment">// mode since proportional sweep should have just finished</span>
    <span class="token comment">// sweeping everything, but rounding errors, etc, may leave a</span>
    <span class="token comment">// few spans unswept. In forced mode, this is necessary since</span>
    <span class="token comment">// GC can be forced at any point in the sweeping cycle.</span>
    <span class="token comment">//</span>
    <span class="token comment">// We check the transition condition continuously here in case</span>
    <span class="token comment">// this G gets delayed in to the next GC cycle.</span>
    <span class="token comment">/*
        trigger.test() æ£€æµ‹æ˜¯å¦æ»¡è¶³ GC çš„è§¦å‘æ¡ä»¶
        sweepone() æˆ‘çš„ç†è§£æ˜¯ï¼šæ¸…æ‰«ä¸Šæ¬¡ GC é—ç•™ä¸‹æ¥çš„ unswept çš„ span
        ï¼Ÿï¼Ÿ æ˜¯å¦å¯ä»¥ç†è§£æˆ sweep termination çš„é˜¶æ®µ 
    */</span>
    <span class="token keyword">for</span> trigger<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">^</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sweep<span class="token punctuation">.</span>nbgsweep<span class="token operator">++</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Perform GC initialization and the sweep termination</span>
    <span class="token comment">// transition.</span>
    <span class="token comment">/*
    	semaacquire çš„æ“ä½œï¼Œæ˜¯å¦å¯ä»¥ç†è§£ä¸ºï¼Œé€šè¿‡ atomic å»æ‰äº†é”ã€‚
		æ¢å¥è¯è¯´ï¼Œåªæœ‰è·å–äº†æŸä¸ª semaï¼Œæ‰èƒ½å¯¹ gc çŠ¶æ€è¿›è¡Œä¿®æ”¹ã€‚
    */</span>
    <span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>startSema<span class="token punctuation">)</span>
    <span class="token comment">// Re-check transition condition under transition lock.</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>trigger<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>startSema<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// For stats, check if this GC was forced by the user.</span>
    work<span class="token punctuation">.</span>userForced <span class="token operator">=</span> trigger<span class="token punctuation">.</span>kind <span class="token operator">==</span> gcTriggerCycle

    <span class="token comment">// In gcstoptheworld debug mode, upgrade the mode accordingly.</span>
    <span class="token comment">// We do this after re-checking the transition condition so</span>
    <span class="token comment">// that multiple goroutines that detect the heap trigger don't</span>
    <span class="token comment">// start multiple STW GCs.</span>
    <span class="token comment">// å¦‚æœæ²¡å¼€å¯ GODEBUG éƒ½æ˜¯ gcBackgroundMode æ¨¡å¼</span>
    mode <span class="token operator">:=</span> gcBackgroundMode
    <span class="token keyword">if</span> debug<span class="token punctuation">.</span>gcstoptheworld <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
        mode <span class="token operator">=</span> gcForceMode
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> debug<span class="token punctuation">.</span>gcstoptheworld <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">&#123;</span>
        mode <span class="token operator">=</span> gcForceBlockMode
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Ok, we're doing it! Stop everybody else</span>
    <span class="token comment">// è·å– STW éœ€è¦çš„ semaphore</span>
    <span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcsema<span class="token punctuation">)</span>
    <span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>worldsema<span class="token punctuation">)</span>

    <span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">&#123;</span>
        <span class="token function">traceGCStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Check that all Ps have finished deferred mcache flushes.</span>
    <span class="token comment">// TODO æ£€æŸ¥ P çš„ mcache</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> allp <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> fg <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>mcache<span class="token punctuation">.</span>flushGen<span class="token punctuation">)</span><span class="token punctuation">;</span> fg <span class="token operator">!=</span> mheap_<span class="token punctuation">.</span>sweepgen <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"runtime: p"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"flushGen"</span><span class="token punctuation">,</span> fg<span class="token punctuation">,</span> <span class="token string">"!= sweepgen"</span><span class="token punctuation">,</span> mheap_<span class="token punctuation">.</span>sweepgen<span class="token punctuation">)</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"p mcache not flushed"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// å¼€å¯ nproc ä¸ª gcMarkWorkerï¼ŒåŠ å…¥åˆ° workerPool ä¸­</span>
    <span class="token comment">// åˆ›å»ºå®Œä¸€ä¸ª workerï¼Œä¼‘çœ ä¸€ä¸ª worker</span>
    <span class="token comment">// ç”± schedule.findRunnableGCWorker å”¤é†’</span>
    <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// é‡ç½®æ ‡å¿—ä½ï¼Œallg çš„æ ‡å¿—ä½ï¼ŒheapArena çš„æ ‡å¿—ä½</span>
    <span class="token comment">// æ¸…ç©ºäº†æ¯ä¸€ä¸ª g çš„ AssistBytes</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span>gcResetMarkState<span class="token punctuation">)</span>

    work<span class="token punctuation">.</span>stwprocs<span class="token punctuation">,</span> work<span class="token punctuation">.</span>maxprocs <span class="token operator">=</span> gomaxprocs<span class="token punctuation">,</span> gomaxprocs
    <span class="token keyword">if</span> work<span class="token punctuation">.</span>stwprocs <span class="token operator">></span> ncpu <span class="token punctuation">&#123;</span>
        <span class="token comment">// This is used to compute CPU time of the STW phases,</span>
        <span class="token comment">// so it can't be more than ncpu, even if GOMAXPROCS is.</span>
        work<span class="token punctuation">.</span>stwprocs <span class="token operator">=</span> ncpu
    <span class="token punctuation">&#125;</span>
    work<span class="token punctuation">.</span>heap0 <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>heap_live<span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>pauseNS <span class="token operator">=</span> <span class="token number">0</span>
    work<span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

    now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>tSweepTerm <span class="token operator">=</span> now
    work<span class="token punctuation">.</span>pauseStart <span class="token operator">=</span> now
    <span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">&#123;</span>
        <span class="token function">traceGCSTWStart</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// STW è°ƒç”¨è€…å¿…é¡»ä¸º stopTheWorldWithSema è·å– worldsema å¹¶ä¸” å…³é—­æŠ¢å </span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span>stopTheWorldWithSema<span class="token punctuation">)</span>

    <span class="token comment">// Finish sweep before we start concurrent scan.</span>
    <span class="token comment">// ç¡®ä¿æœ¬æ¬¡ GC å¼€å§‹æ—¶ï¼Œå·²å®Œæˆä¸Šä¸€æ¬¡ GC çš„ sweep å·¥ä½œ</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">finishsweep_m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token comment">// clearpools before we start the GC. If we wait they memory will not be</span>
    <span class="token comment">// reclaimed until the next GC cycle.</span>
    <span class="token comment">// 1.å¤„ç† sync.Pool</span>
    <span class="token comment">// 2.æ¸…ç©º sudog cache</span>
    <span class="token comment">// 3.æ¸…ç©º defer pools</span>
    <span class="token function">clearpools</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// å¢åŠ  gc å‘¨æœŸæ•°</span>
    work<span class="token punctuation">.</span>cycles<span class="token operator">++</span>

    <span class="token comment">// å¼€å§‹æœ¬æ¬¡ gc å‘¨æœŸ</span>
    gcController<span class="token punctuation">.</span><span class="token function">startCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>heapGoal <span class="token operator">=</span> memstats<span class="token punctuation">.</span>next_gc

    <span class="token comment">// In STW mode, disable scheduling of user Gs. This may also</span>
    <span class="token comment">// disable scheduling of this goroutine, so it may block as</span>
    <span class="token comment">// soon as we start the world again.</span>
    <span class="token keyword">if</span> mode <span class="token operator">!=</span> gcBackgroundMode <span class="token punctuation">&#123;</span>
        <span class="token function">schedEnableUser</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Enter concurrent mark phase and enable</span>
    <span class="token comment">// write barriers.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Because the world is stopped, all Ps will</span>
    <span class="token comment">// observe that write barriers are enabled by</span>
    <span class="token comment">// the time we start the world and begin</span>
    <span class="token comment">// scanning.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Write barriers must be enabled before assists are</span>
    <span class="token comment">// enabled because they must be enabled before</span>
    <span class="token comment">// any non-leaf heap objects are marked. Since</span>
    <span class="token comment">// allocations are blocked until assists can</span>
    <span class="token comment">// happen, we want enable assists as early as</span>
    <span class="token comment">// possible.</span>
    <span class="token function">setGCPhase</span><span class="token punctuation">(</span>_GCmark<span class="token punctuation">)</span>

    <span class="token function">gcBgMarkPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Must happen before assist enable.</span>
    <span class="token function">gcMarkRootPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Mark all active tinyalloc blocks. Since we're</span>
    <span class="token comment">// allocating from these, they need to be black like</span>
    <span class="token comment">// other allocations. The alternative is to blacken</span>
    <span class="token comment">// the tiny block on every allocation from it, which</span>
    <span class="token comment">// would slow down the tiny allocator.</span>
    <span class="token function">gcMarkTinyAllocs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// At this point all Ps have enabled the write</span>
    <span class="token comment">// barrier, thus maintaining the no white to</span>
    <span class="token comment">// black invariant. Enable mutator assists to</span>
    <span class="token comment">// put back-pressure on fast allocating</span>
    <span class="token comment">// mutators.</span>
    atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcBlackenEnabled<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">// Assists and workers can start the moment we start</span>
    <span class="token comment">// the world.</span>
    gcController<span class="token punctuation">.</span>markStartTime <span class="token operator">=</span> now

    <span class="token comment">// In STW mode, we could block the instant systemstack</span>
    <span class="token comment">// returns, so make sure we're not preemptible.</span>
    mp <span class="token operator">=</span> <span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Concurrent mark.</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        now <span class="token operator">=</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>enabled<span class="token punctuation">)</span>
        work<span class="token punctuation">.</span>pauseNS <span class="token operator">+=</span> now <span class="token operator">-</span> work<span class="token punctuation">.</span>pauseStart
        work<span class="token punctuation">.</span>tMark <span class="token operator">=</span> now
        memstats<span class="token punctuation">.</span>gcPauseDist<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>now <span class="token operator">-</span> work<span class="token punctuation">.</span>pauseStart<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token comment">// Release the world sema before Gosched() in STW mode</span>
    <span class="token comment">// because we will need to reacquire it later but before</span>
    <span class="token comment">// this goroutine becomes runnable again, and we could</span>
    <span class="token comment">// self-deadlock otherwise.</span>
    <span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>worldsema<span class="token punctuation">)</span>
    <span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>

    <span class="token comment">// Make sure we block instead of returning to user code</span>
    <span class="token comment">// in STW mode.</span>
    <span class="token keyword">if</span> mode <span class="token operator">!=</span> gcBackgroundMode <span class="token punctuation">&#123;</span>
        <span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>startSema<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="findRunnableGCWorker-æºç å‰–æ"><a href="#findRunnableGCWorker-æºç å‰–æ" class="headerlink" title="findRunnableGCWorker æºç å‰–æ"></a>findRunnableGCWorker æºç å‰–æ</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// findRunnableGCWorker returns a background mark worker for _p_ if it</span>
<span class="token comment">// should be run. This must only be called when gcBlackenEnabled != 0.</span>
<span class="token comment">// åªæœ‰åœ¨ gc å¼€å¯çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼ŒgcStart ä¸­è®¾ç½®ä¸º 1</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>gcControllerState<span class="token punctuation">)</span> <span class="token function">findRunnableGCWorker</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcControllerState.findRunnable: blackening not enabled"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// No work to be done right now. This can happen at</span>
        <span class="token comment">// the end of the mark phase when there are still</span>
        <span class="token comment">// assists tapering off. Don't bother running a worker</span>
        <span class="token comment">// now because it'll just return immediately.</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Grab a worker before we commit to running below.</span>
    <span class="token comment">// ä» workpool ä¸­å¼¹å‡ºä¸€ä¸ª gcMarkWorker</span>
    node <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>gcBgMarkWorkerNode<span class="token punctuation">)</span><span class="token punctuation">(</span>gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// There is at least one worker per P, so normally there are</span>
        <span class="token comment">// enough workers to run on all Ps, if necessary. However, once</span>
        <span class="token comment">// a worker enters gcMarkDone it may park without rejoining the</span>
        <span class="token comment">// pool, thus freeing a P with no corresponding worker.</span>
        <span class="token comment">// gcMarkDone never depends on another worker doing work, so it</span>
        <span class="token comment">// is safe to simply do nothing here.</span>
        <span class="token comment">//</span>
        <span class="token comment">// If gcMarkDone bails out without completing the mark phase,</span>
        <span class="token comment">// it will always do so with queued global work. Thus, that P</span>
        <span class="token comment">// will be immediately eligible to re-run the worker G it was</span>
        <span class="token comment">// just using, ensuring work can complete.</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// ç”¨äºè®¡ç®—è¯¥ markNode çš„å·¥ä½œæ¨¡å¼</span>
    <span class="token comment">// >  0 dedicatedMode</span>
    <span class="token comment">// &lt;= 0 fractionalMode</span>
    decIfPositive <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ptr <span class="token operator">*</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
            v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loadint64</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
            <span class="token keyword">if</span> v <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casint64</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token function">decIfPositive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>dedicatedMarkWorkersNeeded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// This P is now dedicated to marking until the end of</span>
        <span class="token comment">// the concurrent mark phase.</span>
        _p_<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerDedicatedMode
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>fractionalUtilizationGoal <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// No need for fractional workers.</span>
        gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Is this P behind on the fractional utilization</span>
        <span class="token comment">// goal?</span>
        <span class="token comment">//</span>
        <span class="token comment">// This should be kept in sync with pollFractionalWorkerExit.</span>
        delta <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> c<span class="token punctuation">.</span>markStartTime
        <span class="token keyword">if</span> delta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">float64</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>gcFractionalMarkTime<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">float64</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span> <span class="token operator">></span> c<span class="token punctuation">.</span>fractionalUtilizationGoal <span class="token punctuation">&#123;</span>
            <span class="token comment">// Nope. No need to run a fractional worker.</span>
            gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// Run a fractional worker.</span>
        _p_<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerFractionalMode
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Run the background mark worker.</span>
    <span class="token comment">// ä¿®æ”¹ workerg çš„çŠ¶æ€å¹¶è¿”å›</span>
    gp <span class="token operator">:=</span> node<span class="token punctuation">.</span>gp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>
    <span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">&#123;</span>
        <span class="token function">traceGoUnpark</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> gp
<span class="token punctuation">&#125;</span>


<span class="token comment">// gcMarkWorkAvailable reports whether executing a mark worker</span>
<span class="token comment">// on p is potentially useful. p may be nil, in which case it only</span>
<span class="token comment">// checks the global sources of work.</span>
<span class="token comment">/*
	è¯¥å‡½æ•°ä¸»è¦ä½œç”¨ï¼šè¿”å›æ˜¯å¦æœ‰æ ‡è®°å·¥ä½œå¯ä»¥å¹²
	gcw pçš„é˜Ÿåˆ—
	work å…¨å±€é˜Ÿåˆ—
*/</span>
<span class="token keyword">func</span> <span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span>p <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> p <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>work<span class="token punctuation">.</span>full<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// global work available</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> work<span class="token punctuation">.</span>markrootNext <span class="token operator">&lt;</span> work<span class="token punctuation">.</span>markrootJobs <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// root scan work available</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å‰–æ-gcBgMarkWorker-åˆ›å»ºè¿‡ç¨‹"><a href="#å‰–æ-gcBgMarkWorker-åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="å‰–æ gcBgMarkWorker åˆ›å»ºè¿‡ç¨‹"></a>å‰–æ gcBgMarkWorker åˆ›å»ºè¿‡ç¨‹</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// gcBgMarkStartWorkers prepares background mark worker goroutines. These</span>
<span class="token comment">// goroutines will not run until the mark phase, but they must be started while</span>
<span class="token comment">// the work is not stopped and from a regular G stack. The caller must hold</span>
<span class="token comment">// worldsema.</span>
<span class="token keyword">func</span> <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Background marking is performed by per-P G's. Ensure that each P has</span>
    <span class="token comment">// a background GC G.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Worker Gs don't exit if gomaxprocs is reduced. If it is raised</span>
    <span class="token comment">// again, we can reuse the old workers; no need to create new workers.</span>
    <span class="token keyword">for</span> gcBgMarkWorkerCount <span class="token operator">&lt;</span> gomaxprocs <span class="token punctuation">&#123;</span>
        <span class="token keyword">go</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">notetsleepg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">noteclear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">)</span>
        <span class="token comment">// The worker is now guaranteed to be added to the pool before</span>
        <span class="token comment">// its P's next findRunnableGCWorker.</span>

        gcBgMarkWorkerCount<span class="token operator">++</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ç”±ä¸Šå¯çŸ¥ï¼Œæ‰€æœ‰ gcMarkWorker éƒ½æ˜¯é€šè¿‡è¯¥å‡½æ•°åˆ›å»ºçš„ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ <code>notesleepg()</code> å’Œ <code>go gcBgMarkWorker</code> è¿™ä¸¤è¡Œä»£ç </li>
</ul>
<h3 id="notesleepg"><a href="#notesleepg" class="headerlink" title="notesleepg"></a><code>notesleepg</code></h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// same as runtimeÂ·notetsleep, but called on user g (not g0)</span>
<span class="token comment">// calls only nosplit functions between entersyscallblock/exitsyscall</span>
<span class="token keyword">func</span> <span class="token function">notetsleepg</span><span class="token punctuation">(</span>n <span class="token operator">*</span>note<span class="token punctuation">,</span> ns <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> gp <span class="token operator">==</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>g0 <span class="token punctuation">&#123;</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"notetsleepg on g0"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// è¿™ä¸ªæˆ‘ä»¬åœ¨å­¦ä¹  timer çš„æ—¶å€™å·²ç»çœ‹è¿‡äº†</span>
    <span class="token comment">// ä¸»è¦å°±æ˜¯æ‰§è¡Œ handoff</span>
    <span class="token function">entersyscallblock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// è¿™é‡Œæ‰æ˜¯çœŸæ­£è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„åœ°æ–¹ï¼Œns = -1ï¼Œä¼šæ— ä¼‘æ­¢çš„ä¼‘çœ </span>
    <span class="token comment">// ç›´åˆ°é€šè¿‡ wakeup å”¤é†’</span>
    ok <span class="token operator">:=</span> <span class="token function">notetsleep_internal</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> ns<span class="token punctuation">)</span>
    <span class="token comment">// ä¸Šè¿°ï¼Œé€šè¿‡ wakeup å”¤é†’åä¼šç»§ç»­æ‰§è¡Œè¿™å—ä»£ç </span>
    <span class="token comment">// è¯¥å‡½æ•°ä¸»è¦æ˜¯ç»™åˆšåˆšå‰¥ç¦»çš„ GM æ‰¾ä¸€ä¸ª P</span>
    <span class="token comment">// æ‰¾åˆ°äº†ï¼Œæ‰§è¡Œ</span>
    <span class="token comment">// æ²¡æ‰¾åˆ°ï¼ŒæŠŠ g æ”¾åˆ°å…¨å±€é˜Ÿåˆ—</span>
    <span class="token function">exitsyscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ok
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="go-gcBgMarkWorker"><a href="#go-gcBgMarkWorker" class="headerlink" title="go gcBgMarkWorker"></a><code>go gcBgMarkWorker</code></h3><ul>
<li>è¿™é‡Œåº”ç”¨åˆ° MPG è°ƒåº¦çš„çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡ go å…³é”®å­—æ–°å»ºä¸€ä¸ª goroutineï¼Œæ”¾å…¥ runnext ç­‰å¾…è¢«è°ƒåº¦ã€‚</li>
</ul>
<h3 id="ç»“åˆç€çœ‹"><a href="#ç»“åˆç€çœ‹" class="headerlink" title="ç»“åˆç€çœ‹"></a>ç»“åˆç€çœ‹</h3><p>æˆ‘ä»¬å‡è®¾ç°åœ¨åªæœ‰ä¸€ä¸ª Pï¼Œå³ <code>runtime.GOMAXPROCS(1)</code> ã€‚è¿™æ—¶æˆ‘ä»¬æ¥çœ‹ä¸Šè¿°ä»£ç ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹ä¸ºï¼š</p>
<ul>
<li>1.é€šè¿‡ <code>gcBgMarkStartWorkers</code> åˆ›å»º worker</li>
<li>2.worker è¢«æ”¾å…¥ runnext ç­‰å¾…è¢«è°ƒåº¦</li>
<li>3.æ‰§è¡Œ <code>notesleepg</code><ul>
<li>handoffp</li>
<li>futex &amp;&amp; timeout = -1</li>
<li>ç¬¬ 3 æ­¥æ‰§è¡Œå®Œæˆåï¼ŒGM å·²ç»ä» P ä¸Šå‰¥ç¦»</li>
</ul>
</li>
<li>4.handoffp ä¸­ä¼šå¯åŠ¨ä¸€ä¸ª M ç»§ç»­æ‰§è¡Œè°ƒåº¦å¾ªç¯</li>
<li>5.newM ä» P ä¸Šæ‰¾ G æ‰§è¡Œ</li>
<li>6.æ‹¿åˆ°æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ newg</li>
<li>7.è¿›å…¥åˆ° <code>gcBgMarkWorker()</code> ä¸­æ‰§è¡Œ<ul>
<li>æ–°å»º node &amp;&amp; <strong>wakeup</strong> ä¼‘çœ çš„ GM</li>
<li>ç„¶å <code>gopark</code> æŒ‚èµ· worker ç­‰å¾…å”¤é†’</li>
</ul>
</li>
<li>8.ä¼‘çœ çš„ GM é†’æ¥å<ul>
<li>å°è¯•è·å– oldp</li>
<li>å¦‚æœè·å–ä¸åˆ°åˆ™ï¼Œå°è¯•è·å– idlep</li>
<li>å¦‚æœè·å–ä¸åˆ°åˆ™ï¼Œå°† g æ”¾å…¥å…¨å±€é˜Ÿåˆ—</li>
</ul>
</li>
<li>9.ç¬¬ 8 æ­¥ä¸­çš„ g è¢«è°ƒåº¦åï¼Œä¼šç»§ç»­æ‰§è¡Œ create worker çš„å·¥ä½œï¼Œå›åˆ°ç¬¬ 1 æ­¥ ç»§ç»­æ‰§è¡Œ</li>
</ul>
<h2 id="gcMarkWorker-æ‰§è¡Œè¿‡ç¨‹"><a href="#gcMarkWorker-æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="gcMarkWorker æ‰§è¡Œè¿‡ç¨‹"></a>gcMarkWorker æ‰§è¡Œè¿‡ç¨‹</h2><h3 id="gcBgMarkWorker-æºç å‰–æ"><a href="#gcBgMarkWorker-æºç å‰–æ" class="headerlink" title="gcBgMarkWorker æºç å‰–æ"></a>gcBgMarkWorker æºç å‰–æ</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// We pass node to a gopark unlock function, so it can't be on</span>
    <span class="token comment">// the stack (see gopark). Prevent deadlock from recursively</span>
    <span class="token comment">// starting GC by disabling preemption.</span>
    gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>preemptoff <span class="token operator">=</span> <span class="token string">"GC worker init"</span>
    node <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>gcBgMarkWorkerNode<span class="token punctuation">)</span>
    gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>preemptoff <span class="token operator">=</span> <span class="token string">""</span>

    node<span class="token punctuation">.</span>gp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>

    node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">notewakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">)</span>
    <span class="token comment">// After this point, the background mark worker is generally scheduled</span>
    <span class="token comment">// cooperatively by gcController.findRunnableGCWorker. While performing</span>
    <span class="token comment">// work on the P, preemption is disabled because we are working on</span>
    <span class="token comment">// P-local work buffers. When the preempt flag is set, this puts itself</span>
    <span class="token comment">// into _Gwaiting to be woken up by gcController.findRunnableGCWorker</span>
    <span class="token comment">// at the appropriate time.</span>
    <span class="token comment">//</span>
    <span class="token comment">// When preemption is enabled (e.g., while in gcMarkDone), this worker</span>
    <span class="token comment">// may be preempted and schedule as a _Grunnable G from a runq. That is</span>
    <span class="token comment">// fine; it will eventually gopark again for further scheduling via</span>
    <span class="token comment">// findRunnableGCWorker.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Since we disable preemption before notifying bgMarkReady, we</span>
    <span class="token comment">// guarantee that this G will be in the worker pool for the next</span>
    <span class="token comment">// findRunnableGCWorker. This isn't strictly necessary, but it reduces</span>
    <span class="token comment">// latency between _GCmark starting and the workers starting.</span>

    <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Go to sleep until woken by</span>
        <span class="token comment">// gcController.findRunnableGCWorker.</span>
        <span class="token function">gopark</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>g <span class="token operator">*</span>g<span class="token punctuation">,</span> nodep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
            node <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>gcBgMarkWorkerNode<span class="token punctuation">)</span><span class="token punctuation">(</span>nodep<span class="token punctuation">)</span>

            <span class="token keyword">if</span> mp <span class="token operator">:=</span> node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> mp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// The worker G is no longer running; release</span>
                <span class="token comment">// the M.</span>
                <span class="token comment">//</span>
                <span class="token comment">// N.B. it is _safe_ to release the M as soon</span>
                <span class="token comment">// as we are no longer performing P-local mark</span>
                <span class="token comment">// work.</span>
                <span class="token comment">//</span>
                <span class="token comment">// However, since we cooperatively stop work</span>
                <span class="token comment">// when gp.preempt is set, if we releasem in</span>
                <span class="token comment">// the loop then the following call to gopark</span>
                <span class="token comment">// would immediately preempt the G. This is</span>
                <span class="token comment">// also safe, but inefficient: the G must</span>
                <span class="token comment">// schedule again only to enter gopark and park</span>
                <span class="token comment">// again. Thus, we defer the release until</span>
                <span class="token comment">// after parking the G.</span>
                <span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Release this G to the pool.</span>
            gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
            <span class="token comment">// Note that at this point, the G may immediately be</span>
            <span class="token comment">// rescheduled and may be running.</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonGCWorkerIdle<span class="token punctuation">,</span> traceEvGoBlock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment">/*
        	ä»¥ä¸Šä»£ç éƒ½å·²ç»è§£é‡Šè¿‡äº†
        */</span>

        <span class="token comment">/*
        	TODO å…³äºåœ¨ GC æœŸé—´ä»€ä¹ˆæ—¶å€™å¯ä»¥æŠ¢å ï¼Œä»€ä¹ˆæ—¶å€™ç¦æ­¢æŠ¢å 
        	è¿˜éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ï¼Œç›®å‰å¯ä»¥å…ˆæŠŠæ•´ä¸ªæµç¨‹æ¢³ç†ä¸‹æ¥
        */</span>

        <span class="token comment">// Preemption must not occur here, or another G might see</span>
        <span class="token comment">// p.gcMarkWorkerMode.</span>

        <span class="token comment">// Disable preemption so we can use the gcw. If the</span>
        <span class="token comment">// scheduler wants to preempt us, we'll stop draining,</span>
        <span class="token comment">// dispose the gcw, and then preempt.</span>
        node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pp <span class="token operator">:=</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// P can't change with preemption disabled.</span>

        <span class="token comment">// æ˜¯å¦å·²å¼€å¯æ ‡è®°</span>
        <span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"worker mode"</span><span class="token punctuation">,</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode<span class="token punctuation">)</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcBgMarkWorker: blackening not enabled"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// æ£€æŸ¥ markworker çš„ Mode</span>
        <span class="token keyword">if</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">==</span> gcMarkWorkerNotWorker <span class="token punctuation">&#123;</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcBgMarkWorker: mode not set"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// è®°å½• worker æ ‡è®°çš„å¼€å§‹æ—¶é—´</span>
        startTime <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pp<span class="token punctuation">.</span>gcMarkWorkerStartTime <span class="token operator">=</span> startTime

        <span class="token comment">// å°†ç­‰å¾…æ‰§è¡Œçš„ worker æ•°é‡å‡ä¸€</span>
        decnwait <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>nwait<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> decnwait <span class="token operator">==</span> work<span class="token punctuation">.</span>nproc <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"runtime: work.nwait="</span><span class="token punctuation">,</span> decnwait<span class="token punctuation">,</span> <span class="token string">"work.nproc="</span><span class="token punctuation">,</span> work<span class="token punctuation">.</span>nproc<span class="token punctuation">)</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"work.nwait was > work.nproc"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Mark our goroutine preemptible so its stack</span>
            <span class="token comment">// can be scanned. This lets two mark workers</span>
            <span class="token comment">// scan each other (otherwise, they would</span>
            <span class="token comment">// deadlock). We must not modify anything on</span>
            <span class="token comment">// the G stack. However, stack shrinking is</span>
            <span class="token comment">// disabled for mark workers, so it is safe to</span>
            <span class="token comment">// read from the G stack.</span>
            <span class="token comment">// å…³äºè¿™é‡Œä¸ºä»€ä¹ˆæŠŠ G çš„ running çŠ¶æ€ä¿®æ”¹ä¸º waiting çŠ¶æ€</span>
            <span class="token comment">// TODO éœ€è¦è¿›ä¸€æ­¥çš„ç ”ç©¶ï¼Œæ›¹å¤§è¯´è¦ç»“åˆ suspendG æ¥çœ‹</span>
            <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunning<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">)</span>
            <span class="token keyword">switch</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token punctuation">&#123;</span>
                <span class="token keyword">default</span><span class="token punctuation">:</span>
                	<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcBgMarkWorker: unexpected gcMarkWorkerMode"</span><span class="token punctuation">)</span>
                <span class="token keyword">case</span> gcMarkWorkerDedicatedMode<span class="token punctuation">:</span>
                	<span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> gp<span class="token punctuation">.</span>preempt <span class="token punctuation">&#123;</span>
                        <span class="token comment">// We were preempted. This is</span>
                        <span class="token comment">// a useful signal to kick</span>
                        <span class="token comment">// everything out of the run</span>
                        <span class="token comment">// queue so it can run</span>
                        <span class="token comment">// somewhere else.</span>
                        <span class="token keyword">if</span> drainQ<span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token function">runqdrain</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
                            <span class="token function">globrunqputbatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drainQ<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token comment">// Go back to draining, this time</span>
                    <span class="token comment">// without preemption.</span>
                    <span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainFlushBgCredit<span class="token punctuation">)</span>
                <span class="token keyword">case</span> gcMarkWorkerFractionalMode<span class="token punctuation">:</span>
                	<span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainFractional<span class="token operator">|</span>gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
                <span class="token keyword">case</span> gcMarkWorkerIdleMode<span class="token punctuation">:</span>
                	<span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainIdle<span class="token operator">|</span>gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

        <span class="token comment">// Account for time.</span>
        duration <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime
        <span class="token keyword">switch</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> gcMarkWorkerDedicatedMode<span class="token punctuation">:</span>
                atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>dedicatedMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
                atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>dedicatedMarkWorkersNeeded<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">case</span> gcMarkWorkerFractionalMode<span class="token punctuation">:</span>
                atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>fractionalMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
                atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcFractionalMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
            <span class="token keyword">case</span> gcMarkWorkerIdleMode<span class="token punctuation">:</span>
                atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>idleMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Was this the last worker and did we run out</span>
        <span class="token comment">// of work?</span>
        incnwait <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>nwait<span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> incnwait <span class="token operator">></span> work<span class="token punctuation">.</span>nproc <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"runtime: p.gcMarkWorkerMode="</span><span class="token punctuation">,</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode<span class="token punctuation">,</span>
                    <span class="token string">"work.nwait="</span><span class="token punctuation">,</span> incnwait<span class="token punctuation">,</span> <span class="token string">"work.nproc="</span><span class="token punctuation">,</span> work<span class="token punctuation">.</span>nproc<span class="token punctuation">)</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"work.nwait > work.nproc"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// We'll releasem after this point and thus this P may run</span>
        <span class="token comment">// something else. We must clear the worker mode to avoid</span>
        <span class="token comment">// attributing the mode to a different (non-worker) G in</span>
        <span class="token comment">// traceGoStart.</span>
        pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerNotWorker

        <span class="token comment">// If this worker reached a background mark completion</span>
        <span class="token comment">// point, signal the main GC goroutine.</span>
        <span class="token keyword">if</span> incnwait <span class="token operator">==</span> work<span class="token punctuation">.</span>nproc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// We don't need the P-local buffers here, allow</span>
            <span class="token comment">// preemption becuse we may schedule like a regular</span>
            <span class="token comment">// goroutine in gcMarkDone (block on locks, etc).</span>
            <span class="token function">releasem</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>

            <span class="token function">gcMarkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>gcMarkWorker çš„çŠ¶æ€ï¼ˆdedicated, fractionï¼‰è¿™ä¸ªçŠ¶æ€æ˜¯ç»‘å®šåœ¨ P ä¸Šï¼Œå¹¶ä¸æ˜¯ G çš„çŠ¶æ€ã€‚</li>
</ul>
<h3 id="GC-æ ‡è®°çš„å‡ ä¸ªå·¥ä½œæ¨¡å¼"><a href="#GC-æ ‡è®°çš„å‡ ä¸ªå·¥ä½œæ¨¡å¼" class="headerlink" title="GC æ ‡è®°çš„å‡ ä¸ªå·¥ä½œæ¨¡å¼"></a>GC æ ‡è®°çš„å‡ ä¸ªå·¥ä½œæ¨¡å¼</h3><ol>
<li>gcDrainFlushBgCredit: æŠŠ bgMarkWorker ç§¯ç´¯çš„ credit åˆ·æ–°åˆ°å…¨å±€çš„ gcController ä¸­ã€‚</li>
<li>gcDrainFractional: self-preempt è¡¨ç¤ºåœ¨è¾¾åˆ° fractional åè‡ªåŠ¨é€€å‡ºã€‚</li>
<li>gcDrainUntilPreempt: ä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ°è¢«æŠ¢å ã€‚</li>
<li>gcDrainIdle: ä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ°å…¶ä»–ä»»åŠ¡è¦åšã€‚</li>
</ol>
<h3 id="bitmap-ä¸-ha-çš„æ˜ å°„å…³ç³»ï¼ˆæ ‡è®°è¿‡ç¨‹ç”¨åˆ°çš„ä½å›¾ï¼‰"><a href="#bitmap-ä¸-ha-çš„æ˜ å°„å…³ç³»ï¼ˆæ ‡è®°è¿‡ç¨‹ç”¨åˆ°çš„ä½å›¾ï¼‰" class="headerlink" title="bitmap ä¸ ha çš„æ˜ å°„å…³ç³»ï¼ˆæ ‡è®°è¿‡ç¨‹ç”¨åˆ°çš„ä½å›¾ï¼‰"></a>bitmap ä¸ ha çš„æ˜ å°„å…³ç³»ï¼ˆæ ‡è®°è¿‡ç¨‹ç”¨åˆ°çš„ä½å›¾ï¼‰</h3><h4 id="bitmap-çš„ä½¿ç”¨"><a href="#bitmap-çš„ä½¿ç”¨" class="headerlink" title="bitmap çš„ä½¿ç”¨"></a>bitmap çš„ä½¿ç”¨</h4><p>ä¸¤ä¸ªæ¯”ç‰¹è¡¨ç¤ºä¸€ä¸ªå­—</p>
<p>ha 64 Mï¼Œbitmap 2 Mï¼Œbitmap ä¸­çš„ä¸€ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤ºhaè¿ç»­4ä¸ªæŒ‡é’ˆçš„å†…å­˜å¤§å°ã€‚</p>
<p>0-4ï¼Œ1-5ï¼Œ 2-6ï¼Œ 3-7 </p>
<p>ä½ä½ bit ç”¨äºè¡¨ç¤ºæ˜¯å¦ä¸ºæŒ‡é’ˆï¼Œ0 ä¸ºéæŒ‡é’ˆï¼Œ1 ä¸ºæŒ‡é’ˆã€‚</p>
<p>é«˜ä½ bit ç”¨äºè¡¨ç¤ºæ˜¯å¦è¦ç»§ç»­æ‰«æè¯¥å¯¹è±¡ä¸­åç»­çš„å†…å®¹ï¼Œ0 ä¸ºä¸éœ€è¦ï¼Œ1 ä¸ºéœ€è¦ã€‚</p>
<p><img src="https://blogstatic.haohtml.com/uploads/2021/04/d2b5ca33bd970f64a6301fa75ae2eb22-6.png?x-oss-process=image/format,webp" alt="img"></p>
<h4 id="heapBitsForAddr"><a href="#heapBitsForAddr" class="headerlink" title="heapBitsForAddr"></a>heapBitsForAddr</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// heapBitsForAddr returns the heapBits for the address addr.</span>
<span class="token comment">// The caller must ensure addr is in an allocated span.</span>
<span class="token comment">// In particular, be careful not to point past the end of an object.</span>
<span class="token comment">//</span>
<span class="token comment">// nosplit because it is used during write barriers and must not be preempted.</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">heapBitsForAddr</span><span class="token punctuation">(</span>addr <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>h heapBits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 2 bits per word, 4 pairs per byte, and a mask is hard coded.</span>
    <span class="token comment">// å¦‚æ³¨é‡Šæ‰€è¯´ï¼Œä¸¤ä¸ªæ¯”ç‰¹å¯ä»¥ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå­—çš„å¤§å°</span>
    arena <span class="token operator">:=</span> <span class="token function">arenaIndex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    ha <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span>arenas<span class="token punctuation">[</span>arena<span class="token punctuation">.</span><span class="token function">l1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>arena<span class="token punctuation">.</span><span class="token function">l2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment">// The compiler uses a load for nil checking ha, but in this</span>
    <span class="token comment">// case we'll almost never hit that cache line again, so it</span>
    <span class="token comment">// makes more sense to do a value check.</span>
    <span class="token keyword">if</span> ha <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// addr is not in the heap. Return nil heapBits, which</span>
        <span class="token comment">// we expect to crash in the caller.</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ç¬”è€…ç†è§£ï¼šä¹‹æ‰€ä»¥è¦ *4ï¼Œå°±æ˜¯å› ä¸º bitmap ä¸ ha çš„æ˜ å°„å…³ç³»</span>
    <span class="token comment">// ä¸€å­—èŠ‚å¯ä»¥è¡¨ç¤ºå †ä¸Š 4 ä¸ªè¿ç»­çš„æŒ‡é’ˆå†…å­˜</span>
    h<span class="token punctuation">.</span>bitp <span class="token operator">=</span> <span class="token operator">&amp;</span>ha<span class="token punctuation">.</span>bitmap<span class="token punctuation">[</span><span class="token punctuation">(</span>addr<span class="token operator">/</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>PtrSize<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span>heapArenaBitmapBytes<span class="token punctuation">]</span>
    <span class="token comment">// ç¬”è€…ç†è§£ï¼šshift å°±åƒæ©ç ä¸€æ ·ï¼Œç”¨æ¥è®¡ç®—ä½ä½ä¸é«˜ä½æ¯”ç‰¹çš„ä½ç½®</span>
    <span class="token comment">// &amp;3 çš„è¿ç®—ä¹Ÿèƒ½è¯´æ˜è¿™ä¸€ç‚¹ï¼Œ&amp;3 çš„ç»“æœåªèƒ½æ˜¯ 0 1 2 3ï¼Œ</span>
    <span class="token comment">// è¿™é‡Œå°±å¯¹åº”ä¸Šäº† 8 æ¯”ç‰¹çš„ä½å››ä½</span>
    h<span class="token punctuation">.</span>shift <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">/</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment">// è®°å½•å½“å‰ arena çš„ä½ç½®</span>
    h<span class="token punctuation">.</span>arena <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>arena<span class="token punctuation">)</span>
    <span class="token comment">// è®°å½•å½“å‰ arena å¯¹åº”çš„ bitmap ä¸­çš„æœ€åä¸€å­—èŠ‚</span>
    h<span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token operator">&amp;</span>ha<span class="token punctuation">.</span>bitmap<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>ha<span class="token punctuation">.</span>bitmap<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// next returns the heapBits describing the next pointer-sized word in memory.</span>
<span class="token comment">// That is, if h describes address p, h.next() describes p+ptrSize.</span>
<span class="token comment">// Note that next does not modify h. The caller must record the result.</span>
<span class="token comment">//</span>
<span class="token comment">// å¦‚æ³¨é‡Šæ‰€æè¿°çš„ï¼Œnext å‡½æ•°ï¼Œè¿”å›æè¿°äº†åœ¨å†…å­˜ä¸­ä¸‹ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„wordçš„heapBits</span>
<span class="token comment">// å¦‚æœ h è¡¨ç¤ºçš„æ˜¯æŒ‡é’ˆ p çš„åœ°å€ï¼Œé‚£ä¹ˆ h.next() è¡¨ç¤ºçš„å°±æ˜¯ p+ptrSize çš„heapBits</span>
<span class="token comment">// nosplit because it is used during write barriers and must not be preempted.</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h heapBits<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> heapBits <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> h<span class="token punctuation">.</span>shift <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token operator">*</span>heapBitsShift <span class="token punctuation">&#123;</span> <span class="token comment">// åœ¨åŒä¸€å­—èŠ‚ä¸Šæ‰«æï¼Œå››ä¸ªè¿ç»­çš„ptrè¿˜æ²¡æ‰«æå®Œ</span>
        h<span class="token punctuation">.</span>shift <span class="token operator">+=</span> heapBitsShift
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> h<span class="token punctuation">.</span>bitp <span class="token operator">!=</span> h<span class="token punctuation">.</span>last <span class="token punctuation">&#123;</span>	<span class="token comment">// å¦‚æœæ²¡æ‰«æåˆ°è¯¥ bitmap çš„æœ€åä¸€å­—èŠ‚ï¼Œé‚£ä¹ˆæ‰«æä¸‹ä¸€ä¸ªbyte</span>
        h<span class="token punctuation">.</span>bitp<span class="token punctuation">,</span> h<span class="token punctuation">.</span>shift <span class="token operator">=</span> <span class="token function">add1</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>bitp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// æ­¤æ—¶ï¼Œå½“å‰å·²ç»æ‰«æå®Œäº†å½“å‰ ha çš„æ‰€æœ‰å†…å®¹ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª ha è¿›è¡Œæ‰«æ</span>
        <span class="token comment">// Move to the next arena.</span>
        <span class="token keyword">return</span> h<span class="token punctuation">.</span><span class="token function">nextArena</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> h
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="gcDrain-æ ‡è®°è¿‡ç¨‹"><a href="#gcDrain-æ ‡è®°è¿‡ç¨‹" class="headerlink" title="gcDrain æ ‡è®°è¿‡ç¨‹"></a>gcDrain æ ‡è®°è¿‡ç¨‹</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// gcDrain æ‰«æ work buffer ä¸­çš„æ ¹èŠ‚ç‚¹å’Œå¯¹è±¡ï¼Œ</span>
<span class="token comment">// gcDrain ä¼šå°†é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚</span>
<span class="token comment">// gcDrain å¯èƒ½åœ¨ GC ç»“æŸå‰è¿”å›ã€‚</span>
<span class="token comment">// gcDrain çš„è°ƒç”¨è€…è´Ÿè´£å¹³è¡¡å½“å‰ P ä¸ å…¶ä»– P çš„æ ‡è®°å·¥ä½œã€‚</span>
<span class="token comment">//go:nowritebarrier</span>
<span class="token keyword">func</span> <span class="token function">gcDrain</span><span class="token punctuation">(</span>gcw <span class="token operator">*</span>gcWork<span class="token punctuation">,</span> flags gcDrainFlags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>writeBarrier<span class="token punctuation">.</span>needed <span class="token punctuation">&#123;</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcDrain phase incorrect"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg
    preemptible <span class="token operator">:=</span> flags<span class="token operator">&amp;</span>gcDrainUntilPreempt <span class="token operator">!=</span> <span class="token number">0</span>
    flushBgCredit <span class="token operator">:=</span> flags<span class="token operator">&amp;</span>gcDrainFlushBgCredit <span class="token operator">!=</span> <span class="token number">0</span>
    idle <span class="token operator">:=</span> flags<span class="token operator">&amp;</span>gcDrainIdle <span class="token operator">!=</span> <span class="token number">0</span>

    initScanWork <span class="token operator">:=</span> gcw<span class="token punctuation">.</span>scanWork

    <span class="token comment">// checkWork is the scan work before performing the next</span>
    <span class="token comment">// self-preempt check.</span>
    checkWork <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">63</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> check <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token keyword">if</span> flags<span class="token operator">&amp;</span><span class="token punctuation">(</span>gcDrainIdle<span class="token operator">|</span>gcDrainFractional<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        checkWork <span class="token operator">=</span> initScanWork <span class="token operator">+</span> drainCheckThreshold
        <span class="token keyword">if</span> idle <span class="token punctuation">&#123;</span>
            check <span class="token operator">=</span> pollWork
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> flags<span class="token operator">&amp;</span>gcDrainFractional <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            check <span class="token operator">=</span> pollFractionalWorkerExit
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Drain root marking jobs.</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰æ ‡è®°çš„ä½ç½®æ˜¯å¦è¶…å‡ºäº†æ€»çš„æ ‡è®°æ•°é‡</span>
    <span class="token keyword">if</span> work<span class="token punctuation">.</span>markrootNext <span class="token operator">&lt;</span> work<span class="token punctuation">.</span>markrootJobs <span class="token punctuation">&#123;</span>
        <span class="token comment">// Stop if we're preemptible or if someone wants to STW.</span>
        <span class="token keyword">for</span> <span class="token operator">!</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>preempt <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>preemptible <span class="token operator">||</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>gcwaiting<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            job <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>markrootNext<span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">if</span> job <span class="token operator">>=</span> work<span class="token punctuation">.</span>markrootJobs <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// å¯¹ job ç´¢å¼•ä½ç½®çš„ root è¿›è¡Œæ ‡è®°å·¥ä½œ</span>
            <span class="token function">markroot</span><span class="token punctuation">(</span>gcw<span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token comment">// å®Œæˆä¸€ä¸ªæ ¹çš„æ ‡è®°å·¥ä½œï¼Œå°±å»æ£€æŸ¥</span>
            <span class="token comment">// TODO æ˜¯å¦è¾¾åˆ°äº† fractional æˆ–è€… å…¶ä»–</span>
            <span class="token keyword">if</span> check <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">goto</span> done
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Drain heap marking jobs.</span>
    <span class="token comment">// Stop if we're preemptible or if someone wants to STW.</span>
    <span class="token keyword">for</span> <span class="token operator">!</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>preempt <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>preemptible <span class="token operator">||</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>gcwaiting<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Try to keep work available on the global queue. We used to</span>
        <span class="token comment">// check if there were waiting workers, but it's better to</span>
        <span class="token comment">// just keep work available than to make workers wait. In the</span>
        <span class="token comment">// worst case, we'll do O(log(_WorkbufSize)) unnecessary</span>
        <span class="token comment">// balances.</span>
        <span class="token comment">// å¹³è¡¡æ ‡è®°å·¥ä½œï¼Œè®©å®ƒæœ‰æ´»å¯å¹²æ¯”è®©å®ƒç­‰ç€è¦å¥½</span>
        <span class="token keyword">if</span> work<span class="token punctuation">.</span>full <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            gcw<span class="token punctuation">.</span><span class="token function">balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
		
        <span class="token comment">// ä» gcw é˜Ÿåˆ—ä¸­å–å€¼</span>
        b <span class="token operator">:=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGetFast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Flush the write barrier</span>
                <span class="token comment">// buffer; this may create</span>
                <span class="token comment">// more work.</span>
                å¦‚æœè¯´ wbuf ä¸­éƒ½æ²¡æœ‰ï¼Œå°†
                <span class="token function">wbBufFlush</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                b <span class="token operator">=</span> gcw<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Unable to get work.</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">scanobject</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> gcw<span class="token punctuation">)</span>

        <span class="token comment">// Flush background scan work credit to the global</span>
        <span class="token comment">// account if we've accumulated enough locally so</span>
        <span class="token comment">// mutator assists can draw on it.</span>
        <span class="token keyword">if</span> gcw<span class="token punctuation">.</span>scanWork <span class="token operator">>=</span> gcCreditSlack <span class="token punctuation">&#123;</span>
            atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>scanWork<span class="token punctuation">,</span> gcw<span class="token punctuation">.</span>scanWork<span class="token punctuation">)</span>
            <span class="token keyword">if</span> flushBgCredit <span class="token punctuation">&#123;</span>
                <span class="token function">gcFlushBgCredit</span><span class="token punctuation">(</span>gcw<span class="token punctuation">.</span>scanWork <span class="token operator">-</span> initScanWork<span class="token punctuation">)</span>
                initScanWork <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token punctuation">&#125;</span>
            checkWork <span class="token operator">-=</span> gcw<span class="token punctuation">.</span>scanWork
            gcw<span class="token punctuation">.</span>scanWork <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token keyword">if</span> checkWork <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                checkWork <span class="token operator">+=</span> drainCheckThreshold
                <span class="token keyword">if</span> check <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    done<span class="token punctuation">:</span>
    <span class="token comment">// Flush remaining scan work credit.</span>
    <span class="token keyword">if</span> gcw<span class="token punctuation">.</span>scanWork <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>scanWork<span class="token punctuation">,</span> gcw<span class="token punctuation">.</span>scanWork<span class="token punctuation">)</span>
        <span class="token keyword">if</span> flushBgCredit <span class="token punctuation">&#123;</span>
            <span class="token function">gcFlushBgCredit</span><span class="token punctuation">(</span>gcw<span class="token punctuation">.</span>scanWork <span class="token operator">-</span> initScanWork<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        gcw<span class="token punctuation">.</span>scanWork <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="æ ‡è®°å·¥ä½œçš„å¹³è¡¡"><a href="#æ ‡è®°å·¥ä½œçš„å¹³è¡¡" class="headerlink" title="æ ‡è®°å·¥ä½œçš„å¹³è¡¡"></a>æ ‡è®°å·¥ä½œçš„å¹³è¡¡</h4><h5 id="balance"><a href="#balance" class="headerlink" title="balance"></a>balance</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// balance moves some work that's cached in this gcWork back on the</span>
<span class="token comment">// global queue.</span>
<span class="token comment">// å°†ç¼“å­˜åœ¨ P gcw ä¸Šçš„æ ‡è®°ä»»åŠ¡ï¼Œé€‚å½“çš„ç§»åŠ¨åˆ°å…¨å±€queueä¸­</span>
<span class="token comment">//go:nowritebarrierrec</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>gcWork<span class="token punctuation">)</span> <span class="token function">balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// å¦‚æœ P çš„æœ¬åœ° wbf æ²¡æœ‰æ ‡è®°ä»»åŠ¡ï¼Œç›´æ¥è¿”å›</span>
    <span class="token keyword">if</span> w<span class="token punctuation">.</span>wbuf1 <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/*
   	1.å…ˆå¤„ç† wbuf2 ä¸­çš„æ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œå°†æ•°æ®æ”¾å…¥åˆ°
   	å…¨å±€ work full é˜Ÿåˆ—ä¸­
   	2.æŸ¥çœ‹ wbuf1 ä¸­å¯¹è±¡æ•°é‡ï¼Œè¶…è¿‡å››ä¸ªï¼Œæ‰§è¡Œ handoff
   */</span>
    <span class="token keyword">if</span> wbuf <span class="token operator">:=</span> w<span class="token punctuation">.</span>wbuf2<span class="token punctuation">;</span> wbuf<span class="token punctuation">.</span>nobj <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token function">putfull</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">)</span>
        w<span class="token punctuation">.</span>flushedWork <span class="token operator">=</span> <span class="token boolean">true</span>
        w<span class="token punctuation">.</span>wbuf2 <span class="token operator">=</span> <span class="token function">getempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> wbuf <span class="token operator">:=</span> w<span class="token punctuation">.</span>wbuf1<span class="token punctuation">;</span> wbuf<span class="token punctuation">.</span>nobj <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">&#123;</span>
        w<span class="token punctuation">.</span>wbuf1 <span class="token operator">=</span> <span class="token function">handoff</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">)</span>
        w<span class="token punctuation">.</span>flushedWork <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// handoff did putfull</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// We flushed a buffer to the full list, so wake a worker.</span>
    <span class="token keyword">if</span> gcphase <span class="token operator">==</span> _GCmark <span class="token punctuation">&#123;</span>
        gcController<span class="token punctuation">.</span><span class="token function">enlistWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="enlistWorker"><a href="#enlistWorker" class="headerlink" title="enlistWorker"></a>enlistWorker</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// enlistWorker encourages another dedicated mark worker to start on</span>
<span class="token comment">// another P if there are spare worker slots. It is used by putfull</span>
<span class="token comment">// when more work is made available.</span>
<span class="token comment">//</span>
<span class="token comment">//go:nowritebarrier</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>gcControllerState<span class="token punctuation">)</span> <span class="token function">enlistWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// If there are idle Ps, wake one so it will run an idle worker.</span>
    <span class="token comment">// NOTE: This is suspected of causing deadlocks. See golang.org/issue/19112.</span>
    <span class="token comment">//</span>
    <span class="token comment">// if atomic.Load(&amp;sched.npidle) != 0 &amp;&amp; atomic.Load(&amp;sched.nmspinning) == 0 &#123;</span>
    <span class="token comment">//    wakep()</span>
    <span class="token comment">//    return</span>
    <span class="token comment">// &#125;</span>

    <span class="token comment">// There are no idle Ps. If we need more dedicated workers,</span>
    <span class="token comment">// try to preempt a running P so it will switch to a worker.</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>dedicatedMarkWorkersNeeded <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Pick a random other P to preempt.</span>
    <span class="token keyword">if</span> gomaxprocs <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> gp<span class="token punctuation">.</span>m <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    myID <span class="token operator">:=</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id
    <span class="token keyword">for</span> tries <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> tries <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> tries<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
        id <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">fastrandn</span><span class="token punctuation">(</span><span class="token function">uint32</span><span class="token punctuation">(</span>gomaxprocs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> id <span class="token operator">>=</span> myID <span class="token punctuation">&#123;</span>
            id<span class="token operator">++</span>
        <span class="token punctuation">&#125;</span>
        p <span class="token operator">:=</span> allp<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>status <span class="token operator">!=</span> _Prunning <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// æ‰§è¡ŒæŠ¢å </span>
        <span class="token keyword">if</span> <span class="token function">preemptone</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹    ä¸çŸ¥é“ä½ ä»¬æƒ³æ²¡æƒ³è¿‡è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œé€šè¿‡ preemptone å‡½æ•°è¿›è¡ŒæŠ¢å ï¼Œæ˜¯æ€ä¹ˆåšåˆ°å»å¯åŠ¨ä¸€ä¸ª gcMarkWorker çš„ï¼Ÿ</p>
<p>â€‹    å¦‚æœä½ æ²¡æƒ³åˆ°çš„è¯ï¼Œç»™ä½ ä¸€ç‚¹æç¤ºï¼Œå’Œè°ƒåº¦å¾ªç¯ç›¸å…³ã€‚</p>
<h5 id="handoff"><a href="#handoff" class="headerlink" title="handoff"></a>handoff</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// åœ¨ wbuf ä¸­å¯¹è±¡æ•°é‡å¤§äº 4 æ—¶ï¼Œå°†å‰ä¸€åŠæ”¾å…¥åˆ°å…¨å±€ work full é˜Ÿåˆ—ä¸­</span>
<span class="token comment">//go:nowritebarrier</span>
<span class="token keyword">func</span> <span class="token function">handoff</span><span class="token punctuation">(</span>b <span class="token operator">*</span>workbuf<span class="token punctuation">)</span> <span class="token operator">*</span>workbuf <span class="token punctuation">&#123;</span>
    <span class="token comment">// Make new buffer with half of b's pointers.</span>
    b1 <span class="token operator">:=</span> <span class="token function">getempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    n <span class="token operator">:=</span> b<span class="token punctuation">.</span>nobj <span class="token operator">/</span> <span class="token number">2</span>
    b<span class="token punctuation">.</span>nobj <span class="token operator">-=</span> n
    b1<span class="token punctuation">.</span>nobj <span class="token operator">=</span> n
    <span class="token comment">// é€šè¿‡è·å–ä¸€ä¸ªæ–°çš„ empty workbuf</span>
    <span class="token comment">// å°†å‰ä¸€åŠæ”¾è¿›å»</span>
    <span class="token function">memmove</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b1<span class="token punctuation">.</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>obj<span class="token punctuation">[</span>b<span class="token punctuation">.</span>nobj<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>b1<span class="token punctuation">.</span>obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// Put b on full list - let first half of b get stolen.</span>
    <span class="token function">putfull</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token keyword">return</span> b1
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="GC-è¿‡ç¨‹ä¸­-P-çš„-gcw-é˜Ÿåˆ—"><a href="#GC-è¿‡ç¨‹ä¸­-P-çš„-gcw-é˜Ÿåˆ—" class="headerlink" title="GC è¿‡ç¨‹ä¸­ P çš„ gcw é˜Ÿåˆ—"></a>GC è¿‡ç¨‹ä¸­ P çš„ gcw é˜Ÿåˆ—</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> P <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment">// gcw is this P's GC work buffer cache. The work buffer is</span>
    <span class="token comment">// filled by write barriers, drained by mutator assists, and</span>
    <span class="token comment">// disposed on certain GC state transitions.</span>
    gcw gcWork
    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»¥ä¸‹æ˜¯ Go å®˜æ–¹å¯¹ gcw çš„æè¿°ï¼š</p>
<p>ä¸ºç°è‰²æŒ‡é’ˆå¯¹è±¡å®ç°äº†ä¸€ä¸ªç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å‹ã€‚å¯¹è±¡è¢«æ ‡è®°ä¸ºç°è‰²åï¼Œæ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚å¯¹è±¡è¢«æ ‡è®°ä¸ºé»‘è‰²åï¼Œä¼šåœ¨é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</p>
<p>å†™å±éšœï¼Œæ ¹èŠ‚ç‚¹æ‰«æï¼Œæ ˆæ‰«æå’Œå¯¹è±¡æ‰«æè¿‡ç¨‹ä¼šäº§ç”Ÿç°è‰²å¯¹è±¡ã€‚scanning è¿‡ç¨‹ä¼šæ¶ˆè´¹ç°è‰²å¯¹è±¡çš„æŒ‡é’ˆå¹¶ä¸”æœ‰å¯èƒ½äº§ç”Ÿæ–°çš„ç°è‰²å¯¹è±¡æŒ‡é’ˆã€‚</p>
<p>gcWork ä¸ºåƒåœ¾å›æ”¶å™¨æä¾›äº†ä¸€ä¸ªç”Ÿäº§å’Œæ¶ˆè´¹çš„æ¥å£ã€‚</p>
<p>å¯ä»¥åœ¨ stack ä¸Šè¿™æ ·ä½¿ç”¨ gcWorkï¼š</p>
<ul>
<li>è°ƒç”¨ gcw.Put() è¿›è¡Œç”Ÿäº§ï¼Œè°ƒç”¨ gcw.tryGet() è¿›è¡Œæ¶ˆè´¹ã€‚</li>
</ul>
<p>é‡è¦çš„æ˜¯ï¼Œåœ¨ mark phase ä½¿ç”¨ gcWork å¯ä»¥é˜»æ­¢åƒåœ¾å›æ”¶å™¨ä» transitioning è½¬å˜ä¸º mark termination å› ä¸º gcWork å¯èƒ½åœ¨æœ¬åœ°ä¿å­˜ GC work buffersã€‚è¿™å¯ä»¥é€šè¿‡ç¦ç”¨æŠ¢å æ¥å®Œæˆã€‚</p>
<h5 id="wbuf1-å’Œ-wbuf2"><a href="#wbuf1-å’Œ-wbuf2" class="headerlink" title="wbuf1 å’Œ wbuf2"></a>wbuf1 å’Œ wbuf2</h5><p>å¯ä»¥å°† wbuf1 å’Œ wbuf2 æƒ³è±¡æˆä¸€å—æ ˆç©ºé—´ï¼Œç„¶åè¿™ä¿©è½®æµä½¿ç”¨ã€‚</p>
<p>å½“æˆ‘ä»¬å¼¹å‡ºé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæŒ‡é’ˆæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡å¼•å…¥ä¸€ä¸ªæ–°çš„ç¼“å†²åŒºå¹¶ä¸¢å¼ƒä¸€ä¸ªç©ºç¼“å†²åŒºï¼ˆäº¤æ¢è¿™ä¸¤ä¸ªç¼“å†²åŒºï¼‰ï¼Œç„¶åå°† stack å‘ä¸Šç§»åŠ¨ä¸€ä¸ªæ–° bufferã€‚ å½“æˆ‘ä»¬å°†bufferséƒ½å¡«æ»¡äº†ï¼Œæˆ‘ä»¬é€šè¿‡å¼•å…¥ä¸€ä¸ªæ–°çš„ç©ºç¼“å†²åŒºå¹¶ä¸¢å¼ƒé‚£ä¸ªæ»¡çš„ç¼“å†²åŒºï¼Œç„¶åå°†stackå‘ä¸‹ç§»åŠ¨ä¸€ä¸ªæ–° bufferã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªç¼“å†²åŒºçš„æ»åå€¼ï¼Œå®ƒå¯ä»¥å°†è·å–æˆ–æ”¾ç½®å·¥ä½œç¼“å†²åŒºçš„æˆæœ¬åˆ†æ‘Šåˆ°è‡³å°‘ä¸€ä¸ªå·¥ä½œç¼“å†²åŒºä¸Šï¼Œå¹¶å‡å°‘å…¨å±€å·¥ä½œåˆ—è¡¨ä¸Šçš„äº‰ç”¨ã€‚</p>
<p>wbuf1 æ°¸è¿œéƒ½æ˜¯æˆ‘ä»¬æ­£åœ¨æ“ä½œçš„é‚£ä¸ª bufferï¼Œwbuf2 æ˜¯æ¥ä¸‹æ¥è¦ä¸¢å¼ƒçš„ç¼“å†²åŒºã€‚</p>
<p>æ€»ç»“ï¼š</p>
<p>wbuf1 å’Œ wbuf2 éƒ½æ˜¯ç”¨æ¥å­˜å‚¨ç°è‰²æŒ‡é’ˆçš„ï¼Œwbuf1 æ˜¯æˆ‘ä»¬çœŸæ­£æ“ä½œçš„é‚£ä¸ªé˜Ÿåˆ—ï¼Œå…¥é˜Ÿå‡ºé˜Ÿæ“ä½œçš„éƒ½æ˜¯å®ƒï¼Œwbuf2 èµ·åˆ°çš„æ˜¯æ›¿æ¢ä½œç”¨ï¼Œå½“ wbuf1 ç©ºäº†ï¼Œæ›¿æ¢ wbuf2ï¼Œå½“ wbuf1 æ»¡äº†ï¼Œæ›¿æ¢ wbuf2ã€‚</p>
<h5 id="work-full-å’Œ-work-empty"><a href="#work-full-å’Œ-work-empty" class="headerlink" title="work.full å’Œ work.empty"></a>work.full å’Œ work.empty</h5><p>å…¨å±€ work ä¸­æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œfull å’Œ emptyï¼Œç°è‰²å¯¹è±¡å…¥é˜Ÿè¿‡ç¨‹ï¼š</p>
<p>fastPath: æ£€æŸ¥ wbuf1 æ˜¯å¦ä¸ºç©ºï¼Œæ˜¯å¦æ»¡äº†ï¼Œæ˜¯å°±è¿”å›ï¼›éƒ½ä¸æ˜¯ï¼Œå°†ç°è‰²å¯¹è±¡å…¥é˜Ÿã€‚<br>slowPathï¼šæ£€æŸ¥ wbuf1 æ˜¯å¦ä¸º nilï¼Œä¸º nilï¼Œæ‰§è¡Œåˆå§‹åŒ–ã€‚å¦åˆ™ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡äº†ï¼Œæ»¡äº†ï¼Œäº¤æ¢ wbuf1 å’Œ wbuf2ï¼Œå†æ¬¡åˆ¤æ–­ wbuf1 æ˜¯å¦æ»¡äº†ï¼Œæ»¡äº†åŠ å…¥åˆ°å…¨å±€ full é˜Ÿåˆ—ä¸­ï¼Œç„¶åä» empty é˜Ÿåˆ—è·å–ä¸€ä¸ªç©ºçš„å¹¶èµ‹å€¼ç»™ wbuf1ï¼Œæœ€åæŠŠè¿™ä¸ªç°è‰²å¯¹è±¡å…¥é˜Ÿã€‚</p>
<h4 id="GC-è¿‡ç¨‹ä¸­è´Ÿè´£æ ‡è®°çš„å‡½æ•°"><a href="#GC-è¿‡ç¨‹ä¸­è´Ÿè´£æ ‡è®°çš„å‡½æ•°" class="headerlink" title="GC è¿‡ç¨‹ä¸­è´Ÿè´£æ ‡è®°çš„å‡½æ•°"></a>GC è¿‡ç¨‹ä¸­è´Ÿè´£æ ‡è®°çš„å‡½æ•°</h4><h5 id="markroot"><a href="#markroot" class="headerlink" title="markroot"></a>markroot</h5><p>markroot ä¸»è¦æ˜¯æ ¹æ®ä¸åŒçš„ i æ¥å®šä½è¦æ‰«æå“ªäº›åŒºåŸŸï¼Œå½“ i == 0 ï¼Œi == 1 æ—¶ï¼Œå¯¹åº”åˆ°ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼Œå…·ä½“çš„å«ä¹‰æš‚æ—¶è¿˜ä¸æ¸…æ™°ã€‚</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// TODO äº†è§£è¿™ä¸¤ç§åˆ†åˆ«æ˜¯ä»€ä¹ˆ</span>
<span class="token keyword">case</span> i <span class="token operator">==</span> fixedRootFinalizers<span class="token punctuation">:</span>
   <span class="token keyword">for</span> fb <span class="token operator">:=</span> allfin<span class="token punctuation">;</span> fb <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> fb <span class="token operator">=</span> fb<span class="token punctuation">.</span>alllink <span class="token punctuation">&#123;</span>
      cnt <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fb<span class="token punctuation">.</span>cnt<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">scanblock</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fb<span class="token punctuation">.</span>fin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cnt<span class="token operator">*</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>fb<span class="token punctuation">.</span>fin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>finptrmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gcw<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span>

<span class="token keyword">case</span> i <span class="token operator">==</span> fixedRootFreeGStacks<span class="token punctuation">:</span>
   <span class="token comment">// Switch to the system stack so we can call</span>
   <span class="token comment">// stackfree.</span>
   <span class="token function">systemstack</span><span class="token punctuation">(</span>markrootFreeGStacks<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="scanobject"><a href="#scanobject" class="headerlink" title="scanobject"></a>scanobject</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// scanobject scans the object starting at b, adding pointers to gcw.</span>
<span class="token comment">// b must point to the beginning of a heap object or an oblet.</span>
<span class="token comment">// scanobject consults the GC bitmap for the pointer mask and the</span>
<span class="token comment">// spans for the size of the object.</span>
<span class="token comment">//</span>
<span class="token comment">// å¦‚æ³¨é‡Šæ‰€å†™ï¼Œscanobject æ‰«æä» b ä¸ºèµ·å§‹åœ°å€çš„å¯¹è±¡ï¼Œå¹¶æ·»åŠ æŒ‡é’ˆåˆ° gcw é˜Ÿåˆ—ä¸­ã€‚</span>
<span class="token comment">// b å¿…é¡»æŒ‡å‘å †å¯¹è±¡çš„èµ·å§‹åœ°å€ï¼Œæˆ–è€…ä¸€ä¸ª obletã€‚</span>
<span class="token comment">//go:nowritebarrier</span>
<span class="token keyword">func</span> <span class="token function">scanobject</span><span class="token punctuation">(</span>b <span class="token builtin">uintptr</span><span class="token punctuation">,</span> gcw <span class="token operator">*</span>gcWork<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Find the bits for b and the size of the object at b.</span>
    <span class="token comment">//</span>
    <span class="token comment">// b is either the beginning of an object, in which case this</span>
    <span class="token comment">// is the size of the object to scan, or it points to an</span>
    <span class="token comment">// oblet, in which case we compute the size to scan below.</span>
    <span class="token comment">// è¿™ä¸ªå‡½æ•°å‰è¾¹å·²ç»è¯¦ç»†çš„åˆ†æè¿‡äº†ï¼Œæ²¡å•¥å¥½è¯´çš„</span>
    hbits <span class="token operator">:=</span> <span class="token function">heapBitsForAddr</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token comment">// æ‰¾åˆ°æŒ‡é’ˆ b å¯¹åº”çš„ mspan</span>
    s <span class="token operator">:=</span> <span class="token function">spanOfUnchecked</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token comment">// s.elemsize è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª object çš„å¤§å°</span>
    n <span class="token operator">:=</span> s<span class="token punctuation">.</span>elemsize
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"scanobject n == 0"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/*
		è¿™é‡Œå¯¹å¤§å¯¹è±¡ï¼ˆè¿™é‡Œçš„å¤§å¯¹è±¡ä¸å†…å­˜åˆ†é…çš„æœ‰äº›è®¸å·®å¼‚
		å†…å­˜åˆ†é…å¤§å¯¹è±¡æŒ‡çš„æ˜¯å¤§äº32KBçš„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯å¤§äº 128KBçš„ï¼‰
		è¿›è¡Œäº†è¿›ä¸€æ­¥çš„åŒºåˆ†
		maxobletBytes = 128 &lt;&lt; 10 = 128 KB
		æ„å‘³ç€ï¼Œå½“å‰ obj çš„å¤§å°è¶…è¿‡äº† 128 KB
		è¦è¿›è¡Œä¸€äº›ä¼˜åŒ–æ“ä½œ
	*/</span>
    <span class="token keyword">if</span> n <span class="token operator">></span> maxObletBytes <span class="token punctuation">&#123;</span>
        <span class="token comment">// Large object. Break into oblets for better</span>
        <span class="token comment">// parallelism and lower latency.</span>
        <span class="token keyword">if</span> b <span class="token operator">==</span> s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// It's possible this is a noscan object (not</span>
            <span class="token comment">// from greyobject, but from other code</span>
            <span class="token comment">// paths), in which case we must *not* enqueue</span>
            <span class="token comment">// oblets since their bitmaps will be</span>
            <span class="token comment">// uninitialized.</span>
            <span class="token keyword">if</span> s<span class="token punctuation">.</span>spanclass<span class="token punctuation">.</span><span class="token function">noscan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Bypass the whole scan.</span>
                gcw<span class="token punctuation">.</span>bytesMarked <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Enqueue the other oblets to scan later.</span>
            <span class="token comment">// Some oblets may be in b's scalar tail, but</span>
            <span class="token comment">// these will be marked as "no more pointers",</span>
            <span class="token comment">// so we'll drop out immediately when we go to</span>
            <span class="token comment">// scan those.</span>
            <span class="token keyword">for</span> oblet <span class="token operator">:=</span> b <span class="token operator">+</span> maxObletBytes<span class="token punctuation">;</span> oblet <span class="token operator">&lt;</span> s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>s<span class="token punctuation">.</span>elemsize<span class="token punctuation">;</span> oblet <span class="token operator">+=</span> maxObletBytes <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>gcw<span class="token punctuation">.</span><span class="token function">putFast</span><span class="token punctuation">(</span>oblet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    gcw<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>oblet<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Compute the size of the oblet. Since this object</span>
        <span class="token comment">// must be a large object, s.base() is the beginning</span>
        <span class="token comment">// of the object.</span>
        n <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> s<span class="token punctuation">.</span>elemsize <span class="token operator">-</span> b
        <span class="token keyword">if</span> n <span class="token operator">></span> maxObletBytes <span class="token punctuation">&#123;</span>
            n <span class="token operator">=</span> maxObletBytes
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">var</span> i <span class="token builtin">uintptr</span>
    <span class="token comment">// i &lt; n è¯´æ˜ mspan ä¸­ï¼Œåªå¯¹å½“å‰è¿™ä¸ªå¯¹è±¡è¿›è¡Œæ‰«æ</span>
    <span class="token comment">// æ‰§è¡Œå®Œä¸€æ¬¡ for å¾ªç¯ï¼Œå¹¶ä¸æ„å‘³ç€æ‰«æå®Œå½“å‰è¿™ä¸ªå¯¹è±¡äº†</span>
    <span class="token comment">// åªæ˜¯æ£€æŸ¥äº†å½“å‰ä¸¤ä¸ªæ¯”ç‰¹å¯¹åº”çš„ä¸€ä¸ªå­—</span>
    <span class="token comment">// é™¤éå½“å‰è¿™ä¸ªå¯¹è±¡æ˜¯ä¸éœ€è¦æ‰«æçš„å³ï¼Œbits&amp;bitScan == 0</span>
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token punctuation">,</span> hbits <span class="token operator">=</span> i<span class="token operator">+</span>sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">,</span> hbits<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Load bits once. See CL 22712 and issue 16973 for discussion.</span>
        bits <span class="token operator">:=</span> hbits<span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// è¿™é‡Œçš„ä¸¤ä¸ª if åˆ¤æ–­å°±å¥½åƒä¸¤ä¸ªå¡å°º</span>
        <span class="token comment">// åˆ†åˆ«å¯¹é«˜ä½å’Œä½ä½è¿›è¡Œæ£€æŸ¥</span>
        <span class="token keyword">if</span> bits<span class="token operator">&amp;</span>bitScan <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span> <span class="token comment">// no more pointers in this object</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> bits<span class="token operator">&amp;</span>bitPointer <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span> <span class="token comment">// not a pointer</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Work here is duplicated in scanblock and above.</span>
        <span class="token comment">// If you make changes here, make changes there too.</span>
        <span class="token comment">/*
			è®¾ fakeObj = (*uintptr)(unsafe.Pointer(b + i))
			å¯¹ fakeObj è§£å¼•ç”¨ --> *fakeObj
            	1.è§£å‡ºæ¥ç»“æœ != 0ï¼Œè¯´æ˜æ˜¯ä¸€ä¸ªæŒ‡é’ˆ
            	2.è§£å‡ºæ¥ç»“æœ == 0ï¼Œè¯´æ˜ç»“æœä¸º nil
        */</span>
        obj <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>


        <span class="token comment">// At this point we have extracted the next potential pointer.</span>
        <span class="token comment">// Quickly filter out nil and pointers back to the current object.</span>
        <span class="token comment">// å¦‚æœ obj æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸”æŒ‡å‘çš„ä¸æ˜¯å½“å‰ object</span>
        <span class="token comment">// ç¬”è€…ç†è§£ï¼šä¹‹æ‰€ä»¥è¦è¿‡æ»¤æ‰å½“å‰çš„ objectï¼Œ</span>
        <span class="token comment">// æ˜¯å› ä¸ºå½“å‰è¿™ä¸ª object å°±æ˜¯ä» gcw é˜Ÿåˆ—ä¸­å–å‡ºæ¥çš„</span>
        <span class="token comment">// æ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦å†å¯¹è¯¥ obj è¿›è¡Œæ ‡è®°ï¼ˆå…¥é˜Ÿï¼‰</span>
        <span class="token keyword">if</span> obj <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> obj<span class="token operator">-</span>b <span class="token operator">>=</span> n <span class="token punctuation">&#123;</span>
            <span class="token comment">// Test if obj points into the Go heap and, if so,</span>
            <span class="token comment">// mark the object.</span>
            <span class="token comment">// æ£€æŸ¥ obj æ˜¯å¦æŒ‡å‘äº† Go çš„å †ï¼Œå¦‚æœæ˜¯ï¼Œå¯¹è¿™ä¸ª obj è¿›è¡Œæ ‡è®°</span>
            <span class="token comment">//</span>
            <span class="token comment">// Note that it's possible for findObject to</span>
            <span class="token comment">// fail if obj points to a just-allocated heap</span>
            <span class="token comment">// object because of a race with growing the</span>
            <span class="token comment">// heap. In this case, we know the object was</span>
            <span class="token comment">// just allocated and hence will be marked by</span>
            <span class="token comment">// allocation itself.</span>
            <span class="token keyword">if</span> obj<span class="token punctuation">,</span> span<span class="token punctuation">,</span> objIndex <span class="token operator">:=</span> <span class="token function">findObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> b<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> obj <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                <span class="token function">greyobject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> b<span class="token punctuation">,</span> i<span class="token punctuation">,</span> span<span class="token punctuation">,</span> gcw<span class="token punctuation">,</span> objIndex<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// è®°å½•åˆšåˆšè¢«æ‰«æçš„ obj å¤§å°</span>
    gcw<span class="token punctuation">.</span>bytesMarked <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token comment">// ç§¯ç´¯ creditï¼Œåˆ°äº† 2000 å°±æ›´æ–°åˆ°å…¨å±€ gcCrontroller ä¸­</span>
    gcw<span class="token punctuation">.</span>scanWork <span class="token operator">+=</span> <span class="token function">int64</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="findObject"><a href="#findObject" class="headerlink" title="findObject"></a>findObject</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">/*
	å‚æ•°è§£é‡Šï¼š
		refBase, refOff ä¸»è¦ panic ç”¨
	è¿”å›å€¼è§£é‡Šï¼š
		base: è¡¨ç¤º p æŒ‡é’ˆæ‰€åœ¨å¯¹è±¡ï¼Œåœ¨å †ä¸­çš„èµ·å§‹åœ°å€
		s: è¡¨ç¤º p æŒ‡é’ˆæ‰€åœ¨çš„ mspan
		objIndex: è¡¨ç¤ºåŒ…å« p æŒ‡é’ˆçš„å¯¹è±¡åœ¨ mspan ä¸­çš„ä½ç½®
*/</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">findObject</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> refBase<span class="token punctuation">,</span> refOff <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>base <span class="token builtin">uintptr</span><span class="token punctuation">,</span> s <span class="token operator">*</span>mspan<span class="token punctuation">,</span> objIndex <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    s <span class="token operator">=</span> <span class="token function">spanOf</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>

    <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// çœç•¥æ£€æŸ¥ä»£ç </span>
    
    objIndex <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">objIndex</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    base <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> objIndex<span class="token operator">*</span>s<span class="token punctuation">.</span>elemsize
    <span class="token keyword">return</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="markrootBlock"><a href="#markrootBlock" class="headerlink" title="markrootBlock"></a>markrootBlock</h5><h5 id="markrootFreeGStacks"><a href="#markrootFreeGStacks" class="headerlink" title="markrootFreeGStacks"></a>markrootFreeGStacks</h5><h5 id="markrootSpans"><a href="#markrootSpans" class="headerlink" title="markrootSpans"></a>markrootSpans</h5><h5 id="scanstack"><a href="#scanstack" class="headerlink" title="scanstack"></a>scanstack</h5><p>æ‰«æ goroutine æ ˆ</p>
<h5 id="scanblock"><a href="#scanblock" class="headerlink" title="scanblock"></a>scanblock</h5><h5 id="gcmarknewobject"><a href="#gcmarknewobject" class="headerlink" title="gcmarknewobject"></a>gcmarknewobject</h5><h5 id="gcMarkTinyAllocs"><a href="#gcMarkTinyAllocs" class="headerlink" title="gcMarkTinyAllocs"></a>gcMarkTinyAllocs</h5><h2 id="gcMarkDone"><a href="#gcMarkDone" class="headerlink" title="gcMarkDone"></a>gcMarkDone</h2><p>gcMarkDone æ˜¯ä¸€ä¸ªè¿‡åº¦çš„å‡½æ•°ï¼Œæ˜¯ç”± _GCMark åˆ° _GCMarkTermination çŠ¶æ€è½¬æ¢å‰è¦åšçš„ä¸€äº›å¤„ç†ã€‚æ­¤å¤–ï¼ŒgcMarkDone ä¸­ä¼šå¤„ç† writebarrier bufferï¼Œå¦‚æœè¿™æ—¶å€™å°†æ•°æ®å†™å…¥åˆ°äº†å…¨å±€çš„æ ‡è®°é˜Ÿåˆ—ä¸­ï¼Œé‚£è¿˜éœ€è¦ç»§ç»­æ‰§è¡Œæ ‡è®°å·¥ä½œã€‚</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// å¦‚æœæ‰€æœ‰çš„å¯è¾¾å¯¹è±¡éƒ½å·²ç»è¢«æ ‡è®°äº†ï¼ˆæ„å‘³ç€æ²¡æœ‰ä»»ä½•ç°è‰²å¯¹è±¡å¹¶ä¸”å°†æ¥ä¹Ÿä¸ä¼šæœ‰ï¼‰</span>
<span class="token comment">// gcMarkDone å°† GC çš„çŠ¶æ€ç”± mark è½¬ä¸º mark terminationã€‚</span>
<span class="token comment">// å¦åˆ™ï¼ˆè¿˜æœ‰æ²¡è¢«æ ‡è®°çš„ç°è‰²å¯¹è±¡ï¼‰ï¼ŒgcMarkDone ä¼šå°†æ‰€æœ‰æœ¬åœ°é˜Ÿåˆ—ä¸­çš„å¯¹è±¡æ¨åˆ°å…¨å±€å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œ</span>
<span class="token comment">// è¿™æ ·å…¶ä»–çš„ worker å°±å¯ä»¥çŸ¥é“è¿˜æœ‰æ´»è¦å¹²ã€‚</span>
<span class="token comment">// </span>
<span class="token comment">// This should be called when all local mark work has been drained and</span>
<span class="token comment">// there are no remaining workers. Specifically, when</span>
<span class="token comment">//</span>
<span class="token comment">//   work.nwait == work.nproc &amp;&amp; !gcMarkWorkAvailable(p)</span>
<span class="token comment">//</span>
<span class="token comment">// è°ƒç”¨ gcMarkDone çš„ä¸Šä¸‹æ–‡ä¸€å®šæ˜¯å¯æŠ¢å çš„ã€‚</span>
<span class="token comment">//</span>
<span class="token comment">// Flushing local work is important because idle Ps may have local</span>
<span class="token comment">// work queued. This is the only way to make that work visible and</span>
<span class="token comment">// drive GC to completion.</span>
<span class="token comment">// </span>
<span class="token comment">// åˆ·æ–° P çš„æœ¬åœ°é˜Ÿåˆ—åˆ°å…¨å±€é˜Ÿåˆ—ä¸­æ˜¯ååˆ†é‡è¦çš„ï¼Œå› ä¸º idle çŠ¶æ€çš„ P å¯èƒ½åœ¨æœ¬åœ°</span>
<span class="token comment">// é˜Ÿåˆ—ä¸­æœ‰ç¼“å­˜ã€‚gcMarkDone ä¸­æ˜¯å”¯ä¸€çš„æ–¹å¼è®©è¿™äº›æœ¬åœ°é˜Ÿåˆ—ä¸­çš„å¯¹è±¡å¯ä»¥è¢«çœ‹åˆ°ï¼Œ</span>
<span class="token comment">// ä¿ƒä½¿ GC å®Œæˆã€‚</span>
<span class="token comment">//</span>
<span class="token comment">// It is explicitly okay to have write barriers in this function. If</span>
<span class="token comment">// it does transition to mark termination, then all reachable objects</span>
<span class="token comment">// have been marked, so the write barrier cannot shade any more</span>
<span class="token comment">// objects.</span>
<span class="token keyword">func</span> <span class="token function">gcMarkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Ensure only one thread is running the ragged barrier at a</span>
    <span class="token comment">// time.</span>
    <span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>markDoneSema<span class="token punctuation">)</span>

    top<span class="token punctuation">:</span>
    <span class="token comment">// Re-check transition condition under transition lock.</span>
    <span class="token comment">//</span>
    <span class="token comment">// It's critical that this checks the global work queues are</span>
    <span class="token comment">// empty before performing the ragged barrier. Otherwise,</span>
    <span class="token comment">// there could be global work that a P could take after the P</span>
    <span class="token comment">// has passed the ragged barrier.</span>
    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>gcphase <span class="token operator">==</span> _GCmark <span class="token operator">&amp;&amp;</span> work<span class="token punctuation">.</span>nwait <span class="token operator">==</span> work<span class="token punctuation">.</span>nproc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>markDoneSema<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// forEachP needs worldsema to execute, and we'll need it to</span>
    <span class="token comment">// stop the world later, so acquire worldsema now.</span>
    <span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>worldsema<span class="token punctuation">)</span>

    <span class="token comment">// Flush all local buffers and collect flushedWork flags.</span>
    gcMarkDoneFlushed <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg
        <span class="token comment">// Mark the user stack as preemptible so that it may be scanned.</span>
        <span class="token comment">// Otherwise, our attempt to force all P's to a safepoint could</span>
        <span class="token comment">// result in a deadlock as we attempt to preempt a worker that's</span>
        <span class="token comment">// trying to preempt us (e.g. for a stack scan).</span>
        <span class="token comment">/*
        	æ ‡è®°å½“å‰ gp æ˜¯å¯æŠ¢å çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿè¢«æ‰«æã€‚å½“æˆ‘ä»¬å¼ºåˆ¶æ‰€æœ‰çš„ P åˆ°è¾¾
        	ä¸€ä¸ª safepoint å¯èƒ½ä¼šå¯¼è‡´æ­»é”ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³æŠ¢å ä¸€ä¸ª workerï¼ŒåŒæ—¶
        	é‚£ä¸ªworkerä¹Ÿåœ¨å¯¹æˆ‘ä»¬æ‰§è¡ŒæŠ¢å ï¼ˆå¯¹æˆ‘ä»¬è¿›è¡Œæ ˆæ‰«æï¼‰ã€‚
        */</span>
        <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunning<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">)</span>
        <span class="token function">forEachP</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Flush the write barrier buffer, since this may add</span>
            <span class="token comment">// work to the gcWork.</span>
            <span class="token comment">/*
	            1.è·å–å½“å‰ P çš„ writebarrier buffer ä¸­çš„å†…å®¹
	            2.éå†bufferä¸­çš„å¯¹è±¡ï¼Œæ ‡ç°ï¼Œæ ‡è®° span
	            3.å°†ç°è‰²å¯¹è±¡åˆ·åˆ°å…¨å±€çš„ work queue ä¸­
	            4.æ¸…ç©º P çš„ write barrier buffer
            */</span>
            <span class="token function">wbBufFlush1</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>

            <span class="token comment">// Flush the gcWork, since this may create global work</span>
            <span class="token comment">// and set the flushedWork flag.</span>
            <span class="token comment">//</span>
            <span class="token comment">// TODO(austin): Break up these workbufs to</span>
            <span class="token comment">// better distribute work.</span>
            <span class="token comment">// è¿™é‡Œå¤„ç†çš„æ˜¯ P çš„æœ¬åœ°é˜Ÿåˆ—</span>
            <span class="token comment">// å°†æœ¬åœ°é˜Ÿåˆ—ä¸­çš„å†…å®¹åˆ·åˆ°å…¨å±€é˜Ÿåˆ—ä¸­</span>
            _p_<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// Collect the flushedWork flag.</span>
            <span class="token comment">// flushedWork è®°å½•å½“å‰ P æ˜¯å¦åˆå°†å¯¹è±¡æ”¾å…¥åˆ°å…¨å±€workqueue</span>
            <span class="token keyword">if</span> _p_<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span>flushedWork <span class="token punctuation">&#123;</span>
                atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcMarkDoneFlushed<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                _p_<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span>flushedWork <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token comment">// å¦‚æœæœ‰ P å¾€å…¨å±€é˜Ÿåˆ—æ”¾å…¥å¯¹è±¡ï¼Œé‚£è¿˜å¾—å°†é‚£äº›å†…å®¹è¿›è¡Œæ ‡è®°</span>
    <span class="token keyword">if</span> gcMarkDoneFlushed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// More grey objects were discovered since the</span>
        <span class="token comment">// previous termination check, so there may be more</span>
        <span class="token comment">// work to do. Keep going. It's possible the</span>
        <span class="token comment">// transition condition became true again during the</span>
        <span class="token comment">// ragged barrier, so re-check it.</span>
        <span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>worldsema<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> top
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// There was no global work, no local work, and no Ps</span>
    <span class="token comment">// communicated work since we took markDoneSema. Therefore</span>
    <span class="token comment">// there are no grey objects and no more objects can be</span>
    <span class="token comment">// shaded. Transition to mark termination.</span>
    <span class="token comment">// èµ°åˆ°è¿™ä¸€æ­¥æ„å‘³ç€å¯ä»¥å°†çŠ¶æ€è½¬å˜ä¸º markTermination</span>
    now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    work<span class="token punctuation">.</span>tMarkTerm <span class="token operator">=</span> now
    work<span class="token punctuation">.</span>pauseStart <span class="token operator">=</span> now
    <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>preemptoff <span class="token operator">=</span> <span class="token string">"gcing"</span>
    <span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">&#123;</span>
        <span class="token function">traceGCSTWStart</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span>stopTheWorldWithSema<span class="token punctuation">)</span>
    <span class="token comment">// The gcphase is _GCmark, it will transition to _GCmarktermination</span>
    <span class="token comment">// below. The important thing is that the wb remains active until</span>
    <span class="token comment">// all marking is complete. This includes writes made by the GC.</span>

    <span class="token comment">// There is sometimes work left over when we enter mark termination due</span>
    <span class="token comment">// to write barriers performed after the completion barrier above.</span>
    <span class="token comment">// Detect this and resume concurrent mark. This is obviously</span>
    <span class="token comment">// unfortunate.</span>
    <span class="token comment">//</span>
    <span class="token comment">// See issue #27993 for details.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Switch to the system stack to call wbBufFlush1, though in this case</span>
    <span class="token comment">// it doesn't matter because we're non-preemptible anyway.</span>
    restart <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> allp <span class="token punctuation">&#123;</span>
            <span class="token function">wbBufFlush1</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                restart <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> restart <span class="token punctuation">&#123;</span>
        <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>preemptoff <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            now <span class="token operator">:=</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            work<span class="token punctuation">.</span>pauseNS <span class="token operator">+=</span> now <span class="token operator">-</span> work<span class="token punctuation">.</span>pauseStart
            memstats<span class="token punctuation">.</span>gcPauseDist<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>now <span class="token operator">-</span> work<span class="token punctuation">.</span>pauseStart<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>worldsema<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> top
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Disable assists and background workers. We must do</span>
    <span class="token comment">// this before waking blocked assists.</span>
    atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcBlackenEnabled<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// Wake all blocked assists. These will run when we</span>
    <span class="token comment">// start the world again.</span>
    <span class="token comment">// å”¤é†’å› ååŠ©æ ‡è®°è€Œé˜»å¡çš„ goroutine</span>
    <span class="token function">gcWakeAllAssists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Likewise, release the transition lock. Blocked</span>
    <span class="token comment">// workers and assists will run when we start the</span>
    <span class="token comment">// world again.</span>
    <span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>markDoneSema<span class="token punctuation">)</span>

    <span class="token comment">// In STW mode, re-enable user goroutines. These will be</span>
    <span class="token comment">// queued to run after we start the world.</span>
    <span class="token function">schedEnableUser</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token comment">// endCycle depends on all gcWork cache stats being flushed.</span>
    <span class="token comment">// The termination algorithm above ensured that up to</span>
    <span class="token comment">// allocations since the ragged barrier.</span>
    nextTriggerRatio <span class="token operator">:=</span> gcController<span class="token punctuation">.</span><span class="token function">endCycle</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span>userForced<span class="token punctuation">)</span>

    <span class="token comment">// Perform mark termination. This will restart the world.</span>
    <span class="token function">gcMarkTermination</span><span class="token punctuation">(</span>nextTriggerRatio<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ç•ªå¤–ç¯‡"><a href="#ç•ªå¤–ç¯‡" class="headerlink" title="ç•ªå¤–ç¯‡"></a>ç•ªå¤–ç¯‡</h2><h3 id="suspendG"><a href="#suspendG" class="headerlink" title="suspendG"></a>suspendG</h3><ul>
<li>ä»å…¨å±€ g é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªï¼Œè¿™ä¸ª g æœ‰å¯èƒ½æ˜¯ä¸€ä¸‹å‡ ç§æƒ…å†µ<ul>
<li>æ­£åœ¨åˆ«çš„ P ä¸Šè¿è¡Œ</li>
<li>æ­£åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨</li>
<li>æ­£åœ¨æŸä¸ªåœ°æ–¹ç­‰å¾…</li>
<li>å·²ç»æ˜¯å¯æ‰§è¡ŒçŠ¶æ€</li>
<li>æ­£åœ¨å‘ç”ŸæŠ¢å </li>
<li>ä¹Ÿå¯èƒ½æ˜¯å½“å‰è¿™ä¸ª gcMarkWorker</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">/*
    suspendG åœ¨ä¸€ä¸ªå®‰å…¨æ—¶åˆ»æš‚åœ goroutine å¹¶ä¸”è¿”å›è¢«æŒ‚èµ· goroutine çš„çŠ¶æ€ã€‚
    suspendG çš„è°ƒç”¨è€…æ‹¥æœ‰è¯¥ goroutine çš„è¯»æƒé™ç›´åˆ°è°ƒç”¨çš„ resumeGã€‚

    å¤šä¸ªè°ƒç”¨è€…åœ¨åŒä¸€æ—¶åˆ»æƒ³æŒ‚èµ·åŒä¸€ä¸ª goroutine æ˜¯å®‰å…¨çš„ã€‚
    The goroutine may execute between subsequent successful suspend operations.
    å½“å‰çš„å®ç°ä¸ºäº’æ–¥è®¿é—® goroutineï¼Œå› æ­¤å¤šä¸ªè°ƒç”¨è€…çš„è®¿é—®ä¼šè¢«ä¸²è¡ŒåŒ–ã€‚
    ç„¶è€Œï¼Œè¿™æ ·çš„ç›®çš„æ˜¯ä¸ºäº†è¯»å…±äº«ï¼Œæ‰€ä»¥è¯·ä¸è¦ä¾èµ–äº’æ–¥è®¿é—®ã€‚

    suspendG ä¸€å®šè¦åœ¨ system stack ä¸Šè°ƒç”¨å¹¶ä¸”å½“å‰ M ä¸Šçš„ goroutine ä¸€å®šæ˜¯å¯ä»¥è¢«æŠ¢å çš„çŠ¶æ€ã€‚è¿™é˜»æ­¢äº†ä¸¤ä¸ª goroutine å°è¯•ç›¸äº’æŒ‚èµ·ä½†æ˜¯ä»–ä»¬éƒ½å¤„åœ¨éæŠ¢å çŠ¶æ€ä¸‹å‘ç”Ÿæ­»é”çš„æƒ…å†µã€‚è™½ç„¶è¿˜æœ‰å…¶ä»–çš„æ–¹å¼å¯ä»¥è§£å†³æ­»é”ï¼Œä½†æ˜¯è¿™ç§æ˜¯æœ€ç®€å•çš„æ–¹å¼ã€‚
*/</span>
<span class="token comment">//go:systemstack</span>
<span class="token keyword">func</span> <span class="token function">suspendG</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> suspendGState <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> mp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">;</span> mp<span class="token punctuation">.</span>curg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">readgstatus</span><span class="token punctuation">(</span>mp<span class="token punctuation">.</span>curg<span class="token punctuation">)</span> <span class="token operator">==</span> _Grunning <span class="token punctuation">&#123;</span>
        <span class="token comment">// Since we're on the system stack of this M, the user</span>
        <span class="token comment">// G is stuck at an unsafe point. If another goroutine</span>
        <span class="token comment">// were to try to preempt m.curg, it could deadlock.</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"suspendG from non-preemptible goroutine"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// See https://golang.org/cl/21503 for justification of the yield delay.</span>
    <span class="token keyword">const</span> yieldDelay <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span>
    <span class="token keyword">var</span> nextYield <span class="token builtin">int64</span>

    <span class="token comment">// Drive the goroutine to a preemption point.</span>
    stopped <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token keyword">var</span> asyncM <span class="token operator">*</span>m
    <span class="token keyword">var</span> asyncGen <span class="token builtin">uint32</span>
    <span class="token keyword">var</span> nextPreemptM <span class="token builtin">int64</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> s <span class="token operator">:=</span> <span class="token function">readgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token punctuation">&#123;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> s<span class="token operator">&amp;</span>_Gscan <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Someone else is suspending it. Wait</span>
                <span class="token comment">// for them to finish.</span>
                <span class="token comment">//</span>
                <span class="token comment">// TODO: It would be nicer if we could</span>
                <span class="token comment">// coalesce suspends.</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">&#125;</span>

            <span class="token function">dumpgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"invalid g status"</span><span class="token punctuation">)</span>

            <span class="token keyword">case</span> _Gdead<span class="token punctuation">:</span>
            <span class="token comment">// Nothing to suspend.</span>
            <span class="token comment">//</span>
            <span class="token comment">// preemptStop may need to be cleared, but</span>
            <span class="token comment">// doing that here could race with goroutine</span>
            <span class="token comment">// reuse. Instead, goexit0 clears it.</span>
            <span class="token keyword">return</span> suspendGState<span class="token punctuation">&#123;</span>dead<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span>

            <span class="token keyword">case</span> _Gcopystack<span class="token punctuation">:</span>
            <span class="token comment">// The stack is being copied. We need to wait</span>
            <span class="token comment">// until this is done.</span>

            <span class="token keyword">case</span> _Gpreempted<span class="token punctuation">:</span>
            <span class="token comment">// We (or someone else) suspended the G. Claim</span>
            <span class="token comment">// ownership of it by transitioning it to</span>
            <span class="token comment">// _Gwaiting.</span>
            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">casGFromPreempted</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gpreempted<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// We stopped the G, so we have to ready it later.</span>
            stopped <span class="token operator">=</span> <span class="token boolean">true</span>

            s <span class="token operator">=</span> _Gwaiting
            <span class="token keyword">fallthrough</span>

            <span class="token keyword">case</span> _Grunnable<span class="token punctuation">,</span> _Gsyscall<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">:</span>
            <span class="token comment">// Claim goroutine by setting scan bit.</span>
            <span class="token comment">// This may race with execution or readying of gp.</span>
            <span class="token comment">// The scan bit keeps it from transition state.</span>
            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">castogscanstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s<span class="token operator">|</span>_Gscan<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Clear the preemption request. It's safe to</span>
            <span class="token comment">// reset the stack guard because we hold the</span>
            <span class="token comment">// _Gscan bit and thus own the stack.</span>
            gp<span class="token punctuation">.</span>preemptStop <span class="token operator">=</span> <span class="token boolean">false</span>
            gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>
            gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> gp<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>lo <span class="token operator">+</span> _StackGuard

            <span class="token comment">// The goroutine was already at a safe-point</span>
            <span class="token comment">// and we've now locked that in.</span>
            <span class="token comment">//</span>
            <span class="token comment">// TODO: It would be much better if we didn't</span>
            <span class="token comment">// leave it in _Gscan, but instead gently</span>
            <span class="token comment">// prevented its scheduling until resumption.</span>
            <span class="token comment">// Maybe we only use this to bump a suspended</span>
            <span class="token comment">// count and the scheduler skips suspended</span>
            <span class="token comment">// goroutines? That wouldn't be enough for</span>
            <span class="token comment">// &#123;_Gsyscall,_Gwaiting&#125; -> _Grunning. Maybe</span>
            <span class="token comment">// for all those transitions we need to check</span>
            <span class="token comment">// suspended and deschedule?</span>
            <span class="token keyword">return</span> suspendGState<span class="token punctuation">&#123;</span>g<span class="token punctuation">:</span> gp<span class="token punctuation">,</span> stopped<span class="token punctuation">:</span> stopped<span class="token punctuation">&#125;</span>

            <span class="token keyword">case</span> _Grunning<span class="token punctuation">:</span>
            <span class="token comment">// Optimization: if there is already a pending preemption request</span>
            <span class="token comment">// (from the previous loop iteration), don't bother with the atomics.</span>
            <span class="token keyword">if</span> gp<span class="token punctuation">.</span>preemptStop <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>preempt <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">==</span> stackPreempt <span class="token operator">&amp;&amp;</span> asyncM <span class="token operator">==</span> gp<span class="token punctuation">.</span>m <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asyncM<span class="token punctuation">.</span>preemptGen<span class="token punctuation">)</span> <span class="token operator">==</span> asyncGen <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Temporarily block state transitions.</span>
            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">castogscanstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunning<span class="token punctuation">,</span> _Gscanrunning<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Request synchronous preemption.</span>
            gp<span class="token punctuation">.</span>preemptStop <span class="token operator">=</span> <span class="token boolean">true</span>
            gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">true</span>
            gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> stackPreempt

            <span class="token comment">// Prepare for asynchronous preemption.</span>
            asyncM2 <span class="token operator">:=</span> gp<span class="token punctuation">.</span>m
            asyncGen2 <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asyncM2<span class="token punctuation">.</span>preemptGen<span class="token punctuation">)</span>
            needAsync <span class="token operator">:=</span> asyncM <span class="token operator">!=</span> asyncM2 <span class="token operator">||</span> asyncGen <span class="token operator">!=</span> asyncGen2
            asyncM <span class="token operator">=</span> asyncM2
            asyncGen <span class="token operator">=</span> asyncGen2

            <span class="token function">casfrom_Gscanstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gscanrunning<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>

            <span class="token comment">// Send asynchronous preemption. We do this</span>
            <span class="token comment">// after CASing the G back to _Grunning</span>
            <span class="token comment">// because preemptM may be synchronous and we</span>
            <span class="token comment">// don't want to catch the G just spinning on</span>
            <span class="token comment">// its status.</span>
            <span class="token keyword">if</span> preemptMSupported <span class="token operator">&amp;&amp;</span> debug<span class="token punctuation">.</span>asyncpreemptoff <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> needAsync <span class="token punctuation">&#123;</span>
                <span class="token comment">// Rate limit preemptM calls. This is</span>
                <span class="token comment">// particularly important on Windows</span>
                <span class="token comment">// where preemptM is actually</span>
                <span class="token comment">// synchronous and the spin loop here</span>
                <span class="token comment">// can lead to live-lock.</span>
                now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> now <span class="token operator">>=</span> nextPreemptM <span class="token punctuation">&#123;</span>
                    nextPreemptM <span class="token operator">=</span> now <span class="token operator">+</span> yieldDelay<span class="token operator">/</span><span class="token number">2</span>
                    <span class="token function">preemptM</span><span class="token punctuation">(</span>asyncM<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// TODO: Don't busy wait. This loop should really only</span>
        <span class="token comment">// be a simple read/decide/CAS loop that only fails if</span>
        <span class="token comment">// there's an active race. Once the CAS succeeds, we</span>
        <span class="token comment">// should queue up the preemption (which will require</span>
        <span class="token comment">// it to be reliable in the _Grunning case, not</span>
        <span class="token comment">// best-effort) and then sleep until we're notified</span>
        <span class="token comment">// that the goroutine is suspended.</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            nextYield <span class="token operator">=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> yieldDelay
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> nextYield <span class="token punctuation">&#123;</span>
            <span class="token function">procyield</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">osyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            nextYield <span class="token operator">=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> yieldDelay<span class="token operator">/</span><span class="token number">2</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="resumeG"><a href="#resumeG" class="headerlink" title="resumeG"></a>resumeG</h3><h3 id="ç¨æ”¶ä¸å¼€æ”¯"><a href="#ç¨æ”¶ä¸å¼€æ”¯" class="headerlink" title="ç¨æ”¶ä¸å¼€æ”¯"></a>ç¨æ”¶ä¸å¼€æ”¯</h3><ul>
<li>åŸºæœ¬ç†å¿µ</li>
</ul>
<p>â€‹        æ¯ä¸ªèµ‹å€¼å™¨çº¿ç¨‹éƒ½åº”å½“å‚ä¸ä¸€å®šçš„å›æ”¶å·¥ä½œï¼ˆå³çº³ç¨ï¼‰ã€‚åŒæ—¶ä¹Ÿåº”å½“ä¸å›æ”¶å™¨äº¤æ›¿æ‰§è¡Œï¼Œä»¥ç¡®ä¿æœ€å°èµ‹å€¼å™¨ä½¿ç”¨ç‡çš„è¦æ±‚ã€‚    </p>
<p>â€‹        å›æ”¶å™¨åº”å¯åœ¨èµ‹å€¼å™¨æ‰§è¡Œé—´éš™å°½é‡å¤šçš„æ‰§è¡Œå›æ”¶å·¥ä½œï¼ˆå³å°½é‡å¤šçš„ç§¯ç´¯ creditï¼Œä»¥ä¾›èµ‹å€¼å™¨æ”¯å‡ºã€‚ï¼‰</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// gcFlushBgCredit flushes scanWork units of background scan work</span>
<span class="token comment">// credit. This first satisfies blocked assists on the</span>
<span class="token comment">// work.assistQueue and then flushes any remaining credit to</span>
<span class="token comment">// gcController.bgScanCredit.</span>
<span class="token comment">//</span>
<span class="token comment">// Write barriers are disallowed because this is used by gcDrain after</span>
<span class="token comment">// it has ensured that all work is drained and this must preserve that</span>
<span class="token comment">// condition.</span>
<span class="token comment">//</span>
<span class="token comment">//go:nowritebarrierrec</span>
<span class="token keyword">func</span> <span class="token function">gcFlushBgCredit</span><span class="token punctuation">(</span>scanWork <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Fast path; there are no blocked assists. There's a</span>
        <span class="token comment">// small window here where an assist may add itself to</span>
        <span class="token comment">// the blocked queue and park. If that happens, we'll</span>
        <span class="token comment">// just get it on the next flush.</span>
        atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>bgScanCredit<span class="token punctuation">,</span> scanWork<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    assistBytesPerWork <span class="token operator">:=</span> <span class="token function">float64frombits</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>assistBytesPerWork<span class="token punctuation">)</span><span class="token punctuation">)</span>
    scanBytes <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>scanWork<span class="token punctuation">)</span> <span class="token operator">*</span> assistBytesPerWork<span class="token punctuation">)</span>

    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token operator">!</span>work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> scanBytes <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        gp <span class="token operator">:=</span> work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// Note that gp.gcAssistBytes is negative because gp</span>
        <span class="token comment">// is in debt. Think carefully about the signs below.</span>
        <span class="token comment">// scanBytes+gp.gcAssistBytes æ„å‘³ç€è¶³å¤Ÿæ”¯ä»˜å€ºåŠ¡</span>
        <span class="token keyword">if</span> scanBytes<span class="token operator">+</span>gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Satisfy this entire assist debt.</span>
            scanBytes <span class="token operator">+=</span> gp<span class="token punctuation">.</span>gcAssistBytes
            gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token comment">// It's important that we *not* put gp in</span>
            <span class="token comment">// runnext. Otherwise, it's possible for user</span>
            <span class="token comment">// code to exploit the GC worker's high</span>
            <span class="token comment">// scheduler priority to get itself always run</span>
            <span class="token comment">// before other goroutines and always in the</span>
            <span class="token comment">// fresh quantum started by GC.</span>
            <span class="token comment">// è¿˜å€ºåå”¤é†’è¿™ä¸ª g</span>
            <span class="token function">ready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// æ²¡æ³•å®Œå…¨æ”¯ä»˜å€ºåŠ¡ï¼Œä½†æ˜¯å¯ä»¥å¿è¿˜ä¸€éƒ¨åˆ†</span>
            <span class="token comment">// å¿è¿˜å®Œæˆåï¼Œåˆæ”¾å›äº†ååŠ©æ ‡è®°çš„é˜Ÿåˆ—ä¸­</span>
            <span class="token comment">// Partially satisfy this assist.</span>
            gp<span class="token punctuation">.</span>gcAssistBytes <span class="token operator">+=</span> scanBytes
            scanBytes <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token comment">// As a heuristic, we move this assist to the</span>
            <span class="token comment">// back of the queue so that large assists</span>
            <span class="token comment">// can't clog up the assist queue and</span>
            <span class="token comment">// substantially delay small assists.</span>
            work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">pushBack</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
	
    <span class="token comment">// å¦‚æœä»ç„¶æœ‰å‰©ä½™çš„ credit å°±åˆ·æ–°åˆ°å…¨å±€çš„ credit ä¸­</span>
    <span class="token keyword">if</span> scanBytes <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Convert from scan bytes back to work.</span>
        assistWorkPerByte <span class="token operator">:=</span> <span class="token function">float64frombits</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>assistWorkPerByte<span class="token punctuation">)</span><span class="token punctuation">)</span>
        scanWork <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>scanBytes<span class="token punctuation">)</span> <span class="token operator">*</span> assistWorkPerByte<span class="token punctuation">)</span>
        atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>bgScanCredit<span class="token punctuation">,</span> scanWork<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>assistQueue<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é¢˜å¤–è¯"><a href="#é¢˜å¤–è¯" class="headerlink" title="é¢˜å¤–è¯"></a>é¢˜å¤–è¯</h2><p>GC çœŸçš„æ˜¯å¤ªéš¾äº†â€¦ æ„Ÿè§‰è¿™äº›éƒ½è¿˜åªæ˜¯å†°å±±ä¸€è§’ï¼Œæ›¹å¤§è®²è¿‡ï¼ŒGC è¿™éƒ¨åˆ†é‡åŠ›è€Œè¡Œï¼Œå¯¹äºå¤§éƒ¨åˆ†ç¨‹åºå‘˜æ¥è¯´å¯ä»¥å®Œæ•´çš„æŠŠä¸‰è‰²æŠ½è±¡ã€GC æµç¨‹ç»™é¢è¯•å®˜æè¿°å‡ºæ¥ï¼Œå·²ç»æ˜¯å¾ˆå‰å®³äº†ï¼Œå¦‚æœä»–è¿˜äº†è§£ä¸€äº›ç†è®ºåŸºç¡€ï¼Œé‚£ç®—æ˜¯ç›¸å½“ä¸é”™äº†â€¦</p>
<p>æˆ‘ä»¬è¿½æ±‚çš„ä¸æ˜¯å¾—åˆ°åˆ«äººçš„è®¤å¯ï¼Œè€Œæ˜¯å¯¹çŸ¥è¯†çš„æ¸´æœ›ã€‚ä¸¥äºå¾‹å·±ï¼Œæé«˜è‡ªå·±çš„èŒä¸šç´ å…»ã€‚</p>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=1.0.0"><script type="text/javascript" src="/js/donate.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><a class="pos-f tr3" id="github" href="https://github.com/Kaiyuan/donate-page" target="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="ps">æ²¡æœ‰å¼€å¯ä»»ä½•Donateé€‰é¡¹!</li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>GC æºç æ¢³ç†</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>bqyang</p><p><span>å‘å¸ƒæ—¶é—´ï¼š</span>2021-12-02</p><p><span>æœ€åæ›´æ–°ï¼š</span>2022-01-12</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2021/GC/">https://bqyang.top/2021/GC/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://bqyang.top/2021/GC/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2021/HappyWeekend/">Weekend</a><a class="next" href="/2021/GCComments/">GC from go comments</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '4bcae079402e9cc4ce7b',
  clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
  repo: 'blog_comments',
  owner: 'clamyang',
  admin: ['clamyang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://bqyang.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/leetcode/array/easy/">æ•°ç»„-ç®€å•é¢˜</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/recur/">å†å­¦é€’å½’ï¼ˆå‡ ä¸ªæœ‰æ„æ€çš„é€’å½’ç»ƒä¹ ï¼‰</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/print/">æ‰“å°å­—ç¬¦</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/string/">C-String</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/enum/">Rust-Enums</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/structs/">Rust-Structs</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/ownership/">Rust-Ownership</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/deployment/">Deployment æ›´æ–°ç­–ç•¥</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/os-start/">æ“ä½œç³»ç»Ÿå¯åŠ¨</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/concurrency-sema/">åŒæ­¥åŸè¯­-semaphore</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.xargin.com/" title="Xargin" target="_blank">Xargin</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2022 <a href="/." rel="nofollow">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>