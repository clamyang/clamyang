<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€ç‰©ä¸çŸ¥æ·±ä»¥ä¸ºè€»"><title>Go å†…å­˜åˆ†é…å™¨ | æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Go å†…å­˜åˆ†é…å™¨</h1><a id="logo" href="/.">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</a><p class="description">Gopher Watcher</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Go å†…å­˜åˆ†é…å™¨</h1><div class="post-meta">2022-07-22</div><div class="post-content"><p><img src="https://s2.loli.net/2022/07/24/SYqz9rCngZNVdAp.png"></p>
<p>æ¢³ç† Golang å†…å­˜åˆ†é…å™¨ï¼Œä»¥å‰é€šè¿‡ä»£ç è°ƒè¯•è¿‡ï¼Œæœ‰äº†ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œè¿™æ¬¡æŠŠä¸€äº›ç»†èŠ‚æ€§çš„ä¸œè¥¿éƒ½æ¢³ç†å‡ºæ¥äº†ï¼Œå‘ç°è‡ªå·±å¯¹å†…å­˜åˆ†é…çš„è¿‡ç¨‹æœ‰äº†æ›´æ¸…æ™°çš„è®¤è¯†ï¼Œå¾ˆå¤šå†…å®¹é è„‘å­æƒ³è¿˜æ˜¯å¤ªè´¹äº‹äº†ï¼Œå°±å’±è¿™ä¸ªâ€œå¤„ç†å™¨â€å·®ä¸€ç‚¹å°±çƒ§åäº†.. æŠŠå›¾ç”»å‡ºæ¥èƒ½å¤Ÿæœ‰æ•ˆçš„ç¼“è§£å¤§è„‘è´Ÿè½½..</p>
<span id="more"></span>

<h2 id="Unmanaged-memoryï¼ˆå †å¤–å†…å­˜ï¼‰"><a href="#Unmanaged-memoryï¼ˆå †å¤–å†…å­˜ï¼‰" class="headerlink" title="Unmanaged memoryï¼ˆå †å¤–å†…å­˜ï¼‰"></a>Unmanaged memoryï¼ˆå †å¤–å†…å­˜ï¼‰</h2><p>åœ¨çœ‹ Go å†…å­˜æºç éƒ¨åˆ†çš„æ—¶å€™ï¼Œæ¶‰åŠåˆ°ç®¡ç†å†…å­˜çš„ç›¸å…³æ•°æ®ç»“æ„æ—¶ï¼Œæ€»èƒ½çœ‹åˆ°è¿™æ ·ä¸€è¡Œ commentï¼Œ <code>go:notinheap</code> å°±æ„Ÿè§‰æŒºå¥‡æ€ªçš„ï¼Œå†…å­˜åœ°å€ç©ºé—´é™¤äº†å †å°±æ˜¯æ ˆï¼Œé‚£è¦å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<p>GC æ‰«æçš„æ—¶å€™æ˜¯ä¸éœ€è¦å¯¹å †å¤–å†…å­˜è¿›è¡Œæ‰«æçš„ï¼Œå®˜æ–¹ç»™å‡ºäº†å †å¤–å†…å­˜å­˜åœ¨çš„ä¸¤ä¸ªå¿…è¦æ€§ï¼š</p>
<ul>
<li>å½“è¿™å—å†…å­˜æ˜¯ memory manager æœ¬èº«æ—¶ã€‚</li>
<li>åœ¨è°ƒç”¨è€…æ²¡æœ‰ P çš„æƒ…å†µä¸‹åˆ†é…ï¼Œè°ƒåº¦å™¨åˆå§‹åŒ–ä¹‹å‰æ˜¯ä¸å­˜åœ¨ P çš„ã€‚</li>
</ul>
<p>åŒæ—¶ï¼Œå®˜æ–¹ä¹Ÿç»™å‡ºäº†å£°æ˜ unmanaged memory çš„ä¸‰ç§æ–¹å¼</p>
<ol>
<li>sysAlloc</li>
<li>persistentalloc</li>
<li>fixalloc</li>
</ol>
<h3 id="go-notinheap"><a href="#go-notinheap" class="headerlink" title="go:notinheap"></a>go:notinheap</h3><p>ç±»å‹å£°æ˜çš„æ—¶å€™ä½¿ç”¨ï¼Œè¡¨ç¤ºè¿™ä¸ªå¯¹è±¡ç¦æ­¢åœ¨ gc æ‰«æçš„å †ä¸Šæˆ–è€…æ ˆä¸Šåˆ†é…ã€‚å°¤å…¶æ˜¯ï¼ŒæŒ‡å‘è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆåœ¨ <code>runtime.inheap</code> æ£€æŸ¥æ—¶æ€»æ˜¯è¿”å›å‡ã€‚</p>
<blockquote>
<p>go:notinheap çœŸæ­£çš„æ„ä¹‰ï¼šruntime åœ¨æŸäº›åº•å±‚æ•°æ®ç»“æ„ä¸Šä½¿ç”¨ï¼Œé¿å…äº†å†…å­˜å±éšœï¼Œæé«˜äº†æ€§èƒ½ã€‚</p>
</blockquote>
<h2 id="basic-concept"><a href="#basic-concept" class="headerlink" title="basic concept"></a>basic concept</h2><p>Go è¯­è¨€ä¸­çš„å†…å­˜ç®¡ç†åŒ tcmalloc ç±»ä¼¼ï¼Œå°†ä»æ“ä½œç³»ç»Ÿé‚£é‡Œå¾—åˆ°çš„å†…å­˜æŒ‰ç…§å¤§å°ä¸åŒçš„å—è¿›è¡Œç®¡ç†ï¼Œå½¢å¦‚<code>segregated list</code>ï¼Œ<code>mspan</code> æ˜¯ Go è¯­è¨€ä¸­æœ€åŸºæœ¬çš„å†…å­˜ç®¡ç†å•å…ƒã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:notinheap</span></span><br><span class="line"><span class="keyword">type</span> mspan <span class="keyword">struct</span> &#123;</span><br><span class="line">    next *mspan     <span class="comment">// next span in list, or nil if none</span></span><br><span class="line">    prev *mspan     <span class="comment">// previous span in list, or nil if none</span></span><br><span class="line">    <span class="comment">// ... çœç•¥äº†å¤§é‡å­—æ®µ</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘äº†å®é™…çš„ chunk</span></span><br><span class="line">    tiny       <span class="keyword">uintptr</span></span><br><span class="line">    <span class="comment">// è¡¨æ˜è¿™ä¸ª chunk ç”¨äº†å¤šå°‘</span></span><br><span class="line">    tinyoffset <span class="keyword">uintptr</span></span><br><span class="line">    <span class="comment">// è¡¨æ˜ tiny allocation æ‰§è¡Œçš„æ¬¡æ•°</span></span><br><span class="line">    tinyAllocs <span class="keyword">uintptr</span></span><br><span class="line">    alloc [numSpanClasses]*mspan <span class="comment">// spans to allocate from, indexed by spanClass</span></span><br><span class="line">    startAddr <span class="keyword">uintptr</span> <span class="comment">// address of first byte of span aka s.base()</span></span><br><span class="line">    npages    <span class="keyword">uintptr</span> <span class="comment">// number of pages in span</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸€æ¬¡åˆ†é…ï¼Œéƒ½ä¼šä» freeindex å¼€å§‹æ‰«æ allocbits</span></span><br><span class="line">    <span class="comment">// ç›´åˆ°é‡åˆ° 0ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªç©ºé—²å—ã€‚</span></span><br><span class="line">    <span class="comment">// å½“ freeindex == nelemes æ—¶ï¼Œè¯´æ˜è¯¥ mspan æ»¡äº†</span></span><br><span class="line">    <span class="comment">// å½“ n &gt;= freeindex and allocBits[n/8] &amp; (1&lt;&lt;(n%8)) is 0</span></span><br><span class="line">    <span class="comment">// è¯´æ˜ object n æ˜¯ç©ºé—²çš„</span></span><br><span class="line">    freeindex <span class="keyword">uintptr</span></span><br><span class="line"></span><br><span class="line">    nelems <span class="keyword">uintptr</span> <span class="comment">// number of object in the span.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocBits çš„è¡¥ç </span></span><br><span class="line">    allocCache <span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line">    allocBits  *gcBits</span><br><span class="line">    gcmarkBits *gcBits</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·²ç»åˆ†é…çš„å¯¹è±¡æ•°é‡</span></span><br><span class="line">    allocCount  <span class="keyword">uint16</span></span><br><span class="line">    spanclass   spanClass     <span class="comment">// size class and noscan (uint8)</span></span><br><span class="line"></span><br><span class="line">    elemsize    <span class="keyword">uintptr</span>       <span class="comment">// computed from sizeclass or from npages</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒæŠŠè¯¥æ•°æ®ç»“æ„ä¸­æœ‰å…³å†…å­˜åˆ†é…ç›¸å…³çš„å­—æ®µæˆªå–å‡ºæ¥ï¼Œä¸éš¾çœ‹å‡ºï¼Œè¯¥ç»“æ„ä½“é€šè¿‡ <code>next</code> <code>prev</code> æ„æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚åœ¨æ•´ä¸ªå†…å­˜åˆ†é…è¿‡ç¨‹ä¸­ï¼Œæ˜¯æ²¡æœ‰ç”¨åˆ°è¿™ä¸¤ä¸ªå­—æ®µçš„ï¼Œä»–ä»¬çš„å…·ä½“ä½œç”¨è¿˜æœ‰å¾…è€ƒç©¶ã€‚</p>
<p><code>mspan</code> ä¸­åŒ…å«äº†å¾ˆå¤šä¸ª chunkï¼Œæ›´åƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ­£å¦‚æ•°ç»„çš„å®šä¹‰ä¸€æ ·ï¼Œå†…éƒ¨çš„å…ƒç´ æ˜¯ size ç›¸åŒçš„ chunkï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://s2.loli.net/2022/07/23/IGgUj3sm2NnwpKb.png"></p>
<p>Go ä¸­çš„ pages æ˜¯ OS page çš„æ•´æ•°å€ï¼Œé€šå¸¸æ¯ä¸ªé¡µé¢ä¸º 8KBã€‚å›¾ä¸­çš„ <code>mspan</code> ç”± 5 ä¸ª page ç»„æˆï¼Œ5 * 8 = 40 KBï¼Œæˆ‘ä»¬ç”³è¯·ä¸€ä¸ª 10KB çš„åˆ‡ç‰‡ <code>slice := make([]byte, 10240)</code> </p>
<p><img src="https://s2.loli.net/2022/07/23/DRVmvIzYd9jJGOL.png"></p>
<p>è¯¦ç»†çš„æ­¥éª¤æˆ‘ä»¬ä¸€æ­¥æ­¥å±•å¼€ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œå›¾ä¸­æ ‡è¯†äº†å½“å‰ <code>mspan</code> çš„ <code>spanclass = 109</code>ï¼Œæˆ‘è¿™é‡Œçš„ go ç‰ˆæœ¬ä¸ºï¼š<code>1.16</code> æœ‰ 136 ç§ spanclassï¼Œæ›´è¿›ä¸€æ­¥ï¼Œspanclass åˆ†ä¸ºäº†ï¼š</p>
<ul>
<li><p>scan class</p>
<p>éœ€è¦æ‰«æçš„ç±»åˆ«ï¼Œé‚£ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨ scan class å‘¢ï¼Ÿå½“ chunk ä¸­æœ‰æŒ‡é’ˆæ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨ scan classã€‚</p>
</li>
<li><p>noscan class</p>
<p>é€šå¸¸æ¥è®²æ ‡é‡ç±»å‹éƒ½æ˜¯ä¸éœ€è¦æ‰«æçš„ã€‚</p>
</li>
</ul>
<p>spanclass å…¶å®å°±æ˜¯ uint8 çš„ä¸€ä¸ªåˆ«åï¼Œé€šè¿‡æœ€åä¸€ä¸ª bit è¿›è¡Œåˆ¤æ–­ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sc spanClass)</span> <span class="title">noscan</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sc&amp;<span class="number">1</span> != <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <code>sc&amp;1 != 0</code> å°±å¯ä»¥åˆ¤æ–­å‡ºï¼š</p>
<ul>
<li>spanclassä¸ºå¶æ•°æ—¶ï¼Œéœ€è¦</li>
<li>spanclassä¸ºå¥‡æ•°æ—¶ï¼Œä¸éœ€è¦</li>
</ul>
<h3 id="Tiny-Small-Large"><a href="#Tiny-Small-Large" class="headerlink" title="Tiny Small Large"></a>Tiny Small Large</h3><p>Go æŠŠå†…å­˜å¯¹è±¡åˆ†æˆä¸‰ç±»</p>
<table>
<thead>
<tr>
<th>å¯¹è±¡</th>
<th>èŒƒå›´</th>
</tr>
</thead>
<tbody><tr>
<td>Tiny</td>
<td>(0, 16 B)</td>
</tr>
<tr>
<td>Small</td>
<td>[16 B, 32 KB]</td>
</tr>
<tr>
<td>Large</td>
<td>(32 KB, +âˆ)</td>
</tr>
</tbody></table>
<p>åœ¨ä¸Šè¾¹çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª small objectï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¦æ ¹æ®å¯¹è±¡å¤§å°è¿›è¡ŒåŒºåˆ†å‘¢ï¼Ÿä¸ºäº† alloc performanceã€‚</p>
<h3 id="Mcache-Mcentral-Mheap"><a href="#Mcache-Mcentral-Mheap" class="headerlink" title="Mcache Mcentral Mheap"></a>Mcache Mcentral Mheap</h3><p>è¿™é‡Œå°±æ˜¯å®ƒå€Ÿé‰´äº† tcmalloc ä¸­çš„ä¸€ç‚¹ï¼Œå®ç°äº†çº¿ç¨‹ç¼“å­˜ï¼Œè¿™æ ·åœ¨æ¯ä¸ªçº¿ç¨‹ä¸Šåˆ†é…æ—¶å°±ä¸éœ€è¦åŠ é”ã€‚å½“æœ¬åœ°å¤„ç†ä¸äº†æ—¶å°±éœ€è¦å‘ä¸Šä¸€å±‚ä¸€å±‚å°è¯•ï¼Œå½“ mheap éƒ½åˆ†é…ä¸å‡ºæ¥äº†ï¼Œè¯´æ˜å†…å­˜ç”¨å…‰äº†ã€‚</p>
<table>
<thead>
<tr>
<th align="left">åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mcache</td>
<td>çº¿ç¨‹ç¼“å­˜<br />ç”¨äº tiny,small å¯¹è±¡çš„åˆ†é…</td>
</tr>
<tr>
<td align="left">mcentral</td>
<td>ä¸­å¿ƒç¼“å­˜<br />å½“ mcache ä¸­æ²¡æœ‰è¶³å¤Ÿç©ºé—´æ—¶ä¼šç”¨åˆ° mcentral</td>
</tr>
<tr>
<td align="left">mheap</td>
<td>å †ä¸Šå†…å­˜<br />å½“ mcentral ä¸­æ²¡æœ‰è¶³å¤Ÿç©ºé—´æ—¶ä¼šç”¨åˆ° mheap<br /></td>
</tr>
</tbody></table>
<ul>
<li><p>mcache ä¸­æ¯”è¾ƒé‡è¦çš„å­—æ®µ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:notinheap</span></span><br><span class="line"><span class="keyword">type</span> mcache <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// ... çœç•¥äº†å¤§é‡å­—æ®µ</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘äº†å®é™…çš„ chunkï¼Œè´Ÿè´£ tiny å¯¹è±¡çš„åˆ†é…</span></span><br><span class="line">    tiny       <span class="keyword">uintptr</span></span><br><span class="line">    <span class="comment">// è¡¨æ˜è¿™ä¸ª chunk ç”¨äº†å¤šå°‘</span></span><br><span class="line">    tinyoffset <span class="keyword">uintptr</span></span><br><span class="line">    <span class="comment">// è¡¨æ˜ tiny allocation æ‰§è¡Œçš„æ¬¡æ•°</span></span><br><span class="line">    tinyAllocs <span class="keyword">uintptr</span></span><br><span class="line">    <span class="comment">// è´Ÿè´£ small å¯¹è±¡çš„åˆ†é…</span></span><br><span class="line">    alloc [numSpanClasses]*mspan <span class="comment">// spans to allocate from, indexed by spanClass</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>å½“æˆ‘ä»¬å­¦ä¹  large å¯¹è±¡åˆ†é…çš„æ—¶å€™å†æ·±å…¥ç ”ç©¶ mcentral mheap ä¹Ÿä¸è¿Ÿ</p>
</li>
</ul>
<h2 id="Allocator"><a href="#Allocator" class="headerlink" title="Allocator"></a>Allocator</h2><p>æœ‰äº†åŸºæœ¬çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å°±å¯ä»¥æ›´æ·±å…¥çš„äº†è§£å†…å­˜åˆ†é…å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ¢ç´¢çš„æ˜¯ <code>tiny allocator</code> ï¼Œå¦‚æœä½ å†™ä¸å‡ºåˆé€‚çš„å•å…ƒæµ‹è¯•ï¼Œé‚£ä¹ˆå®˜æ–¹çš„ test å°±æ˜¯ä½ çš„æœ€ä½³é€‰æ‹©ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTinyAlloc</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">const</span> N = <span class="number">16</span></span><br><span class="line">    <span class="keyword">var</span> v [N]unsafe.Pointer</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> v &#123;</span><br><span class="line">        v[i] = unsafe.Pointer(<span class="built_in">new</span>(<span class="keyword">byte</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    chunks := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">uintptr</span>]<span class="keyword">bool</span>, N)</span><br><span class="line">    <span class="keyword">for</span> _, p := <span class="keyword">range</span> v &#123;</span><br><span class="line">        <span class="comment">// a &amp;^ b çš„æ„æ€å°±æ˜¯ æ¸…é›¶aä¸­ï¼Œabéƒ½ä¸º1çš„ä½</span></span><br><span class="line">        <span class="comment">// 0110 &amp;^ 1011 -&gt; 0100</span></span><br><span class="line">        <span class="comment">// æŒ‰ç…§ 8 å­—èŠ‚è¿›è¡Œå¯¹é½</span></span><br><span class="line">        chunks[<span class="keyword">uintptr</span>(p)&amp;^<span class="number">7</span>] = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(chunks) == N &#123;</span><br><span class="line">        t.Fatal(<span class="string">&quot;no bytes allocated within the same 8-byte chunk&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tiny allocator</code> åœ¨åˆ†é…å‰éœ€è¦æ ¹æ® size è®¡ç®—å­—èŠ‚å¯¹é½ï¼Œç„¶åç§»åŠ¨ tinyoff çš„ä½ç½®ï¼Œå¦‚æœ size æ˜¯ 8 çš„å€æ•°ï¼Œå°±æŒ‰ç…§ 8 å­—èŠ‚å¯¹é½ï¼Œ4 çš„å€æ•°å°±æŒ‰ç…§ 4 å­—èŠ‚å¯¹é½ï¼Œ2 çš„å€æ•°å°±æŒ‰ç…§ 2 å­—èŠ‚å¯¹é½ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// alignUp rounds n up to a multiple of a. a must be a power of 2.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alignUp</span><span class="params">(n, a <span class="keyword">uintptr</span>)</span> <span class="title">uintptr</span></span> &#123;</span><br><span class="line">    <span class="comment">// &amp;^ bit clear</span></span><br><span class="line">    <span class="keyword">return</span> (n + a - <span class="number">1</span>) &amp;^ (a - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº Allocator æ¥è¯´ï¼Œæœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯<strong>æ€§èƒ½</strong>ï¼Œ<code>mallocgc</code> ä¸­ä¼šé€šè¿‡ä½å›¾æ¥æå‡åˆ†é…å™¨çš„æ€§èƒ½ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬è™½ç„¶å¯ä»¥é€šè¿‡ allocCache åŠ é€Ÿåœ¨ <code>mspan</code> æŸ¥æ‰¾ç©ºé—²å†…å­˜å—çš„é€Ÿåº¦ï¼Œä½†æ˜¯<strong>ä¸€ä¸ª allocCache</strong>æœ€å¤šåªèƒ½è¡¨ç¤º 64 ä¸ªå†…å­˜å—çš„ä½¿ç”¨æƒ…å†µï¼Œåƒå‰é¢çš„ tiny  å¯¹è±¡ï¼Œä¸€ä¸ª page ï¼ˆ8Kï¼‰ ä¸­æœ‰ 512 ä¸ª 16 Byte çš„å¯¹è±¡ï¼Œè¿™æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬åº”è¯¥å»ç ”ç©¶å…·ä½“çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œå³ <code>nextFreeFast nextFree nextFreeIndex</code>:</p>
<ul>
<li><p>nextFreeFast (fastPath)</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fastPath </span></span><br><span class="line"><span class="comment">// å‡è®¾ allocCache ä¸º 0001 1111 1....1 ï¼ˆå…± 64 ä½ï¼‰ è¿™æ˜¯ä¸€ä¸ªå·²ç»åˆ†é…äº†ä¸‰æ¬¡çš„ allocCache</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nextFreeFast</span><span class="params">(s *mspan)</span> <span class="title">gclinkptr</span></span> &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—å½“å‰ allocCache ç¬¬ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä½ç½®</span></span><br><span class="line">    <span class="comment">// 0 ä½¿ç”¨ï¼Œ1 æœªä½¿ç”¨</span></span><br><span class="line">    theBit := sys.Ctz64(s.allocCache)</span><br><span class="line">    <span class="comment">// 64 çš„åŸå› ä¸Šè¾¹æœ‰æåˆ°ï¼Œuint64 åªèƒ½è¡¨ç¤º 64 ä¸ªå†…å­˜å—</span></span><br><span class="line">    <span class="comment">// å¦‚æœ theBit == 64 è¯´æ˜è¯¥ä½å›¾å¯¹åº”çš„æ‰€æœ‰å†…å­˜å—éƒ½è¢«ä½¿ç”¨äº†</span></span><br><span class="line">    <span class="comment">// å¦‚æœ theBit &lt; 64 è¯´æ˜è¿˜æœ‰å†…å­˜å—æœªè¢«ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> theBit &lt; <span class="number">64</span> &#123;</span><br><span class="line">        <span class="comment">// result ä»£è¡¨çš„æ˜¯ç©ºé—²å†…å­˜å—çš„ç´¢å¼•</span></span><br><span class="line">        result := s.freeindex + <span class="keyword">uintptr</span>(theBit)</span><br><span class="line">        <span class="keyword">if</span> result &lt; s.nelems &#123;</span><br><span class="line">            <span class="comment">// ä¸‹ä¸€æ¬¡ alloc å¼€å§‹æŸ¥æ‰¾çš„ä½ç½®</span></span><br><span class="line">            freeidx := result + <span class="number">1</span></span><br><span class="line">            <span class="comment">// è§£é‡Šè¯·è§ä¸‹é¢å†…å®¹</span></span><br><span class="line">            <span class="keyword">if</span> freeidx%<span class="number">64</span> == <span class="number">0</span> &amp;&amp; freeidx != s.nelems &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">            s.allocCache &gt;&gt;= <span class="keyword">uint</span>(theBit + <span class="number">1</span>)</span><br><span class="line">            s.freeindex = freeidx</span><br><span class="line">            s.allocCount++</span><br><span class="line">            <span class="keyword">return</span> gclinkptr(result*s.elemsize + s.base())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ spancalss=5 çš„ mspan ä¸¾ä¾‹ï¼š</p>
<p><img src="https://s2.loli.net/2022/07/24/jLlNhRDOP6us3Yd.png"></p>
<p>è¿˜æ˜¯æŒºæ¸…æ™°çš„å§ï¼ŒfastPath å°±æ˜¯æ£€æŸ¥å½“å‰è¿™ 64 ä¸ªå†…å­˜å—æœ‰æ²¡æœ‰ç©ºé—²çš„ï¼Œæ²¡æ‰¾åˆ°å°±èµ° slowPathï¼Œæ‰¾åˆ°äº†åˆ™æ›´æ–°allocCache å¯¹åº”çš„ bitï¼Œå°† freeIndex æŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ¬¡åˆ†é…çš„æŸ¥æ‰¾ï¼Œæ›´æ–°å½“å‰ mspan å·²ç»åˆ†é…çš„æ¬¡æ•°ã€‚</p>
<p><code>freeidx%64 == 0 &amp;&amp; freeidx != s.nelems</code> çš„æ„æ€æ˜¯ï¼šå½“ freeIndex æŒ‡å‘ allocCache ä¹‹å¤–ä¸”ä¸æ˜¯æœ€åä¸€ä¸ªå¯¹è±¡æ—¶ï¼ŒfastPath ä¹Ÿæ˜¯èµ°ä¸é€šçš„ã€‚ è¿™é‡Œä¸»è¦å°±æ˜¯ç†è§£ freeIndex çš„èµ·å§‹ç¼–å·ä¸º 0ï¼Œè¡¨ç¤ºè¿™ 64 ä¸ªæ¯”ç‰¹ä½åªéœ€è¦ 0-63ï¼Œå¦‚æœå¯¹ 64 å–æ¨¡ä¸º 0 è¯´æ˜å·²ç»è¶…è¿‡å½“å‰ allocCache çš„ç®¡è¾–èŒƒå›´äº†ï¼Œä¸”å½“å‰ allocCache å¯¹åº”çš„å†…å­˜å—éƒ½è¢«ç”¨å…‰äº†ã€‚</p>
<p>é‚£æˆ‘ä»¬å°±éœ€è¦æ›´æ–° allocCache ä¸­çš„å†…å®¹ï¼Œä½¿å…¶æŒ‡å‘ä¸‹ä¸€ä¸ª 64 ä½çš„ cache bitã€‚ä»¥ tinyAllocator ä¸ºä¾‹ï¼Œæ¯æ¬¡åˆ†é…  1 å­—èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦åˆ†é… 1024 æ¬¡æ‰èƒ½è¾¾åˆ°è¿™ä¸ªé˜ˆå€¼ï¼ˆå‰ææ˜¯è¿™ä¸ª mspanæ˜¯ç©ºçš„ï¼‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">*runtime.mspan &#123;</span><br><span class="line">    startAddr: <span class="number">824633810944</span>,</span><br><span class="line">    npages: <span class="number">1</span>,</span><br><span class="line">    manualFreeList: <span class="number">0</span>,</span><br><span class="line">    freeindex: <span class="number">63</span>,</span><br><span class="line">    nelems: <span class="number">512</span>,</span><br><span class="line">    allocCache: <span class="number">1</span>,</span><br><span class="line">    allocCount: <span class="number">63</span>,</span><br><span class="line">    spanclass: tinySpanClass (<span class="number">5</span>),</span><br><span class="line">    elemsize: <span class="number">16</span>,</span><br><span class="line">    limit: <span class="number">824633819136</span>&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Š mspanï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨å®ƒåˆ†é…äº† 63 ä¸ªå¯¹è±¡ï¼ˆ0-62ï¼‰ï¼Œæœ¬æ¬¡åˆ†é…çš„ç©ºé—²å—ç´¢å¼•ä¸º 63ï¼Œä¸‹ä¸€æ¬¡å†…å­˜åˆ†é…çš„ç´¢å¼•ä¸º 64ï¼Œå³ <code>freeidx%64 == 0 &amp;&amp; freeidx != s.nelems</code> æ¡ä»¶æˆç«‹ï¼Œåªèƒ½èµ° slowPath äº†ã€‚</p>
</li>
<li><p>nextFree (slowPath)</p>
<p>nextFree ä¸­å¤„ç† allocCache çš„ä¸»è¦é€»è¾‘åœ¨ <code>s.nextFreeIndex</code> ä¸­</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcache)</span> <span class="title">nextFree</span><span class="params">(spc spanClass)</span> <span class="params">(v gclinkptr, s *mspan, shouldhelpgc <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    s = c.alloc[spc]</span><br><span class="line">    shouldhelpgc = <span class="literal">false</span></span><br><span class="line">    freeIndex := s.nextFreeIndex()</span><br><span class="line">    <span class="keyword">if</span> freeIndex == s.nelems &#123;</span><br><span class="line">        <span class="comment">// The span is full.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) != s.nelems &#123;</span><br><span class="line">            <span class="built_in">println</span>(<span class="string">&quot;runtime: s.allocCount=&quot;</span>, s.allocCount, <span class="string">&quot;s.nelems=&quot;</span>, s.nelems)</span><br><span class="line">            throw(<span class="string">&quot;s.allocCount != s.nelems &amp;&amp; freeIndex == s.nelems&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        c.refill(spc)</span><br><span class="line">        shouldhelpgc = <span class="literal">true</span></span><br><span class="line">        s = c.alloc[spc]</span><br><span class="line"></span><br><span class="line">        freeIndex = s.nextFreeIndex()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> freeIndex &gt;= s.nelems &#123;</span><br><span class="line">        throw(<span class="string">&quot;freeIndex is not valid&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v = gclinkptr(freeIndex*s.elemsize + s.base())</span><br><span class="line">    s.allocCount++</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) &gt; s.nelems &#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">&quot;s.allocCount=&quot;</span>, s.allocCount, <span class="string">&quot;s.nelems=&quot;</span>, s.nelems)</span><br><span class="line">        throw(<span class="string">&quot;s.allocCount &gt; s.nelems&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>nextFreeIndex (find freeindex)</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *mspan)</span> <span class="title">nextFreeIndex</span><span class="params">()</span> <span class="title">uintptr</span></span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰ç©ºé—²å—çš„ä½ç½®</span></span><br><span class="line">    sfreeindex := s.freeindex</span><br><span class="line">    snelems := s.nelems</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯è¯¥ mspan ä¸­æœ€åä¸€ä¸ªå†…å­˜å—ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> sfreeindex == snelems &#123;</span><br><span class="line">        <span class="keyword">return</span> sfreeindex</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sfreeindex &gt; snelems &#123;				</span><br><span class="line">        throw(<span class="string">&quot;s.freeindex &gt; s.nelems&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    aCache := s.allocCache</span><br><span class="line"></span><br><span class="line">    bitIndex := sys.Ctz64(aCache)</span><br><span class="line">    <span class="keyword">for</span> bitIndex == <span class="number">64</span> &#123;</span><br><span class="line">        <span class="comment">// Move index to start of next cached bits.</span></span><br><span class="line">        sfreeindex = (sfreeindex + <span class="number">64</span>) &amp;^ (<span class="number">64</span> - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> sfreeindex &gt;= snelems &#123;</span><br><span class="line">            s.freeindex = snelems</span><br><span class="line">            <span class="keyword">return</span> snelems</span><br><span class="line">        &#125;</span><br><span class="line">        whichByte := sfreeindex / <span class="number">8</span></span><br><span class="line">        <span class="comment">// Refill s.allocCache with the next 64 alloc bits.</span></span><br><span class="line">        s.refillAllocCache(whichByte)</span><br><span class="line">        aCache = s.allocCache</span><br><span class="line">        bitIndex = sys.Ctz64(aCache)</span><br><span class="line">        <span class="comment">// nothing available in cached bits</span></span><br><span class="line">        <span class="comment">// grab the next 8 bytes and try again.</span></span><br><span class="line">    &#125;</span><br><span class="line">    result := sfreeindex + <span class="keyword">uintptr</span>(bitIndex)</span><br><span class="line">    <span class="keyword">if</span> result &gt;= snelems &#123;</span><br><span class="line">        s.freeindex = snelems</span><br><span class="line">        <span class="keyword">return</span> snelems</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s.allocCache &gt;&gt;= <span class="keyword">uint</span>(bitIndex + <span class="number">1</span>)</span><br><span class="line">    sfreeindex = result + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sfreeindex%<span class="number">64</span> == <span class="number">0</span> &amp;&amp; sfreeindex != snelems &#123;</span><br><span class="line">        <span class="comment">// We just incremented s.freeindex so it isn&#x27;t 0.</span></span><br><span class="line">        <span class="comment">// As each 1 in s.allocCache was encountered and used for allocation</span></span><br><span class="line">        <span class="comment">// it was shifted away. At this point s.allocCache contains all 0s.</span></span><br><span class="line">        <span class="comment">// Refill s.allocCache so that it corresponds</span></span><br><span class="line">        <span class="comment">// to the bits at s.allocBits starting at s.freeindex.</span></span><br><span class="line">        whichByte := sfreeindex / <span class="number">8</span></span><br><span class="line">        s.refillAllocCache(whichByte)</span><br><span class="line">    &#125;</span><br><span class="line">    s.freeindex = sfreeindex</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>æŸ¥çœ‹ä¸Šè¿°æºç å¾—çŸ¥ï¼Œè´Ÿè´£é‡æ–°åˆ†é… allocCache çš„æ˜¯ <code>refilllAllocCache()</code></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *mspan)</span> <span class="title">refillAllocCache</span><span class="params">(whichByte <span class="keyword">uintptr</span>)</span></span> &#123;</span><br><span class="line">    bytes := (*[<span class="number">8</span>]<span class="keyword">uint8</span>)(unsafe.Pointer(s.allocBits.bytep(whichByte)))</span><br><span class="line">    aCache := <span class="keyword">uint64</span>(<span class="number">0</span>)</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">0</span>])</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">1</span>]) &lt;&lt; (<span class="number">1</span> * <span class="number">8</span>)</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">2</span>]) &lt;&lt; (<span class="number">2</span> * <span class="number">8</span>)</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">3</span>]) &lt;&lt; (<span class="number">3</span> * <span class="number">8</span>)</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">4</span>]) &lt;&lt; (<span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">5</span>]) &lt;&lt; (<span class="number">5</span> * <span class="number">8</span>)</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">6</span>]) &lt;&lt; (<span class="number">6</span> * <span class="number">8</span>)</span><br><span class="line">    aCache |= <span class="keyword">uint64</span>(bytes[<span class="number">7</span>]) &lt;&lt; (<span class="number">7</span> * <span class="number">8</span>)</span><br><span class="line">    s.allocCache = ^aCache</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä» allocBits ä¸­è·å–å¯¹åº”çš„å†…å­˜å—ä½¿ç”¨ä¿¡æ¯ï¼Œæœ€åä»¥è¡¥ç çš„æ–¹å¼ä¿å­˜åˆ° allocCache ä¸­ï¼Œæ–¹ä¾¿ Ctz å‡½æ•°çš„ä½¿ç”¨ã€‚</p>
<p>ç„¶åè¿™é‡Œæˆ‘è§‚å¯Ÿäº†ä¸€ä¸‹ allocBits å®ƒæ˜¯ä¸€ä¸ª <code>*gcBits</code> ç±»å‹ï¼Œåº•å±‚å®é™…ä¸Šæ˜¯ä¸€ä¸ª uint8 çš„åˆ«åï¼Œè¿™é‡Œæœ€åˆä¹ŸæŒºè®©æˆ‘å¥½å¥‡çš„ï¼Œä¸€ä¸ª uint8 ç±»å‹å°± 8 ä¸ª bit æ˜¯æ€ä¹ˆæ ‡è®° mspan ä¸­é‚£ä¹ˆå¤šå¯¹è±¡çš„ã€‚</p>
<p>ç„¶ååˆä¸€å¤´æ‰è¿›æºç ä¸­ï¼Œå‘ç°è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ allocBits çš„æŒ‡é’ˆï¼Œå®é™… allocBits å¤§å°æ˜¯æ ¹æ® nelems è®¡ç®—å¾—å‡ºçš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// allocBit çš„åˆå§‹åŒ–å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMarkBits</span><span class="params">(nelems <span class="keyword">uintptr</span>)</span> *<span class="title">gcBits</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä»¥ 64 ä¸ºæ­¥é•¿ï¼Œè®¡ç®—è¡¨è¾¾ nelemes ä¸ªå¯¹è±¡éœ€è¦å¤šå°‘å—</span></span><br><span class="line">    blocksNeeded := <span class="keyword">uintptr</span>((nelems + <span class="number">63</span>) / <span class="number">64</span>)</span><br><span class="line">    bytesNeeded := blocksNeeded * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try directly allocating from the current head arena.</span></span><br><span class="line">    head := (*gcBitsArena)(atomic.Loadp(unsafe.Pointer(&amp;gcBitsArenas.next)))</span><br><span class="line">    <span class="keyword">if</span> p := head.tryAlloc(bytesNeeded); p != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// There&#x27;s not enough room in the head arena. We may need to</span></span><br><span class="line">    <span class="comment">// allocate a new arena.</span></span><br><span class="line">    lock(&amp;gcBitsArenas.lock)</span><br><span class="line">    <span class="comment">// Try the head arena again, since it may have changed. Now</span></span><br><span class="line">    <span class="comment">// that we hold the lock, the list head can&#x27;t change, but its</span></span><br><span class="line">    <span class="comment">// free position still can.</span></span><br><span class="line">    <span class="keyword">if</span> p := gcBitsArenas.next.tryAlloc(bytesNeeded); p != <span class="literal">nil</span> &#123;</span><br><span class="line">        unlock(&amp;gcBitsArenas.lock)</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate a new arena. This may temporarily drop the lock.</span></span><br><span class="line">    fresh := newArenaMayUnlock()</span><br><span class="line">    <span class="comment">// If newArenaMayUnlock dropped the lock, another thread may</span></span><br><span class="line">    <span class="comment">// have put a fresh arena on the &quot;next&quot; list. Try allocating</span></span><br><span class="line">    <span class="comment">// from next again.</span></span><br><span class="line">    <span class="keyword">if</span> p := gcBitsArenas.next.tryAlloc(bytesNeeded); p != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// Put fresh back on the free list.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Mark it &quot;already zeroed&quot;</span></span><br><span class="line">        fresh.next = gcBitsArenas.free</span><br><span class="line">        gcBitsArenas.free = fresh</span><br><span class="line">        unlock(&amp;gcBitsArenas.lock)</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate from the fresh arena. We haven&#x27;t linked it in yet, so</span></span><br><span class="line">    <span class="comment">// this cannot race and is guaranteed to succeed.</span></span><br><span class="line">    p := fresh.tryAlloc(bytesNeeded)</span><br><span class="line">    <span class="keyword">if</span> p == <span class="literal">nil</span> &#123;</span><br><span class="line">        throw(<span class="string">&quot;markBits overflow&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the fresh arena to the &quot;next&quot; list.</span></span><br><span class="line">    fresh.next = gcBitsArenas.next</span><br><span class="line">    atomic.StorepNoWB(unsafe.Pointer(&amp;gcBitsArenas.next), unsafe.Pointer(fresh))</span><br><span class="line"></span><br><span class="line">    unlock(&amp;gcBitsArenas.lock)</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p><code>(nelems + 63) / 64</code> æ¶‰åŠåˆ°ä¸€ä¸ªå‘ä¸Šå–æ•´çš„é€šç”¨ç®—æ³•ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œ  Google</p>
</blockquote>
<p><code>gcBitsArenas</code> æ˜¯ç”¨æ¥ç®¡ç†è¿™äº› Bitmap çš„æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:notinheap</span></span><br><span class="line"><span class="keyword">type</span> gcBitsArena <span class="keyword">struct</span> &#123;</span><br><span class="line">    free <span class="keyword">uintptr</span> <span class="comment">// free is the index into bits of the next free byte; read/write atomically</span></span><br><span class="line">    next *gcBitsArena</span><br><span class="line">    bits [gcBitsChunkBytes - gcBitsHeaderBytes]gcBits</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gcBitsArenas <span class="keyword">struct</span> &#123;</span><br><span class="line">    lock     mutex</span><br><span class="line">    free     *gcBitsArena</span><br><span class="line">    next     *gcBitsArena <span class="comment">// Read atomically. Write atomically under lock.</span></span><br><span class="line">    current  *gcBitsArena</span><br><span class="line">    previous *gcBitsArena</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>allocBit çš„åˆå§‹åŒ–è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæˆ‘ä»¬ç»§ç»­å›åˆ° <code>allocCache</code>  çš„æ›¿æ¢ä¸Šï¼Œå³ <code>refillAllocCache</code> å‡½æ•°ã€‚ç†è§£è¿™ä¸ªå‡½æ•°æœ€å…³é”®çš„ä¸€ç‚¹åœ¨äºå¦‚ä½•ç†è§£ä»–çš„å‚æ•° whichByteã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½“ sfreeindex % 64 == 0 æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸ªè®¡ç®—</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ whichByte è‚¯å®šæ€»æ˜¯ 8 çš„å€æ•°</span></span><br><span class="line"><span class="comment">// ç”¨æ¥å®šä½ freeindex åœ¨ allocBits å“ªä¸ªä½ç½®</span></span><br><span class="line"><span class="comment">// ç›¸å¯¹äº allocBit å¼€å§‹ä½ç½®çš„åç§»é‡ï¼Œæœ€åˆåç§»é‡ä¸º 0 ç„¶åä¾æ¬¡åç§» 8 çš„æ•´æ•°å€ï¼Œ8ï¼Œ 16ï¼Œ24..</span></span><br><span class="line"><span class="comment">// ä¾¿å®œçš„æ˜¯å­—èŠ‚æ•°ï¼Œå¦‚æœæ¢ç®—æˆ bit æ˜¯ 8*8ï¼Œ16*8ï¼Œ 24*8</span></span><br><span class="line">whichByte := sfreeindex / <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå°†è¿™ä¸ªåç§»é‡åŠ åˆ° <code>s.allocBits.bytep(whichByte)</code> å°±è·å–åˆ°äº†ä¸‹ä¸€ä¸ª 8å­—èŠ‚çš„èµ·å§‹åœ°å€ã€‚å†ä¾æ¬¡è·å–è¿™8å­—èŠ‚ä¸­çš„æ¯ä¸ªå­—èŠ‚è¡¨ç¤ºçš„å†…å­˜å—çš„å ç”¨ä¿¡æ¯ï¼Œä»¥è¡¥ç çš„å½¢å¼ä¿å­˜åœ¨ allocCache ä¸­å³å¯ã€‚</p>
<p>è‡³æ­¤ï¼Œ<code>tiny allocator</code> æ¶‰åŠåˆ°çš„å†…å®¹å°±ç»“æŸäº†ã€‚<code>small allocator</code> æŸ¥æ‰¾å†…å­˜å—çš„è¿‡ç¨‹åŒ tiny allocator ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†ç»§ç»­å±•å¼€ã€‚</p>
<p>é¢å¤–æä¸€ç‚¹ï¼Œä½ åº”è¯¥èƒ½å¤Ÿå‘ç°å½“æˆ‘ä»¬é€šè¿‡ <code>fastPaht</code> æˆ– <code>nextFree</code> æ‰¾åˆ° tiny å†…å­˜å—çš„èµ·å§‹åœ°å€åï¼Œå°†è¿™ä¸ªæŒ‡é’ˆè½¬æ¢æˆäº† <code>*[2]uint64</code>ï¼Œç„¶åæ‰§è¡Œäº†ä¸¤ä¸ªèµ‹å€¼æ“ä½œï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">(*[<span class="number">2</span>]<span class="keyword">uint64</span>)(x)[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">(*[<span class="number">2</span>]<span class="keyword">uint64</span>)(x)[<span class="number">1</span>] = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Ÿå†…å­˜æ¸…é›¶ã€‚tiny allocator ä¸­ï¼Œæ¯ä¸ªå†…å­˜å—éƒ½æ˜¯ 16 å­—èŠ‚ï¼Œä¸¤ä¸ª uint64 çœŸå¥½å¯¹åº” 16å­—èŠ‚ï¼Œç„¶åå°†å…¶ä¸­å­˜å‚¨çš„å†…å®¹ç½®ä¸º0ã€‚</p>
<p>æ‹“å±•ï¼š</p>
<p>å¾·å¸ƒé²å› åºåˆ— ï¼ˆCtz çš„å®ç°åŸç†ï¼‰</p>
<p><a target="_blank" rel="noopener" href="http://supertech.csail.mit.edu/papers/debruijn.pdf">http://supertech.csail.mit.edu/papers/debruijn.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://halfrost.com/go_s2_de_bruijn/#toc-0">https://halfrost.com/go_s2_de_bruijn/#toc-0</a></p>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=1.0.0"><script type="text/javascript" src="/js/donate.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><a class="pos-f tr3" id="github" href="https://github.com/clamyang" target="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/AliPayQR.jpg"></li><li id="WeChat" qr="/img/WeChatQR.jpg"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>Go å†…å­˜åˆ†é…å™¨</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>bqyang</p><p><span>å‘å¸ƒæ—¶é—´ï¼š</span>2022-07-22</p><p><span>æœ€åæ›´æ–°ï¼š</span>2022-07-25</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2022/language/golang/memory-alloc/">https://bqyang.top/2022/language/golang/memory-alloc/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://bqyang.top/2022/language/golang/memory-alloc/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"></div><div class="post-nav"><a class="next" href="/2022/os/memory/free-space-manage/">free space management</a></div><script src="https://utteranc.es/client.js" repo="clamyang/blogs" issue-term="title" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://bqyang.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/memory-alloc/">Go å†…å­˜åˆ†é…å™¨</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/memory/free-space-manage/">free space management</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/k8s-storage-source-code/">k8s pv pvc æºç </a></li><li class="post-list-item"><a class="post-list-link" href="/2022/design-pattern/Structural/composite/">ç»„åˆæ¨¡å¼</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/pstree/">ç®€æ˜“ç‰ˆ pstree</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/k8s-storage/">k8s å­˜å‚¨å†…å®¹</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/design-pattern/Structural/facade/">é—¨é¢æ¨¡å¼ï¼ˆå¤–è§‚æ¨¡å¼ï¼‰</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/memory-api/">å†…å­˜ç›¸å…³ API</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/100-go-mistaks/2-misuse-init/">misuse init func</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/go-params-to-goroutine/">å‚æ•°æ˜¯æ€ä¹ˆä¼ ç»™ goroutine çš„</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.xargin.com/" title="Xargin" target="_blank">Xargin</a><ul></ul><a href="https://mytechshares.com/" title="è‘£æ³½æ¶¦çš„æŠ€æœ¯ç¬”è®°" target="_blank">è‘£æ³½æ¶¦çš„æŠ€æœ¯ç¬”è®°</a><ul></ul><a href="https://hujingnb.com/" title="çƒŸè‰çš„é¦™å‘³" target="_blank">çƒŸè‰çš„é¦™å‘³</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2022 <a href="/." rel="nofollow">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°.</a>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/"> äº¬ICPå¤‡2021035561å·.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>