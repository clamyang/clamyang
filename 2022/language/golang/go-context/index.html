<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€ç‰©ä¸çŸ¥æ·±ä»¥ä¸ºè€»"><title>go context | æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">go context</h1><a id="logo" href="/.">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</a><p class="description">Gopher Watcher</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">go context</h1><div class="post-meta">2022-06-23</div><div class="post-content"><p><img src="https://s2.loli.net/2022/06/15/4SjfIcJUAtRrigO.png"></p>
<p>è¿™ä¸¤å¤©åœ¨çœ‹ Context çš„æœ€ä½³å®è·µï¼Œåœ¨é¡¹ç›®ä¸­æœ‰ç”¨åˆ°è¿™ä¸ªä¸œè¥¿ï¼Œä½†æ˜¯åˆæ²¡æœ‰å®é™…èµ·ä½œç”¨ï¼Œåªæ˜¯å•çº¯çš„ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ æ¥ä¼ å»ã€‚è¿™ç¯‡æ–‡ç« çš„ç›®çš„å°±æ˜¯å­¦ä¼šä½¿ç”¨ Context ä»¥åŠé˜…è¯» Context éƒ¨åˆ†æºç å®ç°ï¼Œè¿˜æœ‰åœ¨ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚</p>
<span id="more"></span>

<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><h3 id="Background-amp-amp-TODO"><a href="#Background-amp-amp-TODO" class="headerlink" title="Background &amp;&amp; TODO"></a>Background &amp;&amp; TODO</h3><p><strong>Background</strong> ä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥å½“ä½œæ ‘çš„é¡¶ç‚¹æ¥ä½¿ç”¨ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ WithCancel æ´¾ç”Ÿå‡ºä¸€ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// å½“å‰çš„ Context tree ä¸ºï¼š</span></span><br><span class="line">    <span class="comment">// parent --&gt; ctx</span></span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">defer</span> cancel</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use ctx do something..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒBackground æ˜¯æ°¸è¿œéƒ½ä¸ä¼šè¢«å–æ¶ˆçš„ï¼Œè¿™ä¸ªæˆ‘ä»¬ç¨åä¼šçœ‹åˆ°ä¸ºä»€ä¹ˆã€‚</p>
</blockquote>
<p><strong>TODO</strong> ä¸€èˆ¬ç”¨åœ¨ä¸æ¸…æ¥šä½¿ç”¨å“ªä¸ª Context æ—¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾æˆ‘ä»¬æœ‰ä¸ªå‡½æ•°éœ€è¦ context ä½œä¸ºå‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">(ctx context.Context, args Args)</span></span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¯´è¿™æ—¶å€™æˆ‘ä»¬ä¸çŸ¥é“è¦ä¼ ç»™è¿™ä¸ªå‡½æ•°å“ªä¸ªå…·ä½“çš„å®å‚ï¼Œå¯ä»¥ä½¿ç”¨ <code>context.TODO</code> ä»£æ›¿ï¼Œå°†æ¥æœ‰å…·ä½“çš„ Contetxt å¯ä»¥æŠŠè¿™ä¸ªæ›¿æ¢æ‰ã€‚</p>
<h3 id="åº•å±‚å®ç°"><a href="#åº•å±‚å®ç°" class="headerlink" title="åº•å±‚å®ç°"></a>åº•å±‚å®ç°</h3><p>åœ¨åº•å±‚è¿™ä¸¤ä¸ªå…¶å®æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    background = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">    todo       = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<p>æ—¢ç„¶éƒ½è¯´åˆ°è¿™äº†ï¼Œæˆ‘ä»¬çœ‹ä¸‹æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// context åœ¨åº•å±‚å°±æ˜¯ä¸€ä¸ª interface</span></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="keyword">bool</span>)</span><br><span class="line">    <span class="comment">// é‡‡ç”¨äº† lazy init çš„æ–¹å¼è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    Err() error</span><br><span class="line">    Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>emptyCtx å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œä½†æ˜¯ä¸å…¶ä»– <code>ctx</code> ä¸åŒçš„æ˜¯ï¼ŒemptyCtx æ˜¯ä¸ä¼šè¢« cancel çš„ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•çš„ value å’Œ deadlineã€‚</p>
<p>å¦ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„åœ°æ–¹ï¼Œ<code>emptyCtx</code> å…¶å®æ˜¯ int çš„ä¸€ä¸ªåˆ«åï¼Œå®˜æ–¹æ³¨é‡Šæåˆ°ä¸ä½¿ç”¨ struct çš„åŸå› æ˜¯<strong>éœ€è¦ä¸åŒçš„åœ°å€</strong>ï¼Œå¯ä»¥åŠ¨æ‰‹å®éªŒä¸€ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printAddr</span><span class="params">()</span></span> &#123;    </span><br><span class="line">    <span class="keyword">type</span> s <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    a := <span class="built_in">new</span>(s)</span><br><span class="line">    b := <span class="built_in">new</span>(s)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p, %p\n&quot;</span>, a, b)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">type</span> i <span class="keyword">int</span></span><br><span class="line">    i1 := <span class="built_in">new</span>(i)</span><br><span class="line">    i2 := <span class="built_in">new</span>(i)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%p, %p\n&quot;</span>, i1, i2)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">    Output: </span></span><br><span class="line"><span class="comment">    address of a is 0x8cb1d0, address of b is 0x8cb1d0</span></span><br><span class="line"><span class="comment">    address of i1 is 0xc00000a0a8, address of i2 is 0xc00000a0e0</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨ç›¸åŒçš„åœ°å€ï¼Ÿ</p>
<p>ä¸ªäººè®¤ä¸ºæ˜¯ä¸ºäº†åŒºåˆ† Background å’Œ TODOï¼Œåœ¨æºç ä¸­æˆ‘ä»¬èƒ½çœ‹åˆ° emptyCtx æœ‰ä¸€ä¸ªæ–¹æ³•å«åš String()</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *emptyCtx)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">   <span class="keyword">switch</span> e &#123;</span><br><span class="line">   <span class="keyword">case</span> background:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;context.Background&quot;</span></span><br><span class="line">   <span class="keyword">case</span> todo:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;context.TODO&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;unknown empty Context&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¯´æˆ‘ä»¬ä½¿ç”¨ <code>type emptyCtx struct&#123;&#125;</code> ä½œä¸º Background å’Œ TODO çš„åº•å±‚å®ç°ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæ‰“å°çš„æ—¶å€™å°±ä¼šèµ°åŒä¸€ä¸ª case ä¸èƒ½æ˜¾ç¤ºæ­£ç¡®çš„è¾“å‡ºã€‚</p>
<p>è‡³äºå…¶ä»–åŸå› æš‚æ—¶æ²¡æƒ³åˆ°ã€‚</p>
</blockquote>
<p>åŒæ ·çš„ WithCancel / WithValue ç­‰åœ¨åº•å±‚å¯¹åº”çš„ç»“æ„ä½“éƒ½å®ç°äº†è¿™ä¸ªæ¥å£ã€‚</p>
<table>
<thead>
<tr>
<th>funcName</th>
<th>structName</th>
</tr>
</thead>
<tbody><tr>
<td>WithValue()</td>
<td><a target="_blank" rel="noopener" href="https://cs.opensource.google/go/go/+/refs/tags/go1.18.3:src/context/context.go;drc=c29be2d41c6c3ed78a76b4d8d8c1c22d7e0ad5b7;l=538">valueCtx</a></td>
</tr>
<tr>
<td>WithDeadline() / WithTimeout()</td>
<td><a target="_blank" rel="noopener" href="https://cs.opensource.google/go/go/+/refs/tags/go1.18.3:src/context/context.go;drc=c29be2d41c6c3ed78a76b4d8d8c1c22d7e0ad5b7;l=465">timerCtx</a></td>
</tr>
<tr>
<td>WithCancel()</td>
<td><a target="_blank" rel="noopener" href="https://cs.opensource.google/go/go/+/refs/tags/go1.18.3:src/context/context.go;drc=c29be2d41c6c3ed78a76b4d8d8c1c22d7e0ad5b7;l=342">cancelCtx</a></td>
</tr>
<tr>
<td>Background() / TODO()</td>
<td><a target="_blank" rel="noopener" href="https://cs.opensource.google/go/go/+/refs/tags/go1.18.3:src/context/context.go;drc=2580d0e08d5e9f979b943758d3c49877fb2324cb;l=171">emptyCtx</a></td>
</tr>
</tbody></table>
<blockquote>
<p>é¢˜å¤–è¯ï¼Œä½ çœ‹è¿™ç§æ–¹å¼ï¼Œåƒä¸åƒä¹‹å‰æåˆ°çš„å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œä¸Šè¾¹è¡¨æ ¼ä¸­çš„ struct å°±æ˜¯å·¥å‚æ–¹æ³•å­ç±»ï¼Œå¦‚æœè¯´æˆ‘ä»¬ä»¥åè¦æ·»åŠ ä¸€ä¸ªæ–°çš„ ctx æ˜¯ä¸å½±å“å·²å­˜åœ¨çš„å†…å®¹çš„ï¼Œæ»¡è¶³äº†å¼€é—­åŸåˆ™ã€‚</p>
</blockquote>
<h3 id="WithCancel"><a href="#WithCancel" class="headerlink" title="WithCancel"></a>WithCancel</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A cancelCtx can be canceled. When canceled, it also cancels any children</span></span><br><span class="line"><span class="comment">// that implement canceler.</span></span><br><span class="line"><span class="keyword">type</span> cancelCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    Context</span><br><span class="line"></span><br><span class="line">    mu       sync.Mutex            <span class="comment">// protects following fields</span></span><br><span class="line">    done     <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;         <span class="comment">// created lazily, closed by first cancel call</span></span><br><span class="line">    children <span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125; <span class="comment">// set to nil by the first cancel call</span></span><br><span class="line">    err      error                 <span class="comment">// set to non-nil by the first cancel call</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>çœ‹åˆ°è¿™é‡Œæœ‰ä¸€æŠŠçå…¶å®å°±æ˜ç™½ä¸ºä»€ä¹ˆ context å¯ä»¥å¹¶å‘è®¿é—®</strong>ã€‚</p>
<p>cancelCtx ä¸­è¿˜æœ‰ä¸ªéå¸¸é‡è¦çš„ç‚¹å°±æ˜¯ <code>cancel</code> å–æ¶ˆå½“å‰çš„ ctx ä»¥åŠå¯¹åº”çš„ childã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡ channel å‘Šè¯‰è¦ cancel æ‰è¿™ä¸ª ctx</span></span><br><span class="line"><span class="comment">// cancel å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">cancel</span><span class="params">(removeFromParent <span class="keyword">bool</span>, err error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;context: internal error: missing cancel error&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> c.err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.mu.Unlock()</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// already canceled</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.err = err</span><br><span class="line">    <span class="keyword">if</span> c.done == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.done = closedchan</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">close</span>(c.done)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> child := <span class="keyword">range</span> c.children &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> acquiring the child&#x27;s lock while holding parent&#x27;s lock.</span></span><br><span class="line">        child.cancel(<span class="literal">false</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    c.children = <span class="literal">nil</span></span><br><span class="line">    c.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> removeFromParent &#123;</span><br><span class="line">        removeChild(c.Context, c)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>åˆ›å»º cancelCtx è¿‡ç¨‹ï¼Œæºç åˆ†æ</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// use ctx do something</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ parent ä¼ é€’ä¸º nil æ—¶ï¼Œç›´æ¥panic</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥åœ¨ä¸çŸ¥é“ä¼ ä»€ä¹ˆçš„æ—¶å€™ï¼Œä¹Ÿä¸è¦ä¼  nilï¼Œä¼  TODO å³å¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span> <span class="params">(ctx Context, cancel CancelFunc)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> parent == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;cannot create context from nil parent&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    c := newCancelCtx(parent)</span><br><span class="line">    <span class="comment">// ä¼ æ’­è¿™ä¸ª ctxï¼Œæ„æ€ä¸ºå°†è¿™ä¸ªæ–°çš„ ctx æŒ‚åˆ°çˆ¶èŠ‚ç‚¹çš„ä¸‹è¾¹</span></span><br><span class="line">    propagateCancel(parent, &amp;c)</span><br><span class="line">    <span class="keyword">return</span> &amp;c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// propagateCancel arranges for child to be canceled when parent is.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">propagateCancel</span><span class="params">(parent Context, child canceler)</span></span> &#123;</span><br><span class="line">    <span class="comment">// çˆ¶èŠ‚ç‚¹çš„ Done æ”¾åœ¨å­èŠ‚ç‚¹è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">    done := parent.Done()</span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±èƒ½çœ‹åˆ°ï¼Œå¦‚æœæ˜¯ emptyCtxï¼Œ done ç›´æ¥è¿”å›äº† nil</span></span><br><span class="line">    <span class="keyword">if</span> done == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// parent is never canceled</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="comment">// é¿å… parent è¢«å–æ¶ˆï¼Œé¢å¤–åšä¸€æ¬¡æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-done:</span><br><span class="line">        <span class="comment">// parent is already canceled</span></span><br><span class="line">        child.cancel(<span class="literal">false</span>, parent.Err())</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­parentçš„ç±»å‹ï¼Œå¦‚æœæ˜¯ cancelCtxï¼Œèµ°ä¸‹é¢è¿™ä¸ªåˆ†æ”¯</span></span><br><span class="line">    <span class="comment">// å¦åˆ™å•èµ·ä¸€ä¸ª goroutine è¿›è¡Œç›‘å¬</span></span><br><span class="line">    <span class="keyword">if</span> p, ok := parentCancelCtx(parent); ok &#123;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°çˆ¶èŠ‚ç‚¹çš„ cancelCtx å</span></span><br><span class="line">        <span class="comment">// å°†å­èŠ‚ç‚¹ç»™åŠ å…¥è¿›å»å°±è¡Œäº†ã€‚</span></span><br><span class="line">        p.mu.Lock()</span><br><span class="line">        <span class="keyword">if</span> p.err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// parent has already been canceled</span></span><br><span class="line">            child.cancel(<span class="literal">false</span>, p.err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> p.children == <span class="literal">nil</span> &#123;</span><br><span class="line">                p.children = <span class="built_in">make</span>(<span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            p.children[child] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        p.mu.Unlock()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸€å¼€å§‹çœŸçš„æƒ³ä¸åˆ°ä»€ä¹ˆæƒ…å†µä¸‹ä¼šèµ°åˆ°è¿™ä¸ªåˆ†æ”¯</span></span><br><span class="line">        <span class="comment">// åæ¥æƒ³é€šäº†ï¼Œè‡ªå®šä¹‰å®ç°çš„ ctx å°±å¯ä»¥èµ°åˆ°è¿™é‡Œ</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”å¿…é¡»å®ç° Done æ–¹æ³•</span></span><br><span class="line">        atomic.AddInt32(&amp;goroutines, +<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// select ä¼šç›´æ¥é˜»å¡ä½ï¼Œé™¤éä¸‹è¾¹ä¸¤ä¸ªé‡Œè¾¹çš„ä¸€ä¸ªâ€œé€šäº†â€</span></span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœparentè¢«å–æ¶ˆäº†ï¼Œå–æ¶ˆå…¶å­èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">case</span> &lt;-parent.Done():</span><br><span class="line">                    child.cancel(<span class="literal">false</span>, parent.Err())</span><br><span class="line">                <span class="comment">// å¦‚æœå­èŠ‚ç‚¹è¢«å–æ¶ˆäº†ï¼Œä¸ç”¨åšé¢å¤–å¤„ç†</span></span><br><span class="line">                <span class="keyword">case</span> &lt;-child.Done():</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// parentCancelCtx å°†çˆ¶èŠ‚ç‚¹ä¸­çš„ cancelCtx æå–å‡ºå•¦</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parentCancelCtx</span><span class="params">(parent Context)</span> <span class="params">(*cancelCtx, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    done := parent.Done()</span><br><span class="line">    <span class="comment">// éªŒè¯ parent æ˜¯å¦å·²ç»å…³é—­äº†</span></span><br><span class="line">    <span class="keyword">if</span> done == closedchan || done == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™ä¸ª key å°±æ˜¯ä¸“é—¨ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸º cancelCtx çš„</span></span><br><span class="line">    <span class="comment">// ä¸€å¼€å§‹è¿˜å¾ˆå¥½å¥‡æ˜¯åœ¨å“ªé‡Œè¿›è¡Œå­˜å‚¨çš„è¿™ä¸ª key value çš„</span></span><br><span class="line">    <span class="comment">// å…¶å®äººå®¶æ ¹æœ¬æ²¡å­˜ï¼Œå°±æ˜¯ç”¨ä¸¤ä¸ªç‰¹å®šçš„ key è¿›è¡Œæ¯”å¯¹çš„</span></span><br><span class="line">    p, ok := parent.Value(&amp;cancelCtxKey).(*cancelCtx)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    p.mu.Lock()</span><br><span class="line">    ok = p.done == done</span><br><span class="line">    p.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ç„¶åå¦å¤– <code>timerCtx</code> çš„å®ç°å…¶å®å¤§å·®ä¸å·®ï¼Œå¢åŠ äº†æ—¶é—´é™åˆ¶è€Œå·²ã€‚</p>
<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>ä½¿ç”¨ Context éœ€è¦æ³¨æ„ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<ul>
<li>ä¸è¦è‡ªå·±å†…åµŒ <code>Context</code>; å–è€Œä»£ä¹‹çš„æ˜¯æ˜¾ç¤ºä¼ é€’ <code>Context</code> ç»™éœ€è¦çš„å‡½æ•°ã€‚</li>
<li>Context åº”è¯¥ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</li>
<li>ä¸è¦ç»™å‡½æ•°ä¼ é€’ nil çš„ <code>Context</code>ï¼Œå°½ç®¡å‡½æ•°æ²¡åŠ é™åˆ¶ï¼Œä½¿ç”¨ <code>context.TODO</code> ä»£æ›¿ã€‚</li>
<li>ä½¿ç”¨ context Value é™„åŠ å‚æ•°æ—¶ï¼Œåªå¯¹é‚£äº›è¯·æ±‚èŒƒå›´å†…çš„å‚æ•°ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p>å‚è€ƒé“¾æ¥: <a target="_blank" rel="noopener" href="https://www.sobyte.net/post/2022-03/go-ctx-best-practice/">Go Context Best Practices</a> [1]</p>
<p><strong>ä½¿ç”¨ context é˜²æ­¢ Goroutine æ³„éœ²</strong>ï¼Œæ¥æºäº [<a target="_blank" rel="noopener" href="https://pkg.go.dev/context#example-WithCancel">è¿™é‡Œ</a>]</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// gen generates integers in a separate goroutine and</span></span><br><span class="line">    <span class="comment">// sends them to the returned channel.</span></span><br><span class="line">    <span class="comment">// The callers of gen need to cancel the context once</span></span><br><span class="line">    <span class="comment">// they are done consuming generated integers not to leak</span></span><br><span class="line">    <span class="comment">// the internal goroutine started by gen.</span></span><br><span class="line">    gen := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        dst := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">        n := <span class="number">1</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">for</span> &#123;</span><br><span class="line">                <span class="keyword">select</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">                    <span class="keyword">return</span> <span class="comment">// returning not to leak the goroutine</span></span><br><span class="line">                <span class="keyword">case</span> dst &lt;- n:</span><br><span class="line">                    n++</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">return</span> dst</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">defer</span> cancel() <span class="comment">// cancel when we are finished consuming integers</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> n := <span class="keyword">range</span> gen(ctx) &#123;</span><br><span class="line">        fmt.Println(n)</span><br><span class="line">        <span class="keyword">if</span> n == <span class="number">5</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=1.0.0"><script type="text/javascript" src="/js/donate.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><a class="pos-f tr3" id="github" href="https://github.com/clamyang" target="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/AliPayQR.jpg"></li><li id="WeChat" qr="/img/WeChatQR.jpg"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>go context</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>bqyang</p><p><span>å‘å¸ƒæ—¶é—´ï¼š</span>2022-06-23</p><p><span>æœ€åæ›´æ–°ï¼š</span>2022-06-24</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2022/language/golang/go-context/">https://bqyang.top/2022/language/golang/go-context/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://bqyang.top/2022/language/golang/go-context/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2022/language/golang/go-errors/">go error handling</a><a class="next" href="/2022/language/golang/go-ast/">åˆè¯† go ast</a></div><script src="https://utteranc.es/client.js" repo="clamyang/blogs" issue-term="title" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://bqyang.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/summary/about-221025/">åˆ·é¢˜è¿˜æ˜¯æŒºæœ‰æ„æ€çš„</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/socket/">ä½¿ç”¨ C æ­å»º Server</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/epoll/">epoll æ–‡æ¡£ç¿»è¯‘</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/k8s/">æ­å»º Kubernetes é›†ç¾¤</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/large-alloc/">Go å¤§å¯¹è±¡åˆ†é…æ¢ç´¢</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/memory-alloc/">Go å†…å­˜åˆ†é…å™¨</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/memory/free-space-manage/">free space management</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/k8s-storage-source-code/">k8s pv pvc æºç </a></li><li class="post-list-item"><a class="post-list-link" href="/2022/design-pattern/Structural/composite/">ç»„åˆæ¨¡å¼</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/pstree/">ç®€æ˜“ç‰ˆ pstree</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.xargin.com/" title="Xargin" target="_blank">Xargin</a><ul></ul><a href="https://mytechshares.com/" title="è‘£æ³½æ¶¦çš„æŠ€æœ¯ç¬”è®°" target="_blank">è‘£æ³½æ¶¦çš„æŠ€æœ¯ç¬”è®°</a><ul></ul><a href="https://hujingnb.com/" title="çƒŸè‰çš„é¦™å‘³" target="_blank">çƒŸè‰çš„é¦™å‘³</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2022 <a href="/." rel="nofollow">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°.</a>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/"> äº¬ICPå¤‡2021035561å·.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>