<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€ç‰©ä¸çŸ¥æ·±ä»¥ä¸ºè€»"><title>Rust-Ownership | æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Rust-Ownership</h1><a id="logo" href="/.">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</a><p class="description">Gopher Watcher</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Rust-Ownership</h1><div class="post-meta">2022-05-11</div><div class="post-content"><p>Rust æ ¸å¿ƒæ¦‚å¿µäº†è§£ â€”â€” Ownership</p>
<span id="more"></span>

<p>Ownership å°±æ˜¯å®šä¹‰äº†ä¸€äº›è§„åˆ™ï¼Œæ¯”å¦‚åœ¨å‡½æ•°ä¸­ä¼ é€’å‚æ•°çš„æ—¶å€™æ˜¯æ€ä¹ˆå¤„ç†å‚æ•°çš„ï¼Œå®˜ç½‘çš„è§£é‡Šä¸º<strong>Rustç¨‹åºå¦‚ä½•ç®¡ç†å†…å­˜çš„ä¸€ç³»åˆ—è§„åˆ™</strong>ã€‚</p>
<p><strong>å†…å­˜ç®¡ç†çš„ä¸‰ç§æ–¹å¼</strong></p>
<ul>
<li>Go è¯­è¨€è¿™ç±»ï¼Œè‡ªåŠ¨åƒåœ¾å›æ”¶æœºåˆ¶</li>
<li>C è¯­è¨€ï¼Œæ‰‹åŠ¨åƒåœ¾å›æ”¶ï¼Œæ˜¾ç¤ºåˆ†é…ã€é‡Šæ”¾</li>
<li>Rust ç‹¬ä¸€æ¡£ï¼Œç»“åˆ<strong>ç¼–è¯‘å™¨ã€ownership å®šä¹‰çš„è§„åˆ™</strong>ï¼Œå¦‚æœè¯´æ²¡æœ‰æŒ‰ç…§ Rust Ownership å®šä¹‰çš„è§„åˆ™ï¼Œé‚£ä¹ˆç¼–è¯‘å°±ä¸ä¼šé€šè¿‡ã€‚</li>
</ul>
<p>ç¬¬ä¸€æ¬¡çŸ¥é“ï¼Œè¿˜èƒ½æœ‰è¿™æ ·çš„å†…å­˜ç®¡ç†æ–¹å¼..</p>
<h1 id="ownership-by-example"><a href="#ownership-by-example" class="headerlink" title="ownership by example"></a>ownership by example</h1><p>ï¼ˆé€šè¿‡ä¾‹å­å­¦ä¹  ownershipï¼‰</p>
<blockquote>
<p>The Stack and the Heap</p>
</blockquote>
<p><code>All data stored on the stack must have a known, fixed size. Data with an unknown size at compile time or a size that might change must be stored on the heap instead.</code></p>
<p><code>Accessing data in the heap is slower than accessing data on the stack because you have to follow a pointer to get there. </code></p>
<h2 id="ownership-Rules"><a href="#ownership-Rules" class="headerlink" title="ownership Rules"></a>ownership Rules</h2><ul>
<li>Rust ä¸­æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªè¢«å«åš <code>owner</code> çš„å˜é‡ï¼Œæ¯”å¦‚ a = 1, 1 çš„ owner å°±æ˜¯ aã€‚</li>
<li>åŒä¸€æ—¶åˆ»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ownerã€‚</li>
<li>å½“ owner è¶…å‡ºèŒƒå›´æ—¶ï¼ˆè¶…å‡ºä½œç”¨åŸŸï¼‰ï¼Œvalue ä¼šè¢«ä¸¢å¼ƒã€‚</li>
</ul>
<h2 id="å˜é‡ä½œç”¨åŸŸ"><a href="#å˜é‡ä½œç”¨åŸŸ" class="headerlink" title="å˜é‡ä½œç”¨åŸŸ"></a>å˜é‡ä½œç”¨åŸŸ</h2><p>ä½œç”¨åŸŸå¤§å®¶äº†è§£çš„å·²ç»å¾ˆå¤šäº†ï¼Œè¦æ˜¯ç›´æ¥çœ‹ C ä»£ç å…¶å®è¿˜æ˜¯æœ‰ç‚¹æ‡µé€¼çš„ã€‚ã€‚ä¸ä¿¡ä½ è¯•è¯•ã€‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">2</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, x);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å¾ˆæ˜¾ç„¶ï¼Œç­”æ¡ˆä¸æ˜¯ 2 ï¼Œ2ï¼› æ­£ç¡®ç­”æ¡ˆä¸ºï¼š2ï¼Œ 1ï¼›</p>
</blockquote>
<p>Rust ä¸­å…¶å®ä¹Ÿç±»ä¼¼ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="string">&quot;hello&quot;</span>;	<span class="comment">// è¿™æ—¶å€™å˜é‡å¼€å§‹æœ‰æ•ˆ</span></span><br><span class="line">    &#125; 					    <span class="comment">// ä»è¿™æ—¶èµ·ï¼Œå°±æ— æ•ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¸¤ä¸ªé‡è¦çš„ç‚¹ï¼š</p>
<ul>
<li>å˜é‡ s åœ¨ä½œç”¨åŸŸå†…ï¼Œæœ‰æ•ˆ</li>
<li>å˜é‡ s è¶…å‡ºä½œç”¨åŸŸï¼Œæ— æ•ˆ</li>
</ul>
<h2 id="å†…å­˜å’Œåˆ†é…"><a href="#å†…å­˜å’Œåˆ†é…" class="headerlink" title="å†…å­˜å’Œåˆ†é…"></a>å†…å­˜å’Œåˆ†é…</h2><p>Rust ä¸­å†…å­˜é‡Šæ”¾çš„æ–¹å¼ï¼Œ<strong>è¶…å‡ºäº†ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾</strong>ã€‚Rust ä¹Ÿç®—æ˜¯å¸®æˆ‘ä»¬åšäº†å†…å­˜ç®¡ç†ï¼Œè™½ç„¶æ²¡æœ‰ GCï¼Œä½†æ˜¯ä¹Ÿä¸ç”¨æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œ freeï¼Œé¿å…å‡ºç° double free é—®é¢˜ï¼Œå¦‚ä¸Šè¿°åˆ†é…çš„ s å˜é‡ï¼Œè¶…å‡ºäº†ä½œç”¨åŸŸå°±è¢«é‡Šæ”¾æ‰ã€‚</p>
<h2 id="ownership-Move"><a href="#ownership-Move" class="headerlink" title="ownership Move"></a>ownership Move</h2><p>Stack </p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> y = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Heap</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> s2 = s1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¸¤æ®µä»£ç è¡¨è¾¾çš„æ„æ€ç›¸è¿‘ï¼Œä½†æ˜¯ï¼Œåœ¨ä¸åŒçš„å†…å­˜ç©ºé—´ä¸Šæœ‰ç€å¾ˆå¤§çš„å·®åˆ«ã€‚</p>
<ul>
<li><p>stack ä¸èµ˜è¿°</p>
</li>
<li><p>heap</p>
<p><img src="https://doc.rust-lang.org/book/img/trpl04-02.svg" alt="s1 and s2 pointing to the same value"></p>
</li>
</ul>
<p>æ‰§è¡Œå®Œèµ‹å€¼æ“ä½œåï¼Œæœ‰ä¸¤ä¸ªæŒ‡å‘åŒä¸€å—å†…å­˜çš„æŒ‡é’ˆï¼Œä½†æ˜¯è¿™ä¹Ÿä¼šå­˜åœ¨ä¸€ç§æƒ…å†µï¼Œå½“ s1 å’Œ s2 éƒ½ç”¨ä¸åˆ°æ—¶å€™ï¼Œä¼šè¿›è¡Œ freeï¼Œå°±ä¼šå‡ºç° double free çš„æƒ…å†µã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯å†…å­˜å®‰å…¨ï¼Œåœ¨ <code>let s2 = s1;</code> æ‰§è¡Œå®Œæˆåï¼ŒRust <strong>è®¤ä¸º s1 ä¸å†æœ‰æ•ˆ</strong>ã€‚å³ï¼Œå°† s1 ownership move to s2.</p>
<h2 id="ownership-Clone"><a href="#ownership-Clone" class="headerlink" title="ownership Clone"></a>ownership Clone</h2><p>(deeply copy)</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> s2 = s1.<span class="built_in">Copy</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;s1 is &#123;&#125;, s2 is &#123;&#125;&quot;</span>, s1, s2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://doc.rust-lang.org/book/img/trpl04-03.svg" alt="s1 and s2 to two places"></p>
<h2 id="Stack-Only-Data-Copy"><a href="#Stack-Only-Data-Copy" class="headerlink" title="Stack-Only Data: Copy"></a>Stack-Only Data: Copy</h2><p><code>The reason is that types such as integers that have a known size at compile time are stored entirely on the stack, so copies of the actual values are quick to make. That means thereâ€™s no reason we would want to prevent </code>x<code>from being valid after we create the variable</code>y<code>. </code></p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œæ ˆä¸Šçš„æ•°æ®ä¼šè¿›è¡Œ Copyï¼Œå †ä¸Šçš„æ•°æ®ä¼šè¿›è¡Œ moveã€‚</p>
<h2 id="å‡½æ•°ä¹‹é—´-ownership-çš„æ”¹å˜"><a href="#å‡½æ•°ä¹‹é—´-ownership-çš„æ”¹å˜" class="headerlink" title="å‡½æ•°ä¹‹é—´ ownership çš„æ”¹å˜"></a>å‡½æ•°ä¹‹é—´ ownership çš„æ”¹å˜</h2><p>å°†å˜é‡ä¼ é€’ç»™å‡½æ•°çš„æ—¶å€™ä¹Ÿå¯èƒ½ä¼šå‘ç”Ÿ move æˆ– copyï¼Œå’Œåˆ†é…å·®ä¸å¤šã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);  <span class="comment">// s comes into scope</span></span><br><span class="line"></span><br><span class="line">    takes_ownership(s);             <span class="comment">// s&#x27;s value moves into the function...</span></span><br><span class="line">    <span class="comment">// ... and so is no longer valid here</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">5</span>;                      <span class="comment">// x comes into scope</span></span><br><span class="line"></span><br><span class="line">    makes_copy(x);                  <span class="comment">// x would move into the function,</span></span><br><span class="line">    <span class="comment">// but i32 is Copy, so it&#x27;s okay to still</span></span><br><span class="line">    <span class="comment">// use x afterward</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// Here, x goes out of scope, then s. But because s&#x27;s value was moved, nothing</span></span><br><span class="line"><span class="comment">// special happens.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">takes_ownership</span></span>(some_string: <span class="built_in">String</span>) &#123; <span class="comment">// some_string comes into scope</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, some_string);</span><br><span class="line">&#125; <span class="comment">// Here, some_string goes out of scope and `drop` is called. The backing</span></span><br><span class="line"><span class="comment">// memory is freed.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">makes_copy</span></span>(some_integer: <span class="built_in">i32</span>) &#123; <span class="comment">// some_integer comes into scope</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, some_integer);</span><br><span class="line">&#125; <span class="comment">// Here, some_integer goes out of scope. Nothing special happens.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="å‡½æ•°è¿”å›æ—¶ä¸-ownership"><a href="#å‡½æ•°è¿”å›æ—¶ä¸-ownership" class="headerlink" title="å‡½æ•°è¿”å›æ—¶ä¸ ownership"></a>å‡½æ•°è¿”å›æ—¶ä¸ ownership</h2><p>è¿”å›å€¼ä¹Ÿä¼šè½¬ç§» ownershipã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = gives_ownership();         <span class="comment">// gives_ownership moves its return</span></span><br><span class="line">    <span class="comment">// value into s1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> s2 = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);     <span class="comment">// s2 comes into scope</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> s3 = takes_and_gives_back(s2);  <span class="comment">// s2 is moved into</span></span><br><span class="line">    <span class="comment">// takes_and_gives_back, which also</span></span><br><span class="line">    <span class="comment">// moves its return value into s3</span></span><br><span class="line">&#125; <span class="comment">// Here, s3 goes out of scope and is dropped. s2 was moved, so nothing</span></span><br><span class="line"><span class="comment">// happens. s1 goes out of scope and is dropped.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">gives_ownership</span></span>() -&gt; <span class="built_in">String</span> &#123;             <span class="comment">// gives_ownership will move its</span></span><br><span class="line">    <span class="comment">// return value into the function</span></span><br><span class="line">    <span class="comment">// that calls it</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> some_string = <span class="built_in">String</span>::from(<span class="string">&quot;yours&quot;</span>); <span class="comment">// some_string comes into scope</span></span><br><span class="line"></span><br><span class="line">    some_string                              <span class="comment">// some_string is returned and</span></span><br><span class="line">    <span class="comment">// moves out to the calling</span></span><br><span class="line">    <span class="comment">// function</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function takes a String and returns one</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">takes_and_gives_back</span></span>(a_string: <span class="built_in">String</span>) -&gt; <span class="built_in">String</span> &#123; <span class="comment">// a_string comes into</span></span><br><span class="line">    <span class="comment">// scope</span></span><br><span class="line"></span><br><span class="line">    a_string  <span class="comment">// a_string is returned and moves out to the calling function</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæ¯æ¬¡è¿›è¡Œå‡½æ•°ä¼ å‚çš„æ—¶å€™éƒ½ä¼šå‘ç”Ÿ ownership çš„è½¬ç§»ï¼Œå¦‚æœè¯´æˆ‘ä»¬ç»™ funcA ä¼ ä¸€ä¸ª A å‚æ•°åï¼Œä»ç„¶è¦ä½¿ç”¨ A å‚æ•°ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<ul>
<li> å¯ä»¥æŠŠè¿™ä¸ªå‚æ•°ä» funcA ä¸­è¿”å›</li>
</ul>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> (s2, len) = calculate_length(s1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The length of string &#123;&#125; is &#123;&#125;&quot;</span>, s2, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">calculate_length</span></span>(s: string) -&gt; (<span class="built_in">String</span>, <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> length = s.len();</span><br><span class="line">    (s, length)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç‰›xçš„ Rust å½“ç„¶è¿˜æä¾›äº†å¦ä¸€ç§æ–¹å¼ï¼Œ<strong>reference</strong>ã€‚</li>
</ul>
<h2 id="Reference-and-Borrowing"><a href="#Reference-and-Borrowing" class="headerlink" title="Reference and Borrowing"></a>Reference and Borrowing</h2><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>æœ¬ä»¥ä¸ºè¿™ä¸ª reference å’Œ pointer æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œä½†æ˜¯ rust ä¸­è²Œä¼¼å¹¶ä¸æ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼Œä¸”çœ‹ä¸”åˆ†æã€‚</p>
<p><code> A reference is like a pointer in that itâ€™s an address we can follow to access data stored at that address that is owned by some other variable.</code></p>
<p>reference å’Œ pointer ç›¸åŒçš„ç‚¹ï¼Œå­˜å‚¨çš„éƒ½æ˜¯åœ°å€ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€è®¿é—®å­˜å‚¨åœ¨è¿™ä¸ªåœ°å€ä¸Šçš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®å¯èƒ½æ˜¯å±äºåˆ«çš„å˜é‡çš„ã€‚ <strong>ä¸åŒçš„ç‚¹</strong>ï¼Œreference æŒ‡å‘çš„æ°¸è¿œæ˜¯<strong>æœ‰æ•ˆ</strong>çš„åœ°å€ã€‚</p>
<p><img src="https://doc.rust-lang.org/book/img/trpl04-05.svg" alt="&amp;String s pointing at String s1"></p>
<p>å› æ­¤ï¼Œä¸Šè¿°ä»£ç å°±å¯ä»¥å°±æ”¹ä¸ºï¼Œ</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> len = calculate_length(&amp;s1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The length of &#x27;&#123;&#125;&#x27; is &#123;&#125;.&quot;</span>, s1, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">calculate_length</span></span>(s: &amp;<span class="built_in">String</span>) -&gt; <span class="built_in">usize</span> &#123; <span class="comment">// s is a reference to a String</span></span><br><span class="line">    s.len()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¸‹é¢è¿™æ®µå¼•ç”¨ï¼Œå†ä¸€æ¬¡è§£é‡Šäº†ï¼Œä¼ é€’å¼•ç”¨ç»™å‡½æ•°æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä¸å†èµ˜è¿°ã€‚</p>
<blockquote>
<p><code>When functions have references as parameters instead of the actual values, we wonâ€™t need to return the values in order to give back ownership, because we never had ownership.</code></p>
</blockquote>
<h3 id="Borrowing"><a href="#Borrowing" class="headerlink" title="Borrowing"></a>Borrowing</h3><p>ï¼ˆæŠŠåˆ›å»º reference çš„è¡Œä¸ºå®šä¹‰æˆ borrowingï¼‰ã€‚åœ¨å®é™…ç”Ÿæ´»ä¸­ï¼Œå°±è·Ÿå€Ÿä¸œè¥¿æ˜¯ä¸€ä¸ªæ„æ€ï¼Œå‡è®¾ä¸€ä¸ªäººæ‹¥æœ‰ä¸€è¾†ä¿æ—¶æ·ï¼Œä½ å€Ÿè¿‡æ¥å¼€ä¸¤å¤©ï¼Œç„¶åè¿˜å›å»ï¼Œæˆ‘ä»¬ä»æœªæ‹¥æœ‰è¿‡ä¿æ—¶æ·ã€‚</p>
<p>ç„¶åé—®é¢˜å°±æ¥äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬æ¥è¿‡æ¥ä¿æ—¶æ·å¼€ä¸¤å¤©ï¼Œå‘ç°ä»–çš„é¢œè‰²çœ‹ç€ä¸é¡ºçœ¼ï¼Œä½ æƒ³ç»™ä»–æ”¹è£…ï¼Œè¿™æ—¶å€™æ€ä¹ˆåŠï¼Ÿå¦‚ä¸‹ã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">    change(&amp;s1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">change</span></span>(some_str: &amp;<span class="built_in">String</span>) &#123;     </span><br><span class="line">    some_str.push_str(<span class="string">&quot;RTFM&quot;</span>);     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error[E0596]: cannot borrow `*some_str` as mutable, as it is behind a `&amp;` reference</span><br><span class="line"> --&gt; src/main.rs:8:5</span><br><span class="line">  |</span><br><span class="line">7 | fn change(some_str: &amp;String) &#123;</span><br><span class="line">  |                     ------- help: consider changing this to be a mutable reference: `&amp;mut String`</span><br><span class="line">8 |     some_str.push_str(&quot;RTFM&quot;);</span><br><span class="line">  |     ^^^^^^^^^^^^^^^^^^^^^^^^^ `some_str` is a `&amp;` reference, so the data it refers to cannot be borrowed as mutable</span><br><span class="line"></span><br><span class="line">For more information about this error, try `rustc --explain E0596`.</span><br><span class="line">error: could not compile `borrowing` due to previous error</span><br></pre></td></tr></table></figure>



<p>éªŒè¯äº†ä¸€ä¸ªç»“è®ºï¼Œé»˜è®¤æƒ…å†µåŠ ï¼Œ<strong>borrow</strong>è¿‡æ¥çš„ä¸œè¥¿æ˜¯ä¸å¯ä¿®æ”¹çš„ï¼Œé™¤éåŠ ä¸Š<strong>mut</strong>(mutable)ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fn main() &#123;</span><br><span class="line">    let mut s1 = String::from(&quot;hello&quot;);</span><br><span class="line"></span><br><span class="line">    change(&amp;mut s1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn change(some_str: &amp;mut String) &#123;     </span><br><span class="line">    some_str.push_str(&quot;RTFM&quot;);     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±å¯è‚†æ— å¿Œæƒ®çš„ä¿®æ”¹ reference æŒ‡å‘çš„å†…å®¹äº†ï¼Œå½¢å¦‚è¿™æ ·çš„è¢«ç§°ä¸º <code>mutable reference</code>ã€‚</p>
<p>Mutable referenct ä¸€ä¸ªæœ€å¤§é™åˆ¶ï¼š<strong>åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æ‹¥æœ‰æŸä¸ªå˜é‡çš„ä¸€ä¸ª mut reference</strong>ã€‚å¯ä»¥è¯•è¯•ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> s1 = <span class="built_in">String</span>::from(<span class="string">&quot;RTFM&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> r1 = &amp;<span class="keyword">mut</span> s1;</span><br><span class="line">    <span class="keyword">let</span> r2 = &amp;<span class="keyword">mut</span> s2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>, r1, r2);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error[E0499]: cannot borrow `s1` as mutable more than once at a time</span><br><span class="line"> --&gt; src/main.rs:5:14</span><br><span class="line">  |</span><br><span class="line">4 |     let s2 = &amp;mut s1;</span><br><span class="line">  |              ------- first mutable borrow occurs here</span><br><span class="line">5 |     let s3 = &amp;mut s1;</span><br><span class="line">  |              ^^^^^^^ second mutable borrow occurs here</span><br><span class="line">6 | </span><br><span class="line">7 |     println!(&quot;&#123;&#125; &#123;&#125;&quot;, s2, s3);</span><br><span class="line">  |                       -- first borrow later used here</span><br><span class="line"></span><br><span class="line">For more information about this error, try `rustc --explain E0499`.</span><br><span class="line">error: could not compile `borrowing` due to previous error</span><br></pre></td></tr></table></figure>



<p><strong>mutable reference and immutable reference</strong></p>
<p><strong>ä¸èƒ½åŒæ—¶æ‹¥æœ‰å¯å˜çš„å’Œä¸å¯å˜çš„ reference</strong>ï¼Œæ„å‘³ç€ï¼Œè¦ä¹ˆåªæœ‰ä¸€ä¸ª mutableï¼Œè¦ä¹ˆæœ‰å¤šä¸ª immutableï¼Œä¸èƒ½æœ‰ä¸€ä¸ª mutable å’Œå¤šä¸ª immutable çš„æƒ…å†µã€‚</p>
<h2 id="Reference-scope"><a href="#Reference-scope" class="headerlink" title="Reference scope"></a>Reference scope</h2><p>reference çš„ç”Ÿæ•ˆèŒƒå›´ï¼Œ**Note that a referenceâ€™s scope starts from where it is introduced and continues through the last time that reference is used. **</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> r1 = &amp;s; <span class="comment">// no problem</span></span><br><span class="line">    <span class="keyword">let</span> r2 = &amp;s; <span class="comment">// no problem</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; and &#123;&#125;&quot;</span>, r1, r2);</span><br><span class="line">    <span class="comment">// variables r1 and r2 will not be used after this point</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> r3 = &amp;<span class="keyword">mut</span> s; <span class="comment">// no problem</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, r3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Dangling-References"><a href="#Dangling-References" class="headerlink" title="Dangling References"></a>Dangling References</h2><p>æ‚¬å‚å¼•ç”¨ï¼Œæœ‰ç‚¹ç±»ä¼¼ dangling pointerï¼Œ rust ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥ reference æŒ‡å‘çš„å†…å®¹æ˜¯å¦æœ‰æ•ˆï¼Œä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> reference_to_nothing = dangle();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">dangle</span></span>() -&gt; &amp;<span class="built_in">String</span> &#123; <span class="comment">// dangle returns a reference to a String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">&quot;hello&quot;</span>); <span class="comment">// s is a new String</span></span><br><span class="line"></span><br><span class="line">    &amp;s <span class="comment">// we return a reference to the String, s</span></span><br><span class="line">&#125; <span class="comment">// Here, s goes out of scope, and is dropped. Its memory goes away.</span></span><br><span class="line"><span class="comment">// Danger!</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cargo run</span><br><span class="line">   Compiling ownership v0.1.0 (file:///projects/ownership)</span><br><span class="line">error[E0106]: missing lifetime specifier</span><br><span class="line"> --&gt; src/main.rs:5:16</span><br><span class="line">  |</span><br><span class="line">5 | fn dangle() -&gt; &amp;String &#123;</span><br><span class="line">  |                ^ expected named lifetime parameter</span><br><span class="line">  |</span><br><span class="line">  = help: this function&#x27;s return type contains a borrowed value, but there is no value for it to be borrowed from</span><br><span class="line">help: consider using the `&#x27;static` lifetime</span><br><span class="line">  |</span><br><span class="line">5 | fn dangle() -&gt; &amp;&#x27;static String &#123;</span><br><span class="line">  |                ~~~~~~~~</span><br><span class="line"></span><br><span class="line">For more information about this error, try `rustc --explain E0106`.</span><br><span class="line">error: could not compile `ownership` due to previous error</span><br></pre></td></tr></table></figure>



<h2 id="Rules-of-Reference"><a href="#Rules-of-Reference" class="headerlink" title="Rules of Reference"></a>Rules of Reference</h2><ul>
<li>ä»»ä½•æ—¶åˆ»ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ª mutable referenceï¼Œè¦ä¹ˆæœ‰å¤šä¸ª immutable referenceã€‚</li>
<li>Reference æŒ‡å‘çš„å†…å®¹ä¸€å®šæ˜¯æœ‰æ•ˆçš„ã€‚</li>
</ul>
<h2 id="Slices"><a href="#Slices" class="headerlink" title="Slices"></a>Slices</h2><p>è¿™ä¸ªè·Ÿ Go çš„åˆ‡ç‰‡å¼•ç”¨ç±»ä¼¼..ï¼Œç›´æ¥è´´å¼ å›¾ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<p><img src="https://doc.rust-lang.org/book/img/trpl04-06.svg" alt="world containing a pointer to the byte at index 6 of String s and a length 5"></p>
<h2 id="å®Œç»“æ’’èŠ±"><a href="#å®Œç»“æ’’èŠ±" class="headerlink" title="å®Œç»“æ’’èŠ±"></a>å®Œç»“æ’’èŠ±</h2></div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=1.0.0"><script type="text/javascript" src="/js/donate.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><a class="pos-f tr3" id="github" href="https://github.com/clamyang" target="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/AliPayQR.jpg"></li><li id="WeChat" qr="/img/WeChatQR.jpg"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>Rust-Ownership</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>bqyang</p><p><span>å‘å¸ƒæ—¶é—´ï¼š</span>2022-05-11</p><p><span>æœ€åæ›´æ–°ï¼š</span>2022-07-11</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2022/language/rust/ownership/">https://bqyang.top/2022/language/rust/ownership/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://bqyang.top/2022/language/rust/ownership/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2022/language/rust/structs/">Rust-Structs</a><a class="next" href="/2022/k8s/deployment/">Deployment æ›´æ–°ç­–ç•¥</a></div><script src="https://utteranc.es/client.js" repo="clamyang/blogs" issue-term="title" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://bqyang.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/os/memory/free-space-manage/">free space management</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/memory-alloc/">Go å†…å­˜åˆ†é…å™¨</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/k8s-storage-source-code/">k8s pv pvc æºç </a></li><li class="post-list-item"><a class="post-list-link" href="/2022/design-pattern/Structural/composite/">ç»„åˆæ¨¡å¼</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/pstree/">ç®€æ˜“ç‰ˆ pstree</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/k8s-storage/">k8s å­˜å‚¨å†…å®¹</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/design-pattern/Structural/facade/">é—¨é¢æ¨¡å¼ï¼ˆå¤–è§‚æ¨¡å¼ï¼‰</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/memory-api/">å†…å­˜ç›¸å…³ API</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/100-go-mistaks/2-misuse-init/">misuse init func</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/golang/go-params-to-goroutine/">å‚æ•°æ˜¯æ€ä¹ˆä¼ ç»™ goroutine çš„</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.xargin.com/" title="Xargin" target="_blank">Xargin</a><ul></ul><a href="https://mytechshares.com/" title="è‘£æ³½æ¶¦çš„æŠ€æœ¯ç¬”è®°" target="_blank">è‘£æ³½æ¶¦çš„æŠ€æœ¯ç¬”è®°</a><ul></ul><a href="https://hujingnb.com/" title="çƒŸè‰çš„é¦™å‘³" target="_blank">çƒŸè‰çš„é¦™å‘³</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2022 <a href="/." rel="nofollow">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°.</a>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/"> äº¬ICPå¤‡2021035561å·.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>