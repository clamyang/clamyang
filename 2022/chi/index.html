<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€ç‰©ä¸çŸ¥æ·±ä»¥ä¸ºè€»"><title>chi æ¡†æ¶è·¯ç”±åˆ†æ | æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">chi æ¡†æ¶è·¯ç”±åˆ†æ</h1><a id="logo" href="/.">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">chi æ¡†æ¶è·¯ç”±åˆ†æ</h1><div class="post-meta">2022-02-22</div><div class="post-content"><p>ï¼ˆæš‚æ—¶è¿˜æ²¡å†™å®Œï¼Œä¸è¿‡ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘ä¹Ÿå‘è¡¨äº†å‡ºæ¥ã€‚è¿™æ ·å›å®¶å°±ä¸ç”¨å¸¦ç”µè„‘äº†ã€‚ã€‚ï¼‰</p>
<p>chi æ¡†æ¶ç›¸å¯¹å®¹æ˜“ä¸€äº›ï¼Œè·Ÿä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„ appsrv æ¡†æ¶è¿›è¡Œä¸€ä¸ªç®€å•åœ°å¯¹æ¯”ï¼Œçœ‹ä¸€ä¸‹å®ç°çš„å·®å¼‚åœ¨å“ªé‡Œã€‚</p>
<span id="more"></span>

<p>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šæºç </p>
<hr>
<blockquote>
<p>ä¸‹é¢è¿™æ®µè¯æ˜¯æˆ‘çœ‹è¿‡åæ‰å†™çš„ï¼Œè¿™ä¸ªæ¡†æ¶ä¸­æ¶‰åŠåˆ°çš„äº†èŠ‚ç‚¹çš„æ‹†åˆ†æ›¿æ¢ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯å¯ä»¥èŠ‚çœæ›´å¤šçš„ç©ºé—´ï¼Œå¦‚æœå½¼æ­¤ä¹‹é—´æ²¡æœ‰å…¬å…±éƒ¨åˆ†çš„è¯ã€‚</p>
</blockquote>
<p>æˆ‘ç”¨è¿™ä¸‰ä¸ªè·¯ç”±è¿›è¡Œçš„æµ‹è¯•ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 1 &quot;&#x2F;&quot;
&#x2F;&#x2F; 2 &quot;&#x2F;hello&#x2F;world&quot;
&#x2F;&#x2F; 3 &quot;&#x2F;hello&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæ˜¯æŒ‰ç…§ä¸Šè¿°æ–¹å¼è¿›è¡Œæ’å…¥ï¼Œæ‰§è¡Œçš„ 2 çš„æ—¶å€™ï¼Œnode çš„å­˜å‚¨æ–¹å¼å°±æ˜¯ä¸€ä¸ª <code>hello/world</code> ï¼Œä½†æ˜¯å½“ 3 æ‰§è¡Œçš„æ—¶å€™ï¼ŒåŒ¹é…åˆ°äº†ç›¸åŒçš„å‰ç¼€ <code>hello</code> æ­¤æ—¶ä¼šå°† <code>hello/world</code> æ‹†åˆ†æˆä¸¤ä¸ª nodeï¼Œè€Œ 3 ä¸­çš„ hello è¿™ä¸ªnodeçš„å®ç°ï¼Œå°±æ˜¯ 2ä¸­çš„ helloã€‚ä¸çŸ¥é“è¿™æ ·è¡¨è¿°æ˜¯å¦æ¸…æ™°ã€‚ã€‚</p>
<hr>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// è·¯ç”±çš„æ’å…¥</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">InsertRoute</span><span class="token punctuation">(</span>method methodTyp<span class="token punctuation">,</span> pattern <span class="token builtin">string</span><span class="token punctuation">,</span> handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> parent <span class="token operator">*</span>node
    <span class="token comment">// è·å–è®¿é—®è·¯å¾„ï¼Œå½¢å¦‚ /hello/world</span>
    search <span class="token operator">:=</span> pattern

    <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Handle key exhaustion</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Insert or update the node's leaf handler</span>
            n<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>
            <span class="token keyword">return</span> n
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// We're going to be searching for a wild node next,</span>
        <span class="token comment">// in this case, we need to get the tail</span>
        <span class="token keyword">var</span> label <span class="token operator">=</span> search<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">var</span> segTail <span class="token builtin">byte</span>
        <span class="token keyword">var</span> segEndIdx <span class="token builtin">int</span>
        <span class="token keyword">var</span> segTyp nodeTyp
        <span class="token keyword">var</span> segRexpat <span class="token builtin">string</span>
        <span class="token keyword">if</span> label <span class="token operator">==</span> <span class="token string">'&#123;'</span> <span class="token operator">||</span> label <span class="token operator">==</span> <span class="token string">'*'</span> <span class="token punctuation">&#123;</span>
            segTyp<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> segRexpat<span class="token punctuation">,</span> segTail<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> segEndIdx <span class="token operator">=</span> <span class="token function">patNextSegment</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">var</span> prefix <span class="token builtin">string</span>
        <span class="token keyword">if</span> segTyp <span class="token operator">==</span> ntRegexp <span class="token punctuation">&#123;</span>
            prefix <span class="token operator">=</span> segRexpat
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Look for the edge to attach to</span>
        parent <span class="token operator">=</span> n
        n <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">getEdge</span><span class="token punctuation">(</span>segTyp<span class="token punctuation">,</span> label<span class="token punctuation">,</span> segTail<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>

        <span class="token comment">// No edge, create one</span>
        <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            child <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">&#123;</span>label<span class="token punctuation">:</span> label<span class="token punctuation">,</span> tail<span class="token punctuation">:</span> segTail<span class="token punctuation">,</span> prefix<span class="token punctuation">:</span> search<span class="token punctuation">&#125;</span>
            hn <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> search<span class="token punctuation">)</span>
            hn<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>

            <span class="token keyword">return</span> hn
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Found an edge to match the pattern</span>

        <span class="token keyword">if</span> n<span class="token punctuation">.</span>typ <span class="token operator">></span> ntStatic <span class="token punctuation">&#123;</span>
            <span class="token comment">// We found a param node, trim the param from the search path and continue.</span>
            <span class="token comment">// This param/wild pattern segment would already be on the tree from a previous</span>
            <span class="token comment">// call to addChild when creating a new node.</span>
            search <span class="token operator">=</span> search<span class="token punctuation">[</span>segEndIdx<span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Static nodes fall below here.</span>
        <span class="token comment">// Determine longest prefix of the search key on match.</span>
        <span class="token comment">// åŒ¹é…æœ€é•¿å‰ç¼€ï¼Œä¸€ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º O(n) çš„ç®—æ³•ï¼Œé‡åˆ°ä¸åŒçš„ç›´æ¥ break</span>
        commonPrefix <span class="token operator">:=</span> <span class="token function">longestPrefix</span><span class="token punctuation">(</span>search<span class="token punctuation">,</span> n<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span>
        <span class="token keyword">if</span> commonPrefix <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// èµ°åˆ°è¿™ä¸ª if é‡Œè¾¹ï¼Œè¯´æ˜å½“å‰ parent çš„å‰ç¼€ï¼Œè¢«å®Œå…¨åŒ…å«åœ¨äº† child ä¸­</span>
            <span class="token comment">// the common prefix is as long as the current node's prefix we're attempting to insert.</span>
            <span class="token comment">// keep the search going.</span>
            search <span class="token operator">=</span> search<span class="token punctuation">[</span>commonPrefix<span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Split the node</span>
        child <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">&#123;</span>
            typ<span class="token punctuation">:</span>    ntStatic<span class="token punctuation">,</span>
            prefix<span class="token punctuation">:</span> search<span class="token punctuation">[</span><span class="token punctuation">:</span>commonPrefix<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// replace çš„è¿‡ç¨‹å°±æ˜¯å°†ï¼Œæ—§ node æ›¿æ¢æˆæœ€å¤§ç›¸åŒå‰ç¼€çš„æ ·å­</span>
        parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>search<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> segTail<span class="token punctuation">,</span> child<span class="token punctuation">)</span>

        <span class="token comment">// Restore the existing node</span>
        <span class="token comment">// ä¸Šè¿°å·²ç»æ›¿æ¢äº†ï¼Œä½†æ˜¯è¿˜å‰©ä¸‹ æ—§ node é™¤äº†æœ€å¤§ç›¸åŒå‰ç¼€ä½™ä¸‹çš„éƒ¨åˆ†ï¼Œ</span>
        <span class="token comment">// è¿™é‡Œçš„æ“ä½œå°±æ˜¯å°†è¿™ä¸ª node çš„ååŠéƒ¨åˆ†é‡æ–°æ’å…¥</span>
        n<span class="token punctuation">.</span>label <span class="token operator">=</span> n<span class="token punctuation">.</span>prefix<span class="token punctuation">[</span>commonPrefix<span class="token punctuation">]</span>
        n<span class="token punctuation">.</span>prefix <span class="token operator">=</span> n<span class="token punctuation">.</span>prefix<span class="token punctuation">[</span>commonPrefix<span class="token punctuation">:</span><span class="token punctuation">]</span>
        child<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> n<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span>

        <span class="token comment">// If the new key is a subset, set the method/handler on this node and finish.</span>
        <span class="token comment">// æ‹†åˆ†åï¼Œå¦‚æœsearchå°±æ²¡äº†ï¼Œè¯´æ˜ search æ˜¯ parent node çš„ prefix çš„å­é›†</span>
        <span class="token comment">// ç›´æ¥æ›´æ–°å½“å‰ node çš„ handler å³å¯</span>
        search <span class="token operator">=</span> search<span class="token punctuation">[</span>commonPrefix<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            child<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>
            <span class="token keyword">return</span> child
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Create a new edge for the node</span>
        <span class="token comment">// è¿™é‡Œå…¶å®ä¹Ÿå¥½ç†è§£äº†ï¼Œå¦‚æœè¯´æ‹†åˆ†åï¼Œsearch ä¸­è¿˜æœ‰å†…å®¹ï¼Œ</span>
        <span class="token comment">// ä¹Ÿä¸ç”¨ç®¡äº†ï¼Œç›´æ¥æ‰”åˆ°ä¸‹ä¸€ä¸ªchildä¸­ï¼Œä¹‹åå†æ·»åŠ çš„æ—¶å€™ï¼Œ</span>
        <span class="token comment">// é€šè¿‡åŒ¹é…æœ€å¤§ç›¸åŒå‰ç¼€çš„æ–¹å¼ï¼Œç»§ç»­æ‹†ã€‚ã€‚</span>
        subchild <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">&#123;</span>
            typ<span class="token punctuation">:</span>    ntStatic<span class="token punctuation">,</span>
            label<span class="token punctuation">:</span>  search<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            prefix<span class="token punctuation">:</span> search<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        hn <span class="token operator">:=</span> child<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>subchild<span class="token punctuation">,</span> search<span class="token punctuation">)</span>
        hn<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>
        <span class="token keyword">return</span> hn
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ªäººæ„Ÿè§‰è¿™ä¸ªæ’å…¥çš„è¿‡ç¨‹è¿˜æ˜¯æŒºç»•çš„ã€‚ã€‚éœ€è¦ç»“åˆä¾‹å­åŠ¨æ‰‹çœ‹ä¸€ä¸‹ï¼Œå…‰åœ¨è„‘å­é‡Œæƒ³ï¼ŒæŠ±æ­‰ï¼æˆ‘æ™ºå•†ä¸å¤Ÿ..</p>
<p>chi æ¡†æ¶ä¸­ï¼Œå°† node åˆ†æˆäº†å‡ ä¸ªç±»å‹ï¼Œå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> nodeTyp <span class="token builtin">uint8</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	ntStatic   nodeTyp <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// /home</span>
	ntRegexp                  <span class="token comment">// /&#123;id:[0-9]+&#125;</span>
	ntParam                   <span class="token comment">// /&#123;user&#125;</span>
	ntCatchAll                <span class="token comment">// /api/v1/*</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>çœ‹çœ‹æ’å…¥è¿‡ç¨‹æ¶‰åŠåˆ°çš„ä¸€äº›æ‚ä¸ƒæ‚å…«çš„å‡½æ•°ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// patNextSegment returns the next segment details from a pattern:</span>
<span class="token comment">// node type, param key, regexp string, param tail byte, param starting index, param ending index</span>
<span class="token keyword">func</span> <span class="token function">patNextSegment</span><span class="token punctuation">(</span>pattern <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nodeTyp<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ps <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> <span class="token string">"&#123;"</span><span class="token punctuation">)</span>
    ws <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
	
    <span class="token comment">// é™æ€nodeï¼Œæ—¢ä¸æ˜¯å‚æ•°ï¼Œä¹Ÿä¸æ˜¯æ­£åˆ™è¡¨è¾¾å¼</span>
    <span class="token keyword">if</span> ps <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ws <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> ntStatic<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span> <span class="token comment">// we return the entire thing</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Sanity check å®Œæ•´æ€§æ£€æŸ¥ï¼Œä¹Ÿä½“ç°äº†è·¯ç”±çš„è§„åˆ™ï¼Œé€šé…ç¬¦åªèƒ½å‡ºç°åœ¨ &#123;&#125; ä¹‹å</span>
    <span class="token keyword">if</span> ps <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ws <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ws <span class="token operator">&lt;</span> ps <span class="token punctuation">&#123;</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"chi: wildcard '*' must be the last pattern in a route, otherwise use a '&#123;param&#125;'"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">var</span> tail <span class="token builtin">byte</span> <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token comment">// Default endpoint tail to / byte</span>

    <span class="token keyword">if</span> ps <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Param/Regexp pattern is next</span>
        nt <span class="token operator">:=</span> ntParam

        <span class="token comment">// Read to closing &#125; taking into account opens and closes in curl count (cc)</span>
        <span class="token comment">// è¿™é‡Œå°±æ˜¯æ‰¾æˆå¯¹çš„ &#123;&#125; ï¼Œè™½ç„¶æ²¡åœ¨ leetcode ä¸Šåšè¿™ä¸ªé¢˜ï¼Œä½†æ˜¯ä¹Ÿå¬è¿‡ã€‚ã€‚</span>
        <span class="token comment">// å¦‚æœ cc > 0ï¼Œè¯´æ˜èŠ±æ‹¬å·å¤šäº†</span>
        <span class="token comment">// å¦‚æœ cc &lt; 0ï¼Œè¯´æ˜èŠ±æ‹¬å·å°‘äº†</span>
        <span class="token comment">// å¦‚æœ cc == 0ï¼Œè¯´æ˜æ­£å¥½åŒ¹é…ä¸Š</span>
        cc <span class="token operator">:=</span> <span class="token number">0</span>
        pe <span class="token operator">:=</span> ps
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> pattern<span class="token punctuation">[</span>ps<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">'&#123;'</span> <span class="token punctuation">&#123;</span>
                cc<span class="token operator">++</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">'&#125;'</span> <span class="token punctuation">&#123;</span>
                cc<span class="token operator">--</span>
                <span class="token keyword">if</span> cc <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                    pe <span class="token operator">=</span> ps <span class="token operator">+</span> i
                    <span class="token keyword">break</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> pe <span class="token operator">==</span> ps <span class="token punctuation">&#123;</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"chi: route param closing delimiter '&#125;' is missing"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// æ‹¿åˆ°äº†æ‹¬å·ä¸­çš„å‚æ•°åç§°</span>
        key <span class="token operator">:=</span> pattern<span class="token punctuation">[</span>ps<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">:</span> pe<span class="token punctuation">]</span>
        pe<span class="token operator">++</span> <span class="token comment">// set end to next positionï¼ŒèŠ±æ‹¬å·åè¾¹çš„é‚£ä¸ªå€¼</span>
		
        <span class="token comment">// tail æŒ‡å‘çš„å°±æ˜¯èŠ±æ‹¬å·åè¾¹çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œæ¯”å¦‚ /&#123;name&#125;/world</span>
        <span class="token keyword">if</span> pe <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            tail <span class="token operator">=</span> pattern<span class="token punctuation">[</span>pe<span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
		
        <span class="token comment">/*
        	ä»è¿™é‡Œå¾€ä¸‹å¼€å§‹å°±æ˜¯æœ‰å…³æ­£åˆ™çš„å†…å®¹
        */</span>
        <span class="token keyword">var</span> rexpat <span class="token builtin">string</span>
        <span class="token keyword">if</span> idx <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> idx <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            nt <span class="token operator">=</span> ntRegexp
            rexpat <span class="token operator">=</span> key<span class="token punctuation">[</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            key <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span>idx<span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>

		<span class="token comment">// å¦‚æœæ˜¯æ­£åˆ™åŒ¹é…ï¼Œäººå®¶è¿˜ç»™æ ¡éªŒäº†å¼€å§‹å’Œç»“æŸã€‚ã€‚</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rexpat<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> rexpat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'^'</span> <span class="token punctuation">&#123;</span>
                rexpat <span class="token operator">=</span> <span class="token string">"^"</span> <span class="token operator">+</span> rexpat
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> rexpat<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>rexpat<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'$'</span> <span class="token punctuation">&#123;</span>
                rexpat <span class="token operator">+=</span> <span class="token string">"$"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">/*
        	æ³¨é‡Šé‡Œè¾¹æåˆ°äº†è¿™å‡ ä¸ªå‚æ•°æ˜¯å•¥æ„æ€ï¼Œä¸è¿‡è¿˜æ˜¯çœ‹ä¸€çœ¼
        	nt	èŠ‚ç‚¹ç±»å‹
        	key	å‚æ•°åç§°
        	rexpat æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²
        	tail	key å‚æ•°åè¾¹çš„ä¸€ä¸ªå­—èŠ‚
        	ps	å‚æ•°å¼€å§‹çš„ç´¢å¼•ä½ç½®
        	pe	å‚æ•°ç»“æŸçš„ç´¢å¼•ä½ç½®
        */</span>
		
        <span class="token keyword">return</span> nt<span class="token punctuation">,</span> key<span class="token punctuation">,</span> rexpat<span class="token punctuation">,</span> tail<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> pe
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Wildcard pattern as finale</span>
    <span class="token keyword">if</span> ws <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"chi: wildcard '*' must be the last value in a route. trim trailing text or use a '&#123;param&#125;' instead"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> ntCatchAll<span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ntyp		èŠ‚ç‚¹ç±»å‹</span>
<span class="token comment">// label	label è¡¨ç¤ºçš„å°±æ˜¯ path è·¯å¾„ä¸Šçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span>
<span class="token comment">// tail		è¡¨ç¤ºä¸ label ç›¸åï¼Œè¡¨ç¤ºæœ€åä¸€ä¸ªå­—èŠ‚</span>
<span class="token comment">// prefix	å½“å‰ node ä¸­å­˜å‚¨çš„ path</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">getEdge</span><span class="token punctuation">(</span>ntyp nodeTyp<span class="token punctuation">,</span> label<span class="token punctuation">,</span> tail <span class="token builtin">byte</span><span class="token punctuation">,</span> prefix <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">&#123;</span>
 	<span class="token comment">// é¦–å…ˆæ˜¯é€šè¿‡ èŠ‚ç‚¹ç±»å‹æ‰¾åˆ°å¯¹åº”çš„ èŠ‚ç‚¹é›†åˆï¼Œå‰©ä¸‹çš„å°±æ¯”è¾ƒç®€å•äº†..</span>
    nds <span class="token operator">:=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>ntyp<span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>nds<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> nds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>label <span class="token operator">==</span> label <span class="token operator">&amp;&amp;</span> nds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tail <span class="token operator">==</span> tail <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> ntyp <span class="token operator">==</span> ntRegexp <span class="token operator">&amp;&amp;</span> nds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prefix <span class="token operator">!=</span> prefix <span class="token punctuation">&#123;</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> nds<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// å†™çš„ endpointï¼Œå…¶å®å°±æ˜¯ç»™ node è®¾ç½®ä¸Š handlerï¼Œæ­£å¦‚äººå®¶åœ¨ä¸‹é¢æ³¨é‡Šæ‰€æè¿°çš„</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">setEndpoint</span><span class="token punctuation">(</span>method methodTyp<span class="token punctuation">,</span> handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> pattern <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Set the handler for the method type on the node</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>endpoints <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        n<span class="token punctuation">.</span>endpoints <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// &#123;name&#125; &#123;job&#125; paramKeys ä¸­å­˜å‚¨çš„å°±æ˜¯è¿™äº›åå­—</span>
    paramKeys <span class="token operator">:=</span> <span class="token function">patParamKeys</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>

    <span class="token comment">// å¾€ä¸‹å°±æ²¡å•¥å¥½è¯´äº†ï¼Œé€šè¿‡ä½è¿ç®—æ‰¾åˆ°å¯¹åº”çš„åˆ†æ”¯ï¼Œç„¶åç›´æ¥èµ‹å€¼å°±è¡Œäº†ã€‚ã€‚</span>
    <span class="token keyword">if</span> method<span class="token operator">&amp;</span>mSTUB <span class="token operator">==</span> mSTUB <span class="token punctuation">&#123;</span>
        n<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>mSTUB<span class="token punctuation">)</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> method<span class="token operator">&amp;</span>mALL <span class="token operator">==</span> mALL <span class="token punctuation">&#123;</span>
        h <span class="token operator">:=</span> n<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>mALL<span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>handler <span class="token operator">=</span> handler
        h<span class="token punctuation">.</span>pattern <span class="token operator">=</span> pattern
        h<span class="token punctuation">.</span>paramKeys <span class="token operator">=</span> paramKeys
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> methodMap <span class="token punctuation">&#123;</span>
            h <span class="token operator">:=</span> n<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
            h<span class="token punctuation">.</span>handler <span class="token operator">=</span> handler
            h<span class="token punctuation">.</span>pattern <span class="token operator">=</span> pattern
            h<span class="token punctuation">.</span>paramKeys <span class="token operator">=</span> paramKeys
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        h <span class="token operator">:=</span> n<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>handler <span class="token operator">=</span> handler
        h<span class="token punctuation">.</span>pattern <span class="token operator">=</span> pattern
        h<span class="token punctuation">.</span>paramKeys <span class="token operator">=</span> paramKeys
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>æœ€åè¿™ä¸ªå°±æ˜¯æœ€æ ¸å¿ƒæœ€å¤æ‚çš„äº†å§â€¦ï¼Œä¸è¿‡æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå¯ä»¥æš‚æ—¶å…ˆå¿½ç•¥æ‰<strong>æ­£åˆ™åŒ¹é…</strong>ï¼Œ<strong>å¸¦å‚æ•°</strong>çš„éƒ¨åˆ†ä»£ç ã€‚ã€‚åªå…³æ³¨ nodetyp æ˜¯ static çš„å³å¯ã€‚</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// addChild appends the new `child` node to the tree using the `pattern` as the trie key.</span>
<span class="token comment">// For a URL router like chi's, we split the static, param, regexp and wildcard segments</span>
<span class="token comment">// into different nodes. In addition, addChild will recursively call itself until every</span>
<span class="token comment">// pattern segment is added to the url pattern tree as individual nodes, depending on type.</span>
<span class="token comment">// äººå®¶ä¸Šè¾¹æ³¨é‡Šè¯´çš„éå¸¸æ¸…æ™°äº†..</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">addChild</span><span class="token punctuation">(</span>child <span class="token operator">*</span>node<span class="token punctuation">,</span> prefix <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">&#123;</span>
    search <span class="token operator">:=</span> prefix

    <span class="token comment">// handler leaf node added to the tree is the child.</span>
    <span class="token comment">// this may be overridden later down the flow</span>
    hn <span class="token operator">:=</span> child

    <span class="token comment">// Parse next segment</span>
    segTyp<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> segRexpat<span class="token punctuation">,</span> segTail<span class="token punctuation">,</span> segStartIdx<span class="token punctuation">,</span> segEndIdx <span class="token operator">:=</span> <span class="token function">patNextSegment</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span>

    <span class="token comment">// Add child depending on next up segment</span>
    <span class="token keyword">switch</span> segTyp <span class="token punctuation">&#123;</span>
        <span class="token comment">// è¿™é‡Œç›´æ¥åˆ¤æ–­ç±»å‹å‘—ï¼Œå¦‚æœæ˜¯staticå°±ç›´æ¥åŠ å…¥åˆ°parentçš„childrenèŠ‚ç‚¹ä¸­</span>
        <span class="token keyword">case</span> ntStatic<span class="token punctuation">:</span>
        <span class="token comment">// Search prefix is all static (that is, has no params in path)</span>
        <span class="token comment">// noop</span>

        <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// Search prefix contains a param, regexp or wildcard</span>

        <span class="token keyword">if</span> segTyp <span class="token operator">==</span> ntRegexp <span class="token punctuation">&#123;</span>
            rex<span class="token punctuation">,</span> err <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>segRexpat<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
                <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"chi: invalid regexp pattern '%s' in route param"</span><span class="token punctuation">,</span> segRexpat<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            child<span class="token punctuation">.</span>prefix <span class="token operator">=</span> segRexpat
            child<span class="token punctuation">.</span>rex <span class="token operator">=</span> rex
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> segStartIdx <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Route starts with a param</span>
            child<span class="token punctuation">.</span>typ <span class="token operator">=</span> segTyp

            <span class="token keyword">if</span> segTyp <span class="token operator">==</span> ntCatchAll <span class="token punctuation">&#123;</span>
                segStartIdx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                segStartIdx <span class="token operator">=</span> segEndIdx
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> segStartIdx <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                segStartIdx <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            child<span class="token punctuation">.</span>tail <span class="token operator">=</span> segTail <span class="token comment">// for params, we set the tail</span>

            <span class="token keyword">if</span> segStartIdx <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// add static edge for the remaining part, split the end.</span>
                <span class="token comment">// its not possible to have adjacent param nodes, so its certainly</span>
                <span class="token comment">// going to be a static node next.</span>

                search <span class="token operator">=</span> search<span class="token punctuation">[</span>segStartIdx<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment">// advance search position</span>

                nn <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">&#123;</span>
                    typ<span class="token punctuation">:</span>    ntStatic<span class="token punctuation">,</span>
                    label<span class="token punctuation">:</span>  search<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    prefix<span class="token punctuation">:</span> search<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span>
                hn <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>nn<span class="token punctuation">,</span> search<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> segStartIdx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Route has some param</span>

            <span class="token comment">// starts with a static segment</span>
            child<span class="token punctuation">.</span>typ <span class="token operator">=</span> ntStatic
            child<span class="token punctuation">.</span>prefix <span class="token operator">=</span> search<span class="token punctuation">[</span><span class="token punctuation">:</span>segStartIdx<span class="token punctuation">]</span>
            child<span class="token punctuation">.</span>rex <span class="token operator">=</span> <span class="token boolean">nil</span>

            <span class="token comment">// add the param edge node</span>
            search <span class="token operator">=</span> search<span class="token punctuation">[</span>segStartIdx<span class="token punctuation">:</span><span class="token punctuation">]</span>

            nn <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">&#123;</span>
                typ<span class="token punctuation">:</span>   segTyp<span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> search<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                tail<span class="token punctuation">:</span>  segTail<span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span>
            hn <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>nn<span class="token punctuation">,</span> search<span class="token punctuation">)</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">.</span>typ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">.</span>typ<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span>
    <span class="token comment">// æ’åºæ“ä½œï¼Œæš‚æ—¶ä¸çŸ¥é“äººå®¶è¿™ä¸ªç”¨é€”ã€‚ã€‚</span>
    n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">.</span>typ<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> hn
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=1.0.0"><script type="text/javascript" src="/js/donate.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><a class="pos-f tr3" id="github" href="https://github.com/Kaiyuan/donate-page" target="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="ps">æ²¡æœ‰å¼€å¯ä»»ä½•Donateé€‰é¡¹!</li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>chi æ¡†æ¶è·¯ç”±åˆ†æ</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>bqyang</p><p><span>å‘å¸ƒæ—¶é—´ï¼š</span>2022-02-22</p><p><span>æœ€åæ›´æ–°ï¼š</span>2022-02-24</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2022/chi/">https://bqyang.top/2022/chi/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://bqyang.top/2022/chi/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2022/k8s2nd/">k8s 2nd</a><a class="next" href="/2022/webFrame/">ä¸€ä¸ª web æ¡†æ¶çš„é‚£äº›äº‹</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '4bcae079402e9cc4ce7b',
  clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
  repo: 'blog_comments',
  owner: 'clamyang',
  admin: ['clamyang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://bqyang.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/leetcode/array/easy/">æ•°ç»„-ç®€å•é¢˜</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/recur/">å†å­¦é€’å½’ï¼ˆå‡ ä¸ªæœ‰æ„æ€çš„é€’å½’ç»ƒä¹ ï¼‰</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/print/">æ‰“å°å­—ç¬¦</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/string/">C-String</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/enum/">Rust-Enums</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/structs/">Rust-Structs</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/ownership/">Rust-Ownership</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/deployment/">Deployment æ›´æ–°ç­–ç•¥</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/os-start/">æ“ä½œç³»ç»Ÿå¯åŠ¨</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/concurrency-sema/">åŒæ­¥åŸè¯­-semaphore</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.xargin.com/" title="Xargin" target="_blank">Xargin</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2022 <a href="/." rel="nofollow">æ¨å®å¼ºçš„æŠ€æœ¯ç¬”è®°.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>