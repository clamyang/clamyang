<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一物不知深以为耻"><title>宽松内存模型 | 杨宝强的技术笔记</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">🌓</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">宽松内存模型</h1><a id="logo" href="/.">杨宝强的技术笔记</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">宽松内存模型</h1><div class="post-meta">2022-04-16</div><div class="post-content"><hr>
<p>最近学习到一个关于内存模型的知识点，一开始对内存模型的认识还是以为是描述数据结构实在内存中怎样进行存储的。</p>
<span id="more"></span>

<p>后来发现我这种理解完全被这个名字所误导了，宽松内存模型指的是，在多核处理器的情况下，对访问共享内存行为的描述。</p>
<p>解释下面这个 C 代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"thread.h"</span></span>

<span class="token comment">// 全局变量 x, y</span>
<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

atomic_int flag<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLAG</span> <span class="token expression"><span class="token function">atomic_load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flag<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FLAG_XOR</span><span class="token expression"><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token function">atomic_fetch_xor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flag<span class="token punctuation">,</span> val<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">WAIT_FOR</span><span class="token expression"><span class="token punctuation">(</span>cond<span class="token punctuation">)</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>cond<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span></span></span>

<span class="token comment">// 指定编译的时候不要进行内联优化</span>
 <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">write_x_read_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> y_val<span class="token punctuation">;</span>
  <span class="token comment">// 汇编实现变量 +1 的操作</span>
  <span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span>
    <span class="token string">"movl $1, %0;"</span> <span class="token comment">// x = 1</span>
    <span class="token string">"movl %2, %1;"</span> <span class="token comment">// y_val = y</span>
    <span class="token operator">:</span> <span class="token string">"=m"</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>y_val<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"m"</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> y_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 代码含义如上</span>
 <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">write_y_read_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> x_val<span class="token punctuation">;</span>
  <span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span>
    <span class="token string">"movl $1, %0;"</span> <span class="token comment">// y = 1</span>
    <span class="token string">"movl %2, %1;"</span> <span class="token comment">// x_val = x</span>
    <span class="token operator">:</span> <span class="token string">"=m"</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>x_val<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"m"</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> x_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">T1</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">WAIT_FOR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>FLAG <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_x_read_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLAG_XOR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">T2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">WAIT_FOR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>FLAG <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_y_read_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLAG_XOR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// thread sync func</span>
<span class="token keyword">void</span> <span class="token function">Tsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    x <span class="token operator">=</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/*
      No memory operand will be moved across the operation,
      either forward or backward. Further, 
      instructions will be issued as necessary to prevent 
      the processor from speculating loads across 
      the operation and from queuing stores after the operation.
      简言之就是会保证 x=y=0 这条赋值操作执行完成
      或许你会问，我把这个赋值语句写在前边
    */</span>
    <span class="token function">__sync_synchronize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// full barrier</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>FLAG <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLAG_XOR</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里没搞懂，为什么执行 XOR 会使 cache miss</span>
    <span class="token comment">// T1 and T2 clear 0/1-bit, respectively      </span>
    <span class="token function">WAIT_FOR</span><span class="token punctuation">(</span>FLAG <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 创建线程，线程的起点为 T1</span>
  <span class="token function">create</span><span class="token punctuation">(</span>T1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">create</span><span class="token punctuation">(</span>T2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">create</span><span class="token punctuation">(</span>Tsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>上述代码执行流程分析：</p>
<ul>
<li>T1,T2 函数开始执行就会被卡住，因为 FLAG 变量初始值为 0</li>
<li>Tsync 函数，初始化全局变量 x,y 然后执行了一个 <code>__sync_synchronize();</code> 函数，详情见注释。</li>
</ul>
<p>然后 <code>FLAG_XOR</code> 命令，让 T1, T2 两个在等待中的开始执行。</p>
<p>write_y_read_x 和 write_x_read_y 两个函数，也比较简单，就是将 x y 分别进行赋值的操作，然后读取另一个变量。写 y 读 x，写 x 读 y。我们看下具体的汇编代码：</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">00000000004008f1 &lt;write_x_read_y&gt;:
  ... # 省略无关代码
  # 将 1 赋值 x
  4008f9:       c7 05 89 17 20 00 01    movl   $0x1,0x201789(%rip)        # 60208c &lt;x&gt;
  # 读取 y 变量
  400903:       8b 05 87 17 20 00       mov    0x201787(%rip),%eax        # 602090 &lt;y&gt;
  ...
  400921:       c3                      retq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p> 从程序就是状态机的视角去分析的话，如下：</p>
<p>在开始时，我们有 x,y两个全局变量，T1,T2 两个线程，然后 T1，T2 开始交替执行。</p>
<p><img src="https://s2.loli.net/2022/04/19/x6KeQ2mMXN9qOJ3.jpg" alt="28d0652f7b48792aeea6c52883045fe.jpg"></p>
<p>从上图我们不难得出，所有的输出结果无外乎是</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 0 1</span>
<span class="token comment">// 1 0</span>
<span class="token comment">// 1 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p>我们看一下执行 1000 次的输出结果是什么样</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//   756 0 0 </span>
<span class="token comment">//   242 0 1</span>
<span class="token comment">//     2 1 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>很奇怪，根本不存在序列为 <code>1 1</code> 的组合，而且输出占最多次数的是  <code>0 0</code> ，从我们刚才列出的输出结果中，并没有这个序列。</p>
<h3 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h3><p>实际上，我们的代码经过编译器优化后生成汇编指令，汇编指令被放到处理器上进行执行。在多核的情况下，为了榨取 CPU 的最高性能，<code>处理器会对待执行的汇编代码进行优化</code> 也就是将汇编代码再执行一次编译优化的过程，即处理器也是编译器。</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">movl   $0x1,0x201789(%rip)
mov    0x201787(%rip),%eax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>从我们人类的视角出发，我们更偏向于顺序化执行，但如果从处理器的视角出发，会对这两条指令进行优化。</p>
<p>他做的优化是：将写操作放入到待执行队列中，如果说队列塞满了，批量进行写操作。所以，第一条 mov 指令会被放入到队列中，然后先进行读操作。</p>
<p><img src="https://s2.loli.net/2022/04/19/X5LUKbMhiE9JpCt.png" alt="mem-tso.png"></p>
<p>所以这就是为什么我们没有看到 1 1 的原因。</p>
<h3 id="如何进行修复"><a href="#如何进行修复" class="headerlink" title="如何进行修复"></a>如何进行修复</h3><p>既然找到了问题的源头，那么就“有从下手了”，我们不让他放入到队列中，直接执行即可。</p>
<h3 id="Go-中的内存模型是怎样的？"><a href="#Go-中的内存模型是怎样的？" class="headerlink" title="Go 中的内存模型是怎样的？"></a>Go 中的内存模型是怎样的？</h3><p>// TODO</p>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=1.0.0"><script type="text/javascript" src="/js/donate.js?v=1.0.0" successtext="复制成功!"></script><a class="pos-f tr3" id="github" href="https://github.com/Kaiyuan/donate-page" target="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="ps">没有开启任何Donate选项!</li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>本文标题：</span>宽松内存模型</p><p><span>文章作者：</span>bqyang</p><p><span>发布时间：</span>2022-04-16</p><p><span>最后更新：</span>2022-04-19</p><p><span>原始链接：</span><a href="/2022/RMO/">https://bqyang.top/2022/RMO/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://bqyang.top/2022/RMO/"></i></span></p><p><span>版权声明：</span>The author owns the copyright, please indicate the source reproduced.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2022/peterson/">perterson 算法学习</a><a class="next" href="/2022/tips0309/">一点总结</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '4bcae079402e9cc4ce7b',
  clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
  repo: 'blog_comments',
  owner: 'clamyang',
  admin: ['clamyang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://bqyang.top"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/leetcode/array/easy/">数组-简单题</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/recur/">再学递归（几个有意思的递归练习）</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/print/">打印字符</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/c/string/">C-String</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/enum/">Rust-Enums</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/structs/">Rust-Structs</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/language/rust/ownership/">Rust-Ownership</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/k8s/deployment/">Deployment 更新策略</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/os-start/">操作系统启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/os/concurrency-sema/">同步原语-semaphore</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.xargin.com/" title="Xargin" target="_blank">Xargin</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">杨宝强的技术笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>