<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bqyang.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="[toc] GC n 连问GC 的流程阶段 sweep termination  mark  mark termination  sweep   GC 的触发时机1.runtime.GC 手动触发 2.mallocgc 根据内存分配大小，比如当前使用 4M，当内存分配到达 8M 时，会触发 GC，这个百分比是可以调整的，通过 设置triggerRatio 指定触发 GC 的阈值 go1.16.5">
<meta property="og:type" content="website">
<meta property="og:title" content="杨宝强的技术笔记">
<meta property="og:url" content="https://bqyang.top/pendingPost/GC%20%E8%A7%A6%E5%8F%91%E6%97%B6%E6%9C%BA.html">
<meta property="og:site_name" content="杨宝强的技术笔记">
<meta property="og:description" content="[toc] GC n 连问GC 的流程阶段 sweep termination  mark  mark termination  sweep   GC 的触发时机1.runtime.GC 手动触发 2.mallocgc 根据内存分配大小，比如当前使用 4M，当内存分配到达 8M 时，会触发 GC，这个百分比是可以调整的，通过 设置triggerRatio 指定触发 GC 的阈值 go1.16.5">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-11-28T07:37:19.661Z">
<meta property="article:modified_time" content="2021-11-28T07:37:19.648Z">
<meta property="article:author" content="杨宝强">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bqyang.top/pendingPost/GC%20%E8%A7%A6%E5%8F%91%E6%97%B6%E6%9C%BA">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title> | 杨宝强的技术笔记
</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="杨宝强的技术笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <h1 class="site-title" style="font-size:27px">杨宝强的技术笔记</h1>
      <span class="logo-line-before"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">欢迎~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
  
  

          <div class="content page posts-expand">
            

    
    
    
    <div class="post-block" lang="zh-CN">
      <header class="post-header">

<h1 class="post-title" itemprop="name headline">
</h1>

<div class="post-meta">
  

</div>

</header>

      
      
      
      <div class="post-body">
          <p>[toc]</p>
<h2 id="GC-n-连问"><a href="#GC-n-连问" class="headerlink" title="GC n 连问"></a>GC n 连问</h2><h3 id="GC-的流程阶段"><a href="#GC-的流程阶段" class="headerlink" title="GC 的流程阶段"></a>GC 的流程阶段</h3><ul>
<li><p>sweep termination</p>
</li>
<li><p>mark</p>
</li>
<li><p>mark termination</p>
</li>
<li><p>sweep</p>
</li>
</ul>
<h3 id="GC-的触发时机"><a href="#GC-的触发时机" class="headerlink" title="GC 的触发时机"></a>GC 的触发时机</h3><p>1.runtime.GC 手动触发</p>
<p>2.mallocgc 根据内存分配大小，比如当前使用 4M，当内存分配到达 8M 时，会触发 GC，这个百分比是可以调整的，通过 设置triggerRatio 指定触发 GC 的阈值 go1.16.5 中，是 7/8.0 = 87.5% </p>
<p>3.forcegchelper 定时触发 gc </p>
<p>mallocgc 是主要的触发函数。</p>
<h3 id="GC-的起点"><a href="#GC-的起点" class="headerlink" title="GC 的起点"></a>GC 的起点</h3><p>gcStart，控制 worker 的数量，大约占 CPU 的 1/4。</p>
<h3 id="为什么老版本需要重新扫描栈？"><a href="#为什么老版本需要重新扫描栈？" class="headerlink" title="为什么老版本需要重新扫描栈？"></a>为什么老版本需要重新扫描栈？</h3><h3 id="GC-标记的根都有什么？"><a href="#GC-标记的根都有什么？" class="headerlink" title="GC 标记的根都有什么？"></a>GC 标记的根都有什么？</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go">work<span class="token punctuation">.</span>markrootJobs <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>fixedRootCount <span class="token operator">+</span> work<span class="token punctuation">.</span>nFlushCacheRoots <span class="token operator">+</span> work<span class="token punctuation">.</span>nDataRoots <span class="token operator">+</span> work<span class="token punctuation">.</span>nBSSRoots <span class="token operator">+</span> work<span class="token punctuation">.</span>nSpanRoots <span class="token operator">+</span> work<span class="token punctuation">.</span>nStackRoots<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="单独使用-D-屏障有何问题？"><a href="#单独使用-D-屏障有何问题？" class="headerlink" title="单独使用 D 屏障有何问题？"></a>单独使用 D 屏障有何问题？</h3><h3 id="单独使用-Y-屏障有何问题？"><a href="#单独使用-Y-屏障有何问题？" class="headerlink" title="单独使用 Y 屏障有何问题？"></a>单独使用 Y 屏障有何问题？</h3><h3 id="混合写屏障是怎么一回事？"><a href="#混合写屏障是怎么一回事？" class="headerlink" title="混合写屏障是怎么一回事？"></a>混合写屏障是怎么一回事？</h3><h3 id="协助标记流程"><a href="#协助标记流程" class="headerlink" title="协助标记流程"></a>协助标记流程</h3><h3 id="对象的交叉引用是如何剪枝的？"><a href="#对象的交叉引用是如何剪枝的？" class="headerlink" title="对象的交叉引用是如何剪枝的？"></a>对象的交叉引用是如何剪枝的？</h3><h3 id="gcTriggerKind"><a href="#gcTriggerKind" class="headerlink" title="gcTriggerKind"></a>gcTriggerKind</h3><p>gc 触发类型：</p>
<ul>
<li>gcTriggerHeap 内存到达阈值</li>
<li>gcTriggerTime 到达触发时间</li>
<li>gcTriggerCycle 可以理解为用户手动触发类型</li>
</ul>
<h3 id="STW-时间怎么算出来的？"><a href="#STW-时间怎么算出来的？" class="headerlink" title="STW 时间怎么算出来的？"></a>STW 时间怎么算出来的？</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go">memstats<span class="token punctuation">.</span>gcPauseDist<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>now <span class="token operator">-</span> work<span class="token punctuation">.</span>pauseStart<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="gcStart-源码剖析"><a href="#gcStart-源码剖析" class="headerlink" title="gcStart 源码剖析"></a>gcStart 源码剖析</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// gcStart starts the GC. It transitions from _GCoff to _GCmark (if</span>
<span class="token comment">// debug.gcstoptheworld == 0) or performs all of GC (if</span>
<span class="token comment">// debug.gcstoptheworld != 0).</span>
<span class="token comment">//</span>
<span class="token comment">// This may return without performing this transition in some cases,</span>
<span class="token comment">// such as when called on a system stack or with locks held.</span>

<span class="token comment">// gcStart 是 GC 的起点，并将 GC 的状态由 _GCoff 切换到 _GCmark，</span>
<span class="token comment">// 如果 gcStart 在系统栈上被调用或者持有锁的时候，就不会执行状态的改变直接返回了。</span>
<span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>trigger gcTrigger<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Since this is called from malloc and malloc is called in</span>
	<span class="token comment">// the guts of a number of libraries that might be holding</span>
	<span class="token comment">// locks, don't attempt to start GC in non-preemptible or</span>
	<span class="token comment">// potentially unstable situations.</span>
    
    <span class="token comment">// 如果 gcStart 是从 malloc 调用的，并且 malloc 又是被其他的库调用的，</span>
    <span class="token comment">// 这种情况下可能会持有锁（mp.locks > 1）</span>
    <span class="token comment">// 不要再非抢占或者不稳定的情况下调用 gcStart</span>
    <span class="token comment">/*
       我的理解：如果不是非抢占模式，可能会导致后面 stw 时，一些 g 没有办法停止
       会影响 GC 的结果。
    */</span>
	mp <span class="token operator">:=</span> <span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// mp.locks > 1 说明在 gcStart 之前就持有锁</span>
    <span class="token comment">// mp.preemptoff != "" 说明在 non-preempt 模式下</span>
	<span class="token keyword">if</span> gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">==</span> mp<span class="token punctuation">.</span>g0 <span class="token operator">||</span> mp<span class="token punctuation">.</span>locks <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> mp<span class="token punctuation">.</span>preemptoff <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
		<span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
	mp <span class="token operator">=</span> nilx	

	<span class="token comment">// Pick up the remaining unswept/not being swept spans concurrently</span>
	<span class="token comment">//</span>
	<span class="token comment">// This shouldn't happen if we're being invoked in background</span>
	<span class="token comment">// mode since proportional sweep should have just finished</span>
	<span class="token comment">// sweeping everything, but rounding errors, etc, may leave a</span>
	<span class="token comment">// few spans unswept. In forced mode, this is necessary since</span>
	<span class="token comment">// GC can be forced at any point in the sweeping cycle.</span>
	<span class="token comment">//</span>
	<span class="token comment">// We check the transition condition continuously here in case</span>
	<span class="token comment">// this G gets delayed in to the next GC cycle.</span>
    <span class="token comment">/*
        trigger.test() 检测是否满足 GC 的触发条件
        sweepone() 我的理解是：清扫上次 GC 遗留下来的 unswept 的 span
        ？？ 是否可以理解成 sweep termination 的阶段 
    */</span>
	<span class="token keyword">for</span> trigger<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sweepone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">^</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		sweep<span class="token punctuation">.</span>nbgsweep<span class="token operator">++</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Perform GC initialization and the sweep termination</span>
	<span class="token comment">// transition.</span>
    <span class="token comment">/*
    	semaacquire 的操作，是否可以理解为，通过 atomic 去掉了锁。
		换句话说，只有获取了某个 sema，才能对 gc 状态进行修改。
    */</span>
	<span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>startSema<span class="token punctuation">)</span>
	<span class="token comment">// Re-check transition condition under transition lock.</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>trigger<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>startSema<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// For stats, check if this GC was forced by the user.</span>
	work<span class="token punctuation">.</span>userForced <span class="token operator">=</span> trigger<span class="token punctuation">.</span>kind <span class="token operator">==</span> gcTriggerCycle

	<span class="token comment">// In gcstoptheworld debug mode, upgrade the mode accordingly.</span>
	<span class="token comment">// We do this after re-checking the transition condition so</span>
	<span class="token comment">// that multiple goroutines that detect the heap trigger don't</span>
	<span class="token comment">// start multiple STW GCs.</span>
    <span class="token comment">// 如果没开启 GODEBUG 都是 gcBackgroundMode 模式</span>
	mode <span class="token operator">:=</span> gcBackgroundMode
	<span class="token keyword">if</span> debug<span class="token punctuation">.</span>gcstoptheworld <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
		mode <span class="token operator">=</span> gcForceMode
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> debug<span class="token punctuation">.</span>gcstoptheworld <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">&#123;</span>
		mode <span class="token operator">=</span> gcForceBlockMode
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Ok, we're doing it! Stop everybody else</span>
	<span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcsema<span class="token punctuation">)</span>
	<span class="token function">semacquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>worldsema<span class="token punctuation">)</span>

	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">&#123;</span>
		<span class="token function">traceGCStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Check that all Ps have finished deferred mcache flushes.</span>
    <span class="token comment">// TODO 检查 P 的 mcache</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> allp <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> fg <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>mcache<span class="token punctuation">.</span>flushGen<span class="token punctuation">)</span><span class="token punctuation">;</span> fg <span class="token operator">!=</span> mheap_<span class="token punctuation">.</span>sweepgen <span class="token punctuation">&#123;</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"runtime: p"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"flushGen"</span><span class="token punctuation">,</span> fg<span class="token punctuation">,</span> <span class="token string">"!= sweepgen"</span><span class="token punctuation">,</span> mheap_<span class="token punctuation">.</span>sweepgen<span class="token punctuation">)</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"p mcache not flushed"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	
    <span class="token comment">// 开启 nproc 个 gcMarkWorker，加入到 workerPool 中</span>
    <span class="token comment">// 创建完一个 worker，休眠一个 worker</span>
    <span class="token comment">// schedule.findRunnableGCWorker 会唤醒</span>
	<span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
    <span class="token comment">// 重置标志位，allg 的标志位，heapArena 的标志位</span>
    <span class="token comment">// 清空了每一个 g 的 AssistBytes</span>
	<span class="token function">systemstack</span><span class="token punctuation">(</span>gcResetMarkState<span class="token punctuation">)</span>

	work<span class="token punctuation">.</span>stwprocs<span class="token punctuation">,</span> work<span class="token punctuation">.</span>maxprocs <span class="token operator">=</span> gomaxprocs<span class="token punctuation">,</span> gomaxprocs
	<span class="token keyword">if</span> work<span class="token punctuation">.</span>stwprocs <span class="token operator">></span> ncpu <span class="token punctuation">&#123;</span>
		<span class="token comment">// This is used to compute CPU time of the STW phases,</span>
		<span class="token comment">// so it can't be more than ncpu, even if GOMAXPROCS is.</span>
		work<span class="token punctuation">.</span>stwprocs <span class="token operator">=</span> ncpu
	<span class="token punctuation">&#125;</span>
	work<span class="token punctuation">.</span>heap0 <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>heap_live<span class="token punctuation">)</span>
	work<span class="token punctuation">.</span>pauseNS <span class="token operator">=</span> <span class="token number">0</span>
	work<span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

	now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	work<span class="token punctuation">.</span>tSweepTerm <span class="token operator">=</span> now
	work<span class="token punctuation">.</span>pauseStart <span class="token operator">=</span> now
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">&#123;</span>
		<span class="token function">traceGCSTWStart</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
    
    <span class="token comment">// stw 调用者必须为 stopTheWorldWithSema 获取 worldsema 并且 关闭抢占</span>
	<span class="token function">systemstack</span><span class="token punctuation">(</span>stopTheWorldWithSema<span class="token punctuation">)</span>
    
	<span class="token comment">// Finish sweep before we start concurrent scan.</span>
    <span class="token comment">// 确保本次 GC 开始时，已完成上一次 GC 的 sweep 工作</span>
	<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">finishsweep_m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// clearpools before we start the GC. If we wait they memory will not be</span>
	<span class="token comment">// reclaimed until the next GC cycle.</span>
    <span class="token comment">// 1.处理 sync.Pool</span>
    <span class="token comment">// 2.清空 sudog cache</span>
    <span class="token comment">// 3.清空 defer pools</span>
	<span class="token function">clearpools</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
    <span class="token comment">// 增加 gc 周期数</span>
	work<span class="token punctuation">.</span>cycles<span class="token operator">++</span>

    <span class="token comment">// 开始本次 gc 周期</span>
	gcController<span class="token punctuation">.</span><span class="token function">startCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	work<span class="token punctuation">.</span>heapGoal <span class="token operator">=</span> memstats<span class="token punctuation">.</span>next_gc

	<span class="token comment">// In STW mode, disable scheduling of user Gs. This may also</span>
	<span class="token comment">// disable scheduling of this goroutine, so it may block as</span>
	<span class="token comment">// soon as we start the world again.</span>
	<span class="token keyword">if</span> mode <span class="token operator">!=</span> gcBackgroundMode <span class="token punctuation">&#123;</span>
		<span class="token function">schedEnableUser</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Enter concurrent mark phase and enable</span>
	<span class="token comment">// write barriers.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Because the world is stopped, all Ps will</span>
	<span class="token comment">// observe that write barriers are enabled by</span>
	<span class="token comment">// the time we start the world and begin</span>
	<span class="token comment">// scanning.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Write barriers must be enabled before assists are</span>
	<span class="token comment">// enabled because they must be enabled before</span>
	<span class="token comment">// any non-leaf heap objects are marked. Since</span>
	<span class="token comment">// allocations are blocked until assists can</span>
	<span class="token comment">// happen, we want enable assists as early as</span>
	<span class="token comment">// possible.</span>
	<span class="token function">setGCPhase</span><span class="token punctuation">(</span>_GCmark<span class="token punctuation">)</span>

	<span class="token function">gcBgMarkPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Must happen before assist enable.</span>
	<span class="token function">gcMarkRootPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Mark all active tinyalloc blocks. Since we're</span>
	<span class="token comment">// allocating from these, they need to be black like</span>
	<span class="token comment">// other allocations. The alternative is to blacken</span>
	<span class="token comment">// the tiny block on every allocation from it, which</span>
	<span class="token comment">// would slow down the tiny allocator.</span>
	<span class="token function">gcMarkTinyAllocs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// At this point all Ps have enabled the write</span>
	<span class="token comment">// barrier, thus maintaining the no white to</span>
	<span class="token comment">// black invariant. Enable mutator assists to</span>
	<span class="token comment">// put back-pressure on fast allocating</span>
	<span class="token comment">// mutators.</span>
	atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcBlackenEnabled<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token comment">// Assists and workers can start the moment we start</span>
	<span class="token comment">// the world.</span>
	gcController<span class="token punctuation">.</span>markStartTime <span class="token operator">=</span> now

	<span class="token comment">// In STW mode, we could block the instant systemstack</span>
	<span class="token comment">// returns, so make sure we're not preemptible.</span>
	mp <span class="token operator">=</span> <span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Concurrent mark.</span>
	<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		now <span class="token operator">=</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>enabled<span class="token punctuation">)</span>
		work<span class="token punctuation">.</span>pauseNS <span class="token operator">+=</span> now <span class="token operator">-</span> work<span class="token punctuation">.</span>pauseStart
		work<span class="token punctuation">.</span>tMark <span class="token operator">=</span> now
		memstats<span class="token punctuation">.</span>gcPauseDist<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>now <span class="token operator">-</span> work<span class="token punctuation">.</span>pauseStart<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// Release the world sema before Gosched() in STW mode</span>
	<span class="token comment">// because we will need to reacquire it later but before</span>
	<span class="token comment">// this goroutine becomes runnable again, and we could</span>
	<span class="token comment">// self-deadlock otherwise.</span>
	<span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>worldsema<span class="token punctuation">)</span>
	<span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>

	<span class="token comment">// Make sure we block instead of returning to user code</span>
	<span class="token comment">// in STW mode.</span>
	<span class="token keyword">if</span> mode <span class="token operator">!=</span> gcBackgroundMode <span class="token punctuation">&#123;</span>
		<span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>startSema<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="findRunnableGCWorker-源码剖析"><a href="#findRunnableGCWorker-源码剖析" class="headerlink" title="findRunnableGCWorker 源码剖析"></a>findRunnableGCWorker 源码剖析</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// findRunnableGCWorker returns a background mark worker for _p_ if it</span>
<span class="token comment">// should be run. This must only be called when gcBlackenEnabled != 0.</span>
<span class="token comment">// 只有在 gc 开启的时候才会执行，gcStart 中设置为 1</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>gcControllerState<span class="token punctuation">)</span> <span class="token function">findRunnableGCWorker</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcControllerState.findRunnable: blackening not enabled"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// No work to be done right now. This can happen at</span>
		<span class="token comment">// the end of the mark phase when there are still</span>
		<span class="token comment">// assists tapering off. Don't bother running a worker</span>
		<span class="token comment">// now because it'll just return immediately.</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Grab a worker before we commit to running below.</span>
    <span class="token comment">// 从 workpool 中拿一个 markNode</span>
	node <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>gcBgMarkWorkerNode<span class="token punctuation">)</span><span class="token punctuation">(</span>gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// There is at least one worker per P, so normally there are</span>
		<span class="token comment">// enough workers to run on all Ps, if necessary. However, once</span>
		<span class="token comment">// a worker enters gcMarkDone it may park without rejoining the</span>
		<span class="token comment">// pool, thus freeing a P with no corresponding worker.</span>
		<span class="token comment">// gcMarkDone never depends on another worker doing work, so it</span>
		<span class="token comment">// is safe to simply do nothing here.</span>
		<span class="token comment">//</span>
		<span class="token comment">// If gcMarkDone bails out without completing the mark phase,</span>
		<span class="token comment">// it will always do so with queued global work. Thus, that P</span>
		<span class="token comment">// will be immediately eligible to re-run the worker G it was</span>
		<span class="token comment">// just using, ensuring work can complete.</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	
    <span class="token comment">// 用于计算该 markNode 的工作模式</span>
    <span class="token comment">// >  0 dedicatedMode</span>
    <span class="token comment">// &lt;= 0 fractionalMode</span>
	decIfPositive <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ptr <span class="token operator">*</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loadint64</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
			<span class="token keyword">if</span> v <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casint64</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">decIfPositive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>dedicatedMarkWorkersNeeded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// This P is now dedicated to marking until the end of</span>
		<span class="token comment">// the concurrent mark phase.</span>
		_p_<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerDedicatedMode
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>fractionalUtilizationGoal <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// No need for fractional workers.</span>
		gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Is this P behind on the fractional utilization</span>
		<span class="token comment">// goal?</span>
		<span class="token comment">//</span>
		<span class="token comment">// This should be kept in sync with pollFractionalWorkerExit.</span>
		delta <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> c<span class="token punctuation">.</span>markStartTime
		<span class="token keyword">if</span> delta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">float64</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>gcFractionalMarkTime<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">float64</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span> <span class="token operator">></span> c<span class="token punctuation">.</span>fractionalUtilizationGoal <span class="token punctuation">&#123;</span>
			<span class="token comment">// Nope. No need to run a fractional worker.</span>
			gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// Run a fractional worker.</span>
		_p_<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerFractionalMode
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Run the background mark worker.</span>
    <span class="token comment">// 修改 g 的状态并返回</span>
	gp <span class="token operator">:=</span> node<span class="token punctuation">.</span>gp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">&#123;</span>
		<span class="token function">traceGoUnpark</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> gp
<span class="token punctuation">&#125;</span>


<span class="token comment">// gcMarkWorkAvailable reports whether executing a mark worker</span>
<span class="token comment">// on p is potentially useful. p may be nil, in which case it only</span>
<span class="token comment">// checks the global sources of work.</span>
<span class="token comment">/*
	该函数主要作用：返回是否有标记工作可以干
	gcw p的队列
	work 全局队列
*/</span>
<span class="token keyword">func</span> <span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span>p <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> p <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>gcw<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>work<span class="token punctuation">.</span>full<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// global work available</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> work<span class="token punctuation">.</span>markrootNext <span class="token operator">&lt;</span> work<span class="token punctuation">.</span>markrootJobs <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// root scan work available</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="gcBgMarkWorker-源码剖析"><a href="#gcBgMarkWorker-源码剖析" class="headerlink" title="gcBgMarkWorker 源码剖析"></a>gcBgMarkWorker 源码剖析</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// We pass node to a gopark unlock function, so it can't be on</span>
	<span class="token comment">// the stack (see gopark). Prevent deadlock from recursively</span>
	<span class="token comment">// starting GC by disabling preemption.</span>
	gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>preemptoff <span class="token operator">=</span> <span class="token string">"GC worker init"</span>
	node <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>gcBgMarkWorkerNode<span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>preemptoff <span class="token operator">=</span> <span class="token string">""</span>

	node<span class="token punctuation">.</span>gp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>

	node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">notewakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">)</span>
	<span class="token comment">// After this point, the background mark worker is generally scheduled</span>
	<span class="token comment">// cooperatively by gcController.findRunnableGCWorker. While performing</span>
	<span class="token comment">// work on the P, preemption is disabled because we are working on</span>
	<span class="token comment">// P-local work buffers. When the preempt flag is set, this puts itself</span>
	<span class="token comment">// into _Gwaiting to be woken up by gcController.findRunnableGCWorker</span>
	<span class="token comment">// at the appropriate time.</span>
	<span class="token comment">//</span>
	<span class="token comment">// When preemption is enabled (e.g., while in gcMarkDone), this worker</span>
	<span class="token comment">// may be preempted and schedule as a _Grunnable G from a runq. That is</span>
	<span class="token comment">// fine; it will eventually gopark again for further scheduling via</span>
	<span class="token comment">// findRunnableGCWorker.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Since we disable preemption before notifying bgMarkReady, we</span>
	<span class="token comment">// guarantee that this G will be in the worker pool for the next</span>
	<span class="token comment">// findRunnableGCWorker. This isn't strictly necessary, but it reduces</span>
	<span class="token comment">// latency between _GCmark starting and the workers starting.</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Go to sleep until woken by</span>
		<span class="token comment">// gcController.findRunnableGCWorker.</span>
		<span class="token function">gopark</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>g <span class="token operator">*</span>g<span class="token punctuation">,</span> nodep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
			node <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>gcBgMarkWorkerNode<span class="token punctuation">)</span><span class="token punctuation">(</span>nodep<span class="token punctuation">)</span>

			<span class="token keyword">if</span> mp <span class="token operator">:=</span> node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> mp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">// The worker G is no longer running; release</span>
				<span class="token comment">// the M.</span>
				<span class="token comment">//</span>
				<span class="token comment">// N.B. it is _safe_ to release the M as soon</span>
				<span class="token comment">// as we are no longer performing P-local mark</span>
				<span class="token comment">// work.</span>
				<span class="token comment">//</span>
				<span class="token comment">// However, since we cooperatively stop work</span>
				<span class="token comment">// when gp.preempt is set, if we releasem in</span>
				<span class="token comment">// the loop then the following call to gopark</span>
				<span class="token comment">// would immediately preempt the G. This is</span>
				<span class="token comment">// also safe, but inefficient: the G must</span>
				<span class="token comment">// schedule again only to enter gopark and park</span>
				<span class="token comment">// again. Thus, we defer the release until</span>
				<span class="token comment">// after parking the G.</span>
				<span class="token function">releasem</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

			<span class="token comment">// Release this G to the pool.</span>
			gcBgMarkWorkerPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
			<span class="token comment">// Note that at this point, the G may immediately be</span>
			<span class="token comment">// rescheduled and may be running.</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonGCWorkerIdle<span class="token punctuation">,</span> traceEvGoBlock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

		<span class="token comment">// Preemption must not occur here, or another G might see</span>
		<span class="token comment">// p.gcMarkWorkerMode.</span>

		<span class="token comment">// Disable preemption so we can use the gcw. If the</span>
		<span class="token comment">// scheduler wants to preempt us, we'll stop draining,</span>
		<span class="token comment">// dispose the gcw, and then preempt.</span>
		node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		pp <span class="token operator">:=</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// P can't change with preemption disabled.</span>

		<span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"worker mode"</span><span class="token punctuation">,</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode<span class="token punctuation">)</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcBgMarkWorker: blackening not enabled"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">==</span> gcMarkWorkerNotWorker <span class="token punctuation">&#123;</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcBgMarkWorker: mode not set"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		startTime <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		pp<span class="token punctuation">.</span>gcMarkWorkerStartTime <span class="token operator">=</span> startTime

		decnwait <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>nwait<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> decnwait <span class="token operator">==</span> work<span class="token punctuation">.</span>nproc <span class="token punctuation">&#123;</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"runtime: work.nwait="</span><span class="token punctuation">,</span> decnwait<span class="token punctuation">,</span> <span class="token string">"work.nproc="</span><span class="token punctuation">,</span> work<span class="token punctuation">.</span>nproc<span class="token punctuation">)</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"work.nwait was > work.nproc"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Mark our goroutine preemptible so its stack</span>
			<span class="token comment">// can be scanned. This lets two mark workers</span>
			<span class="token comment">// scan each other (otherwise, they would</span>
			<span class="token comment">// deadlock). We must not modify anything on</span>
			<span class="token comment">// the G stack. However, stack shrinking is</span>
			<span class="token comment">// disabled for mark workers, so it is safe to</span>
			<span class="token comment">// read from the G stack.</span>
			<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunning<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">)</span>
			<span class="token keyword">switch</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token punctuation">&#123;</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"gcBgMarkWorker: unexpected gcMarkWorkerMode"</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> gcMarkWorkerDedicatedMode<span class="token punctuation">:</span>
				<span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
				<span class="token keyword">if</span> gp<span class="token punctuation">.</span>preempt <span class="token punctuation">&#123;</span>
					<span class="token comment">// We were preempted. This is</span>
					<span class="token comment">// a useful signal to kick</span>
					<span class="token comment">// everything out of the run</span>
					<span class="token comment">// queue so it can run</span>
					<span class="token comment">// somewhere else.</span>
					<span class="token keyword">if</span> drainQ<span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token function">runqdrain</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
						<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
						<span class="token function">globrunqputbatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drainQ<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token comment">// Go back to draining, this time</span>
				<span class="token comment">// without preemption.</span>
				<span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainFlushBgCredit<span class="token punctuation">)</span>
			<span class="token keyword">case</span> gcMarkWorkerFractionalMode<span class="token punctuation">:</span>
				<span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainFractional<span class="token operator">|</span>gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
			<span class="token keyword">case</span> gcMarkWorkerIdleMode<span class="token punctuation">:</span>
				<span class="token function">gcDrain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcw<span class="token punctuation">,</span> gcDrainIdle<span class="token operator">|</span>gcDrainUntilPreempt<span class="token operator">|</span>gcDrainFlushBgCredit<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

		<span class="token comment">// Account for time.</span>
		duration <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime
		<span class="token keyword">switch</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> gcMarkWorkerDedicatedMode<span class="token punctuation">:</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>dedicatedMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>dedicatedMarkWorkersNeeded<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> gcMarkWorkerFractionalMode<span class="token punctuation">:</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>fractionalMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pp<span class="token punctuation">.</span>gcFractionalMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
		<span class="token keyword">case</span> gcMarkWorkerIdleMode<span class="token punctuation">:</span>
			atomic<span class="token punctuation">.</span><span class="token function">Xaddint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcController<span class="token punctuation">.</span>idleMarkTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// Was this the last worker and did we run out</span>
		<span class="token comment">// of work?</span>
		incnwait <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>nwait<span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> incnwait <span class="token operator">></span> work<span class="token punctuation">.</span>nproc <span class="token punctuation">&#123;</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"runtime: p.gcMarkWorkerMode="</span><span class="token punctuation">,</span> pp<span class="token punctuation">.</span>gcMarkWorkerMode<span class="token punctuation">,</span>
				<span class="token string">"work.nwait="</span><span class="token punctuation">,</span> incnwait<span class="token punctuation">,</span> <span class="token string">"work.nproc="</span><span class="token punctuation">,</span> work<span class="token punctuation">.</span>nproc<span class="token punctuation">)</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"work.nwait > work.nproc"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// We'll releasem after this point and thus this P may run</span>
		<span class="token comment">// something else. We must clear the worker mode to avoid</span>
		<span class="token comment">// attributing the mode to a different (non-worker) G in</span>
		<span class="token comment">// traceGoStart.</span>
		pp<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerNotWorker

		<span class="token comment">// If this worker reached a background mark completion</span>
		<span class="token comment">// point, signal the main GC goroutine.</span>
		<span class="token keyword">if</span> incnwait <span class="token operator">==</span> work<span class="token punctuation">.</span>nproc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// We don't need the P-local buffers here, allow</span>
			<span class="token comment">// preemption becuse we may schedule like a regular</span>
			<span class="token comment">// goroutine in gcMarkDone (block on locks, etc).</span>
			<span class="token function">releasem</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			node<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>

			<span class="token function">gcMarkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="剖析-gcBgMarkWorker-创建过程"><a href="#剖析-gcBgMarkWorker-创建过程" class="headerlink" title="剖析 gcBgMarkWorker 创建过程"></a>剖析 gcBgMarkWorker 创建过程</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// gcBgMarkStartWorkers prepares background mark worker goroutines. These</span>
<span class="token comment">// goroutines will not run until the mark phase, but they must be started while</span>
<span class="token comment">// the work is not stopped and from a regular G stack. The caller must hold</span>
<span class="token comment">// worldsema.</span>
<span class="token keyword">func</span> <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Background marking is performed by per-P G's. Ensure that each P has</span>
	<span class="token comment">// a background GC G.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Worker Gs don't exit if gomaxprocs is reduced. If it is raised</span>
	<span class="token comment">// again, we can reuse the old workers; no need to create new workers.</span>
	<span class="token keyword">for</span> gcBgMarkWorkerCount <span class="token operator">&lt;</span> gomaxprocs <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> <span class="token function">gcBgMarkWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token function">notetsleepg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">noteclear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token punctuation">.</span>bgMarkReady<span class="token punctuation">)</span>
		<span class="token comment">// The worker is now guaranteed to be added to the pool before</span>
		<span class="token comment">// its P's next findRunnableGCWorker.</span>

		gcBgMarkWorkerCount<span class="token operator">++</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>由上可知，所有 gcMarkWorker 都是通过该函数创建的，我们需要关注的是 <code>notesleepg()</code> 和 <code>go gcBgMarkWorker</code> 这两行代码</li>
</ul>
<h4 id="notesleepg"><a href="#notesleepg" class="headerlink" title="notesleepg"></a><code>notesleepg</code></h4><ul>
<li><pre><code class="go">  // same as runtime·notetsleep, but called on user g (not g0)
  // calls only nosplit functions between entersyscallblock/exitsyscall
  func notetsleepg(n *note, ns int64) bool &#123;
      gp := getg()
      if gp == gp.m.g0 &#123;
          throw(&quot;notetsleepg on g0&quot;)
      &#125;
      // 这个我们在学习 timer 的时候已经看过了
      // 主要就是执行 handoff
      entersyscallblock()
      // 这里才是真正进行系统调用的地方，ns = -1，会无休止的休眠
      // 直到通过 wakeup 唤醒
      ok := notetsleep_internal(n, ns)
      // 上述，通过 wakeup 唤醒后会继续执行这块代码
      // 该函数主要是给刚刚剥离的 GM 找一个 P
      // 找到了，执行
      // 没找到，把 g 放到全局队列
      exitsyscall()
      return ok
  &#125;
</code></pre>
</li>
</ul>
<h4 id="go-gcBgMarkWorker"><a href="#go-gcBgMarkWorker" class="headerlink" title="go gcBgMarkWorker"></a><code>go gcBgMarkWorker</code></h4><ul>
<li>这里应用到 MPG 调度的知识点，我们通过 go 关键字新建一个 goroutine，放入 runnext 等待被调度。</li>
</ul>
<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p>我们假设现在只有一个 P，即 <code>runtime.GOMAXPROCS(1)</code> 。这时我们来看上述代码，其执行过程为：</p>
<ul>
<li>1.通过 <code>gcBgMarkStartWorkers</code> 创建 worker</li>
<li>2.worker 被放入 runnext 等待被调度</li>
<li>3.执行 <code>notesleepg</code><ul>
<li>handoffp</li>
<li>futex &amp;&amp; timeout = -1</li>
<li>第 3 步执行完成后，GM 已经从 P 上剥离</li>
</ul>
</li>
<li>4.handoffp 中会启动一个 M 继续执行调度循环</li>
<li>5.newM 从 P 上找 G 执行</li>
<li>6.拿到我们刚刚创建的 newg</li>
<li>7.进入到 <code>gcBgMarkWorker()</code> 中执行<ul>
<li>新建 node &amp;&amp; <strong>wakeup</strong> 休眠的 GM</li>
<li>然后 <code>gopark</code> 挂起 worker 等待唤醒</li>
</ul>
</li>
<li>8.休眠的 GM 醒来后<ul>
<li>尝试获取 oldp</li>
<li>如果获取不到则，尝试获取 idlep</li>
<li>如果获取不到则，将 g 放入全局队列</li>
</ul>
</li>
<li>9.第 8 步中的 g 被调度后，会继续执行 create worker 的工作，回到第 1 步 继续执行</li>
</ul>

      </div>
      
      
      
    </div>
    

    
    
    


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-n-%E8%BF%9E%E9%97%AE"><span class="nav-number">1.</span> <span class="nav-text">GC n 连问</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-%E7%9A%84%E6%B5%81%E7%A8%8B%E9%98%B6%E6%AE%B5"><span class="nav-number">1.1.</span> <span class="nav-text">GC 的流程阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-%E7%9A%84%E8%A7%A6%E5%8F%91%E6%97%B6%E6%9C%BA"><span class="nav-number">1.2.</span> <span class="nav-text">GC 的触发时机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-%E7%9A%84%E8%B5%B7%E7%82%B9"><span class="nav-number">1.3.</span> <span class="nav-text">GC 的起点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%80%81%E7%89%88%E6%9C%AC%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E6%89%AB%E6%8F%8F%E6%A0%88%EF%BC%9F"><span class="nav-number">1.4.</span> <span class="nav-text">为什么老版本需要重新扫描栈？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-%E6%A0%87%E8%AE%B0%E7%9A%84%E6%A0%B9%E9%83%BD%E6%9C%89%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.5.</span> <span class="nav-text">GC 标记的根都有什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E7%8B%AC%E4%BD%BF%E7%94%A8-D-%E5%B1%8F%E9%9A%9C%E6%9C%89%E4%BD%95%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-number">1.6.</span> <span class="nav-text">单独使用 D 屏障有何问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E7%8B%AC%E4%BD%BF%E7%94%A8-Y-%E5%B1%8F%E9%9A%9C%E6%9C%89%E4%BD%95%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-number">1.7.</span> <span class="nav-text">单独使用 Y 屏障有何问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B7%E5%90%88%E5%86%99%E5%B1%8F%E9%9A%9C%E6%98%AF%E6%80%8E%E4%B9%88%E4%B8%80%E5%9B%9E%E4%BA%8B%EF%BC%9F"><span class="nav-number">1.8.</span> <span class="nav-text">混合写屏障是怎么一回事？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E5%8A%A9%E6%A0%87%E8%AE%B0%E6%B5%81%E7%A8%8B"><span class="nav-number">1.9.</span> <span class="nav-text">协助标记流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BA%A4%E5%8F%89%E5%BC%95%E7%94%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%89%AA%E6%9E%9D%E7%9A%84%EF%BC%9F"><span class="nav-number">1.10.</span> <span class="nav-text">对象的交叉引用是如何剪枝的？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcTriggerKind"><span class="nav-number">1.11.</span> <span class="nav-text">gcTriggerKind</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STW-%E6%97%B6%E9%97%B4%E6%80%8E%E4%B9%88%E7%AE%97%E5%87%BA%E6%9D%A5%E7%9A%84%EF%BC%9F"><span class="nav-number">1.12.</span> <span class="nav-text">STW 时间怎么算出来的？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gcStart-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">gcStart 源码剖析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#findRunnableGCWorker-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">findRunnableGCWorker 源码剖析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gcBgMarkWorker-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">gcBgMarkWorker 源码剖析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%96%E6%9E%90-gcBgMarkWorker-%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">4.1.</span> <span class="nav-text">剖析 gcBgMarkWorker 创建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#notesleepg"><span class="nav-number">4.1.1.</span> <span class="nav-text">notesleepg</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#go-gcBgMarkWorker"><span class="nav-number">4.1.2.</span> <span class="nav-text">go gcBgMarkWorker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BE%E4%BE%8B"><span class="nav-number">4.1.3.</span> <span class="nav-text">举例</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">杨宝强</p>
  <div class="site-description" itemprop="description">记录技术精进之路，记录生活的打情骂俏</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/clamyang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;clamyang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://xargin.com/" title="https:&#x2F;&#x2F;xargin.com" rel="noopener" target="_blank">Xargin</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://mytechshares.com/" title="https:&#x2F;&#x2F;mytechshares.com&#x2F;" rel="noopener" target="_blank">董泽润</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-car"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨宝强</span>
</div>
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2021035561号-1 </a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '4bcae079402e9cc4ce7b',
      clientSecret: 'bc6b6ecab4d016f0a056df8253ad41b76b944084',
      repo        : 'blog_comments',
      owner       : 'clamyang',
      admin       : ['clamyang'],
      id          : '8e15dd5589f5d9933b51c9f52bb75158',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
